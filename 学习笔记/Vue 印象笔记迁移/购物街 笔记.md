## 创建项目

Github方式创建项目：

cd 项目目录

vue create HYMall-master

![3 [1].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652054847-e58f91d7-2f70-46d3-b5d4-b92858270dac.jpeg)

![3 [2].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652054947-1e0b3252-415d-40dc-b2a9-4dc7d38f45fb.jpeg)

第一种连接远程仓库方式：

新建一个空文件夹 supermall1 放置 vue-cli3 创建的项目（因为仓库名不能与 vue-cli 创建的项目文件夹同名）后git clone

![3 [3].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652056699-f1a7fd94-eff6-4a62-a8b6-9668839149eb.jpeg)

![3 [4].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652056699-5f6450a5-7756-45de-8074-726bdef771c6.jpeg)

拷贝 vue-cli3 项目文件夹（supermall1）的文件到克隆的仓库项目（supermall）上（.git 和 node_modules 文件夹不需要拷贝 ）

![3 [5].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652057665-594e0807-f197-47c6-9c8a-c0c257284be3.jpeg)

```shell
cd 到仓库项目目录

git status // 红色表示未提交

git add .

git commit -m 'project initialized'

git push
```

第二种连接远程仓库方式：

不需要 git clone

确保你的 GitHub 仓库是空的（没有README.md）

```shell
cd  到 vue-cli3 项目目录

git init .

git config --global user.name <yourGitHubAccount>

git config --global user.email <yourGitHubEmailAccount>

git add .

git status

# edit .gitignore to ignore folder you don't want

git commit -m "first commit"

git remote add origin https://github.com/<yourGitHubAccount>/<yourRepo.git>

git push -u origin master
```

![3 [6].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652058228-3978add8-18c7-4add-b524-f3ded1be497f.jpeg)

[解决：如果有](https://jingyan.baidu.com/article/f3e34a12a25bc8f5ea65354a.html)[README.md](https://jingyan.baidu.com/article/f3e34a12a25bc8f5ea65354a.html)

之后每次更新项目，可以通过下面代码来上传：

```shell
git add .

git commit -m "update"

git push -u origin master
```

```shell
cd Desktop/HYMall-master

npm install //（看情况）

npm run serve
```

## 划分目录结构

打开 vue-cli3 创建的项目，删掉 APP相关的子组件和样式

![3 [7].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652058719-8a3b81fa-e90f-407a-8eb2-23fb2cf0a92e.jpeg)

划分目录结构主要针对 src 文件夹（默认有 assets 和 components）

assets 放置公共的 css 资源 和 图片资源

![3 [8].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652059727-a11903ff-9a6a-4e8c-9d68-cc0704e1047c.jpeg)

views 放置页面视图组件

![3 [9].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652060396-c753bc2f-d876-43dd-a775-d32732b88ef2.jpeg)

components 放置公共组件

components/common 放置与本项目无关的公共组件（每个页面（每个项目）都可以使用，下一个项目仍然可以使用）

components/content  放置与当前项目业务相关的公共组件（只针对当前项目）

![3 [10].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652061229-242c3e46-2510-4725-b8fd-6850224cbd5d.jpeg)

router 放置 Vue-router 路由相关

![3 [11].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652062059-4caf5858-3c8c-43aa-ae9f-d4781faeb9ce.jpeg)

store 放置 Vuex 公共状态管理

![3 [12].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652062963-cd2242d7-d0f6-4ad9-aa41-1d352f2e28f6.jpeg)

network 放置网络请求相关

![3 [13].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652063743-b0468ed3-1a7c-4614-8f55-08a9447de562.jpeg)

common 放置公共的 JS 文件，比如公共常量、工具函数util.js、混入mixin.js

![3 [14].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652064107-d8f4c527-ee26-42ea-847c-311a42c44283.jpeg)

## css文件的引入

引入初始化CSS

![3 [15].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652064827-9080d316-c912-4ecd-bdd6-c9e6aead956e.jpeg)

定义并使用CSS变量

![3 [16].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652065721-c42680ee-5953-4fce-b7f1-ccaae614dad9.jpeg)

base.css

-- 表示 CSS 变量，使得原生 CSS 能像预处理工具一样使用

```css
@import "./normalize.css";

:root {
  --color-text: #666;
  --color-high-text: #ff5777;
  --color-tint: #ff8198;
  --color-background: #fff;
  --font-size: 14px;
  --line-height: 1.5;
}

*,
*::before,
*::after {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: "Helvetica Neue",Helvetica,"PingFang SC","Hiragino Sans GB","Microsoft YaHei","微软雅黑",Arial,sans-serif;
  user-select: none; /* 禁止用户鼠标在页面上选中文字/图片等 */
  -webkit-tap-highlight-color: transparent; /* webkit是苹果浏览器引擎，tap点击，highlight背景高亮，color颜色，颜色用数值调节 */
  background: var(--color-background);
  color: var(--color-text);
  width: 100vw;
}

a {
  color: var(--color-text);
  text-decoration: none;
}

.clear-fix::after {
  clear: both;
  content: '';
  display: block;
  width: 0;
  height: 0;
  visibility: hidden;
}

.clear-fix {
  zoom: 1;
}

.arrow-right {
  border-top: 1px solid #999;
  border-left: 1px solid #999;
  width: 9px;
  height: 9px;
  background-color: transparent;
  transform: rotate(135deg);
  display: inline-block;
  margin-left: .1rem;
}

.left {
  float: left;
}

.right {
  float: right;
}
```

引入 base.css

![3 [17].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652067099-5fe20805-52f9-4caf-b79d-b295be314f99.jpeg)

## vue.config.js  和 .editorconfig

对路径起别名和统一代码风格

注意： vue.config.js 文件必须放到项目（这里是mall）目录下，而不是 src 目录下！

![3 [18].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652068220-4de2a41c-32c5-4594-8803-0d2a6c3d73b9.jpeg)

内部已经默认配置一个别名 @ 代表 src，所以

```js
module.export = {
  configureWebpack: {
    resolve: {
      alias: {
        "assets": "@/assets",
        "components": "@/components",
        "common": "@/components/common",
        "content": "@/components/content",
        "network": "@/network",
        "view": "@/view"
      }
    }
  }
}
```

router 一般不配，因为一般只在 main.js 中引用一次（store 同理）

而且可以通过 this.$router 和 this.$store 获取它们

遇到的坑：

配置被忽略，以为是 vue-cli 4.3.1 的 bug 导致不生效，其实是自己把 vue.config.js 放到 src 目录下，而不是项目目录下，

而且 VSCode 没有安装 ES6 代码提示导致拼写错误

vue.config.js

```js
const path = require("path")

function resolve(dir) {
  return path.join(__dirname, dir)
}

module.exports = {
  chainWebpack: config => {
    config.resolve.alias
      .set("assets", resolve("src/assets"))
      .set("components", resolve("src/components"))
      .set("common", resolve("src/components/common"))
      .set("content", resolve("src/components/content"))
      .set("network", resolve("src/network"))
      .set("views", resolve("src/views"));
  }   
}
```

vue-cli 3 没有 vue-cli 2 的 .editorconfig，所以需要自己配置，配置一次后下一个项目直接拷贝就好，这样就可以统一团队代码风格

![3 [19].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652068298-38d0f8c3-2159-45e8-ac5c-bcaa1090231a.jpeg)

.editorconfig

```shell
root = true

[*]
charset = utf-8
indent_style = space
indent_size = 2
end_of_line = lf
insert_final_newline = true
trim_trailing_whitespace = true
```

## 引入 tabBar 组件

注意：在 Vue 的 HTML 中 DOM 使用别名，前面要加~

tabbar 是完全独立的公共组件，所以放到 common 下

下一个项目不一定是首页、分类等，甚至图标和文字都可能不一样，所以将 MainTabBar（与业务有关） 放到 content 下

![3 [20].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652068303-2b66b1a9-c15d-4c36-9992-a0cb6063a049.jpeg)

img 下也要进行目录划分

![3 [21].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652068874-1cd86da7-99cc-4b8a-81c6-f0d049d95ba5.jpeg)

MainTabBar 里为 `<img>` src 路径添加别名

![3 [22].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652069074-a3588dc3-7e42-44bc-b504-9f5e9ccea7a7.jpeg?x-oss-process=image%2Fresize%2Cw_929%2Climit_0)

为 APP.vue 注册 MainTabBar 组件

![3 [23].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652069244-8a9f30f9-cbab-4bab-a512-501ece4eb120.jpeg)

为 MainTabBar组件 注册 TabBar组件 和 TabBarItem组件

![3 [24].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652069476-b884e78f-bf17-4939-a51e-b1bec3552790.jpeg)

实现路由效果

APP.vue

```vue
<template>
  <div id="app">
    <router-view></router-view>
    <main-tab-bar></main-tab-bar>
  </div>
</template>

<script>
  import MainTabBar from 'content/mainTabbar/MainTabBar'
  export default {
    name: 'app',
    components: {
      MainTabBar
    }
  }
</script>

<style>
  @import "assets/css/base.css";
</style>
```

router 的 index.js

```js
import Vue from 'vue'
// 1、引入 router
import VueRouter from 'vue-router'
// 2、安装插件
Vue.use(VueRouter)

// 5、实现组件懒加载
const Home = () => import('views/home/Home')
const Category = () => import('views/category/Category')
const Cart = () => import('views/cart/Cart')
const Profile = () => import('views/profile/Profile')

// 4、routes 配置数组中的对象记录路由，配置映射关系
const routes = [
  {
    path: '',
    redirect: '/home'
  },
  {
    path: '/home',
    component: Home
  },
  {
    path: '/category',
    component: Category
  },
  {
    path: '/cart',
    component: cart
  },
  {
    path: '/profile',
    component: Profile
  }
]

// 3、创建 router 实例，传入 routes 路由
const router = new VueRouter({
  mode: 'history',
  base: process.env.BASE_URL,
  routes
})

// 6、导出 router
export default router
```

MainTabBar.vue

```vue
<template>
  <tab-bar>
    <tab-bar-item path="/home">
      <img slot="item-icon" src="~assets/img/tabbar/home.svg" alt="首页">
      <img slot="item-icon-active" src="~assets/img/tabbar/home_active.svg" alt="">
      <div slot="item-text">首页</div>
    </tab-bar-item>
    <tab-bar-item path="/category">
      <img slot="item-icon" src="~assets/img/tabbar/category.svg" alt="分类">
      <img slot="item-icon-active" src="~assets/img/tabbar/category_active.svg" alt="">
      <div slot="item-text">分类</div>
    </tab-bar-item>
    <tab-bar-item path="/cart">
      <img slot="item-icon" src="~assets/img/tabbar/cart.svg" alt="购物车">
      <img slot="item-icon-active" src="~assets/img/tabbar/cart_active.svg" alt="">
      <div slot="item-text">购物车</div>
    </tab-bar-item>
    <tab-bar-item path="/profile">
      <img slot="item-icon" src="~assets/img/tabbar/profile.svg" alt="我的">
      <img slot="item-icon-active" src="~assets/img/tabbar/profile_active.svg" alt="">
      <div slot="item-text">我的</div>
    </tab-bar-item>
  </tab-bar>
</template>

<script>
import TabBar from 'common/tabBar/TabBar'
import TabBarItem from 'common/tabBar/TabBarItem'

export default {
  name: 'MainTabBar',
  components: {
    TabBar,
    TabBarItem
  }
}
</script>

<style scoped>
</style>
```

![3 [25].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652069615-ccc03101-23da-4310-8d8f-390f44d49750.jpeg)

标签页小图标的修改

public 文件夹下 修改 index.html （图片文件改为 logo.png）

![3 [26].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652070704-3d389124-f866-4453-9af1-c43ddfc1dea6.jpeg)

<%= Base_URL %> 是 JSP 的语法，表示当前文件（index.html）所在的路径

public文件夹 相当于 vue-cli2 的 static 文件夹，打包（run build）时会将里面的文件原封不动地复制（并进行压缩后）到 dist 目录下

## navbar 组件的封装

![3 [27].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652070719-bad9f210-9bcc-4b16-8a1b-7e21080cbb7e.jpeg)

不是所有导航中间都是标题，例如下图 中间是 TabBar（TabControl）

![3 [28].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652070808-a113241a-7496-48f4-b1ca-75e5509d48da.jpeg)

后续导航还需要加图标

![3 [29].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652070951-6f9662da-407c-459c-973f-2e830c4f003a.jpeg)

所以需要封装一个独立的导航栏组件

将 NavBar 组件放进 components/common 公共组件里，文件夹小写、组件大写（代码风格）

![3 [30].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652070887-2511ff42-2d87-4a7c-8f44-fe7df1ec5633.jpeg)

不可以对 `<slot>` 直接使用 class 添加样式，所以需要在外面包裹一层 `<div>` 用来添加 class

不对 `<div>` 使用 id 命名为 nav-bar，而是使用 class 命名为 nav-bar，因为一个项目里多个地方都会有导航栏会导致 id 重复，

而 tabBar 只有一个

NavBar.vue

```vue
<template>
  <div class="nav-bar">
    <div class="left"><slot name="left"></slot></div>
    <div class="center"><slot name="center"></slot></div>
    <div class="right"><slot name="right"></slot></div>
  </div>
</template>

<script>
export default {
  name: 'NavBar'
}
</script>

<style scoped>
  .nav-bar {
    display: flex;
    height: 44px;
    line-height: 44px;
    text-align: center;
    box-shadow: 0 1px 1px rgba(100, 100, 100, .1);
  }
  .left {
    width: 60px;
  }
  .center {
    flex: 1;
  }
  .right {
    width: 60px;
  }
</style>
```

在首页使用导航栏组件

![3 [31].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652071647-bd30fc09-e2bd-47d0-aba0-e12bcef7a7fc.jpeg)

Home.vue

```vue
<template>
  <div id="home">
    <nav-bar class="nav">
      <div slot="center">购物街</div>
    </nav-bar>
  </div>
</template>

<script>
import NavBar from 'common/navBar/NavBar'
export default {
  name: 'Home',
  components: {
    NavBar
  }
}
</script>

<style>
  .nav {
    background-color: var(--color-tint);
    color: #fff;
    z-index: 9;
  }
</style>
```

注意：不要在公共组件中使用 z-index

因为每个导航栏的背景颜色和文字颜色都不一样，所以不在 NavBar 组件添加背景颜色和文字颜色

![3 [32].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652071714-6c3e2630-f497-4f69-9147-4a0de5355419.jpeg)

## 请求首页的多个数据

一般来说，不要在组件里发送网络请求，而是再做一层封装，在 network 文件夹里进行统一管理

![3 [33].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652071722-3a535bd6-fa4c-4699-83ff-56f115e1238c.jpeg)

```shell
npm install axios --save
```

request.js

```js
import axios from 'axios'

export function request(config) {
  // 1、创建 axios 实例
  const instance = axios.create({
    baseURL: "http://123.207.32.32:8000/api/m3",
    timeout: 5000
  });
  // axios 拦截器
  // 2、请求拦截
  instance.interceptors.request.use(config => {
    return config
  }, err => {
    console.log("error");
  })
  // 3、响应拦截
  instance.interceptors.response.use(res => {
    return res.data
  }, err => {
    console.log('error')
  })
  // 4、 发送真正的网络请求（ Get 请求），返回 Promise，可以 .then
  return instance(config)
}
```

home.js

假如首页有多个请求时，方便管理所有首页相关的请求（这个设计方案对大项目非常好，多去看优秀的代码才能学到）

Home.vue 面向 home.js 模块进行开发

![3 [34].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652071821-f2d05c6b-fd7c-4303-82a1-0e0bca50db2b.jpeg)

```js
import {request} from './request'

export function getHomeMultidata() {
   return request({
     url: '/home/multidata'
   })
}
```

Home.vue

```vue
<template>
  <div id="home">
    <nav-bar class="nav">
      <div slot="center">购物街</div>
    </nav-bar>
  </div>
</template>

<script>
import NavBar from 'common/navBar/NavBar'
import {getHomeMultidata} from 'network/home'

export default {
  name: 'Home',
  data() {
    return {
      banner: [], // 这里的变量永远被 Home 组件引用
      recommend: []
    }   
  },
  components: {
    NavBar
  },
  created () {
    getHomeMultidata().then(res => {
      // this.result = res
      this.banner = res.data.banner.list; // 回调函数执行完成后会弹出执行栈，内存会回收释放所有函数局部变量，所以需要保存起来，这里保存在 data 中
      this.recommend = res.data.recommend.list; // 箭头函数的 this 就是 created 的 this ，也就是 Home 组件
      // 垃圾回收只会等到没有引用指向才会回收，这里只回收 res
    })
  }
}
</script>

<style>
  .nav {
    background-color: var(--color-tint);
    color: #fff
  }
</style>
```

网络请求里回调函数执行完会释放所有局部变量，数据无法保存，所以需要在 data 定义一个变量接收响应的数据

result 和 res 的内存地址同时指向 data，函数执行完 res 被回收，res 的箭头引用也就不存在了

因为 result 在组件中存在，data 被 result 箭头引用，所以不会被垃圾回收回收掉

![3 [35].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652072034-4cc4964e-7c9b-4353-8c14-e8f3da3f33e2.jpeg)

注意：不可以像下图那样验证数据，因为 getHomeMultidata().then() 是异步操作，所以会打印 undefined

![3 [36].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652072334-c7c215b3-9d0c-44f4-9852-0a9a099370a6.jpeg)

所以这里需要工具进行验证

![3 [37].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652072400-c701eee0-33ea-430f-944a-49e433c19d29.jpeg)

![3 [38].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652072660-0920fefe-1deb-44b3-8d1c-accde645418f.jpeg)

解决问题： vue-tools 无法打开

![3 [39].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652073151-967b5413-ebc5-45ba-bdfb-5f05c0bd2625.jpeg)

在 main.js 添加

```js
Vue.config.devtools = true;
```

https://segmentfault.com/q/1010000008735643

## 轮播图的展示

![3 [40].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652073485-3e516668-9248-4972-b734-dfa1410ad878.jpeg)

Swiper.vue

```vue
<template>
    <div id="hy-swiper">
      <div class="swiper" @touchstart="touchStart" @touchmove="touchMove" @touchend="touchEnd">
        <slot></slot>
      </div>
      <slot name="indicator">
      </slot>
      <div class="indicator">
        <slot name="indicator" v-if="showIndicator && slideCount>1">
          <div v-for="(item, index) in slideCount" class="indi-item" :class="{active: index === currentIndex-1}" :key="index"></div>
        </slot>
      </div>
    </div>
</template>

<script>
  export default {
    name: "Swiper",
    props: {
      interval: {
        type: Number,
        default: 3000
      },
      animDuration: {
        type: Number,
        default: 300
      },
      moveRatio: {
        type: Number,
        default: 0.25
      },
      showIndicator: {
        type: Boolean,
        default: true
      }
    },
    data: function () {
      return {
        slideCount: 0, // 元素个数
        totalWidth: 0, // swiper的宽度
        swiperStyle: {}, // swiper样式
        currentIndex: 1, // 当前的index
        scrolling: false, // 是否正在滚动
      }
    },
    mounted: function () {
      // 1.操作DOM, 在前后添加Slide
      setTimeout(() => {
        this.handleDom();
        // 2.开启定时器
        this.startTimer();
      }, 3000)
    },
    methods: {
      /**
       * 定时器操作
       */
      startTimer: function () {
        this.playTimer = window.setInterval(() => {
          this.currentIndex++;
          this.scrollContent(-this.currentIndex * this.totalWidth);
        }, this.interval)
      },
      stopTimer: function () {
        window.clearInterval(this.playTimer);
      },
      /**
       * 滚动到正确的位置
       */
      scrollContent: function (currentPosition) {
        // 0.设置正在滚动
        this.scrolling = true;
        // 1.开始滚动动画
        this.swiperStyle.transition ='transform '+ this.animDuration + 'ms';
        this.setTransform(currentPosition);
        // 2.判断滚动到的位置
        this.checkPosition();
        // 4.滚动完成
        this.scrolling = false
      },
      /**
       * 校验正确的位置
       */
      checkPosition: function () {
        window.setTimeout(() => {
          // 1.校验正确的位置
          this.swiperStyle.transition = '0ms';
          if (this.currentIndex >= this.slideCount + 1) {
            this.currentIndex = 1;
            this.setTransform(-this.currentIndex * this.totalWidth);
          } else if (this.currentIndex <= 0) {
            this.currentIndex = this.slideCount;
            this.setTransform(-this.currentIndex * this.totalWidth);
          }
          // 2.结束移动后的回调
          this.$emit('transitionEnd', this.currentIndex-1);
        }, this.animDuration)
      },
      /**
       * 设置滚动的位置
       */
      setTransform: function (position) {
        this.swiperStyle.transform = `translate3d(${position}px, 0, 0)`;
        this.swiperStyle['-webkit-transform'] = `translate3d(${position}px), 0, 0`;
        this.swiperStyle['-ms-transform'] = `translate3d(${position}px), 0, 0`;
      },
      /**
       * 操作DOM, 在DOM前后添加Slide
       */
      handleDom: function () {
        // 1.获取要操作的元素
        let swiperEl = document.querySelector('.swiper');
        let slidesEls = swiperEl.getElementsByClassName('slide');
        // 2.保存个数
        this.slideCount = slidesEls.length;
        // 3.如果大于1个, 那么在前后分别添加一个slide
        if (this.slideCount > 1) {
          let cloneFirst = slidesEls[0].cloneNode(true);
          let cloneLast = slidesEls[this.slideCount - 1].cloneNode(true);
          swiperEl.insertBefore(cloneLast, slidesEls[0]);
          swiperEl.appendChild(cloneFirst);
          this.totalWidth = swiperEl.offsetWidth;
          this.swiperStyle = swiperEl.style;
        }
        // 4.让swiper元素, 显示第一个(目前是显示前面添加的最后一个元素)
        this.setTransform(-this.totalWidth);
      },
      /**
       * 拖动事件的处理
       */
      touchStart: function (e) {
        // 1.如果正在滚动, 不可以拖动
        if (this.scrolling) return;
        // 2.停止定时器
        this.stopTimer();
        // 3.保存开始滚动的位置
        this.startX = e.touches[0].pageX;
      },
      touchMove: function (e) {
        // 1.计算出用户拖动的距离
        this.currentX = e.touches[0].pageX;
        this.distance = this.currentX - this.startX;
        let currentPosition = -this.currentIndex * this.totalWidth;
        let moveDistance = this.distance + currentPosition;
        // 2.设置当前的位置
        this.setTransform(moveDistance);
      },
      touchEnd: function (e) {
        // 1.获取移动的距离
        let currentMove = Math.abs(this.distance);
        // 2.判断最终的距离
        if (this.distance === 0) {
          return
        } else if (this.distance > 0 && currentMove > this.totalWidth * this.moveRatio) { // 右边移动超过0.5
          this.currentIndex--
        } else if (this.distance < 0 && currentMove > this.totalWidth * this.moveRatio) { // 向左移动超过0.5
          this.currentIndex++
        }
        // 3.移动到正确的位置
        this.scrollContent(-this.currentIndex * this.totalWidth);
        // 4.移动完成后重新开启定时器
        this.startTimer();
      },
      /**
       * 控制上一个, 下一个
       */
      previous: function () {
        this.changeItem(-1);
      },
      next: function () {
        this.changeItem(1);
      },
      changeItem: function (num) {
        // 1.移除定时器
        this.stopTimer();
        // 2.修改index和位置
        this.currentIndex += num;
        this.scrollContent(-this.currentIndex * this.totalWidth);
        // 3.添加定时器
        this.startTimer();
      }
    }
  }
</script>

<style scoped>
  #hy-swiper {
    overflow: hidden;
    position: relative;
  }
  .swiper {
    display: flex;
  }
  .indicator {
    display: flex;
    justify-content: center;
    position: absolute;
    width: 100%;
    bottom: 8px;
  }
  .indi-item {
    box-sizing: border-box;
    width: 8px;
    height: 8px;
    border-radius: 4px;
    background-color: #fff;
    line-height: 8px;
    text-align: center;
    font-size: 12px;
    margin: 0 5px;
  }
  .indi-item.active {
    background-color: rgba(212,62,46,1.0);
  }
</style>
```

SwiperItem.vue

```vue
<template>
    <div class="slide">
      <slot></slot>
    </div>
</template>

<script>
  export default {
    name: "Slide"
  }
</script>

<style scoped>
  .slide {
    width: 100%;
    flex-shrink: 0;
  }
  .slide img {
    width: 100%;
  }
</style>
```

index.js

```js
import Swiper from './Swiper'
import SwiperItem from './SwiperItem'

export {
  Swiper, SwiperItem
}
```

UI 库直接用是简单的（知道怎么用就行），如果要学习研究它必须自己从零封装一个，才能熟悉，大胆在项目中用

如果 swiper 组件放到 Home.vue 中，会出现以下情况，代码越来越多造成 Home.vue 的臃肿，层级越来越多：

![3 [41].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652073595-8debdb95-099a-4b34-86ad-085a1547691b.jpeg)

Home.vue 只负责管理最主要的逻辑，至于组件里面怎么写、怎么封装的 Home.vue 不需要关心，

因为 swiper 属于 Home，是Home 里面的代码，所以要抽取到 Home文件夹下（而不是其他文件夹）

![3 [42].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652073579-abb17b5a-dac1-4b98-81a0-f1fa45a1b34e.jpeg)

所有关于 Home 的子组件都放到 childComps 里（个人认为命名叫作 childCpns 比较好） 

![3 [43].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652074100-8e97151e-5d9a-4a93-985d-74f9c87d167e.jpeg)

![3 [44].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652074207-1ff5068b-3131-40fc-afa6-494a9b52f8c5.jpeg)

HomeSwiper.vue

```vue
<template>
  <swiper>
    <swiper-item v-for="(item, index) in banner" :key="index">
      <a :href="item.link">
        <img :src="item.image">
      </a>
    </swiper-item>
  </swiper>
</template>

<script>
  import {Swiper, SwiperItem} from 'common/swiper/index.js'
  export default {
    name: 'HomeSwiper',
    props: {
      banner: {
        type: Array,
        default() {
          return []
        }
      }
    },
    components: {
      Swiper,
      SwiperItem
    }
  }
</script>

<style scoped>
</style>
```

Home.vue

组件按顺序导入

```vue
<template>
  <div id="home">
    <nav-bar class="nav">
      <div slot="center">购物街</div>
    </nav-bar>
    <home-swiper :banner="banner"></home-swiper>
  </div>
</template>

<script>
  import NavBar from 'common/navbar/NavBar'
  import HomeSwiper from './childComps/HomeSwiper'
  import { getHomeMultidata } from 'network/home'
  export default {
    name: 'Home',
    components: {
      NavBar,
      HomeSwiper
    },
    data() {
      return {
        banner: null,
        recommend: null
      }    
    },
    created () {
      getHomeMultidata().then(res => {
        this.banner = res.data.banner.list;
        this.recommend = res.data.recommend.list;
      })
    }
  }
</script>

<style scoped>
  .nav {
    background-color: var(--color-tint);
    color: #fff;
  }
</style>
```

遇到的坑：

没有属性绑定和没有设置根元素 `<div>`

效果图

![3.gif](https://cdn.nlark.com/yuque/0/2022/gif/1614731/1656660128407-b7d56041-4c37-4d4d-a758-519518dbf937.gif)

## 推荐信息的展示

![3 [45].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652074517-ff35fb57-0d5a-41dc-9430-0dca6f4505e2.jpeg)

推荐信息是一个独立的组件（属于 Home 的 子组件）

![3 [46].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652074914-a85e079e-494b-4aae-bc69-a407c808af05.jpeg)

HomeRecommend.vue

```vue
<template>
  <div class="recommend">
    <div class="recommend-item" v-for="item of recommend">
      <a :href="item.link">
        <img :src="item.image">
        <div>{{item.title}}</div>
      </a>
    </div>
  </div>
</template>

<script>
  export default {
    name: 'HomeRecommend',
    props: {
      recommend: {
        type: Array,
        default() {
          return []
        }
      }
    }
  }
</script>

<style scoped>
  .recommend {
    display: flex;
    text-align: center;
    font-size: 12px;
    padding: 10px 0 20px;
    border-bottom: 5px solid #ccc;
  }
  .recommend-item {
    flex: 1;
  }
  .recommend-item img {
    width: 70px;
    height: 70px;
    margin-bottom: 10px;
  }
</style>
```

Home.vue

```vue
<template>
  <div id="home">
    <nav-bar class="nav">
      <div slot="center">购物街</div>
    </nav-bar>
    <home-swiper :banner="banner"></home-swiper>
    <home-recommend :recommend="recommend"></home-recommend>
  </div>
</template>

<script>
  import NavBar from 'common/navbar/NavBar'
  import HomeSwiper from './childCpns/HomeSwiper'
  import HomeRecommend from './childCpns/HomeRecommend'
  import { getHomeMultidata } from 'network/home'
  export default {
    name: 'Home',
    components: {
      NavBar,
      HomeSwiper,
      HomeRecommend
    },
    data() {
      return {
        banner: null,
        recommend: null
      }    
    },
    created () {
      getHomeMultidata().then(res => {
        this.banner = res.data.banner.list;
        this.recommend = res.data.recommend.list;
      })
    }
  }
</script>

<style scoped>
  .nav {
    background-color: var(--color-tint);
    color: #fff;
  }
</style>
```

效果图

![3 [47].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652075016-85ee7716-aa52-436b-bc22-16e30fb3e372.jpeg)

## FeatureView 的封装

目前来说，我们只在首页 Home.vue 添加了三个组件：tab-bar、home-swiper、home-recommend，具体的东西可以在具体的小组件查看

这种封装的思想就是组件化开发的思想

```vue
<template>
  <div id="home">
    <nav-bar class="nav">
      <div slot="center">购物街</div>
    </nav-bar>
    <home-swiper :banner="banner"></home-swiper>
    <home-recommend :recommend="recommend"></home-recommend>
  </div>
</template>
```

![3 [48].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652075111-097d6e78-6122-48ac-8a8e-c17edf4bdc76.jpeg)

虽然这块只是一张图片，但是也不推荐在 Home.vue 中直接添加 `<img>`，

因为它也属于一个独立的功能模块，所以也要把它封装成一个独立的组件

它也属于首页的子组件，所以要放到 childCpns 里

![3 [49].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652075243-334265e3-ade3-47e0-8cbe-d58c133ca46f.jpeg)

因为它是购物特点相关的，所以命名为 FeatureView

FeatureView.vue

```vue
<template>
  <div class="feature">
    <a href="http://act.mogujie.com/zzlx67">
      <img src="~assets/img/home/recommend_bg.jpg" alt="">
    </a>
  </div>
</template>

<script>
  export default {
    name: 'FeatureView',
    data () {
      return {
      }
    }
  }
</script>

<style scoped>
  .feature img{
    width: 100%;
  }
</style>
```

导航栏在滚动时必须固定，而且需要使用 padding-top 让整个页面增加一个导航栏的高度

ul>li{列表$}*100 暂时撑开下拉列表的高度，使得滚动时看到下拉列表的内容，后面再删

Home.vue

```vue
<template>
  <div id="home">
    <nav-bar class="nav">
      <div slot="center">购物街</div>
    </nav-bar>
    <home-swiper :banner="banner"></home-swiper>
    <home-recommend :recommend="recommend"></home-recommend>
    <feature-view></feature-view>
    <ul>
      <li>列表1</li>
      <li>列表2</li>
      <li>列表3</li>
      ...  
    </ul>
  </div>
</template>

<script>
  import NavBar from 'common/navbar/NavBar'
  import HomeSwiper from './childCpns/HomeSwiper'
  import HomeRecommend from './childCpns/HomeRecommend'
  import FeatureView from './childCpns/FeatureView'
  import { getHomeMultidata } from 'network/home'
  export default {
    name: 'Home',
    components: {
      NavBar,
      HomeSwiper,
      HomeRecommend,
      FeatureView
    },
    data() {
      return {
        banner: null,
        recommend: null
      }    
    },
    created () {
      getHomeMultidata().then(res => {
        this.banner = res.data.banner.list;
        this.recommend = res.data.recommend.list;
      })
    }
  }
</script>

<style scoped>
  #home {
    padding-top: 44px;
  }
  .nav {
    background-color: var(--color-tint);
    color: #fff;
    position: fixed;
    top: 0;
    right: 0;
    left: 0;
  }
</style>
```

为了不在移动端浏览器滚动时非常卡顿，所以我们不使用原生，将会使用 better-scroll 库（一个仿 iscroll 核心的库）

![3 [1].gif](https://cdn.nlark.com/yuque/0/2022/gif/1614731/1656660117247-4214c327-00c3-4d88-a3cd-379fd4c873be.gif)

## TabControl 的封装

选项卡控制栏也是一个独立的组件，它也会在其它地方用

首页里面用（有停留吸顶效果）

![3 [50].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652075862-22f47bc3-8878-4f81-9c7d-04d8a4d5bc95.jpeg)

![3 [51].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652075924-c6472bd7-69a9-4d5e-b15e-d666a29341f9.jpeg)

既然这个组件可以在多个页面中使用，所以不能放在 home/ChildCpns 里（分类页面不应该使用 Home的子组件），

而是放在 components/content 里，因为它属于业务相关的公共组件，在下一个项目当中可能不一样

![3 [52].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652076008-5318221f-7de5-4bd7-b060-25af874ac320.jpeg)

因为在不同页面填充的文字无法确定，而且选项卡的个数也不是确定的

只是文字不一样而已，并不像导航栏（不一样的东西太多），所以没有必要搞 `<slot>`插槽，根据不同情况采取不同思想

只需要让开发者传入包含所有标题文字的数组，根据有几个标题文字和标题文字叫什么来决定显示几个选项卡和显示什么样的 标题文字

每个选项卡是一个 `<div>`，`<div>`里有一个 `<span>`，`<span>` 有一个 border-bottom

![3 [53].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652076012-3a1df404-ef7c-4b74-baa9-d2439f607fe1.jpeg)

`<div> `选项卡个数根据传进来的标题文字数组决定


子组件和 common 的公共组件导入时使用空格区分，按顺序导入，另外：components: {} 与 import 顺序要保持一致

Home.vue

```vue
<template>
  <div id="home">
    <nav-bar class="nav">
      <div slot="center">购物街</div>
    </nav-bar>
    <home-swiper :banner="banner"></home-swiper>
    <home-recommend :recommend="recommend"></home-recommend>
    <feature-view></feature-view>
    <tab-control :title="['流行', '新款', '精选']"></tab-control>
    <ul>
      <li>列表1</li>
      <li>列表2</li>
      <li>列表3</li>
      ...
    </ul>
  </div>
</template>

<script>
  import HomeSwiper from './childCpns/HomeSwiper'
  import HomeRecommend from './childCpns/HomeRecommend'
  import FeatureView from './childCpns/FeatureView'

  import NavBar from 'common/navbar/NavBar'
  import TabControl from 'content/tabControl/TabControl'

  import { getHomeMultidata } from 'network/home'

  export default {
    name: 'Home',
    components: {    
      HomeSwiper,
      HomeRecommend,
      FeatureView,
      NavBar,
      TabControl
    },
    data() {
      return {
        banner: null,
        recommend: null
      }    
    },
    created () {
      getHomeMultidata().then(res => {
        this.banner = res.data.banner.list;
        this.recommend = res.data.recommend.list;
      })
    }
  }
</script>
```

TabControl.vue

```vue
<template>
  <div class="tab-control">
    <div v-for="(item, index) of title" :key="index"
    @click="tabClick(index)" :class="{active: currentIndex === index}"
    class="tab-control-item">
      <span>{{item}}</span>
    </div>  
  </div>
</template>

<script>
  export default {
    name: 'TabControl',
    props: {
      title: {
        type: Array,
        default() {
          return []
        }
      }
    },
    data () {
      return {
        currentIndex: 0
      }
    },
    methods: {
      tabClick(index) {
        this.currentIndex = index
      }
    }
  }
</script>

<style scoped>
  .tab-control {
    display: flex;
    text-align: center;
    height: 40px;
    line-height: 40px;
    font-size: 15px;
  }
  .tab-control-item {
    flex: 1;
  }
  .active {
    color: var(--color-tint);   
  }
  .active span {
    border-bottom: 2px solid var(--color-tint);
    padding: 5px;
  }
</style>
```

注意： border-bottom 必须添加到 span 上，否则太长，而且需要使用 padding 撑开一点距离

![3 [54].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652076411-00c79fc1-f605-461c-ae54-7dde42e98a95.jpeg)

![3 [55].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656744145186-bc3fc972-8125-4127-b2fc-81e181964564.jpeg)

## 保存商品的数据结构设计

接下来要做商品列表页，第一件事是要请求数据，但是数据分为三类： 流行、新款、精选，而且有点多

Vue 会默认对组件进行复用，复用的话会造成切换 TabControl 时商品列表页的图片不会更新（就像两个 input 一样）

所以在后面需要绑定一个 :key 属性

![3 [56].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652076790-60106451-a035-4ec4-9df9-a5c19969cc5b.jpeg)

使用计算属性来决定显示哪个 img

![3 [57].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652076926-ad0e1e84-9da8-42a0-97a6-723e06504656.jpeg)

根据不同的点击展示不同的数据，但是保存数据的时候既要有流行的数据，也要有新款和精选的数据，

如果没有就只能再次发送请求，这样的话用户延迟时间就比较长了

所以要一次性把所有 流行/新款/精选 数据 请求下来，放到一个地方存储

![3 [58].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652077036-6df10e9e-2469-497b-843e-b08170e5d36c.jpeg?x-oss-process=image%2Fresize%2Cw_818%2Climit_0)

但是一个 流行 的数据有很多页，因为要做上拉加载更多，既有第一页也有其他页，数据量还是很大的

假如在 goods 变量（一个对象）保存所有的 流行/新款/精选 数据

流行/新款/精选 其中的每个数据又是一个对象（里面有页数 page 和表示列表数据的 list），有可能保存着30条，有可能保存着60条，有可能保存着90条

另外，流行/新款/精选 每一页显示的页数是可以不一样的

![3 [59].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652077702-df791e9e-6f04-4d0e-b61a-f4b0c3f32c45.jpeg)

当用户上拉加载更多时，新款就要增加 30 条数据，page变成第 3 页 list变成展示 90 条数据

做其他开发时也可以设计成 map 数据结构

![3 [60].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652077752-61fc3327-f43c-4bd7-9394-5ae369303a2c.jpeg)

这个数据模型属于首页，所以可以在首页 Home.vue 中添加 goods

goods 可以默认写成第 1 页，也可以是第 0 页，表示什么都还没请求

![3 [61].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652078099-f7aa35f9-1637-4cd6-b027-facfa4e63eb9.jpeg)

## 首页数据的请求和保存

默认先把每个类型的第一页数据请求下来，方便展示和操作，当用户上拉加载更多时再显示其他页

所以要先从 network 里入手，封装一个请求商品列表数据的函数，添加类型和页码请求不同类型的数据

![3 [62].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652078204-2439c92b-05c0-4c37-8354-0767c00f7d48.jpeg)

引入 请求商品列表数据 的函数

![3 [63].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656744167332-4b4f1954-50cc-4573-b140-ec43593fed68.jpeg)

created 里保存数据时，created 里的代码会有点多，容易乱

![3 [64].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652078717-36b5623a-bf5e-431a-be24-3cf86ceeb56d.jpeg)

所以要把 请求的代码抽离到 methods 里（代码组织方式，只有用经验慢慢体会和积累），而且可以动态地请求数据了

因为一旦首页创建完之后请求的不是一个数据，所以请求类型 type  和请求页码 page 可以不写死，要让请求函数可以复用，请求不同类型的数据

由于默认先请求第一页数据，而且 请求函数复用 时未必是第一页，所以请求页码 page 是之前的页码 + 1，不写死数据让 请求函数复用 更方便

下面例子 请求的 res结果 默认就是 pop类型的第一页30条数据

![3 [65].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652079228-f2135eab-4b4c-48b8-aa36-d5e0884b78c9.jpeg)

不能直接 .push(数组)

```js
let totalNums = []

totalNums.push([10, 20, 30]); // 结果为[[10, 20, 30]]
```

所以 使用 .push(可变参数 ...数组) 依次取出数组的值然后依次push

![3 [66].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652079798-b38b900f-710e-4f02-93ae-9b0405b57c4f.jpeg)

![3 [67].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652080033-a854e230-5d25-4082-9757-918473e89766.jpeg)

home.js

```js
import {request} from './request'

export function getHomeMultidata() {
  return request({
    url: 'home/multidata'
  })
}

export function getHomeGoods(type, page) {
  return request({
    url: 'home/data',
    params: {
      type,
      page
    }
  })
}
```

Home.vue

```vue
<template>
  <div id="home">
    <nav-bar class="nav">
      <div slot="center">购物街</div>
    </nav-bar>
    <home-swiper :banner="banner"></home-swiper>
    <home-recommend :recommend="recommend"></home-recommend>
    <feature-view></feature-view>
    <tab-control :title="['流行', '新款', '精选']"></tab-control>
    <ul>
      <li>列表1</li>
      <li>列表2</li>
      <li>列表3</li>
      ...
    </ul>
  </div>
</template>
<script>
  
  import HomeSwiper from './childCpns/HomeSwiper'
  import HomeRecommend from './childCpns/HomeRecommend'
  import FeatureView from './childCpns/FeatureView'

  import NavBar from 'common/navbar/NavBar'
  import TabControl from 'content/tabControl/TabControl'

  import { getHomeMultidata, getHomeGoods } from 'network/home'

  export default {
    name: 'Home',
    components: {    
      HomeSwiper,
      HomeRecommend,
      FeatureView,
      NavBar,
      TabControl
    },
    data() {
      return {
        banner: null,
        recommend: null,
        goods: {
          'pop': {page: 0, list: []},
          'new': {page: 0, list: []},
          'sell': {page: 0, list: []}
        }
      }    
    },
    created () {
      this.getHomeMultidata();
      this.getHomeGoods('pop');
      this.getHomeGoods('new');
      this.getHomeGoods('sell');
    },
    methods: {
      getHomeMultidata() {
        getHomeMultidata().then(res => {
          this.banner = res.data.banner.list;
          this.recommend = res.data.recommend.list;
        })
      },
      getHomeGoods(type) {
        const page = this.goods[type].page + 1;
        getHomeGoods(type, page).then(res => {
           this.goods[type].list.push(...res.data.list);
           this.goods[type].page += 1;
        })
      }
    }
  }
</script>
```

请求成功：

![3 [68].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652080282-e48bb781-a69f-475b-bcb2-bb350a9a0008.jpeg)

## 首页商品数据的展示

如果要展示，要如何封装组件进行展示呢？

整个区域是一个大的组件，根据数据量的多少塞这些小组件

![3 [69].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652080593-74c765ba-86bc-4088-9d7b-db5fd5c8e7a6.jpeg)

这个大组件要封装在哪呢？首先考虑组件会不会被复用，其实会被复用，所以将它放到业务有关的 common/content 公共组件里

![3 [70].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652081057-392da7ed-31e4-481d-b808-6f550e910f70.jpeg)

每一个小的 GoodsItem 本身都是一个组件（GoodList的局部组件），根据数据的多少遍历出多少个小的 GoodsItem

所以要有两个组件

然后引入 GoodsList 组件

![3 [71].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652081247-cddc68a9-609c-4336-ab63-f8e300e3965d.jpeg)

GoodList 要展示首页的 商品列表数据，所以需要 Home.vue 将数据传递给 GoodList.vue

![3 [72].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652081398-a463da94-0ea8-452a-b6cb-8e999665dd95.jpeg)

Home.vue

![3 [73].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652081740-46a4647c-84a4-42dd-92ff-3f67f1e2b2fa.jpeg)

GoodsList.vue

![3 [74].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652081755-fbd59e6d-2317-4b95-a789-b765fd123f01.jpeg)

GoodsList 大组件循环数据渲染多个 GoodsListItem

![3 [75].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652082402-d58d0f6e-230d-4fda-aee1-1d8b706543f5.jpeg)

GoodsItem.vue

![3 [76].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652083056-f7556e68-db36-4af0-bdad-9c462980a550.jpeg)

![3 [77].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652083165-db473075-3df2-44c9-9ec5-626583b2385d.jpeg)

![3 [78].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652083462-4cb04efe-f246-4bed-8dfc-b368a5d790b7.jpeg?x-oss-process=image%2Fresize%2Cw_929%2Climit_0)

接下来添加样式即可

GoodsList.vue

```vue
<template>
  <div class="goods">
    <goods-item v-for="(item, index) in goods" :key="index" :goodsItem="item"></goods-item>
  </div>
</template>

<script>
  import GoodsItem from './GoodsItem'
  export default {
    name: 'Goods',
    props: {
      goods: {
        type: Array,
        default() {
          return []
        }
      }
    },
    components: {
      GoodsItem
    }
  }
</script>

<style scoped>
  .goods {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-around;
  }
</style>
```

GoodsItem.vue

```vue
<template>
  <div class="goods-item">
    <img :src="goodsItem.show.img">
    <div class="goods-info">
      <p>{{goodsItem.title}}</p>
      <span class="price">{{goodsItem.price}}</span>
      <span class="collect">{{goodsItem.cfav}}</span>
    </div>
  </div>
</template>

<script>
  export default {
    name: 'GoodsItem',
    props: {
      goodsItem: {
        type: Object,
        default() {
          return {}
        }
      }
    }
  }
</script>

<style scoped>
  .goods-item {
    padding-bottom: 40px;
    position: relative;
    width: 150px;
  }
  .goods-item img {
    width: 100%;
  }
  .goods-info {
    font-size: 12px;
    position: absolute;
    bottom: 5px;
    left: 0;
    right: 0;
    overflow: hidden;
    text-align: center;
  }
  .goods-info p {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    margin-bottom: 3px;
  }
  .goods-info .price {
    color: var(--color-high-text);
    margin-right: 20px;
  }
  .goods-info .collect {
    position: relative;
  }
  .goods-info .collect::before {
    content: '';
    position: absolute;
    left: -15px;
    top: 0;
    width: 14px;
    height: 14px;
    background: url("~assets/img/common/collect.svg") 0 0/14px 14px;
  }
</style>
```

Home.vue

```vue
<template>
  <div id="home">
    <nav-bar class="nav">
      <div slot="center">购物街</div>
    </nav-bar>
    <home-swiper :banner="banner"></home-swiper>
    <home-recommend :recommend="recommend"></home-recommend>
    <feature-view></feature-view>
    <tab-control :title="['流行', '新款', '精选']"></tab-control>
    <goods-list :goods="goods['pop'].list"></goods-list>
  </div>
</template>

<script>
  
  import HomeSwiper from './childCpns/HomeSwiper'
  import HomeRecommend from './childCpns/HomeRecommend'
  import FeatureView from './childCpns/FeatureView'
  import NavBar from 'common/navbar/NavBar'
  import TabControl from 'content/tabControl/TabControl'
  import GoodsList from 'content/goods/GoodsList'
  import { getHomeMultidata, getHomeGoods } from 'network/home'
  export default {
    name: 'Home',
    components: {    
      HomeSwiper,
      HomeRecommend,
      FeatureView,
      NavBar,
      TabControl,
      GoodsList
    },
    data() {
      return {
        banner: null,
        recommend: null,
        goods: {
          'pop': {page: 0, list: []},
          'new': {page: 0, list: []},
          'sell': {page: 0, list: []}
        }
      }    
    },
    created () {
      this.getHomeMultidata();
      this.getHomeGoods('pop');
      this.getHomeGoods('new');
      this.getHomeGoods('sell');
    },
    methods: {
      getHomeMultidata() {
        getHomeMultidata().then(res => {
          this.banner = res.data.banner.list;
          this.recommend = res.data.recommend.list;
        })
      },
      getHomeGoods(type) {
        const page = this.goods[type].page + 1;
        getHomeGoods(type, page).then(res => {
          this.goods[type].list.push(...res.data.list);
          this.goods[type].page += 1;
        })
      }
    }
  }
</script>
```

效果图

![3 [79].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652083905-65a9ab9c-df66-4bee-ac1a-c693a74c1fe2.jpeg)

## TabControl 点击切换商品

![3 [80].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652084610-47dda7d5-5e89-465f-9329-2b07f604a8a0.jpeg)

要实现点击切换商品，首先要在 TabControl 内部监听点击（已监听），但是没有把 TabControl 的点击事件传播到外面（Home.vue）去

因为 Home.vue 组件需要知道你点击了哪个 Tab（子组件向父组件传值）

![3 [81].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652084726-c594f7b9-a469-4713-9bec-0e856581045e.jpeg)

注意：

改完代码要在浏览器刷新，不要依赖热更新（热更新可能不是完全更新）

真正写代码时多注释，不然自己都看不懂

要改变 :goods="goods['pop'].list" 就不能把写死 ['pop']，所以在 data 中添加一个属性 currentType 记录当前类型，默认为  'pop'

当选中 tab 的 index 不同时，根据 index 的不同给 currentType 赋值

TabControl.vue

```vue
<template>
  <div class="tab-control">
    <div v-for="(item, index) of title" :key="index"
    @click="tabClick(index)" :class="{active: currentIndex === index}"
    class="tab-control-item">
      <span>{{item}}</span>
    </div>  
  </div>
</template>

<script>
  export default {
    name: 'TabControl',
    props: {
      title: {
        type: Array,
        default() {
          return []
        }
      }
    },
    data () {
      return {
        currentIndex: 0
      }
    },
    methods: {
      tabClick(index) {
        this.currentIndex = index
        this.$emit('tabClick', index);
      }
    }
  }
</script>

<style scoped>
  .tab-control {
    display: flex;
    text-align: center;
    height: 40px;
    line-height: 40px;
    font-size: 15px;
  }
  .tab-control-item {
    flex: 1;
  }
  .active {
    color: var(--color-tint);   
  }
  .active span {   
    border-bottom: 2px solid var(--color-tint);
    padding: 5px;
  }
</style>
```

Home.vue

```vue
<template>
  <div id="home">
    <nav-bar class="nav">
      <div slot="center">购物街</div>
    </nav-bar>
    <home-swiper :banner="banner"></home-swiper>
    <home-recommend :recommend="recommend"></home-recommend>
    <feature-view></feature-view>
    <tab-control :title="['流行', '新款', '精选']" @tabClick="tabClick"></tab-control>
    <goods-list :goods="showGoods"></goods-list>
  </div>
</template>

<script>
  
  import HomeSwiper from './childCpns/HomeSwiper'
  import HomeRecommend from './childCpns/HomeRecommend'
  import FeatureView from './childCpns/FeatureView'

  import NavBar from 'common/navbar/NavBar'
  import TabControl from 'content/tabControl/TabControl'
  import GoodsList from 'content/goods/GoodsList'

  import { getHomeMultidata, getHomeGoods } from 'network/home'

  export default {
    name: 'Home',
    components: {    
      HomeSwiper,
      HomeRecommend,
      FeatureView,
      NavBar,
      TabControl,
      GoodsList
    },
    data() {
      return {
        banner: null,
        recommend: null,
        goods: {
          'pop': {page: 0, list: []},
          'new': {page: 0, list: []},
          'sell': {page: 0, list: []}
        },
        currentType: 'pop'
      }    
    },
    computed: {
      showGoods() {
        return this.goods[this.currentType].list
      }
    },
    created () {
      this.getHomeMultidata();
      this.getHomeGoods('pop');
      this.getHomeGoods('new');
      this.getHomeGoods('sell');
    },
    methods: {
      // 事件监听
      tabClick(index) {
        switch(index) {
          case 0:
            this.currentType = 'pop'
            break
          case 1:
            this.currentType = 'new'
            break
          case 2:
            this.currentType = 'sell'
            break    
        }
      },
      // 网络请求
      getHomeMultidata() {
        getHomeMultidata().then(res => {
          this.banner = res.data.banner.list;
          this.recommend = res.data.recommend.list;
        })
      },
      getHomeGoods(type) {
        const page = this.goods[type].page + 1;
        getHomeGoods(type, page).then(res => {
           this.goods[type].list.push(...res.data.list);
           this.goods[type].page += 1;
        })
      }
    }
  }
</script>
```

属性绑定的值太长了，所以需要一个计算属性

![3 [82].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652084989-58976b9b-298f-464c-bdbe-2946b63eb49e.jpeg)

![3 [83].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656744202987-f1c355e0-266d-47ac-801c-324707c0ee7b.jpeg)

效果图

![3 [2].gif](https://cdn.nlark.com/yuque/0/2022/gif/1614731/1656660116856-c74ac26c-bb49-4fde-a522-1ead8b190fc2.gif)

## BetterScroll 的安装和使用

滚动只要超出视觉视口高度就可以滚动，

为了解决移动端滚动卡顿（滚一下，卡一下）的问题，这个原生滚动的问题在项目部署到服务器之后移动端调试时尤为明显

以前用 iScroll （几年不维护了），现在用 Better-Scroll 

[BetterScroll 2.x 中文文档](https://better-scroll.github.io/docs/zh-CN/)

![3 [84].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652085590-39f7ba8d-3907-4b21-82e2-f1026e01281e.jpeg)

找源码，找到最新的 Tag，然后找到 dist 文件夹，下载未压缩版

![3 [85].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652086060-81d98693-a0ea-4d0d-9548-9584e40171ea.jpeg)

![3 [86].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652086191-f4d4a7e5-4a07-4085-b2ad-2bd35eb9f16a.jpeg)

esm（ESModule） 表示要使用模块化方式导入

原生局部滚动方式（移动端非常卡顿）

![3 [87].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652086343-1e5dae2b-1969-4d8a-ab16-acbd09922db9.jpeg)

![3 [88].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652086686-9bc6100a-a573-45f8-82de-141a855966f0.jpeg)

![3 [89].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656652086765-fb57705c-bcab-4836-afbf-dd5e50581628.jpeg)

在项目中使用时，还是不直接引入第三方库（为了可维护），所以先要进行封装

BetterScroll 的使用

```shell
npm install better-scroll --save
```

绿色部分为 wrapper，也就是父容器，它会有固定的高度。黄色部分为 content，它是父容器的第一个子元素，它的高度会随着内容的大小而撑高。

强制结构：content 由一个标签组成，也就是说wrapper里面必须只有一个包裹多个元素的元素，即一个 wrapper 包裹 一个有多个元素的 content

实现局部滚动：wrapper 必须设置一个高度，content 通常会设置 overflow: hidden

<img src="https://cdn.nlark.com/yuque/0/2022/png/1614731/1656652125858-f4f5cf75-0c7c-4bc3-ba26-55603fff90c3.png" alt="schematic.png" style="zoom: 25%;" />

created() 生命周期函数：组件创建完之后调用，不会挂载 tamplate 模板，所以不能在 created() 生命周期函数中使用 new Bscroll()

所以需要在 mounted() 生命周期函数使用 new Bscroll()，才能获取需要滚动的 wrapper 元素

```shell
import BScroll from 'better-scroll'
```

![3 [90].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663452822-eef54a90-adeb-4d57-a0d8-f6dc6f19971d.jpeg)

![3 [91].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663452875-4aebeeb0-83aa-4a00-82b3-4470208f774e.jpeg)

## BetterScroll 的基本使用解析

node_modules 中找到 BetterScroll 的源码

![3 [92].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663452958-af9dd52f-49f6-4dab-bf8c-ced761a6d575.jpeg)

在项目中应用 BetterScroll，实时监听滚动到的位置来实现 TabControl 吸顶效果，

显示 /隐藏回到顶部按钮（一旦超过某个区域就显示，一旦小于某个区域就隐藏）

![3 [93].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663453049-f969555a-3a15-404d-ab33-ba82bb1d9235.jpeg)

1、默认情况下， BScroll 不可以实时监听滚动位置，如果想监听必须传一个参数 probeType

**probeType参数 表示要不要实时侦测滚动的位置**

probeType: 0 （不侦测）和 1（屏幕滑动超过一定时间后才侦测） 都表示不实时侦测滚动的位置

probeType: 2 表示在屏幕滑动的过程实时侦测滚动的位置

probeType: 3 表示不仅在屏幕滑动的过程中，而且在手指离开的惯性滚动回弹动画（弹簧效果）运行过程中实时侦测滚动的位置

![3 [94].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663452938-ac7c6bd5-0ed3-4a8c-9ae9-ffd517c23ad5.jpeg)

![3 [95].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663453585-a625816d-b34d-4b95-b596-04bd6295a845.jpeg)

监听scroll事件 

```js
.on('scroll', function() {})
```

2、BScroll 管理的元素里面有 button 按钮元素时是监听不到的，因为 BetterScroll 默认会阻止浏览器的原生 click 事件。

所以要设置 click: true。

3、还有一个：

当列表内容滚动到最底部的时候需要实现上拉加载更多，需要在滚动到底部时马上回调一个事件请求下一页数据，然后把数据追加到 list 数组里，最后将所有数据一起展示

所以还需要使用 BetterScroll 的 上拉加载更多的功能

**如何监听已经滚动到底部呢？**

**pullUpLoad** **当设置为 true 或者是一个 Object 的时候，可以开启上拉加载**

当配置项为一个 Object 时，有如下属性：

threshold 决定开始加载的时机，类型为 Number，默认为 0

![3 [96].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663454165-33586755-4bcb-4dfb-96f7-04a0a0613076.jpeg)

pullingUp 事件 

pullUpLoad 上拉加载更多后触发，当距离滚动到底部小于 threshold 值时，触发一次 pullingUp 事件，一般用于向后端请求数据。

![3 [97].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663454307-466d11da-b5ad-46b1-b67d-a24d62193b0f.jpeg)

pullingUp 事件执行完成后， 必须调用bscroll.finishpullUp() 

bscroll 才知道这次的上拉加载更多做完了，使用定时器控制每次上拉加载更多请求的间隔

![3 [98].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663454455-13791e7e-b39d-4e8b-b97b-deb2c1354d90.jpeg)

## Better-Scroll 在Vue项目中使用基本过程

![3 [99].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663454714-45b00dca-718e-43a9-bc44-40e7c5338c6d.jpeg)

首先把 better-scroll 封装到 components/common 里

1、设置滚动的高度是由开发者自己决定的

2、使用 document.querySelelctor('.wrapper') 时，获取的是一个 class="wrapper" 的元素，当很多组件都有 class="wrapper" 时，很容易获取出错，导致 better-scroll 失效

   所以为组件添加 ref="别名" 更为准确，

   ref 特性 一般绑定到组件上，那么通过 this.$ref.别名 获取一个组件对象

   ref 特性 如果是绑定在普通的元素中，那么通过 this.$refs.别名 获取到的是一个元素对象

3、因为 `<style scoped>`，即使 Home.vue 的 `<scroll class="content">` 同名，样式也不会覆盖到其他组件

**第一种方案 使用 calc 与** **margin-top** **计算滚动区域高度（即 `<scroll>` 的整体高度）**

NavBar 高度 44px + TabBar高度 49px = 93px

![3 [100].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663454886-9f4f3d18-e223-493a-94b3-3663264fafb6.jpeg)

**第二种方案 height: 100vh 结合 position:absolute**

Scroll.vue

```vue
<template>
  <div class="wrapper" ref="wrapper">
    <div class="content">
      <slot></slot>
    </div>
  </div>
</template>

<script>
  import Bscroll from 'better-scroll'
  export default {
    name: 'Scroll',
    data () {
      return {
      }
    },
    mounted() {
      this.scroll = new Bscroll(this.$refs.wrapper)
    }
  }
</script>

<style scoped>
</style>
```

Home.vue

```vue
<template>
  <div id="home">
    <nav-bar class="nav">
      <div slot="center">购物街</div>
    </nav-bar>
    <scroll class="content">
      <home-swiper :banner="banner"></home-swiper>
      <home-recommend :recommend="recommend"></home-recommend>
      <feature-view></feature-view>
      <tab-control :title="['流行', '新款', '精选']" @tabClick="tabClick"></tab-control>
      <goods-list :goods="showGoods"></goods-list>
    </scroll>
  </div>
</template>

<script>
  
  import HomeSwiper from './childCpns/HomeSwiper'
  import HomeRecommend from './childCpns/HomeRecommend'
  import FeatureView from './childCpns/FeatureView'

  import NavBar from 'common/navbar/NavBar'
  import TabControl from 'content/tabControl/TabControl'
  import GoodsList from 'content/goods/GoodsList'
  import Scroll from 'common/scroll/Scroll'

  import { getHomeMultidata, getHomeGoods } from 'network/home'

  export default {
    name: 'Home',
    components: {    
      HomeSwiper,
      HomeRecommend,
      FeatureView,
      NavBar,
      TabControl,
      GoodsList,
      Scroll
    },
    data() {
      return {
        banner: null,
        recommend: null,
        goods: {
          'pop': {page: 0, list: []},
          'new': {page: 0, list: []},
          'sell': {page: 0, list: []}
        },
        currentType: 'pop'
      }    
    },
    computed: {
      showGoods() {
        return this.goods[this.currentType].list
      }
    },
    created () {
      this.getHomeMultidata();
      this.getHomeGoods('pop');
      this.getHomeGoods('new');
      this.getHomeGoods('sell');
    },
    methods: {
      // 事件监听
      tabClick(index) {
        switch(index) {
          case 0:
            this.currentType = 'pop'
            break
          case 1:
            this.currentType = 'new'
            break
          case 2:
            this.currentType = 'sell'
            break    
        }
      },
      // 网络请求
      getHomeMultidata() {
        getHomeMultidata().then(res => {
          this.banner = res.data.banner.list;
          this.recommend = res.data.recommend.list;
        })
      },
      getHomeGoods(type) {
        const page = this.goods[type].page + 1;
        getHomeGoods(type, page).then(res => {
           this.goods[type].list.push(...res.data.list);
           this.goods[type].page += 1;
        })
      }
    }
  }
</script>

<style scoped>
  #home {
    height: 100vh;
  }
  .nav {
    background-color: var(--color-tint);
    color: #fff;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
  }
  .content {
    position: absolute;
    top: 44px;
    bottom: 49px;
    left: 0;
    right: 0;   
  }
</style>
```

![3 [101].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663455511-829180c7-0131-47af-935b-3cdbb8aa8004.jpeg)

## BackTop 组件的封装

实现滚动到一定位置  显示/隐藏 回到顶部按钮的功能

![3 [102].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663455568-7f6e71d5-3111-4317-a644-f63e62e3b018.jpeg)

因为不是原生的滚动了， better-scroll 在帮忙做滚动，但是系统无法检测滚动的位置，

所以吸顶的样式效果不起作用了，之后需要重新做了

![3 [103].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663456042-1f005219-621c-414c-adb0-b25664aa4b42.jpeg)

## 回到顶部按钮思路

首先，不管滚到哪个位置先把回到按钮显示出来再说

之后，再决定它的显示 /隐藏

因为不仅只有首页有这个组件，其他页面（比如下方详情页）也有这个组件，所以需要封装到 components/content 里

![3 [104].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663456009-f920bfc5-3cea-4483-98d4-9c9f5234f570.jpeg)

这个按钮里面其实就是一张小图片

back-top 组件不需要跟着 scroll 一起滚动，所以写在 scroll 下面

另外，back-top 组件的位置都一样，设置相同的位置即可

添加点击事件监听，实现回到顶部，但是回到顶部意味着下图框选部分回到顶部，

现在的滚动都依赖 Bscroll，所以点击时需要调用 Bscroll 的 scrollTo(x, y) 

![3 [105].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663456038-07ad303b-a813-47bd-947d-23765faaa293.jpeg)

现在要在 back-top 组件中操作 scroll 组件，但是不使用 $emit （因为比较啰嗦，麻烦）

![3 [106].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663456568-c00b08d6-5635-4968-aceb-9fd1d1250ad9.jpeg)

要在组件上进行点击，组件上是不允许直接 @click 监听点击的，所以需要使用 @click.native 才可以监听原生点击事件

监听组件原生事件（不仅仅是 click 事件）时必须添加 .native 修饰符，才能进行监听

通过 this.$refs 可以直接访问该组件的数据和方法

出现问题： 

调用 this.scroll.scrollTo(x, y, time) 时无效

原因：#home 多了padding-top: 44px，.wrapper 即 `<scroll>`组件的高度不够，而且 position: fixed 没有写在 `<back-top> `组件上

BackUp.vue

```vue
<template>
  <div class="back-up">
    <img src="~assets/img/common/top.png" alt="回到顶部">
  </div>
</template>

<script>
  export default {
    name: 'BackUp',
    data () {
      return {
      }
    }
  }
</script>

<style scoped>
  .back-up img {
    width: 43px;
    height: 43px;
  }
</style>

Scroll.vue

<template>
  <div class="wrapper" ref="wrapper">
    <div class="content">
      <slot></slot>
    </div>
  </div>
</template>

<script>
  import Bscroll from 'better-scroll'
  export default {
    name: 'Scroll',
    data () {
      return {
        scroll: {}
      }
    },
    methods: {
      scrollTo(x, y, time=500) {
        this.scroll.scrollTo(x, y, time)
      }
    },
    mounted() {
      this.scroll = new Bscroll(this.$refs.wrapper);
    }
  }
</script>

<style scoped>
</style>
```

Home.vue

```vue
<template>
  <div id="home">
    <nav-bar class="nav">
      <div slot="center">购物街</div>
    </nav-bar>
    <scroll class="content" ref="scroll">
      <home-swiper :banner="banner"></home-swiper>
      <home-recommend :recommend="recommend"></home-recommend>
      <feature-view></feature-view>
      <tab-control :title="['流行', '新款', '精选']" @tabClick="tabClick"></tab-control>
      <goods-list :goods="showGoods"></goods-list>
    </scroll>
    <back-up @click.native="backClick" class="back-up"></back-up>
  </div>
</template>

<script>
  
  import HomeSwiper from './childCpns/HomeSwiper'
  import HomeRecommend from './childCpns/HomeRecommend'
  import FeatureView from './childCpns/FeatureView'

  import NavBar from 'common/navbar/NavBar'
  import TabControl from 'content/tabControl/TabControl'
  import GoodsList from 'content/goods/GoodsList'
  import Scroll from 'common/scroll/Scroll'
  import BackUp from 'content/backUp/BackUp'

  import { getHomeMultidata, getHomeGoods } from 'network/home'
  export default {
    name: 'Home',
    components: {    
      HomeSwiper,
      HomeRecommend,
      FeatureView,
      NavBar,
      TabControl,
      GoodsList,
      Scroll,
      BackUp
    },
    data() {
      return {
        banner: null,
        recommend: null,
        goods: {
          'pop': {page: 0, list: []},
          'new': {page: 0, list: []},
          'sell': {page: 0, list: []}
        },
        currentType: 'pop'
      }    
    },
    computed: {
      showGoods() {
        return this.goods[this.currentType].list
      }
    },
    created () {
      this.getHomeMultidata();
      this.getHomeGoods('pop');
      this.getHomeGoods('new');
      this.getHomeGoods('sell');
    },
    methods: {
      // 事件监听
      tabClick(index) {
        switch(index) {
          case 0:
            this.currentType = 'pop'
            break
          case 1:
            this.currentType = 'new'
            break
          case 2:
            this.currentType = 'sell'
            break    
        }
      },
      backClick() {
        this.$refs.scroll.scrollTo(0, 0, 300);
      },
      // 网络请求
      getHomeMultidata() {
        getHomeMultidata().then(res => {
          this.banner = res.data.banner.list;
          this.recommend = res.data.recommend.list;
        })
      },
      getHomeGoods(type) {
        const page = this.goods[type].page + 1;
        getHomeGoods(type, page).then(res => {
           this.goods[type].list.push(...res.data.list);
           this.goods[type].page += 1;
        })
      }
    }
  }
</script>

<style scoped>
  #home {
    height: 100vh;
  }
  .nav {
    background-color: var(--color-tint);
    color: #fff;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
  }
  .content {
    position: absolute;
    top: 44px;
    bottom: 49px;
    left: 0;
    right: 0;   
  }
  .back-up {
    position: fixed;
    right: 8px;
    bottom: 55px;  
  }
</style>
```

效果图

![3 [3].gif](https://cdn.nlark.com/yuque/0/2022/gif/1614731/1656660119284-96a7a854-6986-4743-90f7-4f8354d59c99.gif)

## 回到顶部按钮的 显示/隐藏

在 Better-Scroll 管理的元素中需要注意：

![3 [107].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663456643-e0fb57c7-270d-493e-8936-ca01daf92d72.jpeg)

Scroll.vue

```js
mounted() {
  this.scroll = new Bscroll(this.$refs.wrapper, {
    click:true
  });
}
```

在 Better-Scroll 管理的元素中，除了button 元素不需要，其他元素需要监听点击时添加 click:true

计算机中没有黑魔法，一般出现问题首先考虑的是代码有没有问题，使用框架大部分情况不会出现问题。

做到这里，其实还有一个图片相关的Bug没解决：

![3 [4].gif](https://cdn.nlark.com/yuque/0/2022/gif/1614731/1656660117709-bd5eedd1-967f-42c3-ba00-2ab0a8542ce9.gif)

现在，想先完成回到顶部按钮的 显示/隐藏，必然要监听滚动位置滚动了多少，达到临界值时显示，未达到临界值时默认隐藏

但是，注意不能在 Scroll.vue 组件中写监听事件，

因为它是与项目无关的独立的公共组件，所以不能默认监听滚动，而是由开发者自己决定

Scroll.vue

![3 [108].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663456741-d49ae121-29f6-422e-805a-20c55fdb421c.jpeg)

而设置 probeType: 3 时会实时回调下面的 scroll事件，影响性能，所以 probeType 不能写死，像下图这样的话就不会很影响性能了

![3 [109].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663457039-a4186e79-d6cb-481e-8b77-b526af242c06.jpeg)

prop 是驼峰命名时， : 属性绑定的特性需要使用 - 短横线分隔命名，当传入 probe-type 时，才会实时监听

![3 [110].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663457368-6c936ea0-1b8f-493b-a143-e163962ac3be.jpeg)

当其他组件需要时，就要把 position 位置信息给它，所以要通过 $emit 把传 position（x值 和 y值） 出去

Scroll.vue

![3 [111].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663457665-0140c8b8-3d27-4c02-b066-9ed96bf0a446.jpeg)

![3 [112].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663458116-79ed26da-91f2-4772-898a-76d5038f3d13.jpeg)

问题：

1、probeType 应该写在 props 里而不是 data 里。

2、$emit 发送事件时使用了 this.scroll.$emit('scroll', position) 而不是 this.$emit('scroll', position)，this 必须指向组件，让组件调用

也就是说必须是组件使用 this.$emit('scroll', position)，在对应组件中接收 @scroll="contentScroll"，然后调用父组件的 contentScroll 方法即可取得 position的值

Scroll.vue

```vue
<template>
  <div class="wrapper" ref="wrapper">
    <div class="content">
      <slot></slot>
    </div>
  </div>
</template>

<script>
  import Bscroll from 'better-scroll'
  export default {
    name: 'Scroll',
    props: {
      probeType: {
        type: Number,
        default: 0
      }
    },
    data () {
      return {
        scroll: {}        
      }
    },
    methods: {
      scrollTo(x, y, time=500) {
        this.scroll.scrollTo(x, y, time)
      }
    },
    mounted() {
      this.scroll = new Bscroll(this.$refs.wrapper, {
        click:true,
        probeType: this.probeType
      });
      this.scroll.on('scroll', position => {
        this.$emit('scroll', position)
      })
    }
  }
</script>

<style scoped>
</style>
```

Home.vue

```vue
<template>
  <div id="home">
    <nav-bar class="nav">
      <div slot="center">购物街</div>
    </nav-bar>
    <scroll class="content" ref="scroll" :probe-type="3" @scroll="contentScroll">
      <home-swiper :banner="banner"></home-swiper>
      <home-recommend :recommend="recommend"></home-recommend>
      <feature-view></feature-view>
      <tab-control :title="['流行', '新款', '精选']" @tabClick="tabClick"></tab-control>
      <goods-list :goods="showGoods"></goods-list>
    </scroll>
    <back-up @click.native="backClick" class="back-up" v-show="isShowBackUp"></back-up>
  </div>
</template>

<script>
  
  import HomeSwiper from './childCpns/HomeSwiper'
  import HomeRecommend from './childCpns/HomeRecommend'
  import FeatureView from './childCpns/FeatureView'

  import NavBar from 'common/navbar/NavBar'
  import TabControl from 'content/tabControl/TabControl'
  import GoodsList from 'content/goods/GoodsList'
  import Scroll from 'common/scroll/Scroll'
  import BackUp from 'content/backUp/BackUp'

  import { getHomeMultidata, getHomeGoods } from 'network/home'

  export default {
    name: 'Home',
    components: {    
      HomeSwiper,
      HomeRecommend,
      FeatureView,
      NavBar,
      TabControl,
      GoodsList,
      Scroll,
      BackUp
    },
    data() {
      return {
        banner: null,
        recommend: null,
        goods: {
          'pop': {page: 0, list: []},
          'new': {page: 0, list: []},
          'sell': {page: 0, list: []}
        },
        currentType: 'pop',
        isShowBackUp: false
      }    
    },
    computed: {
      showGoods() {
        return this.goods[this.currentType].list
      }
    },
    created () {
      this.getHomeMultidata();
      this.getHomeGoods('pop');
      this.getHomeGoods('new');
      this.getHomeGoods('sell');
    },
    methods: {
      // 事件监听
      tabClick(index) {
        switch(index) {
          case 0:
            this.currentType = 'pop'
            break
          case 1:
            this.currentType = 'new'
            break
          case 2:
            this.currentType = 'sell'
            break    
        }
      },
      backClick() {
        this.$refs.scroll.scrollTo(0, 0, 300);
      },
      contentScroll(position) {
        this.isShowBackUp = (-position.y) > 1000
      },
      // 网络请求
      getHomeMultidata() {
        getHomeMultidata().then(res => {
          this.banner = res.data.banner.list;
          this.recommend = res.data.recommend.list;
        })
      },
      getHomeGoods(type) {
        const page = this.goods[type].page + 1;
        getHomeGoods(type, page).then(res => {
           this.goods[type].list.push(...res.data.list);
           this.goods[type].page += 1;
        })
      }
    }
  }
</script>

<style scoped>
  #home {
    height: 100vh;
  }
  .nav {
    background-color: var(--color-tint);
    color: #fff;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
  }
  .content {
    position: absolute;
    top: 44px;
    bottom: 49px;
    left: 0;
    right: 0;   
  }
  .back-up {
    position: fixed;
    right: 8px;
    bottom: 55px;  
  }
</style>
```

效果图

![3 [5].gif](https://cdn.nlark.com/yuque/0/2022/gif/1614731/1656660120117-61fb4fab-dc0c-4749-861a-40a73961226f.gif)

## 完成上拉加载更多

1、要做上拉加载更多，首先要监听上拉加载更多事件，但上拉加载更多不一定每个 scroll 组件都需要，比如 我的 页面就不需要上拉加载更多，

所以不能把 pullUpLoad 的值 写死，最好把 pullUpLoad 作为 props 的一个属性，需要监听 pullingUp 上拉事件时只需要在 scroll 组件上传值即可

```js
:pull-up-load="true"
```

![3 [113].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663458190-21ac92a6-fd60-4f44-9873-70832215e289.jpeg)


2、为了继续加载更多，必须使用 better-scroll 的 finishPullUp()，否则的话只能加载一页数据，结果只能有两页的数据。

如果上拉加载更多时，一次性加载了很多数据（能不能滚都会这样），

可能是 better-scroll 滚动的问题（就是上述的 Bug，什么时候会滚动，什么时候不滚动的问题）

3、better-scroll 的 bug：不会计算图片的高度，

因为程序中图片都是异步加载的，而 better-scroll 认为 wrapper 下方的箭头才是可滚动区域高度（未加载更多图片时），

当上拉加载更多时，图片撑开可滚动区域高度，可滚动区域高度变高了，但是 better-scroll 不会重新计算

当后来图片加载出来的时候，better-scroll 提前认为 可滚动区域高度应该是 2000（2000 是假想的值），所以就不会再让用户滚动了，

所以等图片异步加载完之后要进行一次刷新（不能把可滚动区域高度写死，因为不知道要滚动多少才够）

**正常的可滚动区域高度**

![3 [114].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663458470-9cce1c7a-1253-4e91-b070-b24daf60b551.jpeg)

**出 Bug 时的可滚动区域高度**

![3 [115].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663458984-ef919299-cf4d-4f1e-8f28-88be6db668b7.jpeg)

为什么首页有时有Bug，有时没有Bug呢？

这由图片加载的速度决定，

如果图片加载速度很快，在 better-scroll 计算之前，图片已经有了，这时 better-scroll 计算出来的高度就是正确的，否则就会出现 Bug

但是这无法保证图片什么时候会加载出来，所以当图片加载出来以后必须自己手动调用一下 better-scroll  的 refresh()，

先让图片加载完，再让 better-scroll 刷新一下，重新计算一下可滚动区域高度

![3 [116].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663459248-896cbccd-d554-47ab-9d09-cc7e904a58ba.jpeg)

![3 [6].gif](https://cdn.nlark.com/yuque/0/2022/gif/1614731/1656660119836-0a0dc00f-18db-4805-bc86-c45b46743fe3.gif)

![3 [117].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663459397-00ee6fc9-484b-43b1-a5fa-e030923180c7.jpeg)

Scroll.vue

```vue
<template>
  <div class="wrapper" ref="wrapper">
    <div class="content">
      <slot></slot>
    </div>
  </div>
</template>

<script>
  import Bscroll from 'better-scroll'
  export default {
    name: 'Scroll',
    props: {
      probeType: {
        type: Number,
        default: 0
      },
      pullUpLoad: {
        type: Boolean,
        default: false
      }
    },
    data () {
      return {
        scroll: {}        
      }
    },
    methods: {
      scrollTo(x, y, time=500) {
        this.scroll.scrollTo(x, y, time)
      },
      finishPullUp() {
        this.scroll.finishPullUp()
      },
      refresh() {
        this.scroll.refresh()
      }
    },
    mounted() {
      this.scroll = new Bscroll(this.$refs.wrapper, {
        click:true,
        probeType: this.probeType,
        pullUpLoad: this.pullUpLoad
      });
      this.scroll.on('scroll', position => {
        this.$emit('scroll', position)
      });
      this.scroll.on('pullingUp', () => {
        this.$emit('pullingUp')
      })
    }
  }
</script>

<style scoped>
</style>
```

Home.vue

```vue
<template>
  <div id="home">
    <nav-bar class="nav">
      <div slot="center">购物街</div>
    </nav-bar>
    <scroll class="content" ref="scroll"
    :probe-type="3"
    :pull-up-load="true"
    @scroll="contentScroll"
    @pullingUp="loadMore">
      <home-swiper :banner="banner"></home-swiper>
      <home-recommend :recommend="recommend"></home-recommend>
      <feature-view></feature-view>
      <tab-control :title="['流行', '新款', '精选']" @tabClick="tabClick"></tab-control>
      <goods-list :goods="showGoods"></goods-list>
    </scroll>
    <back-up @click.native="backClick" class="back-up" v-show="isShowBackUp"></back-up>
  </div>
</template>

<script>
  
  import HomeSwiper from './childCpns/HomeSwiper'
  import HomeRecommend from './childCpns/HomeRecommend'
  import FeatureView from './childCpns/FeatureView'

  import NavBar from 'common/navbar/NavBar'
  import TabControl from 'content/tabControl/TabControl'
  import GoodsList from 'content/goods/GoodsList'
  import Scroll from 'common/scroll/Scroll'
  import BackUp from 'content/backUp/BackUp'

  import { getHomeMultidata, getHomeGoods } from 'network/home'

  export default {
    name: 'Home',
    components: {    
      HomeSwiper,
      HomeRecommend,
      FeatureView,
      NavBar,
      TabControl,
      GoodsList,
      Scroll,
      BackUp
    },
    data() {
      return {
        banner: null,
        recommend: null,
        goods: {
          'pop': {page: 0, list: []},
          'new': {page: 0, list: []},
          'sell': {page: 0, list: []}
        },
        currentType: 'pop',
        isShowBackUp: false
      }    
    },
    computed: {
      showGoods() {
        return this.goods[this.currentType].list
      }
    },
    created () {
      this.getHomeMultidata();
      this.getHomeGoods('pop');
      this.getHomeGoods('new');
      this.getHomeGoods('sell');
    },
    methods: {
      // 事件监听
      tabClick(index) {
        switch(index) {
          case 0:
            this.currentType = 'pop';
            break;
          case 1:
            this.currentType = 'new';
            break;
          case 2:
            this.currentType = 'sell';
            break;   
        }
      },
      backClick() {
        this.$refs.scroll.scrollTo(0, 0, 300);
      },
      contentScroll(position) {
        this.isShowBackUp = (-position.y) > 1000;
      },
      loadMore() {
        this.getHomeGoods(this.currentType);
        this.$refs.scroll.refresh();
      },
      // 网络请求
      getHomeMultidata() {
        getHomeMultidata().then(res => {
          this.banner = res.data.banner.list;
          this.recommend = res.data.recommend.list;
        })
      },
      getHomeGoods(type) {
        const page = this.goods[type].page + 1;
        getHomeGoods(type, page).then(res => {
           this.goods[type].list.push(...res.data.list);
           this.goods[type].page += 1;
           this.$refs.scroll.finishPullUp();
        });        
      }
    }
  }
</script>
```

## 滚动区域的 Bug 分析与解决

Bug：有时候可以滚到底部，有时滚不到底部

![3 [118].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663459686-385eee31-69b7-4e67-821c-157837668cdf.jpeg)

![3 [119].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663460208-d3a8aec7-2e9e-4f1f-b0de-d259c516ca54.jpeg)

![3 [120].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663460333-8e34a4e1-157f-49a1-bc14-f938e79b555b.jpeg)

第一种方案（太麻烦）：

GoodListItem $emit => GoodsList $emit => Home

第二种方案：

利用 Vuex 作为中间的通信

图片一加载完，GoodListItem.vue 就使用 this.$store 改变 Vuex 的属性，

Home.vue 引用 Vuex 的属性并且实时监听 Vuex 的属性的改变，

一旦 Vuex 的属性发生变化，就执行 this.$refs.scroll.scroll.refresh()

![3 [121].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663460495-7bf33147-4b7b-4f2d-a7c8-b398f89f8912.jpeg)

第三种方案：

事件总线 EventBus，它是管理事件的，不像 Vuex，Vuex是管理状态的

![3 [122].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663461064-f18477e9-2f6b-4ce0-afbc-bed1f578662c.jpeg)

![3 [123].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663461365-5c4d18fb-931c-4bb5-a8e6-b11dac0b91c8.jpeg)

等组件创建完就开始监听了，因为图片的 onload 是异步加载的，

但是注意：不能在 created 生命周期函数中获取 this.$refs.scroll 这个 dom 元素

简单理解（详情见 Vue 入门）

created 生命周期函数： data 和 methods 初始化好了，template还没有初始化好。

mounted 生命周期函数：data 、methods 和 template 都初始化好了。

main.js

```js
import Vue from 'vue'
import App from './App.vue'
import router from './router'
import store from './store'
Vue.config.devtools = true;
Vue.config.productionTip = false

Vue.prototype.$bus = new Vue()

new Vue({
  router,
  store,
  render: h => h(App)
}).$mount('#app')
```

GoodsItem.vue

```vue
<template>
  <div class="goods-item">
    <img :src="goodsItem.show.img" @load="imgLoad">
    <div class="goods-info">
      <p>{{goodsItem.title}}</p>
      <span class="price">{{goodsItem.price}}</span>
      <span class="collect">{{goodsItem.cfav}}</span>
    </div>
  </div>
</template>

<script>
  export default {
    name: 'GoodsItem',
    props: {
      goodsItem: {
        type: Object,
        default() {
          return {}
        }
      }
    },
    methods: {
      imgLoad() {
        this.$bus.$emit('itemImgLoad')
      }
    }
  }
</script>
```

Home.vue

```vue
<template>
  <div id="home">
    <nav-bar class="nav">
      <div slot="center">购物街</div>
    </nav-bar>
    <scroll class="content" ref="scroll"
    :probe-type="3"
    :pull-up-load="true"
    @scroll="contentScroll"
    @pullingUp="loadMore">
      <home-swiper :banner="banner"></home-swiper>
      <home-recommend :recommend="recommend"></home-recommend>
      <feature-view></feature-view>
      <tab-control :title="['流行', '新款', '精选']" @tabClick="tabClick"></tab-control>
      <goods-list :goods="showGoods"></goods-list>
    </scroll>
    <back-up @click.native="backClick" class="back-up" v-show="isShowBackUp"></back-up>
  </div>
</template>
<script>
  
  import HomeSwiper from './childCpns/HomeSwiper'
  import HomeRecommend from './childCpns/HomeRecommend'
  import FeatureView from './childCpns/FeatureView'

  import NavBar from 'common/navbar/NavBar'
  import TabControl from 'content/tabControl/TabControl'
  import GoodsList from 'content/goods/GoodsList'
  import Scroll from 'common/scroll/Scroll'
  import BackUp from 'content/backUp/BackUp'

  import { getHomeMultidata, getHomeGoods } from 'network/home'

  export default {
    name: 'Home',
    components: {    
      HomeSwiper,
      HomeRecommend,
      FeatureView,
      NavBar,
      TabControl,
      GoodsList,
      Scroll,
      BackUp
    },
    data() {
      return {
        banner: null,
        recommend: null,
        goods: {
          'pop': {page: 0, list: []},
          'new': {page: 0, list: []},
          'sell': {page: 0, list: []}
        },
        currentType: 'pop',
        isShowBackUp: false
      }    
    },
    computed: {
      showGoods() {
        return this.goods[this.currentType].list
      }
    },
    created() {
      this.getHomeMultidata();
      this.getHomeGoods('pop');
      this.getHomeGoods('new');
      this.getHomeGoods('sell');
    },
    mounted() {
      this.$bus.$on('itemImgLoad', () => this.$refs.scroll.refresh())
    },
    methods: {
      // 事件监听
      tabClick(index) {
        switch(index) {
          case 0:
            this.currentType = 'pop';
            break;
          case 1:
            this.currentType = 'new';
            break;
          case 2:
            this.currentType = 'sell';
            break;   
        }
      },
      backClick() {
        this.$refs.scroll.scrollTo(0, 0, 300);
      },
      contentScroll(position) {
        this.isShowBackUp = (-position.y) > 1000;
      },
      loadMore() {
        this.getHomeGoods(this.currentType);
        this.$refs.scroll.refresh();
      },
      // 网络请求
      getHomeMultidata() {
        getHomeMultidata().then(res => {
          this.banner = res.data.banner.list;
          this.recommend = res.data.recommend.list;
        })
      },
      getHomeGoods(type) {
        const page = this.goods[type].page + 1;
        getHomeGoods(type, page).then(res => {
           this.goods[type].list.push(...res.data.list);
           this.goods[type].page += 1;
           this.$refs.scroll.finishPullUp();
        });        
      }
    }
  }
</script>
```

效果图

![3 [7].gif](https://cdn.nlark.com/yuque/0/2022/gif/1614731/1656660124350-ef8a4c38-4989-42fc-ba34-4fb754e5614a.gif)

## refresh 函数找不到的 bug 处理

因为图片加载得太快，scroll.vue 的 mounted 生命周期函数的 new Bscroll() 还没有初始化，

this.scroll 为 undefined，调用 undefined.refresh() 造成错误

![3 [124].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663461800-873dcae9-ca65-485e-ab58-4b5888394fb5.jpeg)

逻辑与 前面为 false 后面的都不执行，用于判断是否有值

当 this.scroll 初始化有值之后再执行后面的方法

![3 [125].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663461887-7e9bee02-78de-4f58-9827-0695f479c289.jpeg)

第二：不要在 created 生命周期函数中 获取 this.$refs.scroll

## 刷新频繁的防抖函数处理

```js
this.$bus.$on('itemImgLoad', () => this.$refs.scroll.refresh())
```

refresh() 会调用得非常频繁，但是比如说我们希望一秒内多次调用的话就只调用一次就可以了，

如果下一秒还有调用就要等一下才可以继续调用

常见的防抖应用：

在搜索框中输入一个字母就在下拉框中显示结果，持续向服务器发送请求，

这种情况下用户输入速度非常快的话，对服务器压力很大，服务器处理数据太多次，而用户只是想要一个单词的结果而已

所以当用户输入 yifu 时就发送四次请求是没有必要的，要进行防抖操作

常见的防抖应用：

在搜索框中输入一个字母就在下拉框中显示结果，持续向服务器发送请求，

这种情况下用户输入速度非常快的话，对服务器压力很大，服务器处理数据太多次，而用户只是想要一个单词的结果而已

所以当用户输入 yifu 时就发送四次请求是没有必要的，要进行防抖操作

![3 [126].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663462072-04a337c9-5546-43eb-ba12-0d6562e91093.jpeg)

防抖：

当用户输入 y 时，先不发送请求而是等待 500ms，看用户会不会继续输入，

如果继续输入就把上次的请求取消掉，

如果输入完了，等待 500ms后没有继续输入，再把 yifu 整体发送给服务器，让服务器返回相关结果，

只在最后发送一次请求，这就防止了单位时间内连续向服务器发送请求

如何进行防抖操作：

封装一个函数，让执行 this.$refs.scroll.refresh() 函数前搞一个定时器，

先在定时器里等一会，不要进行下一步操作，等单位时间内没有进行这个操作时才执行

必须使用 timer 记录有没有定时器

```js
debounce(func, delay) {
  let timer = null;
  return function(...args) {
    if(timer) clearTimeout(timer);
    timer = setTimeout(() => {
      func.apply(this, args);
    }, delay)
  }
}
```

```js
const refresh = this.debounce(this.$refs.scroll.refresh, 50);
```

![3 [127].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663462041-96ae687e-6e55-4722-bb1e-2b50aacf1cd3.jpeg)

1、第一次 

```js
this.$bus.$on('itemImgLoad', refresh)
```

执行 refresh 的时候 timer 为 null，所以不执行下面这行

```js
if (timer) clearTimeout(timer)
```

2、然后先不执行 refresh ，而是延迟 delay ms ，但是在延迟 delay ms 的过程中，

```js
this.$bus.$on('itemImgLoad', refresh)
```

又会调用一次 refresh，所以第二次执行 refresh

timer 不为 null，执行

```js
clearTimeout(timer)
```

清空了上一次的定时器也就是清空了

```js
timer = setTimeOut(() => func.apply(this, args), delay)
```

然后又来这里等待

```js
timer = setTimeOut(() => func.apply(this, args), delay)
```

3、以此类推，等到最后一次（如第30次）时，会取消掉第 29 次的 refresh，然后等到延迟时间之后才会执行一次 refresh

在 refresh() 中打印即可测试效果

![3 [128].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663462708-644e6107-f998-43ee-9aab-a35d05aba44a.jpeg)

Home.vue

```vue
<template>
  <div id="home">
    <nav-bar class="nav">
      <div slot="center">购物街</div>
    </nav-bar>
    <scroll class="content" ref="scroll"
    :probe-type="3"
    :pull-up-load="true"
    @scroll="contentScroll"
    @pullingUp="loadMore">
      <home-swiper :banner="banner"></home-swiper>
      <home-recommend :recommend="recommend"></home-recommend>
      <feature-view></feature-view>
      <tab-control :title="['流行', '新款', '精选']" @tabClick="tabClick"></tab-control>
      <goods-list :goods="showGoods"></goods-list>
    </scroll>
    <back-up @click.native="backClick" class="back-up" v-show="isShowBackUp"></back-up>
  </div>
</template>

<script>
  
  import HomeSwiper from './childCpns/HomeSwiper'
  import HomeRecommend from './childCpns/HomeRecommend'
  import FeatureView from './childCpns/FeatureView'

  import NavBar from 'common/navbar/NavBar'
  import TabControl from 'content/tabControl/TabControl'
  import GoodsList from 'content/goods/GoodsList'
  import Scroll from 'common/scroll/Scroll'
  import BackUp from 'content/backUp/BackUp'

  import { getHomeMultidata, getHomeGoods } from 'network/home'

  export default {
    name: 'Home',
    components: {    
      HomeSwiper,
      HomeRecommend,
      FeatureView,
      NavBar,
      TabControl,
      GoodsList,
      Scroll,
      BackUp
    },
    data() {
      return {
        banner: null,
        recommend: null,
        goods: {
          'pop': {page: 0, list: []},
          'new': {page: 0, list: []},
          'sell': {page: 0, list: []}
        },
        currentType: 'pop',
        isShowBackUp: false
      }    
    },
    computed: {
      showGoods() {
        return this.goods[this.currentType].list
      }
    },
    created() {
      this.getHomeMultidata();
      this.getHomeGoods('pop');
      this.getHomeGoods('new');
      this.getHomeGoods('sell');
    },
    mounted() {
      const refresh = this.debounce(this.$refs.scroll.refresh, 50);
      this.$bus.$on('itemImgLoad', () => refresh());
    },
    methods: {
      // 事件监听
      tabClick(index) {
        switch(index) {
          case 0:
            this.currentType = 'pop';
            break;
          case 1:
            this.currentType = 'new';
            break;
          case 2:
            this.currentType = 'sell';
            break;   
        }
      },
      backClick() {
        this.$refs.scroll.scrollTo(0, 0, 300);
      },
      contentScroll(position) {
        this.isShowBackUp = (-position.y) > 1000;
      },
      loadMore() {
        this.getHomeGoods(this.currentType);
        this.$refs.scroll.refresh();
      },
      debounce(func, delay) {
        let timer = null;
        return function(...args) {
          if(timer) clearTimeout(timer);
          timer = setTimeout(() => {
            func.apply(this, args);
          }, delay)
        }
      },
      // 网络请求
      getHomeMultidata() {
        getHomeMultidata().then(res => {
          this.banner = res.data.banner.list;
          this.recommend = res.data.recommend.list;
        })
      },
      getHomeGoods(type) {
        const page = this.goods[type].page + 1;
        getHomeGoods(type, page).then(res => {
           this.goods[type].list.push(...res.data.list);
           this.goods[type].page += 1;
           this.$refs.scroll.finishPullUp();
        });        
      }
    }
  }
</script>
```

![3 [129].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663462912-da32e8b6-da18-4fbb-9a46-05fec87c2ee5.jpeg)

...args 意味着传入所有的参数，args是使用所有的参数

this.$bus.$on('itemImgLoad', refresh)  refresh 执行很快的话， delay 都没写也会立马 clearTimeout(timer)，有一点防抖的效果，

相当于

```js
setTimeOut(() => {}, 0)
```

setTimeOut 是同步任务执行完立即执行的异步宏任务

封装 debounce 到 util.js

![3 [130].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663462993-89b7c936-429a-4c3f-9e9b-ee3781dc7b88.jpeg)

为了代码更加严谨，可添加

![3 [131].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663463467-23b0fe49-f31b-4648-adb4-ca68e6621869.jpeg)

出现问题：props 为驼峰命名时必须使用短横线命名且是在大写字母前加（之前为 :pull-upload="true"）

```js
props: {
  probeType: {
    type: Number,
    default: 0
  },
  pullUpLoad: {
    type: Boolean,
    default: false
  }
}
```

```js
:pull-up-load="true"
```

## tabControl 的 offsetTop 获取分析

首页做完之后，还剩一个功能： tabControl 的吸顶效果

所以必须知道滚动到多少距离时，开始有吸顶效果，那么就要获取 tabControl 的 offsetTop

问题：

不能在组件上直接获取 offsetTop，因为 this.$refs.tabConrol 获取的是组件对象，所以打印出 undefined

![3 [132].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663463491-657f546b-9be8-4f31-a9ff-b82844f15827.jpeg)

**解决：** 

通过 this.$refs.tabConrol.$el 获取元素，但是打印过后就会发现 offsetTop 是错的，

因为 mounted() 时图片还没加载完， offsetTop 不包含图片的高度，它的值非常小

所以必须监听图片加载完再获取 offsetTop，图片加载过程中经测试发现轮播图加载是最慢的，监听轮播图加载完再获取 offsetTop 即可，

但是轮播图会加载 4 次，

所以要限制 $emit('swiperImageLoad') 的次数

（这里没有必要使用防抖，因为这里相当于 y ifu，输入 y 时就不再发送事件，而防抖则是等待输入完整）

![3 [133].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663464199-4bc3b20f-34c6-49ba-b72a-5972cc751ee9.jpeg)

## 监听滚动，动态地改变 tabControl

之前已经设置了监听首页滚动事件 contentScroll，所以要在  contentScroll 里决定 tabControl 是否吸顶（position: fixed）

![3 [134].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663464277-189b2ac6-ef50-4eea-b699-1b825106b666.jpeg)

![3 [135].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663464780-b61a2c54-039a-45d3-8a35-ed4d99dd98a4.jpeg)

![3 [136].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663465306-7835d60f-cb23-48b2-9b1c-a9588dd77575.jpeg)

第一个问题：

由下图可以看出图片会往上跑一下，因为原来布局的 tabControl 是顶着图片的，现在 tabControl 脱标了，下面的图片自然会在滚动距离超过 545时，突然往上跑一下

![3 [8].gif](https://cdn.nlark.com/yuque/0/2022/gif/1614731/1656660120527-46ce4c93-fab0-44c3-892f-c1630b126af3.gif)

第二个问题：tabControl 不见了

![3 [137].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663465429-2db8d038-0b9a-41b6-8fd2-83b6be94d1bc.jpeg)

原因：better-scroll 使用了 transform: translate(0px, -500px) 来滚动的，而 tabControl 使用 fixed 定位时受其影响，位置发生了改变，已经在页面最上方，所以看不见

![3 [9].gif](https://cdn.nlark.com/yuque/0/2022/gif/1614731/1656660122607-70d10e04-50ad-4103-bada-4dd8fac8e0b8.gif)

所以 fixed吸顶方案不可行

另一个方案

拷贝多一个 tab-control 组件

![3 [138].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663465757-b4318ac7-22d7-45e1-808e-ab5308096b40.jpeg)

tabControl 会被 nav-bar 挡住

![3 [139].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663466454-4965b608-fea0-4ccc-a6c2-5463112765b1.jpeg)

第一种方法：

better-scroll 对 .content 区域使用了局部滚动，那么 nav-bar 即使不设置 fixed 定位也不会随页面滚动而滚动，

因为 .content 与 nav-bar 相当于是分隔的，nav-bar 不受影响（这里说错了，事实并非如此，还是得设置 z-index）

```js
.nav {
  background-color: var(--color-tint);
  color: #fff;
  position: relative;
  z-index: 1;
}
```

![3 [140].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663466544-f1409d46-7bbb-432c-96d1-e028fad27e1e.jpeg)

取消 fixed 定位后，第一个 tabControl 组件（代码在上面的） 自然会在 nav-bar 组件下面

![3 [141].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663466696-a2520896-9f1a-4565-98d9-d628add08df2.jpeg)

第二种方法：

对第一个 tabControl 组件（代码在上面的）设置 margin-top 形成吸顶效果

然后：

![3 [142].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663467244-b89e4082-8c9b-4007-b205-c32687c25e3c.jpeg)

只要实现滚到第二个 tabControl 组件时第一个 tabControl 组件覆盖它，滚上去时隐藏第一个 tabControl 组件即可

所以很多动画都是假象，都是给用户看的，动画做完会移除掉的

![3 [10].gif](https://cdn.nlark.com/yuque/0/2022/gif/1614731/1656660124444-bf6654d2-7d2a-4a24-8f2d-547146236d7f.gif)

![3 [143].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663467819-89b37c10-d035-4644-a88b-2577515e7689.jpeg)

还有一个问题：首页 tabControl 不一致

首页滚动时 Tab 会切换，因为第一个 tabControl 组件仍然显示的是流行 ，两个 tabControl 组件没有保持一致

![3 [11].gif](https://cdn.nlark.com/yuque/0/2022/gif/1614731/1656660123913-aebd3fc5-099b-4c89-9c4c-90448068d895.gif)

![3 [144].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663468164-9dc5e360-1d30-4b4e-abe1-60a57e94974c.jpeg)

![3 [145].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663468754-d66ab979-6eb2-4219-8888-bd91279aa9d7.jpeg)

问题： 

1、.fixed 吸顶样式设置 z-index，却只有文字覆盖图片，原因是没有背景颜色

2、之前 scroll.vue 中加了 if (this.pullUpLoad) 导致上拉加载更多时出错，所以去除 if (this.pullUpLoad) ，变成

```
this.scroll.on('pullingUp', () => {
  this.$emit('pullingUp')
});
```

HomeSwiper.vue

```vue
<template>
  <swiper>
    <swiper-item v-for="(item, index) in banner" :key="index">
      <a :href="item.link">
        <img :src="item.image" @load="swiperImageLoad">
      </a>
    </swiper-item>
  </swiper>
</template>

<script>
  import {Swiper, SwiperItem} from 'common/swiper/index.js'
  export default {
    name: 'HomeSwiper',
    props: {
      banner: {
        type: Array,
        default() {
          return []
        }
      }
    },
    data() {
      return {
        isImageLoad: false,
      }     
    },
    methods: {
      swiperImageLoad() {
        if (!this.isImageLoad) {
          this.$emit('swiperImageLoad')
          this.isImageLoad = true;
        }      
      }
    },
    components: {
      Swiper,
      SwiperItem
    }
  }
</script>

<style scoped>
</style>
```

Home.vue

```vue
<template>
  <div id="home">
    <nav-bar class="nav">
      <div slot="center">购物街</div>
    </nav-bar>
    <tab-control :title="['流行', '新款', '精选']" @tabClick="tabClick"
                 class="fixed" v-show="isTabFixed"  ref="tabControl1">
    </tab-control>
    <scroll class="content"
            ref="scroll"
            :probe-type="3"
            :pull-up-load="true"
            @scroll="contentScroll"
            @pullingUp="loadMore">
      <home-swiper :banner="banner" @swiperImageLoad="swiperImageLoad"></home-swiper>
      <home-recommend :recommend="recommend"></home-recommend>
      <feature-view></feature-view>
      <tab-control :title="['流行', '新款', '精选']"  
                   @tabClick="tabClick"
                   ref="tabControl2" >
      </tab-control>
      <goods-list :goods="showGoods"></goods-list>
    </scroll>
    <back-up @click.native="backClick" class="back-up" v-show="isShowBackUp"></back-up>
  </div>
</template>
<script>
  
  import HomeSwiper from './childCpns/HomeSwiper'
  import HomeRecommend from './childCpns/HomeRecommend'
  import FeatureView from './childCpns/FeatureView'

  import NavBar from 'common/navbar/NavBar'
  import TabControl from 'content/tabControl/TabControl'
  import GoodsList from 'content/goods/GoodsList'
  import Scroll from 'common/scroll/Scroll'
  import BackUp from 'content/backUp/BackUp'

  import { getHomeMultidata, getHomeGoods } from 'network/home'
  import {debounce} from 'commonjs/utils.js'
  export default {
    name: 'Home',
    components: {    
      HomeSwiper,
      HomeRecommend,
      FeatureView,
      NavBar,
      TabControl,
      GoodsList,
      Scroll,
      BackUp
    },
    data() {
      return {
        banner: null,
        recommend: null,
        goods: {
          'pop': {page: 0, list: []},
          'new': {page: 0, list: []},
          'sell': {page: 0, list: []}
        },
        currentType: 'pop',
        isShowBackUp: false,
        tabOffsetTop: 0,
        isTabFixed: false
      }    
    },
    computed: {
      showGoods() {
        return this.goods[this.currentType].list
      }
    },
    created() {
      this.getHomeMultidata();
      this.getHomeGoods('pop');
      this.getHomeGoods('new');
      this.getHomeGoods('sell');
    },
    mounted() {
      const refresh = debounce(this.$refs.scroll.refresh, 50);
      this.$bus.$on('itemImgLoad', () => refresh());
    },
    methods: {
      // 事件监听
      tabClick(index) {
        switch(index) {
          case 0:
            this.currentType = 'pop';
            break;
          case 1:
            this.currentType = 'new';
            break;
          case 2:
            this.currentType = 'sell';
            break;   
        }
        this.$refs.tabControl1.currentIndex = index;
        this.$refs.tabControl2.currentIndex = index;
      },
      backClick() {
        this.$refs.scroll.scrollTo(0, 0, 300);
      },
      contentScroll(position) {
        this.isShowBackUp = (-position.y) > 1000;
        this.isTabFixed = (-position.y) > this.tabOffsetTop;
      },
      loadMore() {
        this.getHomeGoods(this.currentType);
        this.$refs.scroll.refresh();
      },
      swiperImageLoad() {       
        this.tabOffsetTop = this.$refs.tabControl2.$el.offsetTop;      
      },
      // 网络请求
      getHomeMultidata() {
        getHomeMultidata().then(res => {
          this.banner = res.data.banner.list;
          this.recommend = res.data.recommend.list;
        })
      },
      getHomeGoods(type) {
        const page = this.goods[type].page + 1;
        getHomeGoods(type, page).then(res => {
           this.goods[type].list.push(...res.data.list);
           this.goods[type].page += 1;
           this.$refs.scroll.finishPullUp();
        });        
      }
    }
  }
</script>

<style scoped>
  #home {
    height: 100vh;
  }
  .nav {
    background-color: var(--color-tint);
    color: #fff;
    position: relative;
    z-index: 1;
  }
  .content {
    position: absolute;
    top: 44px;
    bottom: 49px;
    left: 0;
    right: 0;   
  }
  .back-up {
    position: fixed;
    right: 8px;
    bottom: 55px;  
  }
  .fixed {
    position: fixed;
    top: 44px;
    left: 0;
    right: 0;   
    z-index: 1;
    background-color: #fff;
  }
</style>
```

效果图

![3 [12].gif](https://cdn.nlark.com/yuque/0/2022/gif/1614731/1656660124685-6ae915da-7e59-4c1d-8cf4-52cba577f83f.gif)

如果想首页默认选中的是流行，可以这么做：

![3 [146].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663469428-18ca1ad5-3879-4e44-8371-74c1a0b83f5e.jpeg)

![3 [147].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663469589-38729b42-3318-4cd9-804d-43a15e601bc1.jpeg)

![3 [148].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663469781-b7006ed4-944a-445e-80f2-b739be1a6a2f.jpeg)

## Home 组件离开时记录状态和位置

当从首页跳到分类页时，回到首页时应该停留在原来的位置，

但是首页会 destroy 销毁，也就是说每次进入首页都会重新创建首页，不会停留在原来的位置

![3 [149].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663470153-618f4145-490d-49b0-9828-7e1c7409b7f7.jpeg)

![3 [150].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663470821-0f3e4db4-e5d9-4d12-bd12-c08eac9e3ac0.jpeg)

使用 `<keep-alive>` 阻止页面销毁，但是 beeter-scroll 使得首页无法保留原来的位置

![3 [151].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663470808-6db413dc-0544-4a8d-8c29-cd62dc8065bb.jpeg)

问题：应该先 refresh() 再 scrollTo()

![3 [152].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663471369-7ec45814-d39f-4bfe-a2f3-6b58d62e5b24.jpeg)

每次进入首页滚动到指定位置时都需要 refresh()，否则会出 Bug（突然回到顶部）

当 this.scroll 有值时才去取 this.scroll.y，没有值就取默认的 0。

![3 [153].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663472017-5965e566-e7c4-4909-b576-068a6d948f5d.jpeg)

## 跳转到详情页并携带 id

![3 [154].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663472337-729f3f1a-2159-4552-aa57-c446c9337f11.jpeg)

一个商品就是一个 GoodListItem，要跳转到详情页必须先监听 GoodListItem 的点击

新建组件

![3 [155].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663472649-4c029def-4666-4dc1-941c-ddc7510edf98.jpeg)

配置路由

![3 [156].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663473213-c0a433d9-8bd6-4e9a-8beb-ba4ccb0914d5.jpeg)

![3 [157].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663473406-efb5b373-fdc9-4866-8811-b6a05f693642.jpeg)

路由使用 push 到时候可以使用 back 直接返回

![3 [158].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663474058-1effed5d-9d67-4193-8a3b-ac41f43ae3f4.jpeg)

点击时切换到 Detail 并传递参数 iid

![3 [159].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663475004-f6b77dff-9644-4cc2-a34a-411cffadfe06.jpeg)

给路由传递参数

![3 [160].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663475197-591f673b-aca6-4c3f-b591-72b92a3271ba.jpeg)

因为要在详情页拿到 id 发送网络请求，所以需要存储 id

![3 [161].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663475279-6f0d49c6-6c17-4981-859d-fde0b75eaed3.jpeg)

## 详情页导航栏的封装

![3 [162].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663475489-241de186-af20-4f79-9877-e6c482b8d77d.jpeg)

Home.vue

```vue
<template>
  <div id="home">
    <nav-bar class="nav">
      <div slot="center">购物街</div>
    </nav-bar>
    <tab-control :title="['流行', '新款', '精选']" @tabClick="tabClick"
                 class="fixed" v-show="isTabFixed"  ref="tabControl1">
    </tab-control>
    <scroll class="content"
            ref="scroll"
            :probe-type="3"
            :pull-up-load="true"
            @scroll="contentScroll"
            @pullingUp="loadMore">
      <home-swiper :banner="banner" @swiperImageLoad="swiperImageLoad"></home-swiper>
      <home-recommend :recommend="recommend"></home-recommend>
      <feature-view></feature-view>
      <tab-control :title="['流行', '新款', '精选']"  
                   @tabClick="tabClick"
                   ref="tabControl2" >
      </tab-control>
      <goods-list :goods="showGoods"></goods-list>
    </scroll>
    <back-up @click.native="backClick" class="back-up" v-show="isShowBackUp"></back-up>
  </div>
</template>
<script>
  
  import HomeSwiper from './childCpns/HomeSwiper'
  import HomeRecommend from './childCpns/HomeRecommend'
  import FeatureView from './childCpns/FeatureView'

  import NavBar from 'common/navbar/NavBar'
  import TabControl from 'content/tabControl/TabControl'
  import GoodsList from 'content/goods/GoodsList'
  import Scroll from 'common/scroll/Scroll'
  import BackUp from 'content/backUp/BackUp'

  import { getHomeMultidata, getHomeGoods } from 'network/home'
  import {debounce} from 'commonjs/utils.js'
  
  export default {
    name: 'Home',
    components: {    
      HomeSwiper,
      HomeRecommend,
      FeatureView,
      NavBar,
      TabControl,
      GoodsList,
      Scroll,
      BackUp
    },
    data() {
      return {
        banner: null,
        recommend: null,
        goods: {
          'pop': {page: 0, list: []},
          'new': {page: 0, list: []},
          'sell': {page: 0, list: []}
        },
        currentType: 'pop',
        isShowBackUp: false,
        tabOffsetTop: 0,
        isTabFixed: false,
        scrollY: 0
      }    
    },
    computed: {
      showGoods() {
        return this.goods[this.currentType].list
      }
    },
    created() {
      this.getHomeMultidata();
      this.getHomeGoods('pop');
      this.getHomeGoods('new');
      this.getHomeGoods('sell');
    },
    mounted() {
      const refresh = debounce(this.$refs.scroll.refresh, 50);
      this.$bus.$on('itemImgLoad', () => refresh());
    },
    activated () {
      this.$refs.scroll.refresh();
      this.$refs.scroll.scrollTo(0, this.scrollY, 0);     
    },
    deactivated () {
      this.scrollY = this.$refs.scroll.getScrollY();
    },
    methods: {
      // 事件监听
      tabClick(index) {
        switch(index) {
          case 0:
            this.currentType = 'pop';
            break;
          case 1:
            this.currentType = 'new';
            break;
          case 2:
            this.currentType = 'sell';
            break;   
        }
        this.$refs.tabControl1.currentIndex = index;
        this.$refs.tabControl2.currentIndex = index;
      },
      backClick() {
        this.$refs.scroll.scrollTo(0, 0, 300);
      },
      contentScroll(position) {
        this.isShowBackUp = (-position.y) > 1000;
        this.isTabFixed = (-position.y) > this.tabOffsetTop;
      },
      loadMore() {
        this.getHomeGoods(this.currentType);
        this.$refs.scroll.refresh();
      },
      swiperImageLoad() {       
        this.tabOffsetTop = this.$refs.tabControl2.$el.offsetTop;      
      },
      // 网络请求
      getHomeMultidata() {
        getHomeMultidata().then(res => {
          this.banner = res.data.banner.list;
          this.recommend = res.data.recommend.list;
        })
      },
      getHomeGoods(type) {
        const page = this.goods[type].page + 1;
        getHomeGoods(type, page).then(res => {
           this.goods[type].list.push(...res.data.list);
           this.goods[type].page += 1;
           this.$refs.scroll.finishPullUp();
        });        
      }
    }
  }
</script>
```

GoodsItem.vue

```vue
<template>
  <div class="goods-item" @click="itemClick">
    <img :src="goodsItem.show.img" @load="imgLoad">
    <div class="goods-info">
      <p>{{goodsItem.title}}</p>
      <span class="price">{{goodsItem.price}}</span>
      <span class="collect">{{goodsItem.cfav}}</span>
    </div>
  </div>
</template>

<script>
  export default {
    name: 'GoodsItem',
    props: {
      goodsItem: {
        type: Object,
        default() {
          return {}
        }
      }
    },
    methods: {
      imgLoad() {
        this.$bus.$emit('itemImgLoad')
      },
      itemClick() {
        this.$router.push('/detail/' + this.goodsItem.iid)
      }
    }
  }
</script>
```

Detail.vue

```vue
<template>
  <div>
    <nav-bar>
      <div slot="left" class="back" @click="backClick">
        <img src="~assets/img/common/back.svg">
      </div>
      <div slot="center" class="title">
        <div class="item" :class="{active: index === currentIndex}"
             @click="tabClick(index)" v-for="(item, index) of title" :key="index">
          {{item}}
        </div>
      </div>
    </nav-bar>
  </div>
</template>

<script>
  import NavBar from 'common/navbar/NavBar'
  export default {
    name: 'Detail',
    data () {
      return {
        iid: null,
        title: ['商品', '详情', '评论', '推荐'],
        currentIndex: 0
      }
    },
    methods: {
      tabClick(index) {
        this.currentIndex = index
      },
      backClick() {
        this.$router.back();
      }
    },
    created () {
      this.iid = this.$route.params.iid
    },
    components: {
      NavBar
    }
  }
</script>

<style scoped>
  .back img {
    margin-top: 12px;
  }
  .title {
    display: flex;   
    font-size: 12px;
  }
  .item {
    flex: 1;
    text-align: center;
  }
  .active {
    color: var(--color-tint)
  }
</style>
```

在 `<div>`上监听点击，而不是在 `<img>` 上监听点击，因为 `<div>` 监听的范围会更大

发现Bug：第一次刷新时，无法滚动到底部，tabControl1 也不见了

## 数据请求与轮播图展示

![3 [163].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663476656-74ff9e7a-fcbb-4a7a-a45d-fe6bd77ac9a8.jpeg)

有些公司会有详细的接口文档，有些公司则没有（不一定会具体解释内部数据，需要自己找）

![3 [164].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663476934-391ea599-faa1-47fe-abfc-51577f94417d.jpeg)

![3 [165].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663476942-2d5bd9ef-7692-4cb9-9cc6-2da6072b4f30.jpeg)

![3 [166].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663477181-26682184-ed12-457b-97cd-60920fc9865b.jpeg)

![3 [167].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663477656-a0bf9c04-3973-403e-b14d-62c223e0748a.jpeg)

因为封装的组件使用了 querySelector('.swiper')，所以不能取名为 swiper

![3 [168].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663477921-1d6d8c6d-88d7-4601-b1c7-693066c2cc5e.jpeg)

![3 [169].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663478316-6b33d76f-5e47-4d8e-89cb-882648ce6a51.jpeg)

问题：每次进入详情页，轮播图数据不变

exclude="Detail" 之后还要给Detail组件的路由取name="Detail'"

![3 [170].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663478372-9a833afc-0ecb-4188-91aa-00d064d457b1.jpeg)

index.js

```js
import Vue from "vue"
import VueRouter from "vue-router"

Vue.use(VueRouter)

const Home = () => import("views/home/Home")
const Category = () => import("views/category/Category")
const Cart = () => import("views/cart/Cart")
const Profile = () => import("views/profile/Profile")
const Detail = () => import("views/detail/Detail")

const routes = [
  {
    path: "",
    redirect: "/home",
  },
  {
    path: "/home",
    component: Home,
  },
  {
    path: "/category",
    component: Category,
  },
  {
    path: "/cart",
    component: Cart,
  },
  {
    path: "/profile",
    component: Profile,
  },
  {
    path: "/detail/:iid",
    component: Detail,
    name: 'Detail'
  }
]

const router = new VueRouter({
  mode: "history",
  base: process.env.BASE_URL,
  routes,
})

export default router
```

DetailNavBar.vue

```vue
<template>
  <nav-bar>
    <div slot="left" class="back" @click="backClick">
      <img src="~assets/img/common/back.svg">
    </div>
    <div slot="center" class="title">
      <div class="item" :class="{active: index === currentIndex}"
            @click="tabClick(index)" v-for="(item, index) of title" :key="index">
        {{item}}
      </div>
    </div>
  </nav-bar>
</template>

<script>
  import NavBar from 'common/navbar/NavBar'
  export default {
    name: 'DetailNavBar',
    data () {
      return {
        title: ['商品', '详情', '评论', '推荐'],
        currentIndex: 0
      }
    },
    methods: {
      tabClick(index) {
        this.currentIndex = index
      },
      backClick() {
        this.$router.back();
      }
    },
    components: {
      NavBar
    }
  }
</script>

<style scoped>
  .back img {
    margin-top: 12px;
  }
  .title {
    display: flex;   
    font-size: 12px;
  }
  .item {
    flex: 1;
    text-align: center;
  }
  .active {
    color: var(--color-tint)
  }
</style>
```

对子元素使用 flex: 1;

detail.js

```js
import {request} from './request';

export function getDetailData(iid) {
  return request({
    url: '/detail',
    params: {
      iid
    }
  })
}
```

Detail.vue

```vue
<template>
  <div>
    <detail-nav-bar></detail-nav-bar>
    <detail-swiper :topImages="topImages"></detail-swiper>
  </div>
</template>

<script>
  import DetailNavBar from './childCpns/DetailNavBar';
  import DetailSwiper from './childCpns/DetailSwiper';

  import {getDetailData} from 'network/detail';

  export default {
    name: 'Detail',
    data () {
      return {
        iid: null,
        topImages: []
      }
    },
    created () {
      this.iid = this.$route.params.iid;
      getDetailData(this.iid).then(res => {
        this.topImages = res.result.itemInfo.topImages
      })
    },
    components: {
      DetailNavBar,
      DetailSwiper
    }
  }
</script>

<style scoped>
</style>
```

DetailSwiper.vue

```vue
<template>
  <swiper class="detail-swiper">
    <swiper-item v-for="(item, index) of topImages" :key="index">
      <img :src="item" alt="detail images">
    </swiper-item>
  </swiper>
</template>

<script>
  import {Swiper, SwiperItem} from 'common/swiper'
  export default {
    name: 'DetailSwiper',
    props:{
      topImages: {
        type: Array,
        default() {
          return []
        }
      }
    },
    components: {
      Swiper,
      SwiperItem
    }
  }
</script>

<style scoped>
  .detail-swiper {
    height: 300px;
    overflow: hidden;
  }
</style>
```

效果图

![3 [13].gif](https://cdn.nlark.com/yuque/0/2022/gif/1614731/1656660125403-efa01c66-957f-4bbf-80e2-bd04900943a4.gif)

## 商品基本信息的展示

![3 [171].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663479212-7f5e399c-4a2f-43a7-a8f8-867af8fb2300.jpeg)

要想展示数据首先要获取该部分数据

![3 [172].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663480121-028fab0d-95ad-4ae5-916a-664e17a58f92.jpeg)

商品基本信息要封装成一个独立的组件，那么就要先把用到的数据抽离出去再交给 DetailBaseInfo 组件展示

给组件传数据的时候要尽量先整合好（数据杂乱无章也无所谓，真实数据一般都这一块那一块的，所以要做的只是整合）

思想：把杂乱无章的数据封装到 class Goods 里最后整合成一个对象 goods （只有我们想要的数据，有规律的数据）再做展示

detail.js

```js
import {request} from './request';

export function getDetailData(iid) {
  return request({
    url: '/detail',
    params: {
      iid
    }
  })
}

export class Goods {
  constructor(itemInfo, columns, services) {
    this.title = itemInfo.title;
    this.desc = itemInfo.desc;
    this.newPrice = itemInfo.price;
    this.oldPrice = itemInfo.oldPrice;
    this.discount = itemInfo.discountDesc;
    this.columns = columns;
    this.services = services;
    this.lowNowPrice = itemInfo.lowNowPrice;
    this.nowPrice = itemInfo.highNowPrice;
  }
}
```

![3 [173].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663480199-65a115e2-c9ce-4f5c-9e17-0b180637e607.jpeg)

Detail.vue

```vue
<template>
  <div>
    <detail-nav-bar></detail-nav-bar>
    <detail-swiper :topImages="topImages"></detail-swiper>
    <detail-base-info :goods="goods"></detail-base-info>
  </div>
</template>

<script>
  import DetailNavBar from './childCpns/DetailNavBar';
  import DetailSwiper from './childCpns/DetailSwiper';
  import DetailBaseInfo from './childCpns/DetailBaseInfo';
  import {getDetailData, Goods} from 'network/detail';
  export default {
    name: 'Detail',
    data () {
      return {
        iid: null,
        topImages: [],
        goods: {}
      }
    },
    created () {
      this.iid = this.$route.params.iid;
      getDetailData(this.iid).then(res => {
        const data =  res.result;
        this.topImages = data.itemInfo.topImages;
        this.goods = new Goods(data.itemInfo, data.columns, data.shopInfo.services)
      })
    },
    components: {
      DetailNavBar,
      DetailSwiper,
      DetailBaseInfo
    }
  }
</script>

<style scoped>
</style>
```

![3 [174].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663480603-016f2419-71bf-47fb-ae06-82e68889310e.jpeg)

DetailBaseInfo.vue

```vue
<template>
  <div v-if="Object.keys(goods).length !== 0" class="base-info">
    <div class="info-title">{{goods.title}}</div>
    <div class="info-price">
      <span class="n-price">{{goods.newPrice}}</span>
      <span class="o-price">{{goods.oldPrice}}</span>
      <span class="discount">{{goods.discount}}</span>
    </div>
    <div class="info-other">
      <span>{{goods.columns[0]}}</span>
      <span>{{goods.columns[1]}}</span>
      <span>{{goods.services[goods.services.length-1].name}}</span>
    </div>
    <div class="info-service">
      <span class="info-service-item" v-for="index in goods.services.length-1" :key="index">
        <img :src="goods.services[index-1].icon">
        <span>{{goods.services[index-1].name}}</span>
      </span>
    </div>
  </div>
</template>

<script>
  export default {
    name: "DetailBaseInfo",
    props: {
      goods: {
        type: Object
      }
    }
  }
</script>

<style scoped>
  .base-info {
    margin-top: 15px;
    padding: 0 8px;
    color: #999;
    border-bottom: 5px solid #f2f5f8;
  }
  .info-title {
    color: #222
  }
  .info-price {
    margin-top: 10px;
  }
  .info-price .n-price {
    font-size: 24px;
    color: var(--color-high-text);
  }
  .info-price .o-price {
    font-size: 13px;
    margin-left: 5px;
    text-decoration: line-through;
  }
  .info-price .discount {
    font-size: 12px;
    padding: 2px 5px;
    color: #fff;
    background-color: var(--color-high-text);
    border-radius: 8px;
    margin-left: 5px;
    /*让元素上浮一些: 使用相对定位即可*/
    position: relative;
    top: -8px;
  }
  .info-other {
    margin-top: 15px;
    line-height: 30px;
    display: flex;
    font-size: 13px;
    border-bottom: 1px solid rgba(100,100,100,.1);
    justify-content: space-between;
  }
  .info-service {
    display: flex;
    justify-content: space-between;
    line-height: 60px;
  }
  .info-service-item img {
    width: 14px;
    height: 14px;
    position: relative;
    top: 2px;
  }
  .info-service-item span {
    font-size: 13px;
    color: #333;
  }
</style>
```

v-for 可以遍历数字 

```vue
<div v-for="item in 10"></div>
```

item 会从 1 遍历到 10

v-if 请求的 goods 数据不为空才显示

```vue
v-if="Object.keys(goods).length !== 0"
```

Object.keys(obj).length 获取 obj 对象所有的 key，判断对象是否为空

问题

因为还没请求到数据时给 `<detail-base-info :goods="null"></detail-base-info>` 传了个null

而 DetailBaseInfo.vue 要求是个对象

```js
props: {
  goods: {
    type: Object
  }
}
```

所以报错

![3 [175].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663480794-5e0b8cc9-8624-4f96-8f5b-bea991d8b0af.jpeg?x-oss-process=image%2Fresize%2Cw_929%2Climit_0)

Detail.vue 的 goods: null 改为 goods: {} 即可

```js
data () {
  return {
    iid: null,
    topImages: [],
    goods: {}
  }
}
```

## 店铺信息的解析与展示

DetailShopInfo.vue

```vue
<template>
  <div class="shop-info">
    <div class="shop-top">
      <img :src="shop.logo">
      <span class="title">{{shop.name}}</span>
    </div>
    <div class="shop-middle">
      <div class="shop-middle-item shop-middle-left">
        <div class="info-sells">
          <div class="sells-count">
            {{shop.sells | sellCountFilter}}
          </div>
          <div class="sells-text">总销量</div>
        </div>
        <div class="info-goods">
          <div class="goods-count">
            {{shop.goodsCount}}
          </div>
          <div class="goods-text">全部宝贝</div>
        </div>
      </div>
      <div class="shop-middle-item shop-middle-right">
        <table>
          <tr v-for="(item, index) in shop.score" :key="index">
            <td>{{item.name}}</td>
            <td class="score" :class="{'score-better': item.isBetter}">{{item.score}}</td>
            <td class="better" :class="{'better-more': item.isBetter}"><span>{{item.isBetter ? '高':'低'}}</span></td>
          </tr>
        </table>
      </div>
    </div>
    <div class="shop-bottom">
      <div class="enter-shop">进店逛逛</div>
    </div>
  </div>
</template>

<script>
  export default {
    name: "DetailShopInfo",
    props: {
      shop: {
        type: Object
      }
    },
    filters: {
      sellCountFilter: function (value) {
        if (value < 10000) return value;
        return (value/10000).toFixed(1) + '万'
      }
    }
  }
</script>

<style scoped>
  .shop-info {
    padding: 25px 8px;
    border-bottom: 5px solid #f2f5f8;
  }
  .shop-top {
    line-height: 45px;
    /* 让元素垂直中心对齐 */
    display: flex;
    align-items: center;
  }
  .shop-top img {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    border: 1px solid rgba(0,0,0,.1);
  }
  .shop-top .title {
    margin-left: 10px;
    vertical-align: center;
  }
  .shop-middle {
    margin-top: 15px;
    display: flex;
    align-items: center;
  }
  .shop-middle-item {
    flex: 1;
  }
  .shop-middle-left {
    display: flex;
    justify-content: space-evenly;
    color: #333;
    text-align: center;
    border-right: 1px solid rgba(0,0,0,.1);
  }
  .sells-count, .goods-count {
    font-size: 18px;
  }
  .sells-text, .goods-text {
    margin-top: 10px;
    font-size: 12px;
  }
  .shop-middle-right {
    font-size: 13px;
    color: #333;
  }
  .shop-middle-right table {
    width: 120px;
    margin-left: 30px;
  }
  .shop-middle-right table td {
    padding: 5px 0;
  }
  .shop-middle-right .score {
    color: #5ea732;
  }
  .shop-middle-right .score-better {
    color: #f13e3a;
  }
  .shop-middle-right .better span {
    background-color: #5ea732;
    color: #fff;
    text-align: center;
  }
  .shop-middle-right .better-more span {
    background-color: #f13e3a;
  }
  .shop-bottom {
    text-align: center;
    margin-top: 10px;
  }
  .enter-shop {
    display: inline-block;
    font-size: 14px;
    background-color: #f2f5f8;
    width: 150px;
    height: 30px;
    text-align: center;
    line-height: 30px;
    border-radius: 10px;
  }
</style>
```

如果传过来的 isBetter 为 true，item.isBetter 为 true ，.score-better 的样式就会生效，评分变成红色 ，否则为绿色

![3 [176].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663481827-1bb71b82-38d9-4c01-807e-557639d37e2e.jpeg)

但是还有个问题：滚动时导航栏也跟着滚动了

## 加入滚动的效果 Scroll

tabBar 脱离标准流，盖住了详情页，所以详情页要设置层级 z-index

![3 [177].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663482006-ab3f91dd-18ed-4199-9ed6-a050aef48e1c.jpeg)

注意问题：父元素如果没有固定高度，父元素根据内容撑高，那么子元素100%就是父元素内容的高度（不变）

Detail.vue

```vue
<template>
  <div id="detail">
    <detail-nav-bar class="detail-nav"></detail-nav-bar>
    <scroll class="content">
      <detail-swiper :topImages="topImages"></detail-swiper>
      <detail-base-info :goods="goods"></detail-base-info>
      <detail-shop-info :shop="shop"></detail-shop-info>
    </scroll>
  </div>
</template>

<script>
  import DetailNavBar from './childCpns/DetailNavBar';
  import DetailSwiper from './childCpns/DetailSwiper';
  import DetailBaseInfo from './childCpns/DetailBaseInfo';
  import DetailShopInfo from './childCpns/DetailShopInfo';
  import Scroll from 'common/scroll/Scroll';
  import {getDetailData, Goods, Shop} from 'network/detail';
  export default {
    name: 'Detail',
    data () {
      return {
        iid: null,
        topImages: [],
        goods: {},
        shop: {}
      }
    },
    created () {
      this.iid = this.$route.params.iid;
      getDetailData(this.iid).then(res => {
        const data =  res.result;
        this.topImages = data.itemInfo.topImages;
        this.goods = new Goods(data.itemInfo, data.columns, data.shopInfo.services)
        this.shop = new Shop(data.shopInfo)
      })
    },
    components: {
      DetailNavBar,
      DetailSwiper,
      DetailBaseInfo,
      DetailShopInfo,
      Scroll
    }
  }
</script>

<style scoped>
  #detail {
    position: relative;
    z-index: 1;
    height: 100vh;
    background-color: #fff;
  }
  .detail-nav {
    position: relative;
    z-index: 1;
    background-color: #fff;
  }
  .content {
    height: calc(100% - 44px);
  }
</style>
```

## 商品详情数据展示

接下来要展示详情的图片数据

但是有个问题：图片展示后无法滚动到底部

![3 [178].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663482287-a164d7a2-1acf-4688-a815-fa1ffcf36bb9.jpeg)

![3 [179].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663482774-85923b78-4f3e-4d02-b858-f02390f5d959.jpeg)

之前轮播图只要有一个图片加载完，整个可滚动区域高度就确定了

现在这里要把所有图片加载完，因为每一张详情页下面的图片都会影响高度

```js
if (++this.counter === this.imagesLength)
```

也就是当计数器等于图片个数时才发送 imageLoad 事件

![3 [180].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663483617-286bdad5-bfbc-4b08-aa71-0b8d09aa0f8d.jpeg)

![3 [181].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663484199-9f367d66-504f-4dc7-9891-20593f6a76e1.jpeg)

每次获取图片个数时都需要写 this.detailInfo.detailImage[0].list.length，这样性能比较不好，

而且，不能直接 imagesLength: this.detailInfo.detailImage[0].list.length，

因为 detailInfo 默认是 {}，异步请求还没获得数据使，它传的就是 {}，所以 

imagesLength: undefined，imagesLength 是获取不到图片个数的

因此给 imagesLength 默认值先为 0，再使用 watch 监听 props 的 detailInfo 变化，

一旦 detailInfo 发生变化就可以获得最新的数据，获取到长度然后赋值给 imagesLength

![3 [182].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663484238-fde66b11-8a71-4b73-909b-488a6b2a8c71.jpeg)

DetailGoodsInfo.vue

```vue
<template>
  <div v-if="Object.keys(detailInfo).length !== 0" class="goods-info">
    <div class="info-desc clear-fix">
      <div class="start"></div>
      <div class="desc">{{detailInfo.desc}}</div>
      <div class="end"></div>
    </div>
    <div class="info-key">{{detailInfo.detailImage[0].key}}</div>
    <div class="info-list">
      <img v-for="(item, index) in detailInfo.detailImage[0].list"
      :key="index" :src="item" alt="" @load="imgLoad">
    </div>
  </div>
</template>

<script>
  export default {
    name: "DetailGoodsInfo",
    props: {
      detailInfo: {
        type: Object
      }
    },
    data() {
      return {
        counter: 0,
        imgLength: 0
      }
    },
    methods: {
      imgLoad() {
        if (++this.counter === this.imgLength) {
          this.$emit('imgLoad')
        }
      }
    },
    watch: {
      detailInfo() {
        this.imgLength = this.detailInfo.detailImage[0].list.length;
      }
    }
  }
</script>

<style scoped>
  .goods-info {
    padding: 20px 0;
    border-bottom: 5px solid #f2f5f8;
  }
  .info-desc {
    padding: 0 15px;
  }
  .info-desc .start, .info-desc .end {
    width: 90px;
    height: 1px;
    background-color: #a3a3a5;
    position: relative;
  }
  .info-desc .start {
    float: left;
  }
  .info-desc .end {
    float: right;
  }
  .info-desc .start::before, .info-desc .end::after {
    content: '';
    position: absolute;
    width: 5px;
    height: 5px;
    background-color: #333;
    bottom: 0;
  }
  .info-desc .end::after {
    right: 0;
  }
  .info-desc .desc {
    padding: 15px 0;
    font-size: 14px;
  }
  .info-key {
    margin: 10px 0 10px 15px;
    color: #333;
    font-size: 15px;
  }
  .info-list img {
    width: 100%;
  }
</style>
```

Detail.vue

```vue
<template>
  <div id="detail">
    <detail-nav-bar class="detail-nav"></detail-nav-bar>
    <scroll class="content" ref="scroll">
      <detail-swiper :topImages="topImages"></detail-swiper>
      <detail-base-info :goods="goods"></detail-base-info>
      <detail-shop-info :shop="shop"></detail-shop-info>
      <detail-goods-info :detailInfo="detailInfo" @imgLoad="imgLoad"></detail-goods-info>
    </scroll>
  </div>
</template>

<script>
  import DetailNavBar from './childCpns/DetailNavBar';
  import DetailSwiper from './childCpns/DetailSwiper';
  import DetailBaseInfo from './childCpns/DetailBaseInfo';
  import DetailShopInfo from './childCpns/DetailShopInfo';
  import Scroll from 'common/scroll/Scroll';
  import DetailGoodsInfo from './childCpns/DetailGoodsInfo';

  import {getDetailData, Goods, Shop} from 'network/detail';

  export default {
    name: 'Detail',
    data () {
      return {
        iid: null,
        topImages: [],
        goods: {},
        shop: {},
        detailInfo: {}
      }
    },
    methods: {
      imgLoad() {
        this.$refs.scroll.refresh();
      }
    },
    created () {
      this.iid = this.$route.params.iid;
      getDetailData(this.iid).then(res => {
        const data =  res.result;
        this.topImages = data.itemInfo.topImages;
        this.goods = new Goods(data.itemInfo, data.columns, data.shopInfo.services);
        this.shop = new Shop(data.shopInfo);
        this.detailInfo = data.detailInfo
      })
    },
    components: {
      DetailNavBar,
      DetailSwiper,
      DetailBaseInfo,
      DetailShopInfo,
      Scroll,
      DetailGoodsInfo
    }
  }
</script>
```

效果图

![3 [14].gif](https://cdn.nlark.com/yuque/0/2022/gif/1614731/1656660128763-801c54b3-ce9a-4c52-a6a6-6960a6abfe59.gif)

## 商品参数数据的展示

DetailParamsInfo.vue

```vue
<template>
  <div class="param-info" v-if="Object.keys(paramInfo).length !== 0">
    <table v-for="(table, index) in paramInfo.sizes"
           class="info-size" :key="index">
      <tr v-for="(tr, indey) in table" :key="indey">
        <td v-for="(td, indez) in tr" :key="indez">{{td}}</td>
      </tr>
    </table>
    <table class="info-param">
      <tr v-for="(info, index) in paramInfo.infos" :key="index">
        <td class="info-param-key">{{info.key}}</td>
        <td class="param-value">{{info.value}}</td>
      </tr>
    </table>
    <div class="info-img" v-if="paramInfo.image.length !== 0">
      <img :src="paramInfo.image" alt="">
    </div>
  </div>
</template>

<script>
  export default {
    name: "DetailParamInfo",
    props: {
      paramInfo: {
        type: Object
      }
    }
  }
</script>

<style scoped>
  .param-info {
    padding: 20px 15px;
    font-size: 14px;
    border-bottom: 5px solid #f2f5f8;
  }
  .param-info table {
    width: 100%;
    border-collapse: collapse;
  }
  .param-info table tr {
    height: 42px;
  }
  .param-info table tr td {
    border-bottom: 1px solid rgba(100,100,100,.1);
  }
  .info-param-key {
    /*当value的数据量比较大的时候, 会挤到key,所以给一个固定的宽度*/
    width: 95px;
  }
  .info-param {
    border-top: 1px solid rgba(0,0,0,.1);
  }
  .param-value {
    color: #eb4868
  }
  .info-img img {
    width: 100%;
  }
</style>
```

Detail.vue

```vue
<template>
  <div id="detail">
    <detail-nav-bar class="detail-nav"></detail-nav-bar>
    <scroll class="content" ref="scroll">
      <detail-swiper :topImages="topImages"></detail-swiper>
      <detail-base-info :goods="goods"></detail-base-info>
      <detail-shop-info :shop="shop"></detail-shop-info>
      <detail-goods-info :detailInfo="detailInfo" @imgLoad="imgLoad"></detail-goods-info>
      <detail-params-info :paramInfo="paramInfo"></detail-params-info>
    </scroll>
  </div>
</template>

<script>
  import DetailNavBar from './childCpns/DetailNavBar';
  import DetailSwiper from './childCpns/DetailSwiper';
  import DetailBaseInfo from './childCpns/DetailBaseInfo';
  import DetailShopInfo from './childCpns/DetailShopInfo';
  import Scroll from 'common/scroll/Scroll';
  import DetailGoodsInfo from './childCpns/DetailGoodsInfo';
  import DetailParamsInfo from './childCpns/DetailParamInfo';

  import {getDetailData, Goods, Shop, GoodsParam} from 'network/detail';
  export default {
    name: 'Detail',
    data () {
      return {
        iid: null,
        topImages: [],
        goods: {},
        shop: {},
        detailInfo: {},
        paramInfo: {}
      }
    },
    methods: {
      imgLoad() {
        this.$refs.scroll.refresh();
      }
    },
    created () {
      this.iid = this.$route.params.iid;
      getDetailData(this.iid).then(res => {
        const data =  res.result;
        this.topImages = data.itemInfo.topImages;
        this.goods = new Goods(data.itemInfo, data.columns, data.shopInfo.services);
        this.shop = new Shop(data.shopInfo);
        this.detailInfo = data.detailInfo;
        this.paramInfo = new GoodsParam(data.itemParams.info, data.itemParams.rule);
      })
    },
    components: {
      DetailNavBar,
      DetailSwiper,
      DetailBaseInfo,
      DetailShopInfo,
      Scroll,
      DetailGoodsInfo,
      DetailParamsInfo
    }
  }
</script>
```

效果图

![3 [15].gif](https://cdn.nlark.com/yuque/0/2022/gif/1614731/1656660128155-4bad80f4-c1a9-4fca-9650-b620c3369f9f.gif)

## 商品评论信息的展示

对评论信息数据进行获取然后进行展示（接口只有一条评论信息，其他的评论信息没有抓取）

![3 [183].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663484968-932f5f7f-ae33-4d79-9fda-630d29286eb1.jpeg)

![3 [184].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663485255-2fd6f905-f773-4016-8832-156c72540b1d.jpeg)

![3 [185].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663486230-e55c8462-adc5-4183-8321-d86b2b820617.jpeg)

目的是为了让用户点击更多，跳转到另一个页面里展示更多的评论信息

因为有些商家是没有评论的，所以在获取商家评论数据时要做个判断

```js
getDetailData(this.iid).then(res => {
  const data =  res.result;
  this.topImages = data.itemInfo.topImages;
  this.goods = new Goods(data.itemInfo, data.columns, data.shopInfo.services);
  this.shop = new Shop(data.shopInfo);
  this.detailInfo = data.detailInfo;
  this.paramInfo = new GoodsParam(data.itemParams.info, data.itemParams.rule);
  if (data.rate.list) {
    this.commentInfo = data.rate.list[0];
  }
})
```

返回评论信息时，服务器数据返回的日期是数字格式，并没有返回时间格式，这样更灵活

因为有些地方日期格式是不需要时分秒的，有些地方则需要，所以服务器返回的是时间戳，

即格林威治时间1970年01月01日00时00分00秒(北京时间1970年01月01日08时00分00秒)起至现在的总秒数。

![3 [186].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663486242-4863c0d8-531e-4b7f-8cf8-fc99c575fda9.jpeg)

时间格式化字符串

![3 [187].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663486943-9a76c18c-0919-4bc2-8fae-c385bdd24a14.jpeg?x-oss-process=image%2Fresize%2Cw_870%2Climit_0)

![3 [188].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663487192-b0313bab-e4c5-48a6-826c-6b43e6e98bf7.jpeg)

DetailCommentInfo.vue

{{commentInfo.created | showDate}} 使用过滤器，格式化时间

```vue
<template>
  <div>
    <div v-if="Object.keys(commentInfo).length !== 0" class="comment-info">
      <div class="info-header">
        <div class="header-title">用户评价</div>
        <div class="header-more">
          更多
          <i class="arrow-right"></i>
        </div>
      </div>
      <div class="info-user">
        <img :src="commentInfo.user.avatar" alt="">
        <span>{{commentInfo.user.uname}}</span>
      </div>
      <div class="info-detail">
        <p>{{commentInfo.content}}</p>
        <div class="info-other">
          <span class="date">{{commentInfo.created | showDate}}</span>
          <span>{{commentInfo.style}}</span>
        </div>
        <div class="info-imgs">
          <img :src="item" v-for="(item, index) in commentInfo.images" :key="index">
        </div>
      </div>
    </div>
  </div>
</template>

<script>
  import {formatDate} from "commonjs/utils.js";
  export default {
    name: "DetailCommentInfo",
    props: {
      commentInfo: {
        type: Object,
      }
    },
    filters: {
      showDate: function (value) {
        let date = new Date(value * 1000);
        return formatDate(date, 'yyyy-MM-dd')
      }
    }
  }
</script>

<style scoped>
  .comment-info {
    padding: 5px 12px;
    color: #333;
    border-bottom: 5px solid #f2f5f8;
  }
  .info-header {
    height: 50px;
    line-height: 50px;
    border-bottom: 1px solid rgba(0,0,0,.1);
  }
  .header-title {
    float: left;
    font-size: 15px;
  }
  .header-more {
    float: right;
    margin-right: 10px;
    font-size: 13px;
  }
  .info-user {
    padding: 10px 0 5px;
  }
  .info-user img {
    width: 42px;
    height: 42px;
    border-radius: 50%;
  }
  .info-user span {
    position: relative;
    font-size: 15px;
    top: -15px;
    margin-left: 10px;
  }
  .info-detail {
    padding: 0 5px 15px;
  }
  .info-detail p {
    font-size: 14px;
    color: #777;
    line-height: 1.5;
  }
  .info-detail .info-other {
    font-size: 12px;
    color: #999;
    margin-top: 10px;
  }
  .info-other .date {
    margin-right: 8px;
  }
  .info-imgs {
    margin-top: 10px;
  }
  .info-imgs img {
    width: 70px;
    height: 70px;
    margin-right: 5px;
  }
</style>
```

utils.js

Java 有格式化日期的方法，JS 没有，但是这个太常用了，肯定有人写过，就不必那么麻烦了，cv 大法

时间格式化很常用，很重要

```js
export function formatDate(date, fmt) {
  if (/(y+)/.test(fmt)) {
    fmt = fmt.replace(RegExp.$1, (date.getFullYear() + '').substr(4 - RegExp.$1.length));
    // 如果传的是'yyyy'，就是四位的 2019 + '' ，传的是'yy'，则是两位的 19 + ''
  }
  let o = {
    'M+': date.getMonth() + 1,
    'd+': date.getDate(),
    'h+': date.getHours(),
    'm+': date.getMinutes(),
    's+': date.getSeconds()
  };
  for (let k in o) {
    if (new RegExp(`(${k})`).test(fmt)) {
      let str = o[k] + '';
      fmt = fmt.replace(RegExp.$1, (RegExp.$1.length === 1) ? str : padLeftZero(str));
    }
  }
  return fmt;
};

// 旁边补一个0，即 01:01:01 ，而不是 1:1:1
function padLeftZero (str) {
  return ('00' + str).substr(str.length);
};
```

## 商品推荐数据的展示

![3 [189].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663487167-71e5bd95-a87f-4c16-9832-d8c1448fd03d.jpeg)

![3 [190].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663487745-a3fc353d-c848-41a3-be5f-3c1d7f5d5098.jpeg)

推荐数据属于不同接口，在这里有个 list，有 24 条数据

![3 [191].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663488372-3ec2342a-eb0b-4189-b4a8-3e3c6b6bfe51.jpeg)

要展示推荐数据，仍然第一件事是请求获取数据

detail.js

```js
import {request} from './request';

export function getDetailData(iid) {
  return request({
    url: '/detail',
    params: {
      iid
    }
  })
}

export class Goods {
  constructor(itemInfo, columns, services) {
    this.title = itemInfo.title;
    this.desc = itemInfo.desc;
    this.newPrice = itemInfo.price;
    this.oldPrice = itemInfo.oldPrice;
    this.discount = itemInfo.discountDesc;
    this.columns = columns;
    this.services = services;
    this.lowNowPrice = itemInfo.lowNowPrice;
    this.nowPrice = itemInfo.highNowPrice;
  }
}

export class Shop {
  constructor(shopInfo) {
    this.logo = shopInfo.shopLogo;
    this.name = shopInfo.name;
    this.fans = shopInfo.cFans;
    this.sells = shopInfo.cSells;
    this.score = shopInfo.score;
    this.goodsCount = shopInfo.cGoods
  }
}

export class GoodsParam {
  constructor(info, rule) {
    // 注: images可能没有值(某些商品有值, 某些没有值)
    this.image = info.images ? info.images[0] : "";
    this.infos = info.set;
    this.sizes = rule.tables;
  }
}

export function getRecommend() {
  return request({
    url: '/recommend'
  })
}
```

而要展示数据的话不用再搞个子组件了，因为这就是一个 GoodsList 组件，GoodsList 需要传的也正是一个数组，

所以可以 :goods="recommends"，将 recommends 数据传给 goods

`<goods-list>` 也需要滚动，所以把它放进 `<scroll>` 里

![3 [192].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663488672-86cf971f-09ac-47e0-89f2-cb474f5cbab8.jpeg)

Detail.vue

```vue
<template>
  <div id="detail">
    <detail-nav-bar class="detail-nav"></detail-nav-bar>
    <scroll class="content" ref="scroll">
      <detail-swiper :topImages="topImages"></detail-swiper>
      <detail-base-info :goods="goods"></detail-base-info>
      <detail-shop-info :shop="shop"></detail-shop-info>
      <detail-goods-info :detailInfo="detailInfo" @imgLoad="imgLoad"></detail-goods-info>
      <detail-params-info :paramInfo="paramInfo"></detail-params-info>
      <detail-comment-info :comment-info="commentInfo"></detail-comment-info>
      <goods-list :goods="recommends"></goods-list>
    </scroll>
  </div>
</template>

<script>
  import DetailNavBar from './childCpns/DetailNavBar';
  import DetailSwiper from './childCpns/DetailSwiper';
  import DetailBaseInfo from './childCpns/DetailBaseInfo';
  import DetailShopInfo from './childCpns/DetailShopInfo';
  import Scroll from 'common/scroll/Scroll';
  import DetailGoodsInfo from './childCpns/DetailGoodsInfo';
  import DetailParamsInfo from './childCpns/DetailParamInfo';
  import DetailCommentInfo from './childCpns/DetailCommentInfo';
  import GoodsList from 'content/goods/GoodsList';

  import {getDetailData, Goods, Shop, GoodsParam, getRecommend} from 'network/detail';

  export default {
    name: 'Detail',
    data () {
      return {
        iid: null,
        topImages: [],
        goods: {},
        shop: {},
        detailInfo: {},
        paramInfo: {},
        commentInfo: {},
        recommends: []
      }
    },
    methods: {
      imgLoad() {
        this.$refs.scroll.refresh();
      }
    },
    created () {
      this.iid = this.$route.params.iid;
      getDetailData(this.iid).then(res => {
        const data =  res.result;
        this.topImages = data.itemInfo.topImages;
        this.goods = new Goods(data.itemInfo, data.columns, data.shopInfo.services);
        this.shop = new Shop(data.shopInfo);
        this.detailInfo = data.detailInfo;
        this.paramInfo = new GoodsParam(data.itemParams.info, data.itemParams.rule);
        if (data.rate.list) {
          this.commentInfo = data.rate.list[0];
        }
      })
      getRecommend().then(res => {
        this.recommends = res.data.list
      })
    },
    components: {
      DetailNavBar,
      DetailSwiper,
      DetailBaseInfo,
      DetailShopInfo,
      Scroll,
      DetailGoodsInfo,
      DetailParamsInfo,
      DetailCommentInfo,
      GoodsList
    }
  }
</script>

<style scoped>
  #detail {
    position: relative;
    z-index: 1;
    height: 100vh;
    background-color: #fff;
  }
  .detail-nav {
    position: relative;
    z-index: 1;
    background-color: #fff;
  }
  .content {
    height: calc(100% - 44px);
  }
</style>
```

GoodsList.vue

```vue
<template>
  <div class="goods">
    <goods-item v-for="(item, index) in goods" :key="index" :goodsItem="item"></goods-item>
  </div>
</template>

<script>
  import GoodsItem from './GoodsItem'
  export default {
    name: 'GoodsList',
    props: {
      goods: {
        type: Array,
        default() {
          return []
        }
      }
    },
    components: {
      GoodsItem
    }
  }
</script>

<style scoped>
  .goods {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-around;
  }
</style>
```

![3 [193].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663489557-af1693e8-1432-428d-9a14-dca3d290f2a9.jpeg)

哪里读取 img 呢？很明显是 GooodsList Item 的 `<img>` src 特性读不到

因为 recommends 里没有 show 属性，只有 image 属性，所以不能读取

![3 [194].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663489604-1d907d1a-f915-40fd-90f6-fcdee30592b5.jpeg)

不能再这样读取了，所以有时要这样读有时不需要这样读

![3 [195].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663489652-19c5884c-0481-4498-8425-4cdd32c93829.jpeg)

使用计算属性搞一个判断，逻辑或前面为空直接执行后面的

GoodsListItem.vue

```vue
<template>
  <div class="goods-item" @click="itemClick">
    <img :src="showImg" @load="imgLoad">
    <div class="goods-info">
      <p>{{goodsItem.title}}</p>
      <span class="price">{{goodsItem.price}}</span>
      <span class="collect">{{goodsItem.cfav}}</span>
    </div>
  </div>
</template>

<script>
  export default {
    name: 'GoodsItem',
    props: {
      goodsItem: {
        type: Object,
        default() {
          return {}
        }
      }
    },
    computed: {
      showImg() {
        return this.goodsItem.image || this.goodsItem.show.img
      }    
    },
    methods: {
      imgLoad() {
        this.$bus.$emit('itemImgLoad')
      },
      itemClick() {
        this.$router.push('/detail/' + this.goodsItem.iid)
      }
    }
  }
</script>
```

![3 [16].gif](https://cdn.nlark.com/yuque/0/2022/gif/1614731/1656660130634-1c72786c-2998-4a08-bd4c-dbf8976fb6df.gif)

## 首页和详情页监听全局事件和 mixin 使用

详情页滚动问题：滚动很久又可以了

原因：其他图片加载完，大图没加载完造成无法滚动，所以等大图加载完再刷新一次计算可滚动区域高度

![3 [17].gif](https://cdn.nlark.com/yuque/0/2022/gif/1614731/1656660128402-bbb95a36-fdcd-4854-abff-de08c2e64808.gif)

详情页的 GoodListItem 通过 img 的 load 事件发送事件给了 Home，通知 Home 刷新，这是不合理的

怎么区分呢？可以通过路由判断，路由发现路径是 /home 时才发送事件，通知 Home 刷新，详情页也会出现滚动问题，也需要刷新

![3 [196].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663490243-b671cfe4-dd95-4cee-9f08-2dbfc7769266.jpeg)

可以使用第二种方法

![3 [197].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663490935-5be8d559-2a50-423b-8489-f8f32581a721.jpeg)

![3 [198].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663491124-0b7cb7ba-dfd7-498f-b8eb-7a39b8ef463e.jpeg)

Detail.vue

![3 [199].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663491265-5753ff3f-27eb-453e-83ad-3d72083d1ea9.jpeg)

Detail.vue 中 mounted() 的代码与  Home.vue 中 mounted() 的代码是相同的，所以要进行抽取，要使用新技术——混入 mixin

首先强调一点：这里不能使用继承，继承也可以减少重复的代码，但是是减少类里面的重复代码的，而这里是两个对象，所以这里不能用继承

用 Vue 中的 混入 mixin 减少组件之间重复的代码，混入 mixin 也是一个 JS 文件

![3 [200].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663493082-ddf080f0-45d9-45d0-9d26-b15f06180689.jpeg)

![3 [201].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663493086-62688d0a-3f2b-4ddd-88dd-16d0d69e2100.jpeg)

![3 [202].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663493618-27e1b468-c36f-4ec2-b25a-1c19cba93756.jpeg)

Home.vue 同理

混入 mixin 可以放更多的东西

![3 [203].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663493434-75527ba1-0e24-4570-845d-73d3e6a4e992.jpeg)

具体参考： https://cn.vuejs.org/v2/guide/mixins.html

mixin.js

```js
import { debounce } from "commonjs/utils.js";

export const itemListenerMixin = {
  data() {
    return {
      itemImgListener: null
    }
  },
  mounted() {
    const refresh = debounce(this.$refs.scroll.refresh, 50);
    this.itemImgListener = () => refresh();
    this.$bus.$on("itemImgLoad", this.itemImgListener);
  }
}
```

Home.vue

```vue
<template>
  <div id="home">
    <nav-bar class="nav">
      <div slot="center">购物街</div>
    </nav-bar>
    <tab-control :title="['流行', '新款', '精选']" @tabClick="tabClick"
                 class="fixed" v-show="isTabFixed"  ref="tabControl1">
    </tab-control>
    <scroll class="content"
            ref="scroll"
            :probe-type="3"
            :pull-up-load="true"
            @scroll="contentScroll"
            @pullingUp="loadMore">
      <home-swiper :banner="banner" @swiperImageLoad="swiperImageLoad"></home-swiper>
      <home-recommend :recommend="recommend"></home-recommend>
      <feature-view></feature-view>
      <tab-control :title="['流行', '新款', '精选']"  
                   @tabClick="tabClick"
                   ref="tabControl2" >
      </tab-control>
      <goods-list :goods="showGoods"></goods-list>
    </scroll>
    <back-up @click.native="backClick" class="back-up" v-show="isShowBackUp"></back-up>
  </div>
</template>
<script>
  
  import HomeSwiper from './childCpns/HomeSwiper';
  import HomeRecommend from './childCpns/HomeRecommend';
  import FeatureView from './childCpns/FeatureView';
  import NavBar from 'common/navbar/NavBar';
  import TabControl from 'content/tabControl/TabControl';
  import GoodsList from 'content/goods/GoodsList';
  import Scroll from 'common/scroll/Scroll';
  import BackUp from 'content/backUp/BackUp';

  import { getHomeMultidata, getHomeGoods } from 'network/home';

  import {itemListenerMixin} from 'commonjs/mixin';
  
  export default {
    name: 'Home',
    components: {    
      HomeSwiper,
      HomeRecommend,
      FeatureView,
      NavBar,
      TabControl,
      GoodsList,
      Scroll,
      BackUp
    },
    mixins: [itemListenerMixin],
    data() {
      return {
        banner: null,
        recommend: null,
        goods: {
          'pop': {page: 0, list: []},
          'new': {page: 0, list: []},
          'sell': {page: 0, list: []}
        },
        currentType: 'pop',
        isShowBackUp: false,
        tabOffsetTop: 0,
        isTabFixed: false,
        scrollY: 0     
      }    
    },
    computed: {
      showGoods() {
        return this.goods[this.currentType].list
      }
    },
    created() {
      this.getHomeMultidata();
      this.getHomeGoods('pop');
      this.getHomeGoods('new');
      this.getHomeGoods('sell');
    },
    activated () {
      this.$refs.scroll.refresh();
      this.$refs.scroll.scrollTo(0, this.scrollY, 0);     
    },
    deactivated () {
      this.scrollY = this.$refs.scroll.getScrollY();
      this.$bus.$off('itemImgLoad', this.itemImgListener);
    },
    methods: {
      // 事件监听
      tabClick(index) {
        switch(index) {
          case 0:
            this.currentType = 'pop';
            break;
          case 1:
            this.currentType = 'new';
            break;
          case 2:
            this.currentType = 'sell';
            break;   
        }
        this.$refs.tabControl1.currentIndex = index;
        this.$refs.tabControl2.currentIndex = index;
      },
      backClick() {
        this.$refs.scroll.scrollTo(0, 0, 300);
      },
      contentScroll(position) {
        this.isShowBackUp = (-position.y) > 1000;
        this.isTabFixed = (-position.y) > this.tabOffsetTop;
      },
      loadMore() {
        this.getHomeGoods(this.currentType);
        this.$refs.scroll.refresh();
      },
      swiperImageLoad() {       
        this.tabOffsetTop = this.$refs.tabControl2.$el.offsetTop;      
      },
      // 网络请求
      getHomeMultidata() {
        getHomeMultidata().then(res => {
          this.banner = res.data.banner.list;
          this.recommend = res.data.recommend.list;
        })
      },
      getHomeGoods(type) {
        const page = this.goods[type].page + 1;
        getHomeGoods(type, page).then(res => {
           this.goods[type].list.push(...res.data.list);
           this.goods[type].page += 1;
           this.$refs.scroll.finishPullUp();
        });        
      }
    }
  }
</script>
```

Detail.vue

```vue
<template>
  <div id="detail">
    <detail-nav-bar class="detail-nav"></detail-nav-bar>
    <scroll class="content" ref="scroll">
      <detail-swiper :topImages="topImages"></detail-swiper>
      <detail-base-info :goods="goods"></detail-base-info>
      <detail-shop-info :shop="shop"></detail-shop-info>
      <detail-goods-info :detailInfo="detailInfo" @imgLoad="imgLoad"></detail-goods-info>
      <detail-params-info :paramInfo="paramInfo"></detail-params-info>
      <detail-comment-info :comment-info="commentInfo"></detail-comment-info>
      <goods-list :goods="recommends"></goods-list>
    </scroll>
  </div>
</template>

<script>
  import DetailNavBar from './childCpns/DetailNavBar';
  import DetailSwiper from './childCpns/DetailSwiper';
  import DetailBaseInfo from './childCpns/DetailBaseInfo';
  import DetailShopInfo from './childCpns/DetailShopInfo';
  import Scroll from 'common/scroll/Scroll';
  import DetailGoodsInfo from './childCpns/DetailGoodsInfo';
  import DetailParamsInfo from './childCpns/DetailParamInfo';
  import DetailCommentInfo from './childCpns/DetailCommentInfo';
  import GoodsList from 'content/goods/GoodsList';

  import {getDetailData, Goods, Shop, GoodsParam, getRecommend} from 'network/detail';
  
  import {itemListenerMixin} from 'commonjs/mixin';

  export default {
    name: 'Detail',
    mixins: [itemListenerMixin],
    data () {
      return {
        iid: null,
        topImages: [],
        goods: {},
        shop: {},
        detailInfo: {},
        paramInfo: {},
        commentInfo: {},
        recommends: []
      }
    },
    methods: {
      imgLoad() {
        this.$refs.scroll.refresh();
      }
    },
    created () {
      this.iid = this.$route.params.iid;
      getDetailData(this.iid).then(res => {
        const data =  res.result;
        this.topImages = data.itemInfo.topImages;
        this.goods = new Goods(data.itemInfo, data.columns, data.shopInfo.services);
        this.shop = new Shop(data.shopInfo);
        this.detailInfo = data.detailInfo;
        this.paramInfo = new GoodsParam(data.itemParams.info, data.itemParams.rule);
        if (data.rate.list) {
          this.commentInfo = data.rate.list[0];
        }
      })
      getRecommend().then(res => {
        this.recommends = res.data.list
      })
    },
    destroyed() {
      this.$bus.$off('itemImgLoad', this.itemImgListener);
    },
    components: {
      DetailNavBar,
      DetailSwiper,
      DetailBaseInfo,
      DetailShopInfo,
      Scroll,
      DetailGoodsInfo,
      DetailParamsInfo,
      DetailCommentInfo,
      GoodsList
    }
  }
</script>
```

![3 [204].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663494186-d8660c4e-42b6-4b5f-b34b-0e3f18298573.jpeg)

![3 [205].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663494565-0d027671-7884-49f4-955d-e67a0195d872.jpeg)

![3 [206].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663494842-d979185a-d1b1-474c-9127-04ee8fa4c853.jpeg)

**做项目最重要的是理清好思路，而不是立即动手**

## 点击标题滚动到对应内容

**注意事项：属性和事件可以使用驼峰命名，但是特性必须使用短横线命名**

![3 [207].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663495030-c87ac903-eec1-422f-be28-9134c55eb0a5.jpeg)

要滚动到参数，必须获取参数组件的 offsetTop，评论就是获取评论组件的 offsetTop，推荐就是获取推荐组件的 offsetTop

![3 [207].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663495030-c87ac903-eec1-422f-be28-9134c55eb0a5.jpeg)

要滚动到参数，必须获取参数组件的 offsetTop，评论就是获取评论组件的 offsetTop，推荐就是获取推荐组件的 offsetTop

![3 [208].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663495066-644dcdbc-a950-4f97-8035-845b297ff9da.jpeg)

在 Detail.vue 的 mounted() 中获取offsetTop 不对，因为图片没有加载完，甚至异步请求的数据都还没有过来，

而且因为一些组件（如 DetailParams 参数组件）只有等数据请求下来了才显示，所以这时获取到的 offsetTop 是 undefined

![3 [209].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663495435-009e3af1-4912-4cd5-96ed-6463d737b2e1.jpeg)

异步请求了数据还有一个渲染的过程，有了数据后会执行 updated() 生命周期函数，对界面进行更新

但是 updated() 有个问题：就是更新频繁，因为只要有数据变化就会执行 updated()，会执行很多次

所以要每次执行时都要把  重置为空数组  []

下图为第一次 updated() 还没有请求下来数据，第二次updated() 时有数据，所以有值了

![3 [210].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663495441-754e09cc-02a7-4318-ac18-65283f01ba6c.jpeg)

当然也可以不在 updated() 里执行，但是在 created() 请求数据之后再执行就会获取不到元素（值不对的原因：元素没有渲染出来），

所以等数据赋值到组件过后要稍微等一会，等它完成渲染更新 DOM 后才能获取到 offsetTop 的值

渲染线程 和 JS执行线程 不是在同一个线程里，所以需要等待渲染完成

this.$nextTick() 下一帧，表示等待渲染完成后，执行里面的回调函数

![3 [211].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663496281-03bc9a75-81a9-44fd-ab53-1989044fd104.jpeg)

![3 [212].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663496140-72d2d95f-490f-4325-801a-e44dec4ad070.jpeg)

但是，这样还有一个问题：进入新的商品详情时，滚动的位置就不对了

![3 [213].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663496486-a2443288-45d4-48e0-818d-aaa0a7907336.jpeg)

因为 this.$nextTick() 根据最新的数据，对应的 DOM 是已经被渲染出来，

但是图片依然是没有加载完（目前的 offsetTop 是不包含图片的，值不对的原因：没有把图片计算在内）

之前可以是因为图片已经缓存下来了，再次刷新时就可以发现它重新把图片计算在内，滚动位置正确了

一旦重新从首页进入其他商品详情时，滚动位置仍然是错误的

总结： offsetTop 值不对是一般都是因为图片的问题

所以我们选择在图片 load 时，获取 offsetTop

下图可以发现只有第一次获取的值是不对的，但是后面的值都是对的，出现了重复调用过于频繁的问题

![3 [214].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663497315-7f09c932-4637-48f8-9444-cc6f02a32595.jpeg)

![3 [215].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663497271-bb2a6c23-7234-424b-aab8-abf4838778a1.jpeg)

![3 [216].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663497437-1a4fb631-c168-4adf-9b0a-536da4755ae4.jpeg)

![3 [217].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663497993-eb666d01-d7ba-4d3b-9401-a7a40da9fe94.jpeg)

![3 [218].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663498803-1ec31041-9c89-4c17-a0bd-a9628c1dc9dd.jpeg)

DeatailNavBar.vue

```vue
<template>
  <nav-bar>
    <div slot="left" class="back" @click="backClick">
      <img src="~assets/img/common/back.svg">
    </div>
    <div slot="center" class="title">
      <div class="item" :class="{active: index === currentIndex}"
            @click="tabClick(index)" v-for="(item, index) of title" :key="index">
        {{item}}
      </div>
    </div>
  </nav-bar>
</template>

<script>
  import NavBar from 'common/navbar/NavBar'
  export default {
    name: 'DetailNavBar',
    data() {
      return {
        title: ['商品', '详情', '评论', '推荐'],
        currentIndex: 0
      }
    },
    methods: {
      tabClick(index) {
        this.currentIndex = index;
        this.$emit('titleClick', index);
      },
      backClick() {
        this.$router.back();
      }
    },
    components: {
      NavBar
    }
  }
</script>
```

Detail.vue

```vue
<template>
  <div id="detail">
    <detail-nav-bar class="detail-nav" @titleClick="titleClick"></detail-nav-bar>
    <scroll class="content" ref="scroll">
      <detail-swiper :topImages="topImages"></detail-swiper>
      <detail-base-info :goods="goods"></detail-base-info>
      <detail-shop-info :shop="shop"></detail-shop-info>
      <detail-goods-info :detailInfo="detailInfo" @imgLoad="imgLoad"></detail-goods-info>
      <detail-params-info :paramInfo="paramInfo" ref="params"></detail-params-info>
      <detail-comment-info :comment-info="commentInfo" ref="comment"></detail-comment-info>
      <goods-list :goods="recommends" ref="recommend"></goods-list>
    </scroll>
  </div>
</template>

<script>
  import DetailNavBar from './childCpns/DetailNavBar';
  import DetailSwiper from './childCpns/DetailSwiper';
  import DetailBaseInfo from './childCpns/DetailBaseInfo';
  import DetailShopInfo from './childCpns/DetailShopInfo';
  import Scroll from 'common/scroll/Scroll';
  import DetailGoodsInfo from './childCpns/DetailGoodsInfo';
  import DetailParamsInfo from './childCpns/DetailParamInfo';
  import DetailCommentInfo from './childCpns/DetailCommentInfo';
  import GoodsList from 'content/goods/GoodsList';

  import {getDetailData, Goods, Shop, GoodsParam, getRecommend} from 'network/detail';

  import { debounce } from "commonjs/utils.js";
  import {itemListenerMixin} from 'commonjs/mixin';

  export default {
    name: 'Detail',
    mixins: [itemListenerMixin],
    data () {
      return {
        iid: null,
        topImages: [],
        goods: {},
        shop: {},
        detailInfo: {},
        paramInfo: {},
        commentInfo: {},
        recommends: [],
        titleTopY: [],
        getTitleTopY: null
      }
    },
    created () {
      this.iid = this.$route.params.iid;
      getDetailData(this.iid).then(res => {
        const data =  res.result;
        this.topImages = data.itemInfo.topImages;
        this.goods = new Goods(data.itemInfo, data.columns, data.shopInfo.services);
        this.shop = new Shop(data.shopInfo);
        this.detailInfo = data.detailInfo;
        this.paramInfo = new GoodsParam(data.itemParams.info, data.itemParams.rule);
        if (data.rate.list) {
          this.commentInfo = data.rate.list[0];
        }
      })
      getRecommend().then(res => {
        this.recommends = res.data.list
      })
      this.getTitleTopY = debounce(() => {
        this.titleTopY = [];
        this.titleTopY.push(0);
        this.titleTopY.push(this.$refs.params.$el.offsetTop);
        this.titleTopY.push(this.$refs.comment.$el.offsetTop);
        this.titleTopY.push(this.$refs.recommend.$el.offsetTop);
      }, 100)
    },
    destroyed() {
      this.$bus.$off('itemImgLoad', this.itemImgListener);
    },
    methods: {
      imgLoad() {
        this.$refs.scroll.refresh();
        this.getTitleTopY();
      },
      titleClick(index) {
        this.$refs.scroll.scrollTo(0, -this.titleTopY[index] + 44, 100)
      }
    },
    components: {
      DetailNavBar,
      DetailSwiper,
      DetailBaseInfo,
      DetailShopInfo,
      Scroll,
      DetailGoodsInfo,
      DetailParamsInfo,
      DetailCommentInfo,
      GoodsList
    }
  }
</script>
```

![3 [219].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663499269-0e1c091c-ebad-4f4f-a435-aba392477e17.jpeg)

效果图

![3.gif](https://cdn.nlark.com/yuque/0/2022/gif/1614731/1656660214156-da069d58-33e4-4d5e-8a26-eea1810eb2df.gif)

## 滚动内容显示对应标题

![3.jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663602590-0d71c45d-f0fa-4421-8edd-e221eb5dda66.jpeg?x-oss-process=image%2Fresize%2Cw_929%2Climit_0)

![3 [1].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663566107-b6d89c2c-c60b-4a93-96fe-4fa9e0d42731.jpeg)

![3 [2].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663566122-107d1f48-0ed6-45a0-ad30-fb78c376159f.jpeg)

i < length - 1 表示 0 、1、2 前三种情况时

i === length - 1 表示 最后一种情况，即大于等于 9120 值时

由于打印 this.currentIndex 时太频繁，使用 this.currentIndex !== i 表示 currentIndex 与 i 不一致时才把 i  赋值给 currentIndex  

![3 [3].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663566109-72dddc01-dd19-48e0-8acc-c39c7655f39c.jpeg)

当 i 为 0 0 0 时，由于 this.currentIndex 为 0 所以不打印，

当 i 为 1 1 1 时，由于第一个 1时执行了 this.currentIndex = i ，所以 this.currentIndex = 1，

等到第二个 1 时，由于 this.currentIndex === i，所以不会执行后面的条件，也就不会执行 this.currentIndex = i，打印 this.currentIndex

依此类推，所以 1、2 、3 只打印一次

![3 [4].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663566078-897825d4-12e0-42cc-bcff-4e37cab11296.jpeg)

对复杂判断条件进行分析和优化

![3 [5].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663566134-8875d0bb-f9a6-41f8-9380-46ebefa819cc.jpeg)

JS 能传的最大值是 Number.MAX__VALUE，但是存那么大的值会有内存问题，虽然 number 会占空间，但是它占的空间不会特别多

![3 [6].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663567047-11d2d8d6-00f9-480b-83ce-ae748f8a9ec4.jpeg)

![3 [7].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663567384-aad658fd-0a92-4620-a386-eb5fb9c74742.jpeg)

当判断条件特别多时也会影响性能的，比如上图注释的判断条件

操作系统里有句话叫：用空间换时间，多一些变量多占一点空间，但是目的是为了提高运算性能

![3 [8].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663568290-51c77b90-87ca-43b0-995c-b16cfb4a9bbe.jpeg)

Detail.vue

```vue
<template>
  <div id="detail">
    <detail-nav-bar class="detail-nav" @titleClick="titleClick" ref="nav"></detail-nav-bar>
    <scroll class="content" ref="scroll" :probe-type="3" @scroll="contentScroll">
      <detail-swiper :topImages="topImages"></detail-swiper>
      <detail-base-info :goods="goods"></detail-base-info>
      <detail-shop-info :shop="shop"></detail-shop-info>
      <detail-goods-info :detailInfo="detailInfo" @imgLoad="imgLoad"></detail-goods-info>
      <detail-params-info :paramInfo="paramInfo" ref="params"></detail-params-info>
      <detail-comment-info :comment-info="commentInfo" ref="comment"></detail-comment-info>
      <goods-list :goods="recommends" ref="recommend"></goods-list>
    </scroll>
  </div>
</template>

<script>
  import DetailNavBar from './childCpns/DetailNavBar';
  import DetailSwiper from './childCpns/DetailSwiper';
  import DetailBaseInfo from './childCpns/DetailBaseInfo';
  import DetailShopInfo from './childCpns/DetailShopInfo';
  import Scroll from 'common/scroll/Scroll';
  import DetailGoodsInfo from './childCpns/DetailGoodsInfo';
  import DetailParamsInfo from './childCpns/DetailParamInfo';
  import DetailCommentInfo from './childCpns/DetailCommentInfo';
  import GoodsList from 'content/goods/GoodsList';

  import {getDetailData, Goods, Shop, GoodsParam, getRecommend} from 'network/detail';

  import { debounce } from "commonjs/utils.js";
  import {itemListenerMixin} from 'commonjs/mixin';

  export default {
    name: 'Detail',
    mixins: [itemListenerMixin],
    data () {
      return {
        iid: null,
        topImages: [],
        goods: {},
        shop: {},
        detailInfo: {},
        paramInfo: {},
        commentInfo: {},
        recommends: [],
        titleTopY: [],
        getTitleTopY: null,
        currentIndex: 0,
      }
    },
    created () {
      this.iid = this.$route.params.iid;
      getDetailData(this.iid).then(res => {
        const data =  res.result;
        this.topImages = data.itemInfo.topImages;
        this.goods = new Goods(data.itemInfo, data.columns, data.shopInfo.services);
        this.shop = new Shop(data.shopInfo);
        this.detailInfo = data.detailInfo;
        this.paramInfo = new GoodsParam(data.itemParams.info, data.itemParams.rule);
        if (data.rate.list) {
          this.commentInfo = data.rate.list[0];
        }
      })
      getRecommend().then(res => {
        this.recommends = res.data.list
      })
      this.getTitleTopY = debounce(() => {
        this.titleTopY = [];
        this.titleTopY.push(0);
        this.titleTopY.push(this.$refs.params.$el.offsetTop);
        this.titleTopY.push(this.$refs.comment.$el.offsetTop);
        this.titleTopY.push(this.$refs.recommend.$el.offsetTop);
        this.titleTopY.push(Number.MAX_VALUE);
      }, 100)
    },
    destroyed() {
      this.$bus.$off('itemImgLoad', this.itemImgListener);
    },
    methods: {
      imgLoad() {
        this.$refs.scroll.refresh();
        this.getTitleTopY();
      },
      titleClick(index) {
        this.$refs.scroll.scrollTo(0, -this.titleTopY[index] + 44, 100)
      },
      contentScroll(position) {
        let positionY = -position.y;
        let length = this.titleTopY.length;
        for (let i = 0; i < length - 1; i++) {
          if (this.currentIndex !== i &&
          (positionY >= this.titleTopY[i] - 44 && positionY < this.titleTopY[i + 1])) {
            this.currentIndex = i;
            this.$refs.nav.currentIndex = this.currentIndex;
          }
        }  
      }
    },
    components: {
      DetailNavBar,
      DetailSwiper,
      DetailBaseInfo,
      DetailShopInfo,
      Scroll,
      DetailGoodsInfo,
      DetailParamsInfo,
      DetailCommentInfo,
      GoodsList
    }
  }
</script>
```

效果图

![3 [1].gif](https://cdn.nlark.com/yuque/0/2022/gif/1614731/1656660216355-31cb378a-2c74-4e7b-b344-b2c3255462ce.gif)

## 底部工具栏的封装

![3 [9].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663568925-554bd951-3178-45d5-8ace-f8c9862b340d.jpeg)

## BackTop 的混入封装

为了不重复复制代码到 Detail.vue，所以要把两个组件公共的代码抽离出去

![3 [10].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663569060-7320c86b-2e5d-48dd-961c-23de9bbd4819.jpeg)

mixin 不能对 methods 的方法进行抽取，然后合二为一，所以 mixin 的方法名不能与 methods 方法名相同（同名时 mixin 会覆盖 methods 的方法），

其他如 components、data()、生命周期函数名字等可以相同

可以这样抽：

![3 [11].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663569308-ba0c7888-9805-494e-875c-6cb9609d9062.jpeg)

正式的抽法：

![3 [12].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663569585-8041fcd0-4cc7-4c7a-a56f-b6f88d65d2d0.jpeg)



![3 [13].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663569658-e70a4b7e-3f2b-4999-b2b0-1ca6639fc430.jpeg)



![3 [14].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663570240-82b0b272-86ef-4075-9cf3-d3b1e510d512.jpeg)



![3 [15].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663570814-6db23367-c8f2-413d-99ba-34e6cafef578.jpeg?x-oss-process=image%2Fresize%2Cw_929%2Climit_0)



![3 [16].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663571403-fefc2c3d-370b-432c-84f7-c5fb35981908.jpeg)

mixin.js

```js
import { debounce } from "commonjs/utils.js";
import BackUp from "content/backUp/BackUp";

export const itemListenerMixin = {
  data() {
    return {
      itemImgListener: null
    }
  },
  mounted() {
    const refresh = debounce(this.$refs.scroll.refresh, 50);
    this.itemImgListener = () => refresh();
    this.$bus.$on("itemImgLoad", this.itemImgListener);
  }

}

export const backUpMixin = {
  components: {
    BackUp
  },
  data() {
    return {
      isShowBackUp: false
    }
  },
  methods: {
    backClick() {
      this.$refs.scroll.scrollTo(0, 0, 300);
    },
    listenShowBackUp(position) {
      this.isShowBackUp = -position.y > 1000;
    }
  }
}
```

Detail.vue

```vue
<template>
  <div id="detail">
    <detail-nav-bar class="detail-nav" @titleClick="titleClick" ref="nav"></detail-nav-bar>
    <scroll class="content" ref="scroll" :probe-type="3" @scroll="contentScroll">
      <detail-swiper :topImages="topImages"></detail-swiper>
      <detail-base-info :goods="goods"></detail-base-info>
      <detail-shop-info :shop="shop"></detail-shop-info>
      <detail-goods-info :detailInfo="detailInfo" @imgLoad="imgLoad"></detail-goods-info>
      <detail-params-info :paramInfo="paramInfo" ref="params"></detail-params-info>
      <detail-comment-info :comment-info="commentInfo" ref="comment"></detail-comment-info>
      <goods-list :goods="recommends" ref="recommend"></goods-list>
    </scroll>
    <back-up @click.native="backClick" class="back-up" v-show="isShowBackUp"></back-up>
    <detail-bottom-bar></detail-bottom-bar>
  </div>
</template>

<script>
  import DetailNavBar from './childCpns/DetailNavBar';
  import DetailSwiper from './childCpns/DetailSwiper';
  import DetailBaseInfo from './childCpns/DetailBaseInfo';
  import DetailShopInfo from './childCpns/DetailShopInfo';
  import Scroll from 'common/scroll/Scroll';
  import DetailGoodsInfo from './childCpns/DetailGoodsInfo';
  import DetailParamsInfo from './childCpns/DetailParamInfo';
  import DetailCommentInfo from './childCpns/DetailCommentInfo';
  import GoodsList from 'content/goods/GoodsList';
  import DetailBottomBar from './childCpns/DetailBottomBar';

  import {getDetailData, Goods, Shop, GoodsParam, getRecommend} from 'network/detail';
  
  import { debounce } from "commonjs/utils.js";
  import {itemListenerMixin, backUpMixin } from 'commonjs/mixin';

  export default {
    name: 'Detail',
    mixins: [itemListenerMixin, backUpMixin],
    data () {
      return {
        iid: null,
        topImages: [],
        goods: {},
        shop: {},
        detailInfo: {},
        paramInfo: {},
        commentInfo: {},
        recommends: [],
        titleTopY: [],
        getTitleTopY: null,
        currentIndex: 0,
      }
    },
    created () {
      this.iid = this.$route.params.iid;
      getDetailData(this.iid).then(res => {
        const data =  res.result;
        this.topImages = data.itemInfo.topImages;
        this.goods = new Goods(data.itemInfo, data.columns, data.shopInfo.services);
        this.shop = new Shop(data.shopInfo);
        this.detailInfo = data.detailInfo;
        this.paramInfo = new GoodsParam(data.itemParams.info, data.itemParams.rule);
        if (data.rate.list) {
          this.commentInfo = data.rate.list[0];
        }
      })
      getRecommend().then(res => {
        this.recommends = res.data.list
      })
      this.getTitleTopY = debounce(() => {
        this.titleTopY = [];
        this.titleTopY.push(0);
        this.titleTopY.push(this.$refs.params.$el.offsetTop);
        this.titleTopY.push(this.$refs.comment.$el.offsetTop);
        this.titleTopY.push(this.$refs.recommend.$el.offsetTop);
        this.titleTopY.push(Number.MAX_VALUE);
      }, 100)
    },
    destroyed() {
      this.$bus.$off('itemImgLoad', this.itemImgListener);
    },
    methods: {
      imgLoad() {
        this.$refs.scroll.refresh();
        this.getTitleTopY();
      },
      titleClick(index) {
        this.$refs.scroll.scrollTo(0, -this.titleTopY[index] + 44, 100)
      },
      contentScroll(position) {
        let positionY = -position.y;
        let length = this.titleTopY.length;
        for (let i = 0; i < length - 1; i++) {
          if (this.currentIndex !== i &&
          (positionY >= this.titleTopY[i] && positionY < this.titleTopY[i + 1])) {
            this.currentIndex = i;
            this.$refs.nav.currentIndex = this.currentIndex;
          }
        }  
        this.listenShowBackUp(position)
      }
    },
    components: {
      DetailNavBar,
      DetailSwiper,
      DetailBaseInfo,
      DetailShopInfo,
      Scroll,
      DetailGoodsInfo,
      DetailParamsInfo,
      DetailCommentInfo,
      GoodsList,
      DetailBottomBar,
    }
  }
</script>

<style scoped>
  #detail {
    position: relative;
    z-index: 1;
    height: 100vh;
    background-color: #fff;
  }
  .detail-nav {
    position: relative;
    z-index: 1;
    background-color: #fff;
  }
  .content {
    height: calc(100% - 102px);
  }
  .back-up {
    position: fixed;
    right: 8px;
    bottom: 55px;  
  }
</style>
```

DetailBottomBar.vue

```vue
<template>
  <div class="bottom-bar">
    <div class="bar-item bar-left">
      <div>
        <i class="icon service"></i>
        <span class="text">客服</span>
      </div>
      <div>
        <i class="icon shop"></i>
        <span class="text">店铺</span>
      </div>
      <div>
        <i class="icon select"></i>
        <span class="text">收藏</span>
      </div>
    </div>
    <div class="bar-item bar-right">
      <div class="cart" @click="addToCart">加入购物车</div>
      <div class="buy">购买</div>
    </div>
  </div>
</template>

<script>
  export default {
    name: "DetailBottomBar",
    methods: {
      addToCart() {
        this.$emit('addToCart')
      }
    }
  }
</script>

<style scoped>
  .bottom-bar {
    height: 58px;
    position: relative;
    background-color: #fff;
    display: flex;
    text-align: center;
  }
  .bar-item {
    flex: 1;
    display: flex;
  }
  .bar-item>div {
    flex: 1;
  }
  .bar-left .text {
    font-size: 13px;
  }
  .bar-left .icon {
    display: block;
    width: 22px;
    height: 22px;
    margin: 10px auto 3px;
    background: url("~assets/img/detail/detail_bottom.png") 0 0/100%;
  }
  .bar-left .service {
    background-position: 0 -54px;
  }
  .bar-left .shop {
    background-position: 0 -98px;
  }
  .bar-right {
    font-size: 15px;
    color: #fff;
    line-height: 58px;
  }
  .bar-right .cart {
    background-color: #ffe817;
    color: #333;
  }
  .bar-right .buy {
    background-color: #f69;
  }
</style>
```

Home.vue

```vue
<template>
  <div id="home">
    <nav-bar class="nav">
      <div slot="center">购物街</div>
    </nav-bar>
    <tab-control :title="['流行', '新款', '精选']" @tabClick="tabClick"
                 class="fixed" v-show="isTabFixed"  ref="tabControl1">
    </tab-control>
    <scroll class="content"
            ref="scroll"
            :probe-type="3"
            :pull-up-load="true"
            @scroll="contentScroll"
            @pullingUp="loadMore">
      <home-swiper :banner="banner" @swiperImageLoad="swiperImageLoad"></home-swiper>
      <home-recommend :recommend="recommend"></home-recommend>
      <feature-view></feature-view>
      <tab-control :title="['流行', '新款', '精选']"  
                   @tabClick="tabClick"
                   ref="tabControl2" >
      </tab-control>
      <goods-list :goods="showGoods"></goods-list>
    </scroll>
    <back-up @click.native="backClick" class="back-up" v-show="isShowBackUp"></back-up>
  </div>
</template>
<script>
  
  import HomeSwiper from './childCpns/HomeSwiper';
  import HomeRecommend from './childCpns/HomeRecommend';
  import FeatureView from './childCpns/FeatureView';
  import NavBar from 'common/navbar/NavBar';
  import TabControl from 'content/tabControl/TabControl';
  import GoodsList from 'content/goods/GoodsList';
  import Scroll from 'common/scroll/Scroll';

  import { getHomeMultidata, getHomeGoods } from 'network/home';

  import {itemListenerMixin, backUpMixin} from 'commonjs/mixin';
  
  export default {
    name: 'Home',
    components: {    
      HomeSwiper,
      HomeRecommend,
      FeatureView,
      NavBar,
      TabControl,
      GoodsList,
      Scroll
    },
    mixins: [itemListenerMixin, backUpMixin],
    data() {
      return {
        banner: null,
        recommend: null,
        goods: {
          'pop': {page: 0, list: []},
          'new': {page: 0, list: []},
          'sell': {page: 0, list: []}
        },
        currentType: 'pop',
        tabOffsetTop: 0,
        isTabFixed: false,
        scrollY: 0     
      }    
    },
    computed: {
      showGoods() {
        return this.goods[this.currentType].list
      }
    },
    created() {
      this.getHomeMultidata();
      this.getHomeGoods('pop');
      this.getHomeGoods('new');
      this.getHomeGoods('sell');
    },
    activated () {
      this.$refs.scroll.refresh();
      this.$refs.scroll.scrollTo(0, this.scrollY, 0);     
    },
    deactivated () {
      this.scrollY = this.$refs.scroll.getScrollY();
      this.$bus.$off('itemImgLoad', this.itemImgListener);
    },
    methods: {
      // 事件监听
      tabClick(index) {
        switch(index) {
          case 0:
            this.currentType = 'pop';
            break;
          case 1:
            this.currentType = 'new';
            break;
          case 2:
            this.currentType = 'sell';
            break;   
        }
        this.$refs.tabControl1.currentIndex = index;
        this.$refs.tabControl2.currentIndex = index;
      },
      contentScroll(position) {
        this.listenShowBackUp(position);
        this.isTabFixed = (-position.y) > this.tabOffsetTop;
      },
      loadMore() {
        this.getHomeGoods(this.currentType);
        this.$refs.scroll.refresh();
      },
      swiperImageLoad() {       
        this.tabOffsetTop = this.$refs.tabControl2.$el.offsetTop;      
      },
      // 网络请求
      getHomeMultidata() {
        getHomeMultidata().then(res => {
          this.banner = res.data.banner.list;
          this.recommend = res.data.recommend.list;
        })
      },
      getHomeGoods(type) {
        const page = this.goods[type].page + 1;
        getHomeGoods(type, page).then(res => {
           this.goods[type].list.push(...res.data.list);
           this.goods[type].page += 1;
           this.$refs.scroll.finishPullUp();
        });        
      }
    }
  }
</script>
<style scoped>
  #home {
    height: 100vh;
  }
  .nav {
    background-color: var(--color-tint);
    color: #fff;
    position: relative;
    z-index: 1;
  }
  .content {
    position: absolute;
    top: 44px;
    bottom: 49px;
    left: 0;
    right: 0;   
  }
  .back-up {
    position: fixed;
    right: 8px;
    bottom: 55px;  
  }
  .fixed {
    position: fixed;
    top: 44px;
    left: 0;
    right: 0;   
    z-index: 1;
    background-color: #fff;
  }
</style>
```

效果图

![3 [2].gif](https://cdn.nlark.com/yuque/0/2022/gif/1614731/1656660215460-76801419-214e-449c-98ce-e2381bd77787.gif)

coderwhy 老师喜欢使用 relative 进行微调

Bug：首页其实应该监听三张图片全部加载完毕再刷新

## 将商品添加到购物车中

![3 [17].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663572680-2093a350-c19d-4302-a4bc-17be86cd90e2.jpeg)

要知道获取哪些商品信息才能知道怎么做购物车（图片、标题、描述、价格、数量）

在这个购物车里，有个不足就是：无法任意选择数量，必须返回再点击一次加入购物车才能增加数量

注意：加入购物车时必须带有 id ，给服务器使用

使用事件总线的话，如果购物车组件压根没有创建出来，也就没法监听到 product 的值了

![3 [18].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663573463-a8c91fd2-8b15-4869-8b46-529449a31d3c.jpeg?x-oss-process=image%2Fresize%2Cw_929%2Climit_0)

假如使用 Vuex ，如果有其他页面也有加入购物车功能，那么 Vuex 就可以一并处理了

![3 [19].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663573419-ad2365c6-8c4e-4c58-8e2e-ffcfcf0b52cb.jpeg)

![3 [20].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663573567-75fb3abb-75ee-4a3e-a226-bf1c78bbff3f.jpeg)

![3 [21].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663573812-db9ef723-9cb0-4cd0-a923-a334d0ac0c9a.jpeg)

## Vuex 代码的重构

mutations 做的事要尽量单一，而不是像下面这样要么加 1，要么添加新的商品，这样方便在调试工具中对状态进行跟踪

![3 [22].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663575133-bb3b19a5-ad30-4ad9-9d36-8b070330f6f5.jpeg)

所以建议把多余的逻辑放到 actions 里

![3 [23].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663575243-a71b6770-7dee-4813-8592-7c92fb73e116.jpeg)

![3 [24].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663575471-1957d6a8-e808-49c0-af4d-fea7adc51f54.jpeg)

![3 [25].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663575803-a8740f30-e698-4520-b89d-45ca1a0818a8.jpeg)

再次优化

![3 [26].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663575854-29bb2708-ecad-4c14-9e9b-c29a0463d3b0.jpeg)

![3 [27].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663575999-e8e054a0-416f-4df0-9082-f59bec27c466.jpeg)

![3 [28].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663577116-953c791d-be53-48e8-9a4b-ec0dca712a3a.jpeg)

![3 [29].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663577465-b052675c-f51f-4a53-aeba-8fc5efb172ec.jpeg)

## Vuex 知识点

实现购物车页面

![3 [30].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663577534-b95b599e-a58e-43bf-b3c5-35dca0741fce.jpeg)

购物车() 括号里的数字应该通过 Vuex 的 cartList 传给它

![3 [31].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663578090-76f7adf9-4eeb-43c0-9549-d4cb00472365.jpeg)

第一种办法是计算属性

![3 [32].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663578488-191f975c-9fb9-44ae-a753-a3fdf4472d4f.jpeg)

第二种办法是使用 Vuex 的 getters，使用 cartList 的地方多时适合使用 getters，

mapGetters 将 getters 里的函数直接映射为 computed 里的局部计算属性

![3 [33].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663578564-74ba8a04-bed4-406b-ac1a-3b1df87ea24b.jpeg)

![3 [34].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663578797-10cc7a38-dc0c-4f5b-b693-743a02cddf85.jpeg)

Deatail.vue

```vue
<template>
  <div id="detail">
    <detail-nav-bar class="detail-nav" @titleClick="titleClick" ref="nav"></detail-nav-bar>
    <scroll class="content" ref="scroll" :probe-type="3" @scroll="contentScroll">
      <detail-swiper :topImages="topImages"></detail-swiper>
      <detail-base-info :goods="goods"></detail-base-info>
      <detail-shop-info :shop="shop"></detail-shop-info>
      <detail-goods-info :detailInfo="detailInfo" @imgLoad="imgLoad"></detail-goods-info>
      <detail-params-info :paramInfo="paramInfo" ref="params"></detail-params-info>
      <detail-comment-info :comment-info="commentInfo" ref="comment"></detail-comment-info>
      <goods-list :goods="recommends" ref="recommend"></goods-list>
    </scroll>
    <back-up @click.native="backClick" class="back-up" v-show="isShowBackUp"></back-up>
    <detail-bottom-bar @addToCart="addToCart"></detail-bottom-bar>
  </div>
</template>

<script>
  import DetailNavBar from './childCpns/DetailNavBar';
  import DetailSwiper from './childCpns/DetailSwiper';
  import DetailBaseInfo from './childCpns/DetailBaseInfo';
  import DetailShopInfo from './childCpns/DetailShopInfo';
  import Scroll from 'common/scroll/Scroll';
  import DetailGoodsInfo from './childCpns/DetailGoodsInfo';
  import DetailParamsInfo from './childCpns/DetailParamInfo';
  import DetailCommentInfo from './childCpns/DetailCommentInfo';
  import GoodsList from 'content/goods/GoodsList';
  import DetailBottomBar from './childCpns/DetailBottomBar';
  import {getDetailData, Goods, Shop, GoodsParam, getRecommend} from 'network/detail';
  
  import { debounce } from "commonjs/utils.js";
  import {itemListenerMixin, backUpMixin } from 'commonjs/mixin';
  export default {
    name: 'Detail',
    mixins: [itemListenerMixin, backUpMixin],
    data () {
      return {
        iid: null,
        topImages: [],
        goods: {},
        shop: {},
        detailInfo: {},
        paramInfo: {},
        commentInfo: {},
        recommends: [],
        titleTopY: [],
        getTitleTopY: null,
        currentIndex: 0,
      }
    },
    created () {
      this.iid = this.$route.params.iid;
      getDetailData(this.iid).then(res => {
        const data =  res.result;
        this.topImages = data.itemInfo.topImages;
        this.goods = new Goods(data.itemInfo, data.columns, data.shopInfo.services);
        this.shop = new Shop(data.shopInfo);
        this.detailInfo = data.detailInfo;
        this.paramInfo = new GoodsParam(data.itemParams.info, data.itemParams.rule);
        if (data.rate.list) {
          this.commentInfo = data.rate.list[0];
        }
      })
      getRecommend().then(res => {
        this.recommends = res.data.list
      })
      this.getTitleTopY = debounce(() => {
        this.titleTopY = [];
        this.titleTopY.push(0);
        this.titleTopY.push(this.$refs.params.$el.offsetTop);
        this.titleTopY.push(this.$refs.comment.$el.offsetTop);
        this.titleTopY.push(this.$refs.recommend.$el.offsetTop);
        this.titleTopY.push(Number.MAX_VALUE);
      }, 100)
    },
    destroyed() {
      this.$bus.$off('itemImgLoad', this.itemImgListener);
    },
    methods: {
      imgLoad() {
        this.$refs.scroll.refresh();
        this.getTitleTopY();
      },
      titleClick(index) {
        this.$refs.scroll.scrollTo(0, -this.titleTopY[index] + 44, 100)
      },
      contentScroll(position) {
        let positionY = -position.y;
        let length = this.titleTopY.length;
        for (let i = 0; i < length - 1; i++) {
          if (this.currentIndex !== i &&
          (positionY >= this.titleTopY[i] && positionY < this.titleTopY[i + 1])) {
            this.currentIndex = i;
            this.$refs.nav.currentIndex = this.currentIndex;
          }
        }  
        this.listenShowBackUp(position)
      },
      addToCart() {
        // 获取购物车要展示的商品信息
        const product = {};
        product.image = this.topImages[0];
        product.title = this.goods.title;
        product.desc = this.goods.desc;
        product.price = this.goods.lowNowPrice;
        product.iid = this.iid;
        // 将商品添加到购物车
        this.$store.dispatch('addCart', product);
      }
    },
    components: {
      DetailNavBar,
      DetailSwiper,
      DetailBaseInfo,
      DetailShopInfo,
      Scroll,
      DetailGoodsInfo,
      DetailParamsInfo,
      DetailCommentInfo,
      GoodsList,
      DetailBottomBar,
    }
  }
</script>
```

index.js

```js
import Vue from 'vue'
import Vuex from 'vuex'
import mutations from './mutations';
import actions from './actions';
import getters from './getters';

Vue.use(Vuex)

const state = {
  cartList: []
};

const store = new Vuex.Store({
  state,
  mutations,
  actions,
  getters,
  modules: {}
});

export default store
```

mutations-type.js

```js
export const ADD_COUNTER = 'addCounter';
export const ADD_TO_CART = 'addToCart';
```

actions.js

```js
import { ADD_COUNTER, ADD_TO_CART } from "./mutations-type";

export default {
  addCart({ commit, state }, payload) {
    // 查找之前是否有该商品，cartList 中有该商品，就赋值给 oldProduct
    // let oldProduct = null;
    // for (let item of state.carList) {
    //   if (item.iid === payload.iid) {
    //     oldProduct = item
    //   }
    // }
    // 之前有该商品就将该商品的数量加 1
    let oldProduct = state.cartList.find(item => item.iid === payload.iid);
    if (oldProduct) {
      // oldProduct.count += 1;
      commit(ADD_COUNTER, oldProduct);
    }
    // 之前没有该商品就该商品的数量设置为 1 并添加到购物车
    else {
      payload.count = 1;
      // state.cartList.push(payload);
      commit(ADD_TO_CART, payload);
    }
  }
}
```

mutations.js

```js
import {ADD_COUNTER, ADD_TO_CART} from './mutations-type'

export default {
  [ADD_COUNTER](state, payload) {
    payload.count++;
  },
  [ADD_TO_CART](state, payload) {
    state.cartList.push(payload);
  }
};
```

getters.js

```js
export default {
  cartLength(state) {
    return state.cartList.length
  }
}
```

Cart.vue

```vue
<template>
  <div class="cart">
    <nav-Bar class="nav">
      <div slot="center">购物车({{length}})</div>
    </nav-Bar>
  </div>
</template>

<script>
  import navBar from 'common/navbar/NavBar';
  import {mapGetters} from 'vuex';
  export default {
    name: 'Cart',
    components: {
      navBar
    },
    computed: {
      ...mapGetters({
        length: 'cartLength'
      })
    }
  }
</script>

<style>
  .nav {
    background-color: var(--color-tint);
    color: #fff;
  }
</style>
```

效果图

![3 [3].gif](https://cdn.nlark.com/yuque/0/2022/gif/1614731/1656660213419-24e2c3b5-2679-442b-b9e7-ba45bbec0659.gif)

购物车商品列表展示

![3 [35].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663578876-541ae637-0b71-4248-96c0-6296382740a9.jpeg)

![3 [36].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663578999-15c14348-f162-44b6-8f7c-02e7d6afff24.jpeg)

最外层为 .cart ，第二层为 .cart-list ，第三层为 content，要给 content 一个确定高度

![3 [37].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663579939-abadf036-35f9-43a0-aa6b-74c2c75be597.jpeg)

![3 [38].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663580576-f7c9668d-c239-4df7-9adf-43f22ffecc17.jpeg)

![3 [39].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663580595-fe4ca3b9-be8c-4cc7-ba6d-3e9b72604da5.jpeg)

Emmet 语法

```js
li{内容$}*100
```

![3 [40].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663580647-1dbabc91-94eb-4217-9b60-f0facc738c74.jpeg)

![3 [41].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663580689-b8b4946e-0032-4ab4-9470-00991860ad1f.jpeg)

购物车页面无法滚动问题：

因为一开始进入购物车页面时，可滚动区域高度 scrollHeight = 0，

添加数据后，scrollHeight = 0（better-scroll 并不知道添加了数据，所以还是和初始高度一样）

所以如果再次进入购物车页面时，最好要 refresh 刷新 一次，

因为有自动缓存，所以要在 activated() 生命周期函数中刷新

![3 [42].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663581305-801342b3-aea1-4275-840d-9991b19fa75c.jpeg)

将 checkButton 全选按钮组件封装在 content 里

![3 [43].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663581917-746128cb-c26d-4558-8d13-d79113c90f6a.jpeg)

![3 [44].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663582024-c59e7e5f-a297-4c22-8242-9c60118fa3fa.jpeg)

## 购物车商品选中和不选中的切换

是在对象模型里切换的，即 Vuex 的 商品数据中切换

![3 [45].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663582112-ba26fc3c-5e4c-4bae-a7fc-1b23f640096a.jpeg)

![3 [46].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663582409-4266ad90-eb37-4494-b31b-3827d4411ca2.jpeg)

![3 [47].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663583246-79533461-2bb9-4b66-bfd3-4299975dcb87.jpeg?x-oss-process=image%2Fresize%2Cw_929%2Climit_0)

![3 [48].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663583244-f31633a2-5e01-450e-84b3-c117d2bccca3.jpeg)

## 购物车底部工具栏的封装

![3 [49].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663583547-6540c6d6-3deb-44f3-b7ab-0bc2ac9bae3d.jpeg)

![3 [50].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663583680-11d3bc34-8b10-4905-ad9d-972a9764fe05.jpeg)

![3 [51].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663583750-16c99e9b-458c-4ccc-94be-f7582cd54df1.jpeg)

![3 [52].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663584563-ef00f7a4-1de3-4225-bb24-5d8e43cfdb16.jpeg)

![3 [53].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663585080-60b4b75c-9c6a-4ecf-8713-0f8123a9eb58.jpeg)

![3 [54].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663585870-47ff6947-99ea-45b9-9604-21fe0874cf16.jpeg)

Cart.vue

```vue
<template>
  <div class="cart">
    <nav-Bar class="nav">
      <div slot="center">购物车({{length}})</div>
    </nav-Bar>
    <cart-list></cart-list>
  </div>
</template>

<script>
  import navBar from 'common/navbar/NavBar';
  import {mapGetters} from 'vuex';
  import CartList from './childCpns/CartList';
  export default {
    name: 'Cart',
    components: {
      navBar,
      CartList
    },
    computed: {
      ...mapGetters({
        length: 'cartLength'
      })
    }
  }
</script>

<style>
  .cart {
    height: 100vh;
  }
  .nav {
    background-color: var(--color-tint);
    color: #fff;
  }
</style>
```

CartList.vue

```vue
<template>
  <div class="cart-list">
    <scroll class="content" ref="scroll">
      <cart-list-item
        v-for="item of cartList"
        :key="item.iid"
        :item-info="item">
      </cart-list-item>
    </scroll>
    <cart-bottom-bar></cart-bottom-bar>
  </div>
</template>

<script>
  import Scroll from 'common/scroll/Scroll';
  import CartListItem from './CartListItem';
  import CartBottomBar from './CartBottomBar';
  import {mapGetters} from 'vuex';

  export default {
    name: 'CartList',
    components: {
      Scroll,
      CartListItem,
      CartBottomBar
    },
    computed: {
      ...mapGetters({
        cartList: 'cartList'
      })
    },
    activated () {
      this.$refs.scroll.refresh();
    }
  }
</script>

<style scoped>
  .cart-list {
    height: calc(100% - 137px);
  }
  .content {
    height: 100%;
    overflow: hidden;
  }
</style>
```

CheckButton.vue

```vue
<template>
  <div>
    <div class="icon-selector" :class="{check: isChecked}">
      <img src="~/assets/img/cart/tick.svg" alt="">
    </div>
  </div>
</template>

<script>
  export default {
    name: "CheckButton",
    props: {
      isChecked: {
        type: Boolean,
        default: false
      }
    }
  }
</script>

<style scoped>
  .icon-selector {
    position: relative;
    margin: 0;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    border: 2px solid #ccc;
    cursor: pointer;
  }
  .check {
    background-color: #ff8198;
    border-color: #ff8198;
  }
</style>
```

CartListItem.vue

```vue
<template>
  <div id="shop-item">
    <div class="item-selector">
      <check-button :is-checked="itemInfo.checked" @click.native="checkClick"></check-button>
    </div>
    <div class="item-img">
      <img :src="itemInfo.image" alt="商品图片">
    </div>
    <div class="item-info">
      <div class="item-title">{{itemInfo.title}}</div>
      <div class="item-desc">商品描述: {{itemInfo.desc}}</div>
      <div class="info-bottom">
        <div class="item-price left">{{itemInfo.price}}</div>
        <div class="item-count right">x{{itemInfo.count}}</div>
      </div>
    </div>
  </div>
</template>

<script>
  import CheckButton from 'content/checkButton/CheckButton'

  export default {
    name: 'CartListItem',
    props: {
      itemInfo: {
        type: Object,
        default() {
          return {}
        }
      }
    },
    components: {
      CheckButton
    },
    methods: {
      checkClick() {
        this.itemInfo.checked = !this.itemInfo.checked
      }
    }
  }
</script>

<style scoped>
  #shop-item {
    width: 100%;
    display: flex;
    font-size: 0;
    padding: 5px;
    border-bottom: 1px solid #ccc;
  }
  .item-selector {
    width: 14%;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .item-title, .item-desc {
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }
  .item-img {
    padding: 5px;
    /*border: 1px solid #ccc;*/
  }
  .item-img img {
    width: 80px;
    height: 100px;
    display: block;
    border-radius: 5px;
  }
  .item-info {
    font-size: 17px;
    color: #333;
    padding: 5px 10px;
    position: relative;
    overflow: hidden;
  }
  .item-info .item-desc {
    font-size: 14px;
    color: #666;
    margin-top: 15px;
  }
  .info-bottom {
    margin-top: 10px;
    position: absolute;
    bottom: 10px;
    left: 10px;
    right: 10px;
  }
  .info-bottom .item-price {
    color: orangered;
  }
</style>
```

CartBottomBar.vue

```vue
<template>
  <div class="bottom-bar">
    <div class="check-content">
      <check-button class="check-button"></check-button>
      <span>全选</span>
    </div>
    <div class="total">
      合计：{{totalPrice}}
    </div>
    <div class="calculate">去计算({{checkLength}})</div>
  </div>
</template>

<script>
  import CheckButton from 'content/checkButton/CheckButton';
  import { mapGetters } from 'vuex';

  export default {
    name: 'CartBottomBar',
    components: {
      CheckButton
    },
    computed: {
      ...mapGetters(['cartList']),
      totalPrice() {
        return this.cartList.filter(item => {
          return item.checked
        }).reduce((preValue, item) => {
          return preValue + item.price * item.count
        }, 0).toFixed(2)
      },
      checkLength() {
        return this.cartList.filter(item => item.checked).length
      }
    }
  }
</script>

<style scoped>
  .bottom-bar {
    display: flex;
    position: relative;
    height: 44px;
    line-height: 44px;
    background-color: #eee;
  }
  .check-content {
    display: flex;
    align-items: center;
    margin-left: 40px;
    width: 60px;
  }
  .check-button {
    width: 20px;
    height: 20px;
    line-height: 20px;
    margin-right: 5px;
  }
  .total {
    margin-left: 20px;
    flex: 1;
  }
  .calculate {
    width: 90px;
    background-color: orangered;
    color: #fff;
    text-align: center;
  }
</style>
```

效果图

![3 [4].gif](https://cdn.nlark.com/yuque/0/2022/gif/1614731/1656660213959-7cef8050-7247-4ba2-8e13-8ea2c6d11959.gif)

![3 [55].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663585752-bb7217b2-f33e-4fe2-bca7-5a2547a93735.jpeg)

![3 [56].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663585925-e162a1d1-b821-4cfb-86f9-ffa7c223e4be.jpeg)

![3 [57].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663585964-268f4437-7fc9-4707-906d-614a5ff1e8cc.jpeg)

![3 [58].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663586387-2a1ffafa-7b85-499a-8400-565c840d7040.jpeg)

## 全选按钮的状态显示

![3 [59].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663586471-49a62385-ad0a-48bf-a595-fb099c345e22.jpeg)

![3 [60].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663586582-b84f2939-16a6-408a-932d-c8c34233bfe7.jpeg)

![3 [61].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663586639-75e3f227-ce41-40f7-aec8-e2f0acb2cbb6.jpeg)

三种方案

![3 [62].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663587177-5f8df789-fa59-4e47-aeb3-ba53876210ec.jpeg)

## 全选按钮的点击效果

![3 [63].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663587305-36a87268-cc9d-4d9a-857e-14d75aca5b76.jpeg)

![3 [64].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663587320-b7194427-b443-4e16-9a19-59fab7d90aae.jpeg)

![3 [65].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663588634-1377bf34-b181-4a7f-afda-0a418e76f76e.jpeg)

CartBottomBar.vue

```vue
<template>
  <div class="bottom-bar">
    <div class="check-content">
      <check-button
        class="check-button"
        :is-checked="isSelectAll"
        @click.native="checkClick">
      </check-button>
      <span>全选</span>
    </div>
    <div class="total">
      合计：{{totalPrice}}
    </div>
    <div class="calculate">去计算({{checkLength}})</div>
  </div>
</template>

<script>
  import CheckButton from 'content/checkButton/CheckButton';
  import { mapGetters } from 'vuex';
  
  export default {
    name: 'CartBottomBar',
    components: {
      CheckButton
    },
    computed: {
      ...mapGetters(['cartList']),
      totalPrice() {
        return this.cartList.filter(item => {
          return item.checked
        }).reduce((preValue, item) => {
          return preValue + item.price * item.count
        }, 0).toFixed(2)
      },
      checkLength() {
        return this.cartList.filter(item => item.checked).length
      },
      isSelectAll() {
        if (this.cartList.length === 0) {
          return false
        }
        // 找到其中的一个商品 checked 为 false，即一个商品不选中则返回该商品，最后返回 false
        // 没有找到其中的一个商品 checked 为 false，即每个商品都选中则返回 undefined，最后返回 true
        return !this.cartList.find(item => !item.checked)
      }
    },
    methods:{
      checkClick() {
        // 如果全部商品被选中
        if (this.isSelectAll) {
          this.cartList.forEach(item => item.checked = false)
        }
        // 如果全部商品或部分商品不被选中
        else {
          this.cartList.forEach(item => item.checked = true)
        }
      }
    }
  }
</script>
```

效果图

![3 [5].gif](https://cdn.nlark.com/yuque/0/2022/gif/1614731/1656660215355-0c42802e-59bd-4d49-80a6-a21597db4f8f.gif)

## Vuex - actions 返回 Promise - mapActions

弹出模态框提示 —— Toast（太常用，任何一个页面随时可能要显示，所以把这个组件通过一种特别的封装方法，只用一行代码即可显示）

加入购物车时提示 添加到购物车成功

![3 [66].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663588790-4572b237-7b4f-4f40-bd10-0b113c669729.jpeg)

没有选中商品，点击去计算时提示 请选择要购买的商品

![3 [67].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663588947-eb349f10-b24b-4b4a-b84b-4f53375f4d85.jpeg)

1、dispatch 会返回一个 Promise

应该根据  dipatch 的 addCart 返回的结果来提示，而不是在下面直接写显示添加购物车

![3 [68].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663589500-c23c8974-4729-4ce8-8f43-f023a29bcab1.jpeg)

![3 [69].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663589602-cc507af8-24a4-45ed-b801-614c286d9208.jpeg)

2、要想像下图标记处像调用自己的方法一样调用，而不是像下面调用 actions 的方法的话，需要使用 mapActions 把 Actions 的方法 映射到 Detali.vue 的 methods 里

![3 [70].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663589540-a5925d3d-a53f-4c23-850e-023835a6a494.jpeg)

![3 [71].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663589946-4c924a1b-96d5-4570-9eb9-a638a7a066d2.jpeg?x-oss-process=image%2Fresize%2Cw_929%2Climit_0)

![3 [72].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663590280-59badd93-97b2-4346-8eaa-b4d9375fc913.jpeg)

## Toast 封装 —— 普通方式封装

![3 [73].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663590931-38a935eb-2dab-4815-a2ca-e9d077f729d7.jpeg)

![3 [74].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663592731-7fff86bf-5509-4451-b025-fb317a08eecf.jpeg)

![3 [75].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663592690-efe4be2f-51ba-47df-bf64-42f4fd323d6a.jpeg?x-oss-process=image%2Fresize%2Cw_929%2Climit_0)

![3 [76].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663592775-6592c290-e94b-47d6-b94d-0487a9598aa0.jpeg)

![3 [77].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663593638-d5a84aeb-28e8-4798-9fcd-8208c571b0e6.jpeg)

然而普通封装很麻烦，

如果要在 CartBottomBar 中点击去计算时使用 Toast 的话，就要把 Toast 添加到 Cart 中，

这时点击 去计算 时就要把事件发出去，还要导入注册添加元素，message、show重写等等

所以需要另一种封装方式，像 jQuery 一样，一行代码即可

![3 [78].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663593782-a331e7bd-49bd-426b-82df-820a096ac63b.jpeg)

## Toast 封装 —— 插件方式封装

这个组件必须按某一种方式用起来，引入并添加

这么做：把组件封装到某一个插件里面，安装这个插件就把组件创建出来并且把组件在最开始的时候就把它添加到

![3 [79].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663594515-d4382db5-d5c1-4c7a-ab2d-6387bc1066cc.jpeg)

![3 [80].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663594598-d7e44c72-2938-4e4d-8a95-327eded1c753.jpeg)

```js
export default obj;
```

![3 [81].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663595834-1d3eb3b9-809f-4cd6-9484-221e78eafccc.jpeg)

![3 [82].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663596230-bc94627d-b505-40a7-ab56-1e74bb9c04bf.jpeg)

![3 [83].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663596299-f4b3f1c8-c240-4d91-8606-6513345cb2bf.jpeg)

![3 [84].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663596653-afb4ab9f-dcaf-4435-a92d-d7c3b358fa76.jpeg?x-oss-process=image%2Fresize%2Cw_929%2Climit_0)

![3 [85].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663596751-bc26fa9f-6b54-4720-b368-db96f8c4d258.jpeg)

![3 [86].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663597711-899d27b1-dddc-443c-b0be-80e1e9478b32.jpeg)

main.js

```js
import Vue from 'vue'
import App from './App.vue'
import router from './router'
import store from './store'

import toast from 'common/toast';

Vue.config.devtools = true;
Vue.config.productionTip = false

Vue.prototype.$bus = new Vue()
Vue.use(toast)

new Vue({
  router,
  store,
  render: h => h(App)
}).$mount('#app')
```

index.js

```js
import Toast from './Toast';

const obj = {};

obj.install = function(Vue) {
  const toastConstructor = Vue.extend(Toast);
  const toast = new toastConstructor();
  toast.$mount(document.createElement('body'));
  document.body.appendChild(toast.$el);
  Vue.prototype.$toast = toast;
}

export default obj;
```

Toast.vue

```vue
<template>
  <div class="toast" v-show="isShow">
    <div>{{message}}</div>
  </div>
</template>

<script>
  export default {
    name: '',
    data () {
      return {
        isShow: false,
        message: ''
      }
    },
    methods: {
      show(message='默认文字', duration=1000) {
        this.isShow = true;
        this.message = message;
        setTimeout(() => {
          this.isShow = false;
          this.message = '';
        }, duration)
      }
    }
  }
</script>

<style scoped>
  .toast {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 2;
    padding: 8px 10px;
    color: #fff;
    background-color: rgba(0, 0, 0, .75);
  }
</style>
```

actions.js

```js
import { ADD_COUNTER, ADD_TO_CART } from "./mutations-type";

export default {
  addCart({ commit, state }, payload) {
    // 查找之前是否有该商品，cartList 中有该商品，就赋值给 oldProduct
    // let oldProduct = null;
    // for (let item of state.carList) {
    //   if (item.iid === payload.iid) {
    //     oldProduct = item
    //   }
    // }
    // 之前有该商品就将该商品的数量加 1
    return new Promise((resolve, reject) => {
      let oldProduct = state.cartList.find(item => item.iid === payload.iid);
      if (oldProduct) {
        // oldProduct.count += 1;
        commit(ADD_COUNTER, oldProduct);
        resolve('当前商品数量+1')
      }
      // 之前没有该商品就该商品的数量设置为 1 并添加到购物车
      else {
        payload.count = 1;
        // state.cartList.push(payload);
        commit(ADD_TO_CART, payload);
        resolve('添加了新的商品')
      }
    })
  }
}
```

Detail.vue

```vue
<template>
  <div id="detail">
    <detail-nav-bar class="detail-nav" @titleClick="titleClick" ref="nav"></detail-nav-bar>
    <scroll class="content" ref="scroll" :probe-type="3" @scroll="contentScroll">
      <detail-swiper :topImages="topImages"></detail-swiper>
      <detail-base-info :goods="goods"></detail-base-info>
      <detail-shop-info :shop="shop"></detail-shop-info>
      <detail-goods-info :detailInfo="detailInfo" @imgLoad="imgLoad"></detail-goods-info>
      <detail-params-info :paramInfo="paramInfo" ref="params"></detail-params-info>
      <detail-comment-info :comment-info="commentInfo" ref="comment"></detail-comment-info>
      <goods-list :goods="recommends" ref="recommend"></goods-list>
    </scroll>
    <back-up @click.native="backClick" class="back-up" v-show="isShowBackUp"></back-up>
    <detail-bottom-bar @addToCart="addToCart"></detail-bottom-bar>
  </div>
</template>

<script>
  import DetailNavBar from './childCpns/DetailNavBar';
  import DetailSwiper from './childCpns/DetailSwiper';
  import DetailBaseInfo from './childCpns/DetailBaseInfo';
  import DetailShopInfo from './childCpns/DetailShopInfo';
  import Scroll from 'common/scroll/Scroll';
  import DetailGoodsInfo from './childCpns/DetailGoodsInfo';
  import DetailParamsInfo from './childCpns/DetailParamInfo';
  import DetailCommentInfo from './childCpns/DetailCommentInfo';
  import GoodsList from 'content/goods/GoodsList';
  import DetailBottomBar from './childCpns/DetailBottomBar';
  import {getDetailData, Goods, Shop, GoodsParam, getRecommend} from 'network/detail';
  
  import {debounce} from "commonjs/utils.js";
  import {itemListenerMixin, backUpMixin } from 'commonjs/mixin';

  import{mapActions} from 'vuex';

  export default {
    name: 'Detail',
    mixins: [itemListenerMixin, backUpMixin],
    data () {
      return {
        iid: null,
        topImages: [],
        goods: {},
        shop: {},
        detailInfo: {},
        paramInfo: {},
        commentInfo: {},
        recommends: [],
        titleTopY: [],
        getTitleTopY: null,
        currentIndex: 0,
      }
    },
    created () {
      this.iid = this.$route.params.iid;
      getDetailData(this.iid).then(res => {
        const data =  res.result;
        this.topImages = data.itemInfo.topImages;
        this.goods = new Goods(data.itemInfo, data.columns, data.shopInfo.services);
        this.shop = new Shop(data.shopInfo);
        this.detailInfo = data.detailInfo;
        this.paramInfo = new GoodsParam(data.itemParams.info, data.itemParams.rule);
        if (data.rate.list) {
          this.commentInfo = data.rate.list[0];
        }
      })
      getRecommend().then(res => {
        this.recommends = res.data.list
      })
      this.getTitleTopY = debounce(() => {
        this.titleTopY = [];
        this.titleTopY.push(0);
        this.titleTopY.push(this.$refs.params.$el.offsetTop);
        this.titleTopY.push(this.$refs.comment.$el.offsetTop);
        this.titleTopY.push(this.$refs.recommend.$el.offsetTop);
        this.titleTopY.push(Number.MAX_VALUE);
      }, 100)
    },
    destroyed() {
      this.$bus.$off('itemImgLoad', this.itemImgListener);
    },
    methods: {
      ...mapActions(['addCart']),
      imgLoad() {
        this.$refs.scroll.refresh();
        this.getTitleTopY();
      },
      titleClick(index) {
        this.$refs.scroll.scrollTo(0, -this.titleTopY[index] + 44, 100)
      },
      contentScroll(position) {
        let positionY = -position.y;
        let length = this.titleTopY.length;
        for (let i = 0; i < length - 1; i++) {
          if (this.currentIndex !== i &&
          (positionY >= this.titleTopY[i] && positionY < this.titleTopY[i + 1])) {
            this.currentIndex = i;
            this.$refs.nav.currentIndex = this.currentIndex;
          }
        }  
        this.listenShowBackUp(position)
      },
      addToCart() {
        // 获取购物车要展示的商品信息
        const product = {};
        product.image = this.topImages[0];
        product.title = this.goods.title;
        product.desc = this.goods.desc;
        product.price = this.goods.lowNowPrice;
        product.iid = this.iid;
        // 将商品添加到购物车
        // this.$store.dispatch('addCart', product);
        this.addCart(product).then(res => {
          this.$toast.show(res)
        })
      }
    },
    components: {
      DetailNavBar,
      DetailSwiper,
      DetailBaseInfo,
      DetailShopInfo,
      Scroll,
      DetailGoodsInfo,
      DetailParamsInfo,
      DetailCommentInfo,
      GoodsList,
      DetailBottomBar,
    }
  }
</script>
```

效果图

![3 [6].gif](https://cdn.nlark.com/yuque/0/2022/gif/1614731/1656660215668-f43d4c49-858d-4f2a-bfea-c776f841656f.gif)

## fastclick 解决移动端 300ms 问题

```shell
npm install fastclick --save

import fastClick from 'fastclick';

fastClick.attach(document.body);
```

![3 [87].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663597908-9a68fe89-72b7-49c9-aa7a-6d57d5b54443.jpeg)

## 图片懒加载 - vue-lazyload 库

有些公司会做，有些公司不做

```shell
npm install vue-lazyload --save
```

![3 [88].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663598252-d5475df9-2f6e-447b-b91c-60cb13d9e5a7.jpeg)

![3 [89].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663598590-aa4ed699-79cc-4e9b-8f08-963562518dba.jpeg)

px2vw - css转化插件

![3 [90].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663598734-e977eadc-209a-4c1c-b8b1-59124d870b8a.jpeg)

![3 [91].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663598766-c4ffeb8b-997e-41c4-96a0-c41e7ca994b7.jpeg)

postcss.config.js

```js
module.exports = {
  plugins: {
    autoprefixer: {},
    "postcss-px-to-viewport": {
      viewportWidth: 375, // 视窗的宽度，对应的是我们设计稿的宽度
      viewportHeight: 667, // 视窗的高度，对应的是我们设计稿的高度（也可以不设置）
      unitPrecision: 5, // 指定 'px' 转换为视窗单位值的小数位数
      viewportUnit: "vw", // 指定需要转换成的视窗单位，建议使用vm
      selectorBlackList: ["scroll", "wrapper"], // 指定不需要转换的类
      minPixelValue: 1, // 小于或等于 1px 不转换为视窗高度
      mediaQuery: false, // 允许在媒体查询中 转换为 px
      exclude: [/TabBar/, /NavBar/]
    }
  }
};
```

最后修改 tabControl 的样式，否则一开始进入首页没有吸顶效果

Detail.vue

```vue
<template>
  <div id="home">
    <nav-bar class="nav">
      <div slot="center">购物街</div>
    </nav-bar>
    <tab-control :title="['流行', '新款', '精选']" @tabClick="tabClick"
                 class="fixed" v-show="isTabFixed"  ref="tabControl1">
    </tab-control>
    <scroll class="content"
            ref="scroll"
            :probe-type="3"
            :pull-up-load="true"
            @scroll="contentScroll"
            @pullingUp="loadMore">
      <home-swiper :banner="banner" @swiperImageLoad="swiperImageLoad"></home-swiper>
      <home-recommend :recommend="recommend"></home-recommend>
      <feature-view></feature-view>
      <tab-control :title="['流行', '新款', '精选']"  
                   @tabClick="tabClick"
                   ref="tabControl2" >
      </tab-control>
      <goods-list :goods="showGoods"></goods-list>
    </scroll>
    <back-up @click.native="backClick" class="back-up" v-show="isShowBackUp"></back-up>
  </div>
</template>
<script>
  
  import HomeSwiper from './childCpns/HomeSwiper';
  import HomeRecommend from './childCpns/HomeRecommend';
  import FeatureView from './childCpns/FeatureView';
  import NavBar from 'common/navbar/NavBar';
  import TabControl from 'content/tabControl/TabControl';
  import GoodsList from 'content/goods/GoodsList';
  import Scroll from 'common/scroll/Scroll';
  import { getHomeMultidata, getHomeGoods } from 'network/home';
  import {itemListenerMixin, backUpMixin} from 'commonjs/mixin';
  
  export default {
    name: 'Home',
    components: {    
      HomeSwiper,
      HomeRecommend,
      FeatureView,
      NavBar,
      TabControl,
      GoodsList,
      Scroll
    },
    mixins: [itemListenerMixin, backUpMixin],
    data() {
      return {
        banner: null,
        recommend: null,
        goods: {
          'pop': {page: 0, list: []},
          'new': {page: 0, list: []},
          'sell': {page: 0, list: []}
        },
        currentType: 'pop',
        tabOffsetTop: 0,
        isTabFixed: false,
        scrollY: 0     
      }    
    },
    computed: {
      showGoods() {
        return this.goods[this.currentType].list
      }
    },
    created() {
      this.getHomeMultidata();
      this.getHomeGoods('pop');
      this.getHomeGoods('new');
      this.getHomeGoods('sell');
    },
    activated () {
      this.$refs.scroll.refresh();
      this.$refs.scroll.scrollTo(0, this.scrollY, 0);     
    },
    deactivated () {
      this.scrollY = this.$refs.scroll.getScrollY();
      this.$bus.$off('itemImgLoad', this.itemImgListener);
    },
    methods: {
      // 事件监听
      tabClick(index) {
        switch(index) {
          case 0:
            this.currentType = 'pop';
            break;
          case 1:
            this.currentType = 'new';
            break;
          case 2:
            this.currentType = 'sell';
            break;   
        }
        this.$refs.tabControl1.currentIndex = index;
        this.$refs.tabControl2.currentIndex = index;
      },
      contentScroll(position) {
        this.listenShowBackUp(position);
        this.isTabFixed = (-position.y) > this.tabOffsetTop;
      },
      loadMore() {
        this.getHomeGoods(this.currentType);
        this.$refs.scroll.refresh();
      },
      swiperImageLoad() {       
        this.tabOffsetTop = this.$refs.tabControl2.$el.offsetTop;      
      },
      // 网络请求
      getHomeMultidata() {
        getHomeMultidata().then(res => {
          this.banner = res.data.banner.list;
          this.recommend = res.data.recommend.list;
        })
      },
      getHomeGoods(type) {
        const page = this.goods[type].page + 1;
        getHomeGoods(type, page).then(res => {
           this.goods[type].list.push(...res.data.list);
           this.goods[type].page += 1;
           this.$refs.scroll.finishPullUp();
        });        
      }
    }
  }
</script>
<style scoped>
  #home {
    height: 100vh;
  }
  .nav {
    background-color: var(--color-tint);
    color: #fff;
    position: relative;
    z-index: 1;
  }
  .content {
    position: absolute;
    top: 44px;
    bottom: 49px;
    left: 0;
    right: 0;   
  }
  .back-up {
    position: fixed;
    right: 8px;
    bottom: 55px;  
  }
  .fixed {
    position: relative;
    z-index: 2;
    background-color: white;
  }
</style>
```

## ngnix 部署

在公司的话，一般不会把服务器账号密码给前端，很多情况下是对项目进行打包然后传给服务器人员

如果公司有使用自动化部署流程的话，就是项目一旦发布成功的话，把项目提交到 github，打一个 tag 就可以自动化发布的

而且可能首先打包发布到测试人员的测试服务器上

```shell
npm run build
```

![3 [92].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663599623-c2243bc4-237e-469e-9e81-9882348ab08d.jpeg?x-oss-process=image%2Fresize%2Cw_804%2Climit_0)

coderwhy 老师使用 python 的 flask 框架开发了很多接口，为前端服务，数据来自于 app_run.py 文件

还写了个爬虫爬取推荐商品数据，爬虫在服务器上执行，爬到数据后会放到远程服务器的 MongoDB 数据库

再通过 app_run.py 读取 MongoDB 数据库，最后返回前端

项目在远程 Linux 下部署

先登录后安装 nginx

![3 [93].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663599725-8d686257-ef40-4467-bf36-9122bfd0cc41.jpeg)

但是 windows系统 没有 ssh 命令，而 Mac 系统自带 ssh 命令（Mac系统比 windows 系统多很多开发相关的东西）

所以需要使用 SecureCRT 登录到服务器并使用 winSCP 拷贝文件到服务器

![3 [94].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663600036-676a655c-e021-48fa-91ca-13879a20d7a7.jpeg)

![3 [95].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663600298-91cb4bfa-6299-495d-a1c2-ca40e2badacb.jpeg)

![3 [96].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663600859-32988c9d-0efc-4f07-af88-e001cbdc2735.jpeg)

输入服务器主机公网 ip 地址（不是 192 开头的私网 ip）

![3 [97].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663600954-5e42e883-c92d-4a4f-9a72-4ea88de62aeb.jpeg)

点击完成后，选择连接一次，输入服务器密码

![3 [98].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663601488-a0d16152-58d9-4c63-a3c8-ce59f9523e9d.jpeg)

安装 nginix

![3 [99].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663601601-ed05b86d-076b-4285-9f56-6d425d510d8f.jpeg)

winSCP

拷贝打包文件

![3 [100].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663601674-fb59bc8c-ca74-403a-990d-0e7429bd7e7f.jpeg?x-oss-process=image%2Fresize%2Cw_929%2Climit_0)

修改 nginx 配置，右键打开 ngnix.conf

![3 [101].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663601996-79e963a4-b75a-4930-b8f8-1df1d375be1d.jpeg?x-oss-process=image%2Fresize%2Cw_929%2Climit_0)

![3 [102].jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1614731/1656663602082-015be029-5211-4048-9a7c-be167d152fcd.jpeg)

改了配置之后需要进行重启

https://zhidao.baidu.com/question/537772935.html

第一个答案第一种方法

使用 IP 访问即可成功





