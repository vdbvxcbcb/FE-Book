<img src="https://cdn.nlark.com/yuque/0/2022/png/1614731/1652869586099-38850b14-4227-4fb1-9e60-5b9750377c95.png" alt="img" style="zoom: 80%;" />

## 全局

app.json

```json
{
  "pages": [
    "pages/classic/classic",
    "pages/book/book",
    "pages/book-detail/book-detail",
    "pages/my/my",
    "pages/about/about",
    "pages/course/course",
    "pages/classic-detail/classic-detail"
  ],
  "window": {
    "navigationBarBackgroundColor": "#ffffff",
    "navigationBarTextStyle": "black",
    "navigationBarTitleText": "记录",
    "backgroundColor": "#eeeeee",
    "backgroundTextStyle": "light"
  },
  "tabBar": {
    "selectedColor": "#000000",
    "backgroundColor": "#ffffff",
    "color": "#c7c7c7",
    "list": [
      {
        "selectedIconPath": "/images/tab/classic@highlight.png",
        "pagePath": "pages/classic/classic",
        "text": "流行",
        "iconPath": "/images/tab/classic.png"
      },
      {
        "pagePath": "pages/book/book",
        "selectedIconPath": "/images/tab/book@highlight.png",
        "iconPath": "/images/tab/book.png",
        "text": "书籍"
      },
      {
        "pagePath": "pages/my/my",
        "selectedIconPath": "/images/tab/my@highlight.png",
        "iconPath": "/images/tab/my.png",
        "text": "喜欢"
      }
    ]
  },
  "sitemapLocation": "sitemap74.json"
}
```

app.wxss

```css
page {
  font-family: 'PingFangSc-Thin';
  font-size: 32rpx;
}
```

config.js

```js
const config = {
  apiurl: 'http://bl.talelin.com/v1/',
  appkey: 'AbhC31IG7ruCDp57'
};

export {config};
```

## 请求

utils\http.js

```js
import {config} from '../config.js';
const tips = {
  1: '抱歉，出现错误',
  1005: 'appkey不存在或不正确',
  3000: '期刊不存在'
};
class Http{
  request(params) {
    if (!params.method) {
      params.method = 'Get';
    }
    wx.request({
      url: config.apiurl + params.url,
      method: params.method,
      data: params.data,
      header: {
        'content-type': 'application/json',
        'appkey': config.appkey
      },
      success: (res) => {
        let code = res.statusCode.toString();
        if (code.startsWith('2')) {
          params.success && params.success(res.data) 
        }
        // 服务器异常
        else {
          let error_code = res.data.error_code;
          this._showError(error_code);
        } 
      },
      // api调用失败
      fail: (res) => {
        this._showError(1);
      }
    })
  }
  _showError(error_code) {
    if (!error_code) {
      error_code = 1;
    }
    wx.showToast({
      title: tips[error_code],
      icon: 'none',
      duration: 2000
    })
  }
};

export {Http};
```

## 流行页面（初始）

<img src="https://cdn.nlark.com/yuque/0/2022/png/1614731/1652869662552-169fe746-1017-4798-bbfd-f0b3a94170d6.png" alt="img" style="zoom:67%;" />

### 页面请求

models\classic.js

```js
import { Http } from '../utils/http.js';

class ClassicModel extends Http {
  getLatest(callback) {
    this.request({
      url: 'classic/latest',
      success: (res) => {
        callback(res)
      }
    })
  }
};

export {ClassicModel};
```

models\like.js

```js
import { Http } from '../utils/http.js';

class LikeModel extends Http {
  like(behavior, artID, category) {
    let url = behavior === 'like'? 'like' : 'like/cancel';
    this.request({
      url: url,
      method: 'POST',
      data: {
        art_id: artID,
        type: category 
      }     
    })
  }
};

export { LikeModel };
```

### 页面入口

pages\classic\classic.json

```json
{
  "usingComponents": {
    "v-epsoide": "/components/epsoide/index",
    "v-like": "/components/like/index",
    "v-movie": "/components/classic/movie/index" 
  }
}
```

pages\classic\classic.js

```js
// pages/classic/classic.js
import {ClassicModel} from '../../models/classic.js';
import {LikeModel} from '../../models/like.js';

let classic_model = new ClassicModel();
let like_model = new LikeModel();

Page({

  /**
   * 页面的初始数据
   */
  data: {

  },
  
  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
    classic_model.getLatest((res) => {
      this.setData({
        classic_data: res 
      }) 
    });
  },
  onlike: function (event) {
    let behavior = event.detail.behavior;
    like_model.like(behavior, this.data.classic_data.id, this.data.classic_data.type);
  },
})
```

pages\classic\classic.wxml

```html
<view class="header">
  <v-epsoide class="epsoide" index="{{classic_data.index}}"></v-epsoide>
  <v-like class="like" bindlike="onlike" like="{{classic_data.like_status}}" count="{{classic_data.fav_nums}}"></v-like>
</view>
<v-movie img="{{classic_data.image}}" content="{{classic_data.content}}"></v-movie>
```

pages\classic\classic.wxss

```css
.header {
  width:100%;
  display: flex;
  flex-direction: row;
  height:50px;
  align-items: center;
  justify-content: space-between;
  border-top :1px solid #f5f5f5;
  border-bottom: 1px solid #f5f5f5;
}

.epsoide {
   margin-left:10px; 
   margin-top:7px;
}

.like {
  margin-right: 30rpx;
  margin-top:12rpx;
}
```



### epsoide 组件

components\epsoide\index.json  （每个组件都有）

```json
{
  "component": true,
  "usingComponents": {}
}
```

components\epsoide\index.js

```js
Component({
  /**
   * 组件的属性列表
   */
  properties: {
    index: {
      type: String,
      // 监听 properties 的变化
      observer: function (newVal, oldVal) {
        let val = newVal < 10 ? '0' + newVal : newval;
        this.setData({
          _index: val
        })
      }
    }
  },

  /**
   * 组件的初始数据
   */
  data: {
    _index: '',
    year: 0,
    month: '',
    months: ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月']
  },
  attached: function () {
    let date = new Date();
    let month = date.getMonth();
    let year = date.getFullYear();
    this.setData({
      month: this.data.months[month],
      year: year
    })
  },
})
```

components\epsoide\index.wxml

```html
<view class="container">
  <view class="index-container">
    <text class="plain">No.</text>
    <text class="index">{{_index}}</text>
    <view class="vertical-line"></view>
  </view>
    <view class="date"> 
     <text class="month">{{month}}</text> 
    <text class="year">{{year}}</text>
   </view>  
</view>
```

components\epsoide\index.wxss

```css
.index {
  font-size:30px;
  font-weight:800;
  margin-right:7px;
}

.vertical-line {
  margin-right:7px;
  height:22px;
  border-left:1px solid black;
}

.plain {
  font-size:16px;
}

.container {
  display:inline-flex;
  flex-direction: row;
  line-height: 30px;
}

.index-container {
  display:flex;
  flex-direction: row;
  align-items: baseline;      
}

.date {
  display: flex;
  flex-direction: column;
  justify-content: center; 
}

.month {
  font-size:12px;
  line-height:12px; 
  padding-bottom: 2px; 
  margin-right:2rpx;
}

.year {
  font-size:10px;
  line-height:10px; 
  padding-bottom:3px;   
}
```



### like 组件

components\like\index.json

```json
{
  "component": true,
  "usingComponents": {}
}
```

components\like\index.js

```js
Component({
  /**
   * 组件的属性列表
   */
  properties: {
    like: {
      type: Boolean
    },
    count: {
      type: Number
    }
  },

  /**
   * 组件的初始数据
   */
  data: {
    yesSrc: 'images/like.png',
    noSrc: 'images/like@dis.png'
  },

  /**
   * 组件的方法列表
   */
  methods: {
    handleTap: function () {
      let like = this.properties.like;
      let count = this.properties.count;
      count = like ? count - 1 : count + 1;
      this.setData({
        like: !like,
        count: count
      });
      let behavior = this.properties.like ? 'like' : 'cancel';
      this.triggerEvent('like', {
        behavior: behavior
      })
    }
  }
})
```

components\like\index.wxml

```html
<view bindtap="handleTap" class="container">
  <image src="{{like ? yesSrc : noSrc}}"/>
  <text>{{count}}</text>
</view>
```

components\like\index.wxss

```css
.container {
  display: inline-flex;
  padding: 10rpx;
  width: 90rpx;
}
.container image {
  width: 32rpx;
  height: 28rpx; 
}
.container text {
  font-size: 24rpx;
  line-height: 24rpx;
  color: #bbbbbb;
  position: relative;
  bottom: 10rpx;
  left: 6rpx;
}
```



### movie 组件

components\classic\movie\index.json

```json
{
  "component": true,
  "usingComponents": {}
}
```

components\classic\movie\index.js

```json
Component({
  /**
   * 组件的属性列表
   */
  properties: {
    img: String,
    content: String
  },
})
```

components\classic\movie\index.wxml

```html
<view class="classic-container">
  <image class="classic-img" src="{{img}}"></image>
  <image class="tag" src="images/movie@tag.png"></image>
  <text class="content">{{content}}</text> 
</view>
```

components\classic\movie\index.wxss

```css
.classic-container {
  display: flex;
  flex-direction: column;
  align-items: center;
}
.classic-img {
  width:750rpx;
  height: 500rpx;
}

.tag {
  width: 46rpx;
  height: 142rpx;
  position: relative;
  right: 340rpx;
  bottom: 58rpx;
}

.content {
  font-size: 36rpx;
  max-width: 500rpx;
}
```





## 流行页面（完整）

<img src="https://cdn.nlark.com/yuque/0/2022/png/1614731/1652935473386-de8eb391-c5d7-4f8a-ab61-71f373e3e831.png" alt="img" style="zoom: 67%;" />

<img src="https://cdn.nlark.com/yuque/0/2022/png/1614731/1652935726447-8e6905de-7737-43e7-b9d6-9920d81f6c31.png" alt="img" style="zoom:67%;" />

<img src="https://cdn.nlark.com/yuque/0/2022/png/1614731/1652935668322-8c8901a2-b2f4-4e7e-83d0-6d77179b085b.png" alt="img" style="zoom:67%;" />

### 页面请求

models\classic.js

```js
import { Http } from '../utils/http.js';
/*
  model 主要用来请求数据, get 数据
*/
class ClassicModel extends Http {

  getLatest(sCallback) {
    this.request({
      url: 'classic/latest',
      success: (res) => {
        sCallback(res);
        /* 将服务器中保存的最新期刊号 latestIndex 保存到 缓存中 */
        this._setLatestIndex(res.index);
        let key = this._getKey(res.index);
        wx.setStorageSync(key, res);
      },
    });
  }
  /**
   *
   * @param {期刊号} index
   * @param {前一篇还是后一篇} nextOrPrevious
   * @param {成功后的回调函数} sCallback
   * 使用缓存的时候, 一定要注意区分哪些数据是可以被缓存的, 哪些数据是不应该被缓存的。
   * 有一些数据需要实时与服务器交互，此时不应该缓存这类数据，例如 点赞数，favor
   */
  getClassic(index, nextOrPrevious, sCallback) {
    // 缓存中寻找 or API 写入到缓存中
    // key 确定key 缓存中的 key
    let key =
      nextOrPrevious === 'next'
        ? this._getKey(index + 1)
        : this._getKey(index - 1);
    /* 取到缓存 */
    let classic = wx.getStorageSync(key);
    /* 性能优化, 设置缓存, 不要每次点击都发送请求, 缓存未命中, 才发送真正的请求 */
    /* 减少服务器的压力, 同时改善用户体验, 缓存肯定比网络要快的多 */
    if (!classic) {
      this.request({
        url: `classic/${index}/${nextOrPrevious}`,
        success: (res) => {
          /* 写入缓存 key value */
          wx.setStorageSync(this._getKey(res.index), res);
          sCallback(res);
        },
      });
    } else {
      sCallback(classic);
    }
  }

  isFirst(index) {
    return index === 1 ? true : false;
  }

  isLatest(index) {
    /* _getLatestIndex 拿到的就是最新的期刊号(服务器中保存的) */
    let latestIndex = this._getLatestIndex();
    /* index 就是 currentIndex 也就是当前用户所在的期刊期刊号 */
    return latestIndex === index ? true : false;
  }

  getMyFavor(success) {
    const params = {
      url: 'classic/favor',
      success: success,
    };
    this.request(params);
  }

  getById(cid, type, success) {
    let params = {
      url: `classic/${type}/${cid}`,
      success: success,
    };
    this.request(params);
  }

  _setLatestIndex(index) {
    /* key value 缓存 */
    wx.setStorageSync('latest', index);
  }

  /* 读取缓存 */
  _getLatestIndex() {
    const index = wx.getStorageSync('latest');
    return index;
  }
/**
 *
 * @param {期刊号} index
 * @returns
 */
  _getKey(index) {
    /* 设计一个 key 即能够作为 classic 缓存的 key 也可以作为期刊号 index */
    const key = 'classic-' + index;
    return key;
  }
}

export { ClassicModel };
```

models\like.js

```js
import { Http } from '../utils/http.js';

class LikeModel extends Http {
  like(behavior, artID, category) {
    /* 点赞 url: /like  取消点赞 url:  /like/cancel 需要根据 behavior 动态决定 */
    let url = behavior == 'like' ? 'like' : 'like/cancel';
    this.request({
      url: url,
      method: 'POST',
      /* 提交到服务器中的 data */
      data: {
        art_id: artID,
        type: category,
      },
    });
  }

  getClassicLikeStatus(artID, category, sCallback) {
    this.request({
      url: 'classic/' + category + '/' + artID + '/favor',
      success: sCallback,
    });
  }
}

export { LikeModel };
```



### 页面入口

pages\classic\classic.json

```json
{
  "usingComponents": {
    "v-like": "/components/like/index",
    "v-movie": "/components/classic/movie/index",
    "v-music": "/components/classic/music/index",
    "v-essay": "/components/classic/essay/index",
    "v-episode": "/components/episode/index",
    "v-navi": "/components/navi/index"
  }
}
```

pages\classic\classic.js

```js
import { ClassicModel } from '../../models/classic.js';
import { LikeModel } from '../../models/like.js';

const classicModel = new ClassicModel();
const likeModel = new LikeModel();
/*
  页面主要用来完成数据绑定的
*/
Component({
  /**
   * 页面的初始数据
   */

  properties: {
    cid: Number,
    type: Number,
  },

  data: {
    classic: null,
    latest: true,
    first: false,
    likeCount: 0,
    likeStatus: false,
  },

  /**
   * 生命周期函数--监听页面加载
   */

  attached(options) {
    const cid = this.properties.cid;
    const type = this.properties.type;
    if (!cid) {
      classicModel.getLatest((res) => {
        this.setData({
          classic: res,
          likeCount: res.fav_nums,
          likeStatus: res.like_status,
        });
      });
    } else {
      classicModel.getById(cid, type, (res) => {
        this._getLikeStatus(res.id, res.type);
        this.setData({
          classic: res,
          latest: classicModel.isLatest(res.index),
          first: classicModel.isFirst(res.index),
        });
      });
    }
  },

  methods: {
    onLike: function (event) {
      /* 接收自定义事件传递过来的 behavior 数据, 挂载在 event.detail 中, 拿到 like 组件当前的状态 "点赞" OR "取消点赞" */
      const behavior = event.detail.behavior;
      /* 向服务器发送数据, 点赞 OR 不点赞 */
      /* type: 期刊类型,这里的类型分为:100 电影 200 音乐 300 句子
      id: 期刊在数据中序号，供点赞使用 */
      likeModel.like(behavior, this.data.classic.id, this.data.classic.type);
    },

    onNext: function (event) {
      /* next 是 nextOrPrevious 的一个选项, 表示下一篇期刊 */
      this._updateClassic('next');
    },

    onPrevious: function (event) {
      /* previous 是 nextOrPrevious 的一个选项, 表示上一篇期刊 */
      this._updateClassic('previous');
    },

    _updateClassic: function (nextOrPrevious) {
      const index = this.data.classic.index;
      classicModel.getClassic(index, nextOrPrevious, (res) => {
        /* success 回调 */
        this._getLikeStatus(res.id, res.type);
        this.setData({
          classic: res,
          /* 更新新的期刊的同时, 还要更新 latest 以及 first */
          latest: classicModel.isLatest(res.index),
          first: classicModel.isFirst(res.index),
        });
      });
    },

    /**
     *
     * @param {点赞对象的 id 号, 用户} artID
     * @param {点赞类型 取消点赞 OR 点赞} category
     */
    _getLikeStatus: function (artID, category) {
      likeModel.getClassicLikeStatus(artID, category, (res) => {
        /* 从服务器中拿到了最新的 id 和 type, 更新 data */
        this.setData({
          likeCount: res.fav_nums,
          likeStatus: res.like_status,
        });
      });
    },
  },
});
```

pages\classic\classic.wxml

```html
<view class="container">
  <view class="header">
    <!-- episode 组件 -->
    <!-- index 期刊号 -->
    <v-episode class="episode" index="{{classic.index}}" />
    <view class="like-container">
      <v-like class="like" bind:like="onLike" like="{{likeStatus}}"
        count="{{likeCount}}" />
    </view>
  </view>
  <!-- 三种不同的期刊 电影 音乐 句子 -->
  <!-- 小程序标签自带的 hidden 在自定义组件上不生效, 我们在 v-movie 组件中添加一个自定义properties也就是 hidden 自己实现 -->
  <!-- hidden VS wx:if 显示与隐藏 VS 渲染不渲染 -->
  <!-- hidden 初始加载消耗大, 适合频繁切换的场合 -->
  <!-- wx:if 切换消耗大, 适合运行条件不大可能改变的时候 -->
  <v-movie hidden="{{classic.type!=100}}" img="{{classic.image}}"
    content="{{classic.content}}" />
    <!-- 音乐部分, 我们使用 wx:if 需要使用 detached 生命周期函数, 而 hidden 永远不会触发 detached 函数 -->
  <v-music wx:if="{{classic.type==200}}" img="{{classic.image}}"
    content="{{classic.content}}" title="{{classic.title}}"
    src="{{classic.url}}" />
  <v-essay hidden="{{classic.type!=300}}" img="{{classic.image}}"
    content="{{classic.content}}" />

  <!-- 监听 nav 组件自定义的事件 left 和 right 从而得知, 用户是点击了左箭头, 还是点击了右箭头, 监听系统的 bind:tap 事件是得不到这个信息的, 我们只能知道用户点击了, 但是不知道用户具体点击了 左边还是右边 -->
  <v-navi bind:left="onNext" bind:right="onPrevious" title="{{classic.title}}"
    first="{{first}}" latest="{{latest}}" class="navi" />
</view>
```

pages\classic\classic.wxss

```css
/* classic 共有的样式 */
.container {
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.header {
  width: 100%; /* header 的宽度充满整个屏幕, 不要自适应, 使用 flex 布局的时候, 很多奇怪的现象都是没有 设置 height 和 width 造成的 */
  display: flex;
  flex-direction: row;
  height: 100rpx; /* 整体高度 */
  align-items: center; /* 垂直居中 */
  justify-content: space-between; /* 两端分布 */
  border-top: 1px solid #f5f5f5;
  border-bottom: 1px solid #f5f5f5;
}

.episode {
  margin-left: 20rpx;
  margin-top: 4rpx;
}

.like {
  margin-top: 6rpx;
}

.navi {
  position: absolute; /* 距离底部是一个固定的距离, 使用 position: absolute */
  bottom: 40rpx;
}

.like-container {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  margin-right: 30rpx;
}
```



### classic 页面上方的组件

#### episode 组件

components\episode\index.json

```json
{
  "component": true,
  "usingComponents": {}
}
```

components\episode\index.js

```js
// components/episode/index.js
Component({
  /**
   * 组件的属性列表
   */
  properties: {
    /* 自定义属性 */
    index: {
      type: String,
      /* observe 函数, 监听 index 属性的更改, 更改后触发 */
      /* 在组件内部处理, 不满十位, 补零, 补零之后 不要用 Number 用 String! (8 VS 08) */
      observer: function (newVal, oldVal, changedPath) {
        let val = newVal < 10 ? '0' + newVal : newVal;
        this.setData({
          // index: val, 内存泄露, 无限递归, 不要在 observe 函数里面更新属性自身, 也就是 setData !
          _index: val,
        });
      },
    },
  },
  // wxs

  /**
   * 组件的初始数据
   */
  data: {
    months: ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'],
    year: 0 /* data 中的数据不能像 properties 中的数据一样给一个类型 String Number 而是要具体给一个值 '' 0  */,
    month: '',
    _index: '',
  },
  /* 组件的声明周期函数, attached(常用) created(不能使用 setData)  */
  attached: function () {
    // console.log(this.properties);
    // console.log(this.data);
    /* 小程序会将 properties 对象和 data 对象合成一个对象 */
    /* data 和 properties 不要出现同名变量, 否则覆盖, properties 会覆盖 data 中的变量(同名的话) */
    let date = new Date();
    let year = date.getFullYear();
    let month = date.getMonth(); /* month 从 0 开始数! */

    this.setData({
      year,
      month: this.data.months[month], /* 6 => 七月 */
    });
  },

  /**
   * 组件的方法列表
   */
  methods: {},
});
```

components\episode\index.wxml

```html
<view class="container">
  <view class="index-container">
    <text class="plain">No.</text>
    <text class="index">{{_index}}</text>
    <view class="line"></view>
  </view>
  <view class="date-container">
    <text class="month">七月</text>
    <text class="year">{{year}}</text>
  </view>
</view>
```

components\episode\index.wxss

```css
/* 文字排版技巧很多 */
.container{
  height:60rpx; /* 高度是由最大的字体决定的 */
  display:inline-flex;
  flex-direction: row;
}

.index-container{
  display:flex;
  flex-direction: row;
  align-items: baseline; /* 文字的底部是对齐的 */
}

.plain{
  font-size:32rpx;
}


.index{
  font-size:60rpx; /* 最大的字体 */
  line-height:60rpx; /* 行高也是对齐的重要属性 */
  font-weight:800;
  margin-right:14rpx;
}

.line{
  height:44rpx;
  margin-right:14rpx;
  border-left:1px solid black; /* 边框模拟竖线 */
}


.date-container{
  display: flex;
  flex-direction: column;
  margin-top:6rpx;
}

.month{
  font-size:24rpx;
  line-height: 24rpx;
}

.year{
  font-size:20rpx;
}
```

#### like 组件

components\like\index.json

```json
{
  "component": true,
  "usingComponents": {}
}
```

components\like\index.js

```js
// components/like/index.js
Component({
  /**
   * 组件的属性列表
   */
  properties: {
    like: {
      type: Boolean,
    },
    count: {
      type: Number,
    },
    readOnly: {
      type: Boolean,
    },
    test: {
      type: Object,
    },
  },

  /**
   * 组件的初始数据
   */
  data: {
    // 数据绑定
    // 三元表达式
    //封装性 开放性
    // 封装在内部 ，开放出来的
    // 粒度
    // 非常简单的功能   非常复杂的功能
    yesSrc: 'images/like.png',
    noSrc: 'images/like@dis.png',
  },

  /**
   * 组件的方法列表
   */
  methods: {
    onLike: function (event) {

      if (this.properties.readOnly) {
        return;
      }
      let like = this.properties.like;
      let count = this.properties.count;

      count = like ? count - 1 : count + 1;
      this.setData({
        count: count,
        like: !like,
      });
      // 激活 自定义事件, 目的是知道搞清楚用户 tap 一下的时候, 是 "点赞" 还是 "取消点赞" (behavior) 并将其传递出去
      let behavior = this.properties.like ? 'like' : 'cancel';
      this.triggerEvent(
        'like',
        {
          behavior: behavior, /* 其实是在设置自定义事件对象 event 的 detail 属性 */
        },
        {}
      );
    },
  },
});
```

components\like\index.wxml

```html
<!-- components/like/index.wxml -->
<view bind:tap="onLike" class="container">
    <image src="{{like?yesSrc:noSrc}}" />
    <text>{{count}}</text>
</view>
```

components\like\index.wxss

```css
/* components/like/index.wxss */

.container{
    display:inline-flex;
    flex-direction: row;
    padding: 10rpx;
    width:90rpx;
}

.container image{
   width:32rpx;
   height:28rpx;

}

.container text{
    /* 苹方  思源 */
    /* font-family: "PingFangSC-Thin"; */
    font-size:24rpx;
    line-height: 24rpx;
    color: #bbbbbb;
    position: relative;
    bottom: 10rpx;
    left: 6rpx;
}
```

### classic  页面下方的组件

#### navi 组件

components\navi\index.json

```json
{
  "component": true,
  "usingComponents": {}
}
```

components\navi\index.js

```js
// components/navi/navi.js
Component({
  /**
   * 组件的属性列表
   * 考虑有哪些数据是需要从外部传递过来的
   */
  properties: {
    title: String,
    first: Boolean, /* 最新一期? 左边箭头变灰, 不可点击 */
    latest: Boolean /* 最后一期? 右边箭头变灰, 不可点击 */
  },

  /**
   * 组件的初始数据
   */
  data: {
    disLeftSrc: 'images/triangle.dis@left.png',
    leftSrc: 'images/triangle@left.png',
    disRightSrc: 'images/triangle.dis@right.png',
    rightSrc: 'images/triangle@right.png'
  },

  /**
   * 组件的方法列表
   */
  methods: {
    onLeft: function (event) {
      /* 自定义事件, 告诉 page 用户点击了 向左的箭头 */
      if (!this.properties.latest) {
        /* 如果是 latest 根本不触发 */
        this.triggerEvent('left', {}, {})
      }
    },

    onRight: function (event) {
      /* 自定义事件, 告诉 page 用户点击了 向右的箭头 */
      if (!this.properties.first) {
        /* 如果是 first 根本不触发 */
        this.triggerEvent('right', {}, {})
      }
    }

  }
})
```

components\navi\index.wxml

```html
<view class="container">
  <image bind:tap="onLeft" class="icon" src="{{latest?disLeftSrc:leftSrc}}" />
  <text class="title">{{title}}</text>
  <image bind:tap="onRight" class="icon" src="{{first?disRightSrc:rightSrc}}" />
</view>
```

### classic 页面中间的组件

#### 组件共有代码

components\classic\classic-beh.js

```js
/* 组件中的代码复用, 通过 Behavior 对象, 像编写 component 一样编写 behavior */
const classicBeh = Behavior({
  properties: {
    img: String,
    content: String,
    hidden: Boolean,
  },
  attached: function () {},
  data: {},
  methods: {},
});

export { classicBeh };
```

components\classic\common.wxss

```css
/* components/classic/movie/index.wxss */
/* 模板 template*/

.classic-container {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.classic-img {
  width: 750rpx;
  height: 500rpx;
}

.tag {
  width: 46rpx;
  height: 142rpx;
  position: relative; /* 相对自己当前的位置偏移 */
  right: 310rpx;
  bottom: 58rpx;
}

.content {
  font-size: 36rpx;
  max-width: 550rpx; /* 给文本一个宽度, 文本将会自动换行, 但是需要自适应, 不要使用定宽, 使用 max-width */
}
```

#### movie 组件

<img src="https://cdn.nlark.com/yuque/0/2022/png/1614731/1652935726447-8e6905de-7737-43e7-b9d6-9920d81f6c31.png" alt="img" style="zoom:67%;" />

components\classic\movie\index.json

```json
{
  "component": true,
  "usingComponents": {}
}
```

components\classic\movie\index.js

```js
// components/classic/movie/index.js
import {classicBeh} from '../classic-beh.js'
Component({
  /**
   * 组件的属性列表
   */
  behaviors:[classicBeh],
})
```

components\classic\movie\index.wxml

```html
<view hidden="{{hidden}}" class="classic-container">
  <image class="classic-img" src="{{img}}" />
  <image class="tag" src="images/movie@tag.png" />
  <text class="content">{{content}}</text>
</view>
```

components\classic\movie\index.wxss

```css
@import "../common.wxss";
```

#### essay 组件

<img src="https://cdn.nlark.com/yuque/0/2022/png/1614731/1652935668409-c7d9cdeb-dd4c-4deb-b921-bc4bf1b3dbc0.png" alt="img" style="zoom:67%;" />

components\classic\essay\index.json

```json
{
  "component": true,
  "usingComponents": {}
}
```

components\classic\essay\index.js

```js
import {classicBeh} from '../classic-beh.js'

Component({
  /**
   * 组件的属性列表
   */
  behaviors:[classicBeh],
  // behaviors:[classicBeh, bh1, bh2], 多继承 后面覆盖前面, 组件内部定义的覆盖继承的
  /* behavior 中的生命周期函数, 不会存在覆盖现象, 而是会依次调用每个 behavior 中的生命周期函数, 最后再调用组件内部自己定义的生命周期函数 */
  // 多继承
})
```

components\classic\essay\index.wxml

```html
<view hidden="{{hidden}}" class="classic-container">
    <image class="classic-img" src="{{img}}"  />
    <image class="tag" src="images/essay@tag.png" />
    <text class="content" >{{content}}</text>
</view>
```

components\classic\essay\index.wxss

```css
@import "../common.wxss";
```

#### music 组件

<img src="https://cdn.nlark.com/yuque/0/2022/png/1614731/1652935668281-2bdbf697-1df8-4a47-a90d-2e20a938c369.png" alt="img" style="zoom: 67%;" />

<img src="https://cdn.nlark.com/yuque/0/2022/png/1614731/1652935668321-0c3a8860-7f48-4286-b95a-0a8616fd6281.png" alt="img" style="zoom:67%;" />

<img src="https://cdn.nlark.com/yuque/0/2022/png/1614731/1652935668324-9e6ff632-3ce9-4d7a-a727-77a0983434a2.png" alt="img" style="zoom: 67%;" />

components\classic\music\index.json

```json
{
  "component": true,
  "usingComponents": {}
}
```

components\classic\music\index.js

```js
import { classicBeh } from '../classic-beh.js';

/* 获取全局唯一的背景音频管理器 */
const mMgr = wx.getBackgroundAudioManager();

Component({
  /**
   * 组件的属性列, 动画
   * 动画API CSS3 canvas 游戏
   * 现成
   */
  behaviors: [classicBeh],
  properties: {
    src: String,
    title: String,
  },

  /**
   * 组件的初始数据
   * 播放音乐API 老版API 新版API
   */
  data: {
    playing: false,
    pauseSrc: 'images/player@pause.png',
    playSrc: 'images/player@play.png',
  },

  // hidden ready created
  //onShow
  attached(event) {
    // 跳转页面 当前 切换
    /* hidden 不能触发, wx:if 可以触发 */
    this._recoverStatus();
    this._monitorSwitch();
  },
  /* 在组件实例被从页面节点树移除时执行 hidden 不会触发 detached 因为仅仅是隐藏了 DOM 没有移除 DOM	 */
  detached: function (event) {
    // wx:if hidden
    // mMgr.stop()
    // console.log(123);
  },

  /**
   * 组件的方法列表
   */
  methods: {
    onPlay: function (event) {
      // 图片要切换
      /* 如果没有播放音乐, 我们要播放音乐 */
      if (!this.data.playing) {
        this.setData({
          playing: true,
        });
        mMgr.src = this.properties.src; /* 赋值一个 src 自动播放 */
        mMgr.title = this.properties.title;
      } else {
        /* 当前正在播放音乐, 我们应该执行相反操作 */
        this.setData({
          playing: false,
        });
        mMgr.pause();
      }
    },
    /**
     *
     * @returns null 根据条件重置 playing 属性值
     */
    _recoverStatus: function () {
      if (mMgr.paused) {
        this.setData({
          playing: false,
        });
        return;
      }
      /* 每当用户切换到一个 music 组件的时候, 做一次检测, 检测当前播放的音乐 src 是否与 当前文档中的背景音乐相同 */
      if (mMgr.src == this.properties.src) {
        this.setData({
          playing: true,
        });
      }
    },
    /**
     * 解决后台总控开关，控制音乐图片播放还是暂停的显示切换
     * 一旦后台总控开关发生变化（play pause stop ended）重置 playing 属性值，完成图片切换和后台总控开关同步
     */
    _monitorSwitch: function () {
      mMgr.onPlay(() => {
        this._recoverStatus();
      });
      mMgr.onPause(() => {
        this._recoverStatus();
      });
      /* 关掉后台总控开关 */
      mMgr.onStop(() => {
        this._recoverStatus();
      });
      /* 自然播放完成 */
      mMgr.onEnded(() => {
        this._recoverStatus();
      });
    },
  },
});
```

components\classic\music\index.wxml

```html
<view class="container" hidden="{{hidden}}" >
  <!-- 封面图 -->
  <!-- 是否旋转也就是是否添加 rotation 类名。 -->
    <image class="classic-img {{playing?'rotation':''}}" src="{{img}}" />
    <!-- 播放按钮 -->
    <image class="player-img" bind:tap="onPlay"
        src="{{!playing?playSrc:pauseSrc}}" />
        <!-- tag "音乐" -->
    <image class="tag" src="images/music@tag.png" />
    <text class="content">{{content}}</text>
</view>
```

components\classic\music\index.wxss

```css
.container {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.classic-img {
  width: 422rpx;
  height: 422rpx;
  margin-top: 60rpx;
  border-radius: 50%; /* 圆形图片 */
}

.player-img {
  width: 120rpx;
  height: 120rpx;
  position: relative; /* 相对自身进行偏移 */
  bottom: 270rpx;
}

.tag {
  width: 44rpx;
  height: 128rpx;
  position: relative;
  bottom: 160rpx;
  right: 310rpx;
}

.rotation {
  transform: rotate(360deg);
  animation: rotation 12s linear infinite;
  -moz-animation: rotation 12s linear infinite;
  -webkit-animation: rotation 12s linear infinite;
  -o-animation: rotation 12s linear infinite;
}

@keyframes rotation {
  from {
    -webkit-transform: rotate(0deg);
  }

  to {
    -webkit-transform: rotate(360deg);
  }
}
```



## Promise 封装请求

utils\http-p.js

```js
import { config } from '../config.js';

const tips = {
  1: '抱歉，出现了一个错误',
  1005: 'appkey无效，请前往www.7yue.pro申请',
  3000: '期刊不存在',
};
// # 解构
class HTTP {
  /* 默认值, 别人就知道需要传递什么类型的参数了 */
  /* 对象的结构 */
  request({ url, data = {}, method = 'GET' }) {
    return new Promise((resolve, reject) => {
      this._request(url, resolve, reject, data, method);
    });
  }
  /* 必填参数必须放在默认参数之前 */
  _request(url, resolve, reject, data = {}, method = 'GET') {
    wx.request({
      url: config.apiurl + url,
      method: method,
      data: data,
      header: {
        'content-type': 'application/json',
        appkey: config.appkey,
      },
      success: (res) => {
        const code = res.statusCode.toString();
        if (code.startsWith('2')) {
          /* 成功，使用 resolve 将 res.data 传递出去 */
          resolve(res.data);
        } else {
          /* 失败，调用 reject 函数 */
          reject();
          const error_code = res.data.error_code;
          this._show_error(error_code);
        }
      },
      fail: (err) => {
        console.log("失败", err);
        reject();
        this._show_error(1);
      },
    });
  }

  _show_error(error_code) {
    if (!error_code) {
      error_code = 1;
    }
    const tip = tips[error_code];
    wx.showToast({
      title: tip ? tip : tips[1],
      icon: 'none',
      duration: 2000,
    });
  }
}

export { HTTP };
```



## 书籍页面

<img src="https://cdn.nlark.com/yuque/0/2022/gif/1614731/1653462004470-51c99365-0f20-46b7-a2be-f296b766a8d2.gif" alt="img" style="zoom:80%;" />

### 页面请求

models\book.js

```js
import {
  HTTP
}
from '../utils/http-p.js'

class BookModel extends HTTP {
  data = null

  getHotList() {
    /* 直接返回一个 Promise */
    return this.request({
      url: 'book/hot_list'
    })
  }
  
  search(start, q) {
    return this.request({
      url: 'book/search?summary=1',
      data: {
        q: q,
        start: start
      }
    })
  }

  getMyBookCount() {
    return this.request({
      url: 'book/favor/count'
    })
  }

  getDetail(bid) {
    return this.request({
      url: `book/${bid}/detail`
    })
  }

  getLikeStatus(bid) {
    return this.request({
      url: `book/${bid}/favor`
    })
  }

  getComments(bid) {
    return this.request({
      url: `book/${bid}/short_comment`
    })
  }


  postComment(bid, comment) {
    return this.request({
      url: 'book/add/short_comment',
      method: 'POST',
      data: {
        book_id: bid,
        content: comment
      }
    })
  }
}

export {
  BookModel
}
```

models\keyword.js

```js
import { HTTP } from '../utils/http-p.js';

class KeywordModel extends HTTP {
  key = 'q'; /* 默认 const */
  maxLength = 10; /* 限制搜索栏的 tag 数量 */
  /* 历史搜索, 使用缓存原理 */
  getHistory() {
    const words = wx.getStorageSync(this.key);
    if (!words) {
      return [];
    }
    return words;
  }

  /* 热门搜索, 从服务器中获取到数据 */
  getHot() {
    return this.request({
      url: 'book/hot_keyword',
    });
  }

  /* 历史搜索写入到缓存 */
  addToHistory(keyword) {
    let words = this.getHistory();
    const has = words.includes(keyword);
    // 队列 栈
    if (!has) {
      // 数组末尾 删除 ， keyword 数组第一位
      const length = words.length;
      if (length >= this.maxLength) {
        words.pop(); /* 删除数组末尾元素 */
      }
      words.unshift(keyword);
      /* 同步 */
      wx.setStorageSync(this.key, words);
    }
  }
}

export { KeywordModel };
```

### 页面入口

<img src="https://cdn.nlark.com/yuque/0/2022/png/1614731/1653461995618-0f60b340-e00f-4efa-9fe5-c99b87dae816.png" alt="img" style="zoom:80%;" />

utils\common.js

```js
const chars = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];

const random = function generateMixed(n) {
  var res = "";
  for (var i = 0; i < n; i++) {
    var id = Math.ceil(Math.random() * 35);
    res += chars[id];
  }
  return res;
}

const promisic = function(func) {
  return function(params = {}) {
    return new Promise((resolve, reject) => {
      const args = Object.assign(params, {
        success: (res) => {
          resolve(res)
        },
        fail: (error) => {
          reject(error)
        }
      })
      func(args)
    })
  }
}

export {
  random,
  promisic
}
```

pages\book\book.json

```json
{
    "usingComponents": {
        "v-book": "/components/book/index",
        "v-search": "/components/search/index"
    }
}
```

pages\book\book.js

```js
import {
  BookModel
} from '../../models/book.js'

import {
  random
} from '../../utils/common.js'

const bookModel = new BookModel()

Page({
  /**
   * 页面的初始数据
   */
  data: {
    books: [],
    searching:false,
    more:''
  },

  /**
   * 生命周期函数--监听页面加
   * 对象: 可以在内部保存状态
   * 普通函数: 不能够在内部保存状态, 一旦调用必须返回(return undefined)
   */
  async onLoad(options) {
    const books = await bookModel.getHotList()
    /* 记得使用 setData 不要直接赋值 */
    this.setData({
      books
    })
      // .then(res => {
      //   this.setData({
      //     books:res
      //   })
      // })
    // id
  },

  onSearching(event){
    this.setData({
      searching:true
    })
  },

  onCancel(event){
    this.setData({
      searching:false
    })
  },

  onReachBottom(){
    this.setData({
      more:random(16)
    })
  }
})
```

pages\book\book.wxml

```html
<!-- for 循环 wx:for -->
<view wx:if="{{!searching}}" class="container">
  <view class="header">
    <view class='box' bind:tap="onSearching">
      <image src="/images/icon/search.png" />
      <text>搜索书籍</text>
    </view>
  </view>
  <view class="sub-container">
    <image class="head-img" src="/images/book/quality.png" />
    <view class="books-container">
      <!-- wx:key 不要使用 {{}} 双花括号 -->
      <block wx:key="id" wx:for="{{books}}">
        <v-book book="{{item}}" />
      </block>
    </view>
  </view>
</view>
<!-- 监听 cancel 事件 -->
<v-search more="{{more}}" bind:cancel="onCancel" wx:if="{{searching}}" />
```

pages\book\book.wxss

```css
.container {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
}

.sub-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    background-color: #f5f5f5;
    margin-top: 100rpx;
}

.box {
    display: flex;
    flex-direction: row;
    justify-content: center;
    align-items: center;
    border-radius: 50px;
    background-color: #f5f5f5;
    height: 68rpx;
    width: 700rpx;
    color: #999999;
}

.header {
    position: fixed; /* 固定头部搜索栏 */
    background-color: #ffffff;
    height: 100rpx;
    width: 100%;
    border-top: 1px solid #f5f5f5;
    border-bottom: 1px solid #f5f5f5;
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: center;
    box-shadow: 0 0 3px 0 #e3e3e3;
    z-index: 99; /* 提高层级 */
}

.head-img {
    width: 106rpx;
    height: 34rpx;
    margin-top: 40rpx;
}

.box image {
    margin-right: 10px;
    width: 14px;
    height: 14px;
    margin-bottom: -2px;
}

.books-container {
    margin-top: 10rpx;
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: space-between;
    padding: 0 90rpx; /* 给一个 padding 占据更大的 width 然后就可以实现 flex 一行三个 => 一行两个 */
}

.books-container v-book{
    margin-bottom: 10rpx;
}
```

### book 页面下方的组件

#### book 组件

components\book\index.json

```json
{
  "component": true,
  "usingComponents": {}
}
```

components\book\index.js

```js
// components/book/index.js
Component({
  /**
   * 组件的属性列表
   */
  properties: {
    book:Object,
    showLike:{
      type:Boolean,
      value:true
    }
  },

  /**
   * 组件的初始数据
   */
  data: {

  },

  /**
   * 组件的方法列表
   */
  methods: {
    onTap(event){
      /* 组件自己就知道用户点击的到底是哪一本图书的 id 号, 因此在组件内部编写路由跳转代码 */
      /* 这样就不需要自定义事件, 将 id 传递给 book 页面了, 更方便 */
      /* 但是这样子就牺牲了 组件的通用性, 自己取舍 */
      const bid = this.properties.book.id

      /* 将 bid 通过路由参数的形式, 传递给 book-detail 页面 作为 options 参数的属性 */
      wx.navigateTo({
        url:`/pages/book-detail/book-detail?bid=${bid}`
      })
      // 降低了组件的通用性
      // 非常方便
      // 服务于当前的项目 项目组件
      //
    }
  }
})
```

components\book\index.wxml

```html
<view bind:tap="onTap" class="container">
    <image src="{{book.image}}"></image>
    <view class="description">
        <text class='title'>{{book.title}}</text>
        <text class='author'>{{book.author}}</text>
        <view wx:if="{{showLike}}" class='foot'>
            <text class="footer">{{book.fav_nums}}  喜欢</text>
        </view>
    </view>
</view>
```

components\book\index.wxss

```css
.container {
    margin-top: 30rpx;
    display: flex;
    position: relative; /* 父相 */
    box-shadow: 2px 2px 3px #e3e3e3;
    flex-direction: column;
    width: 240rpx;
    height: 360rpx;
}

.container image {
    width: 100%;
    height: 100%;
    border-radius: 2px;
}

.description {
    width: 216rpx;
    position: absolute; /* 子绝, 参照元素的问题 */
    bottom: 0;
    background-color: #fff;
    padding: 5rpx 10rpx 8rpx 15rpx;
    font-size: 24rpx;
    display: flex;
    flex-direction: column;
    border-bottom-right-radius: 2px;
    border-bottom-left-radius: 2px;
}

.title {
    margin-top: 10rpx;
    text-overflow: ellipsis;
    white-space: nowrap;
    overflow: hidden;
}

.author {
    font-size: 20rpx;
    color: #999999;
    margin-bottom: 10rpx;
    text-overflow: ellipsis;
    white-space: nowrap;
    overflow: hidden;
}

.foot {
    font-size: 20rpx;
    display: flex;
    flex-direction: row;
    justify-content: flex-end;
}

.footer {
    color: #666666;
}
```

### 跳转到书籍详情

<img src="https://cdn.nlark.com/yuque/0/2022/png/1614731/1653461995540-2ff36ccd-36a1-405a-be0c-bebce68c7e19.png" alt="img" style="zoom:80%;" />

<img src="https://cdn.nlark.com/yuque/0/2022/png/1614731/1653461995557-c28bcdd0-6296-4e0b-ab09-540d0f2148c6.png" alt="img" style="zoom:80%;" />

<img src="https://cdn.nlark.com/yuque/0/2022/png/1614731/1653461995545-392c8454-6585-426c-9a14-1b9620d77387.png" alt="img" style="zoom:80%;" />

<img src="https://cdn.nlark.com/yuque/0/2022/png/1614731/1653461995557-c3d84dfe-7a7f-4a17-86a1-4ebcad62df38.png" alt="img" style="zoom:80%;" />

#### 书籍详情入口

utils\filter.wxs

```css
var format = function(text){
    if(!text){
        return
    }
    /* 生成 regexp 对象需要使用 getRegExp函数和 ES5 不同。*/
    /* 寻找和匹配的字符串是 \\n 加上转义字符就是 \\\\n */
    var reg = getRegExp('\\\\n','g') /* g 表示 global  */
    /* \\n => \n 而且在段落首添加两个空格 */
    return text.replace(reg, '\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;')
}

/* 截取数组的前若干条 */
var limit = function(array, length){
    return array.slice(0, length)
}

/* 只能使用 commonJS wxs 在语法形式上和 js 相似, 但是有自己的一套语法, 比如不支持 ES6 语法, const let 不支持, 支持 var */
/* 参照 JS 的 ES5 语法标准 */
/* wxs 结合 wxml 使用(能够在 wxml 中进行调用), 但是不能替代 js */
module.exports = {
    format:format,
    limit:limit
}
```

pages\book-detail\book-detail.json

```json
{
    "usingComponents": {
        "v-tag": "/components/tag/index",
        "v-like": "/components/like/index",
        "v-mask": "/components/mask/index"
    }
}
```

pages\book-detail\book-detail.js

```js
// pages/book-detail/book-detail.js
/*
  Page 处理 ui 交互
  Module 处理数据请求发送的具体实现(业务逻辑)
*/
import { BookModel } from '../../models/book.js';
import { LikeModel } from '../../models/like.js';
const bookModel = new BookModel();
const likeModel = new LikeModel();

Page({
  /**
   * 页面的初始数据
   */
  data: {
    comments: [],
    book: null,
    likeStatus: false,
    likeCount: 0,
    posting: false,
  },

  /**
   * 生命周期函数--监听页面加载
   */

  onLoad: function (options) {
    wx.showLoading(); /* 还没有取到数据, 显示 Loading 转圈 */
    /* options 接收到 路由参数 */
    const bid = options.bid;
    /* 取到三个 Promise */
    const detail = bookModel.getDetail(bid);
    const comments = bookModel.getComments(bid);
    const likeStatus = bookModel.getLikeStatus(bid);

    /* 并行发送请求 好于 串行发送请求 */
    /* 使用 all 方法, 可以确实收到三个请求的结果, 然后取消 Loading 状态 */
    Promise.all([detail, comments, likeStatus]).then((res) => {
      this.setData({
        book: res[0],
        comments: res[1].comments,
        likeStatus: res[2].like_status,
        likeCount: res[2].fav_nums,
      });
      wx.hideLoading(); /* 取消 Loading 转圈 */
    });
  },

  onLike(event) {
    const like_or_cancel = event.detail.behavior;
    /* 发送请求, 服务器更新 like */
    likeModel.like(like_or_cancel, this.data.book.id, 400);
  },

  onFakePost(event) {
    this.setData({
      posting: true,
    });
  },

  onCancel(event) {
    this.setData({
      posting: false,
    });
  },

  onPost(event) {
    /* 通过 event.detail 拿到组件传递过来的数据 */
    /* 用户点击 tag 发送的 text 以及用户自己输入的 value(input 输入框) */
    const comment = event.detail.text || event.detail.value;

    if (!comment) {
      return;
    }

    if (comment.length > 12) {
      wx.showToast({
        title: '短评最多12个字',
        icon: 'none',
      });
      return;
    }

    bookModel.postComment(this.data.book.id, comment).then((res) => {
      wx.showToast({
        title: '+ 1',
        icon: 'none',
      });

      /* 用户添加的短评, 添加到 comments 数组中去(添加到数组的第一个元素中) */
      this.data.comments.unshift({
        content: comment,
        nums: 1,
      });

      /* setData 更新 comments 数组 */
      this.setData({
        comments: this.data.comments,
        posting: false /* 设为 false 关闭 mask 蒙层 */,
      });
    });
  },

  /**
   * 用户点击右上角分享
   */
  onShareAppMessage: function () {},
});

```

pages\book-detail\book-detail.wxml

```html
<wxs src="../../utils/filter.wxs" module="util" /> <!-- 导入 wxs 模块, 只能使用相对路径 -->
<view class="container">
  <view class="head">
    <image src="{{book.image}}"></image>
    <text class='title'>{{book.title}}</text>
    <text class='author'>{{book.author}}</text>
  </view>
  <view class="sub-container">
    <text class="headline">短评</text>
    <!-- 一个 tag 短评都没有, 给一个友好提示, "还没有短评" -->
    <text class="shadow" wx:if="{{comments==false}}">还没有短评</text>
    <!-- 书籍标签 -->
    <view class="comment-container">
      <block wx:for="{{util.limit(comments, 10)}}" wx:key="content">
        <!-- wx:for 中 index 可以标记序号 -->
        <v-tag tag-class="{{tool.highlight(index)}}" text="{{item.content}}">
          <!-- 使用 slot 属性，标记这是一个插槽，需要替换掉组件内部的 <slot> 标签 -->
          <text class="num" slot="after">{{'+'+item.nums}}</text>
        </v-tag>
      </block>
    </view>

  </view>
  <view class="sub-container">
    <text class="headline">内容简介</text>
    <!-- format 函数会执行两次! 初始化一次(没有值 undefined), setData 更新一次(有值) -->
    <!-- 小程序认为 text 里面的所有内容就是一段! -->
    <!-- 开启 decode 解析转义字符(&nbsp;)  -->
    <text class="content" decode="{{true}}">{{util.format(book.summary)}}</text>
    <!-- <text>aaaaa\bbbbbb</text> text 本身具有解析 \ 的能力(遇到 \ 换行) 对 text 中间的文本不要手贱去换行! -->
    <!-- 服务器返回的原始数据 \n text 换行 -->
    <!-- 服务器返回的原始数据 \\n 转义字符 变成 \n 不会被 text 识别为换行 -->
    <!-- 所以如果要让 text 将 \\n 解析为换行, 需要将所有的 \\n => \n 可以使用正则进行处理 -->
  </view>

  <view class="sub-container">
    <text class="headline">书本信息</text>
    <view class="detail-container">
      <view class="vertical description">
        <text>出版社</text>
        <text>出版年</text>
        <text>页数</text>
        <text>定价</text>
        <text>装帧</text>
      </view>
      <view class="vertical">
        <text>{{book.publisher}}</text>
        <text>{{book.pubdate}}</text>
        <text>{{book.pages}}</text>
        <text>{{book.price}}</text>
        <text>{{book.binding}}</text>
      </view>
    </view>
  </view>
</view>
<!-- 短评 -->
<view class="post-container" hidden="{{posting}}">
  <!-- 输入框 -->
  <view bind:tap="onFakePost" class="post-fake">
    <text>输入短评</text>
  </view>
  <!-- 点赞按钮, 直接复用 like 组件就 OK 了 -->
  <view class="like-container">
    <v-like bind:like="onLike" class="like" like="{{likeStatus}}"
      count="{{likeCount}}" />
  </view>
</view>

<!-- 真正输入短评的地方 -->
<view class="posting-container" wx:if="{{posting}}">
  <view class="post-header">

    <text wx:if="{{comments==true}}">仅可点击标签+1</text>
    <!-- 友好提示 "暂无短评" -->
    <text wx:else>暂无短评</text>
    <!-- 取消 -->
    <text bind:tap="onCancel" class="cancel">取消</text>
  </view>

  <view class="comment-container">
    <!-- 将点赞数最高的3个标签, 填充到真实的输入框模块 -->
    <block wx:for="{{util.limit(comments, 3)}}" wx:key="content">
      <v-tag bind:tapping="onPost" tag-class="{{tool.highlight(index)}}"
        text="{{item.content}}">
        <!-- tapping 自定义事件 -->
        <text class="num" slot="after">{{'+'+item.nums}}</text>
      </v-tag>
    </block>
  </view>
  <!-- bindconfirm 事件监听用户输入完成之后, 点击键盘上的 确认按钮 -->
  <input bindconfirm="onPost" class="post" placeholder='短评最多12个字'></input>
</view>

<!-- 背景蒙版 -->
<v-mask wx:if="{{posting}}" />

<!--
  wxml 中编写 js 或者调用 js, 不可能
  wxs 可以! wxs 可以写在 wxml 中 也可以独立出去, 然后在 wxml 中引用 wxs
 -->
<wxs module="tool">
  var highlight = function(index){
    if (index === 0) {
      return 'ex-tag1'
    }
    if (index ===  1) {
      return 'ex-tag2'
    }
    return ''
  }
  module.exports = {
    highlight:highlight
  }
</wxs>
```

pages\book-detail\book-detail.wxss

```css
.container {
    background-color: #f5f5f5;
    width: 100%;
}

.head {
    background-color: #fff;
    padding-top: 40rpx;
    padding-bottom: 40rpx;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.title {
    color: #2f2f2f;
    margin-top: 20rpx;
    font-size: 38rpx;
    font-weight: 600;
}

.author {
    font-size: 28rpx;
    color: #999;
    /* margin-bottom: 30rpx; */
}

.head image {
    width: 200rpx;
    height: 300rpx;
    box-shadow: 2px 2px 3px #e3e3e3;
}

.sub-container {
    width: 690rpx;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: 30rpx;
    background-color: #fff;
    padding: 30rpx;
}

.headline {
    font-size: 30rpx;
    font-weight: 600;
    color: #2f2f2f;
    margin-bottom: 20rpx;
}

.comment-container {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
}

.comment-container v-tag {
    margin-right: 15rpx;
    margin-bottom: 10rpx; /* 外边距塌陷，可以使用 flex 布局来解决 */
}

.content {
    text-indent: 58rpx;
    font-weight: 500;
}

.num {
    margin-left: 10rpx;
    font-size: 22rpx;
    color: #aaa;
}

/* hack 技巧, 对自定义组件内部的子元素 view 进行样式的设置, 要求我们明白组件内部的实现细节, 知道组件外面真的包了一层 view */
/* 自己写项目, 组件是自己定义的时候, 推荐使用, 非常方便! */
/* .comment-container>v-tag:nth-child(1)>view {
    background-color: #fffbdd;
}

.comment-container>v-tag:nth-child(2)>view {
    background-color: #eefbff;
} */
/* 可以对小程序内置的组件 view text image 等等应用 CSS 但是自定义组件必须使用外部样式类 */
.ex-tag1 {
    background-color: #fffbdd !important; /* 添加 !important 就可以保证外部样式类一定可以覆盖组件默认的样式! */
}

.ex-tag2 {
    background-color: #eefbff !important;
}

.detail-container {
    width: 100%;
    display: flex;
    flex-direction: row;
    justify-content: flex-start;
    margin-bottom: 100rpx;
    font-size: 28rpx;
    color: #666;
}

.vertical {
    display: flex;
    flex-direction: column;
}

.description {
    color: #999;
    margin-right: 30rpx;
}

.post-container {
    height: 100rpx;
    box-shadow: 1px -1px 1px #e3e3e3;
    position: fixed; /* 固定定位 */
    width: 690rpx;
    background-color: #fff;
    bottom: 0;
    display: flex;
    flex-direction: row;
    align-items: center;
    padding: 0 30rpx;
    justify-content: space-between;
}

.post-fake {
    display: flex;
    flex-direction: row;
    align-items: center;
    height: 60rpx;
    width: 460rpx;
    border: 1px solid #999;
    border-radius: 15px;
    font-size: 22rpx;
    padding-left: 20rpx;
}

.like {
    margin-right: 30rpx;
    margin-top: 10rpx;
}

.like-container {
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
}

.posting-container {
    bottom: 0;
    position: fixed;
    display: flex;
    flex-direction: column;
    align-items: center;
    background-color: #fff;
    width: 100%;
    z-index: 999;
}

.post-header {
    width: 100%;
    border-bottom: 1px solid #f5f5f5;
    border-top: 1px solid #f5f5f5;
    height: 100rpx;
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
}

.cancel {
    color: #666;
}

.post-header text {
    padding: 25rpx;
}

.post-header>text:first-child {
    font-size: 28rpx;
    color: #bbb;
}

.posting-container .comment-container {
    width: 690rpx;
    padding: 40rpx 30rpx 0 30rpx;
}

.post {
    width: 690rpx;
    margin: 30rpx auto;
    height: 56rpx;
    background-color: #f5f5f5;
    border-radius: 15px;
    padding-left: 25rpx;
}

.shadow {
    color: #999;
}
```

#### tag 组件

components\tag\index.json

```json
{
  "component": true,
  "usingComponents": {}
}
```

components\tag\index.js

```js
// components/tag/index.js
Component({
  /**
   * 组件的属性列表
   */

  options: {
    /* 启用 slot */
    multipleSlots: true,
  },
  externalClasses: ['tag-class'], /* 外部样式类 */
  properties: {
    text: String,
  },

  /**
   * 组件的初始数据
   */
  data: {},

  /**
   * 组件的方法列表
   */
  methods: {
    onTap(event) {
      /* 自定义事件 */
      this.triggerEvent('tapping', {
        text: this.properties.text,
      });
    },
  },
});
```

components\tag\index.wxml

```html
<!-- 后面的 tag-class 可以覆盖(新增)前面的 container 中的样式? 不一定!  -->
<!-- 小程序认为所有的样式，都需要从外部添加，这就是外部样式类！ -->
<!-- 设计的很烂，可以在外部样式类中具体的 CSS 规则中添加 !important hack 它 -->
<view bind:tap="onTap" class="container tag-class">
  <!-- 组件插槽, 自定义使用，组件的某一部分完全由组件调用方来决定，可以自定义样式之类的，很方便 -->
  <slot name="before"></slot>
  <text>{{ text }}</text>
  <slot name="after"></slot>
  <!-- 占位，需要就传，不需要当不存在 -->
</view>

<!-- 普通样式 外部样式 -->
```

components\tag\index.wxss

```css
.container {
    padding: 4rpx 12rpx;
    background-color: #f5f5f5;
    color: #666666;
    border-radius: 2px;
    display: inline-flex;
    flex-direction: row;
    align-items: center;
    justify-content: center;
    font-size: 28rpx;
}
```

#### mask 组件

components\loading\index.json

```json
{
  "component": true,
  "usingComponents": {}
}
```

components\loading\index.js

```js
// components/loading/index.js
Component({
  /**
   * 组件的属性列表
   */
  properties: {

  },

  /**
   * 组件的初始数据
   */
  data: {

  },

  /**
   * 组件的方法列表
   */
  methods: {

  }
})
```

components\loading\index.wxml

```html
<view class="spinner">
  <view class="double-bounce1"></view>
  <view class="double-bounce2"></view>
</view>
```

components\loading\index.wxss

```css
.spinner {
    width: 40rpx;
    height: 40rpx;
    position: relative;
}

.double-bounce1,
.double-bounce2 {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background-color: #3063b2;
    opacity: 0.6;
    position: absolute;
    top: 0;
    left: 0;
    -webkit-animation: bounce 2.0s infinite ease-in-out;
    animation: bounce 2.0s infinite ease-in-out;
}

.double-bounce2 {
    -webkit-animation-delay: -1.0s;
    animation-delay: -1.0s;
}

@-webkit-keyframes bounce {

    0%,
    100% {
        -webkit-transform: scale(0.0)
    }

    50% {
        -webkit-transform: scale(1.0)
    }
}

@keyframes bounce {

    0%,
    100% {
        transform: scale(0.0);
        -webkit-transform: scale(0.0);
    }

    50% {
        transform: scale(1.0);
        -webkit-transform: scale(1.0);
    }
}
```

### book 页面上方的组件

<img src="https://cdn.nlark.com/yuque/0/2022/png/1614731/1653461996846-b77cbfa2-6633-4c34-a7b2-04defc088522.png" alt="img" style="zoom:80%;" />

<img src="https://cdn.nlark.com/yuque/0/2022/png/1614731/1653461996731-d2ac9009-0db6-4972-a7f9-1b44a32a1432.png" alt="img" style="zoom:80%;" />

#### search 组件

components\behaviors\pagination.js

```js
const paginationBev = Behavior({
    data: {
        dataArray: [],
        total: null,
        noneResult: false,
        loading:false
    },

    methods: {
        setMoreData(dataArray) {
            const tempArray =
                this.data.dataArray.concat(dataArray)
            this.setData({
                dataArray: tempArray
            })
        },

        getCurrentStart() {
            return this.data.dataArray.length
        },

        setTotal(total) {
            this.data.total = total
            if (total == 0) {
                this.setData({
                    noneResult: true
                })
            }
        },

        hasMore() {
            if (this.data.dataArray.length >= this.data.total) {
                return false
            } else {
                return true
            }
        },
        initialize() {
            this.setData({
                dataArray: [],
                noneResult: false,
                loading:false
            })
            this.data.total = null
        },

        isLocked() {
            return this.data.loading ? true : false
        },

        locked() {
            this.setData({
                loading: true
            })
        },

        unLocked() {
            this.setData({
                loading: false
            })
        },

    }
})

export {
    paginationBev
}
```

components\search\index.json

```json
{
  "component": true,
  "usingComponents": {
    "v-tag": "/components/tag/index",
    "v-book":"/components/book/index",
    "v-loading":"/components/loading/index"
  }
}
```

components\search\index.js

```js
// components/search/index.js
import { KeywordModel } from '../../models/keyword.js'

import { BookModel } from '../../models/book.js'

import { paginationBev } from '../behaviors/pagination.js'

const keywordModel = new KeywordModel()
const bookModel = new BookModel()

Component({
  /**
   * 组件的属性列表
   */
  behaviors: [paginationBev],
  properties: {
    more: {
      type: String,
      observer: 'loadMore',
      // true, true, true,
    },
  },

  /**
   * 组件的初始数据
   */
  data: {
    historyWords: [],
    hotWords: [],
    searching: false,
    q: '',
    loading: false,
    loadingCenter: false,
  },

  attached() {
    this.setData({
      historyWords: keywordModel.getHistory(),
    })

    keywordModel.getHot().then((res) => {
      this.setData({
        hotWords: res.hot,
      })
    })
  },

  /**
   * 组件的方法列表
   */
  methods: {
    loadMore() {
      if (!this.data.q) {
        return
      }
      if (this.isLocked()) {
        return
      }
      if (this.hasMore()) {
        this.locked()
        bookModel.search(this.getCurrentStart(), this.data.q).then(
          (res) => {
            this.setMoreData(res.books)
            this.unLocked()
          },
          () => {
            this.unLocked()
          }
        )
        // 死锁
      }
    },

    onCancel(event) {
      this.initialize()
      this.triggerEvent('cancel', {}, {})
    },

    onDelete(event) {
      this.initialize()
      this._closeResult()
    },

    onConfirm(event) {
      this._showResult()
      this._showLoadingCenter()
      // this.initialize()
      const q = event.detail.value || event.detail.text
      this.setData({
        q,
      })
      bookModel.search(0, q).then((res) => {
        this.setMoreData(res.books)
        this.setTotal(res.total)
        keywordModel.addToHistory(q)
        this._hideLoadingCenter()
      })
    },

    _showLoadingCenter() {
      this.setData({
        loadingCenter: true,
      })
    },

    _hideLoadingCenter() {
      this.setData({
        loadingCenter: false,
      })
    },

    _showResult() {
      this.setData({
        searching: true,
      })
    },

    _closeResult() {
      this.setData({
        searching: false,
        q: '',
        historyWords: keywordModel.getHistory(),
      })
    },

    // onReachBottom(){
    //   console.log(123123)
    // }

    // scroll-view | Page onReachBottom
  },
})
```

components\search\index.wxml

```html
<view class="container">
  <!-- 搜索框 -->
  <view class="header">
    <view class="search-container">
      <image class="icon" src="images/search.png" />
      <!-- input 输入框 -->
      <input value="{{q}}" bind:confirm="onConfirm" placeholder-class='in-bar'
        placeholder='书籍名' class='bar' auto-focus="true" />
      <image bind:tap="onDelete" class="cancel-img" src="images/cancel.png" />
    </view>

    <view bind:tap="onCancel" class='cancel'>取消</view>
  </view>
  <!-- 历史搜索栏 -->
  <view wx:if="{{!searching}}">
    <view class="history">
      <view class="title">
        <view class="chunk"></view>
        <text>历史搜索</text>
      </view>
      <view class="tags">
        <block w x:key="" wx:for="{{historyWords}}">
          <!-- v-search 是一个高阶组件, 引入了其他组件 v-tag -->
          <v-tag bind:tapping="onConfirm" text="{{item}}" />
        </block>
      </view>
    </view>
    <!-- 热门搜索栏, 需要向服务器发送请求 -->
    <view class="history hot-search">
      <view class="title">
        <view class="chunk"></view>
        <text>热门搜索</text>
      </view>
      <view class="tags">
        <block wx:key="" wx:for="{{hotWords}}">
          <v-tag bind:tapping="onConfirm" text="{{item}}" />
        </block>
      </view>
    </view>
  </view>

  <view wx:if="{{searching}}" class="books-container">
    <block wx:for="{{dataArray}}" wx:key="{{item.id}}">
      <v-book showLike="{{false}}" book="{{item}}" class="book" />
    </block>
  </view>

  <v-loading class="loading-center" wx:if="{{loadingCenter}}" />
  <v-loading class="loading" wx:if="{{loading}}" />
  <text wx:if="{{noneResult}}" class="empty-tip">没有搜索到书籍</text>
</view>
```

components\search\index.wxss

```css
.container {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
}

.header {
    background-color: #ffffff;
    position: fixed;
    height: 100rpx;
    border-top: 1px solid #f5f5f5;
    border-bottom: 1px solid #f5f5f5;
    display: flex;
    flex-direction: row;
    width: 750rpx;
    align-items: center;
    z-index: 99;
}

.search-container {
    display: inline-flex;
    flex-direction: row;
    align-items: center;
    background-color: #f5f5f5;
    border-radius: 50px;
    margin-left: 20rpx;
}

.in-bar {
    color: #999;
}

.bar {
    border-top-right-radius: 15px;
    border-bottom-right-radius: 15px;
    display: inline-block;
    height: 68rpx;
    width: 1000rpx;
    font-size: 28rpx;
}

.icon {
    width: 28rpx;
    height: 28rpx;
    margin-left: 24rpx;
    margin-right: 16rpx;
}

.cancel {
    line-height: 68rpx;
    width: 120rpx;
    text-align: center;
    display: inline-block;
    border: none;
}

.cancel-img {
    width: 28rpx;
    height: 28rpx;
    /* 扩大可点击区域 */
    border: 20rpx solid transparent;
    margin-right: 20rpx;
}

.history {
    width: 690rpx;
    margin: 40rpx 0 20rpx 0;
    display: flex;
    font-size: 28rpx;
    margin-top: 160rpx;
    flex-direction: column;
}

.hot-search {
    margin-top: 70rpx;
}

.title {
    line-height: 30rpx;
    display: flex;
    flex-direction: row;
    align-items: center;
}

.books-container v-book {
    margin-bottom: 25rpx;
}

.books-container {
    width: 570rpx;
    margin-top: 100rpx;
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    padding: 0 90rpx 0 90rpx;
    justify-content: space-between;
}

.loading {
    margin: 50rpx 0 50rpx 0;
}

.loading-center {
    position: absolute;
    top: 50%;
    left: 50%;
}

.empty-tip {
    display: inline-block;
    width: 100%;
    text-align: center;
    position: absolute;
    top: 50%;
}

.chunk {
    height: 30rpx;
    width: 10rpx;
    background-color: #000;
    display: inline-block;
    margin-right: 20rpx;
}

.tags {
    /* padding-left:15px; */
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    margin-top: 24rpx;
    padding-left: 30rpx;
    width: 630rpx;
}

.tags v-tag {
    margin-right: 20rpx;
    margin-bottom: 20rpx;
}

.bar {
    border-top-right-radius: 15px;
    border-bottom-right-radius: 15px;
    display: inline-block;
    height: 68rpx;
    width: 500rpx;
    font-size: 28rpx;
}
```

#### loading 组件

components\loading\index.json

```json
{
  "component": true,
  "usingComponents": {}
}
```

components\loading\index.js

```js
// components/loading/index.js
Component({
  /**
   * 组件的属性列表
   */
  properties: {

  },

  /**
   * 组件的初始数据
   */
  data: {

  },

  /**
   * 组件的方法列表
   */
  methods: {

  }
})
```

components\loading\index.wxml

```html
<view class="spinner">
  <view class="double-bounce1"></view>
  <view class="double-bounce2"></view>
</view>
```

components\loading\index.wxss

```css
.spinner {
    width: 40rpx;
    height: 40rpx;
    position: relative;
}

.double-bounce1,
.double-bounce2 {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background-color: #3063b2;
    opacity: 0.6;
    position: absolute;
    top: 0;
    left: 0;
    -webkit-animation: bounce 2.0s infinite ease-in-out;
    animation: bounce 2.0s infinite ease-in-out;
}

.double-bounce2 {
    -webkit-animation-delay: -1.0s;
    animation-delay: -1.0s;
}

@-webkit-keyframes bounce {
    0%,
    100% {
        -webkit-transform: scale(0.0)
    }

    50% {
        -webkit-transform: scale(1.0)
    }
}

@keyframes bounce {

    0%,
    100% {
        transform: scale(0.0);
        -webkit-transform: scale(0.0);
    }

    50% {
        transform: scale(1.0);
        -webkit-transform: scale(1.0);
    }
}
```

## 喜欢页面

### 页面入口

<img src="https://cdn.nlark.com/yuque/0/2022/gif/1614731/1653470484040-a907df66-5af5-4ba1-bcb9-9b885a30d3d9.gif" alt="img" style="zoom:80%;" />

点击申请授权

<img src="https://cdn.nlark.com/yuque/0/2022/png/1614731/1653470479837-d2398e66-f60f-4d68-920b-3a6172bffa33.png" alt="img" style="zoom:80%;" />

<img src="https://cdn.nlark.com/yuque/0/2022/png/1614731/1653470479695-0d07de68-6d5d-4e5e-8519-f347d0b08b25.png" alt="img" style="zoom:80%;" />

pages\my\my.json

```json
{
    "usingComponents":{
      "v-tag": "/components/tag/index",
      "v-button": "/components/image-button/index",
      "v-preview": "/components/preview/index"
    },
    "backgroundColor":"#f5f5f5"
  }
```

pages\my\my.js

```js
import { ClassicModel } from '../../models/classic.js'
import { BookModel } from '../../models/book.js'

import { promisic } from '../../utils/common.js'

const classicModel = new ClassicModel()
const bookModel = new BookModel()

Page({
  /**
   * 页面的初始数据
   */
  data: {
    authorized: false,
    userInfo: null,
    bookCount: 0,
    classics: null,
  },

  onShow(options) {
    this.userAuthorized2()
    this.getMyBookCount()
    this.getMyFavor()
    // wx.getUserInfo({
    //   success:data=>{
    //     console.log(data)
    //   }
    // })
  },

  getMyFavor() {
    classicModel.getMyFavor((res) => {
      this.setData({
        classics: res,
      })
    })
  },

  getMyBookCount() {
    bookModel.getMyBookCount().then((res) => {
      this.setData({
        bookCount: res.count,
      })
    })
  },

  userAuthorized1() {
    promisic(wx.getSetting)()
      .then((data) => {
        if (data.authSetting['scope.userInfo']) {
          return promisic(wx.getUserInfo)()
        }
        return false
      })
      .then((data) => {
        if (!data) return
        this.setData({
          authorized: true,
          userInfo: data.userInfo,
        })
      })
  },

  async userAuthorized2() {
    const data = await promisic(wx.getSetting)()
    if (data.authSetting['scope.userInfo']) {
      const res = await promisic(wx.getUserInfo)()
      const userInfo = res.userInfo
      this.setData({
        authorized: true,
        userInfo,
      })
    }
  },

  userAuthorized() {
    wx.getSetting({
      success: (data) => {
        if (data.authSetting['scope.userInfo']) {
          wx.getUserInfo({
            success: (data) => {
              this.setData({
                authorized: true,
                userInfo: data.userInfo,
              })
            },
          })
        }
      },
    })
  },

  onGetUserInfo(event) {
    const userInfo = event.detail.userInfo
    if (userInfo) {
      this.setData({
        userInfo,
        authorized: true,
      })
    }
  },

  onJumpToAbout(event) {
    wx.navigateTo({
      url: '/pages/about/about',
    })
  },

  onStudy(event) {
    wx.navigateTo({
      url: '/pages/course/course',
    })
  },

  onJumpToDetail(event) {
    const cid = event.detail.cid
    const type = event.detail.type
    // wx.navigateTo
    wx.navigateTo({
      url: `/pages/classic-detail/classic-detail?cid=${cid}&type=${type}`,
    })
  },
})

// wx.navigateTo({
//   url:`/pages/classic-detail/index?cid=${cid}
//     &type=${type}`
// })
```

pages\my\my.wxml

```html
<view class="container">
    <image src="/images/my/my@bg.png" class="bg"></image>
    <!-- <open-data type="userAvatarUrl" class="avatar avatar-position"/> -->
    <v-button wx:if="{{!authorized}}" open-type="getUserInfo" class="avatar-position" bind:getuserinfo="onGetUserInfo">
        <image slot="img" class="avatar" src="/images/my/my.png" />
    </v-button>
    <!-- 登录 难点 服务器 微信支付 -->
    <view wx:if="{{authorized}}" class="avatar-container avatar-position">
        <image src="{{userInfo.avatarUrl}}" class="avatar" />
        <text>{{userInfo.nickName}}</text>
    </view>
    <view class="about-container">
        <view bind:tap="onJumpToAbout" class="about-us">
            <image src="/images/my/about.png" />
            <text class="description">关于我们</text>
        </view>
        <view class="about-us">
            <text class="book-num">{{bookCount}}</text>
            <text class="description">喜欢的书</text>
        </view>
    </view>

    <view class="like-container">
        <image class="headline" src="/images/my/like.png" />
        <view class="preview-container">
            <block wx:for="{{classics}}" wx:key="">
                <v-preview bind:tapping="onJumpToDetail" class="preview" classic="{{item}}" />
            </block>
        </view>
    </view>

</view>
<image bind:tap="onStudy" class="study" src="/images/my/study.png"></image>
```

pages\my\my.wxss

```css
.container {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.bg {
    width: 750rpx;
    height: 574rpx;
}

.avatar-position {
    position: absolute;
    top: 255rpx;
}

.my-img {
    width: 120rpx;
    height: 120rpx;
}

.avatar-container {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.avatar {
    width: 120rpx;
    height: 120rpx;
    overflow: hidden;
    border-radius: 50%;
}

.about-container {
    padding: 0 100rpx;
    width: 550rpx;
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    position: absolute;
    top: 440rpx;
}

.about-us image {
    width: 34rpx;
    height: 34rpx;
}

.preview-container {
    margin-top: 30rpx;
    width: 690rpx;
    display: flex;
    flex-direction: row;
    padding:0 30rpx;
    flex-wrap:wrap;
    justify-content: space-between;
}

.preview {
    margin-bottom: 30rpx;
}

.about-us {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
}

.book-num {
    font-size: 36rpx;
    color: #000000;
}

.description {
    font-size: 24rpx;
    color: #999999;
}

.about-container>view:nth-child(2) {
    margin-top: -5rpx;
}

.like-container {
    /* margin-top:30rpx; */
    margin-top: -13rpx;
    display: flex;
    flex-direction: column;
    align-items: center;
    background-color: #f5f5f5;
}

.headline {
    margin-top: 30rpx;
    width: 97rpx;
    height: 42rpx;
}

.study {
    width: 88rpx;
    height: 88rpx;
    position: absolute;
    top: 40rpx;
    right: 45rpx;
}
```

### image-button 组件

components\image-button\index.json

```json
{
  "component": true,
  "usingComponents": {}
}
```

components\image-button\index.js

```js
// components/image-button/index.js
Component({
  /**
   * 组件的属性列表
   */
  options: {
    multipleSlots: true 
  },
  properties: {
    openType: {
      type: String
    }
  },

  /**
   * 组件的初始数据
   */
  data: {

  },

  /**
   * 组件的方法列表
   */
  methods: {
    onGetUserInfo(event){
      this.triggerEvent('getuserinfo', event.detail, {})
    }
  }
})
```

components\image-button\index.wxml

```html
<button
  bind:getuserinfo="onGetUserInfo"
  open-type="{{ openType }}"
  plain="{{ true }}"
  class="container"
>
  <slot name="img"></slot>
</button>

```

components\image-button\index.wxss

```css
.container{
    padding: 0 !important;
    border:none !important;
  }
```

### preview 组件

components\preview\index.json

```json
{
  "component": true,
  "usingComponents": {
    "v-tag":"/components/tag/index",
    "v-like": "/components/like/index"
  }
}
```

components\preview\index.js

```js
// components/preview/index.js
Component({
  /**
   * 组件的属性列表
   */
  properties: {
    classic: {
      type: Object,
      observer: function(newVal) {
        if (newVal) {
          var typeText = {
            100: "电影",
            200: "音乐",
            300: "句子"
          }[newVal.type]
        }
        this.setData({
          typeText
        })
      }
    }
  },

  /**
   * 组件的初始数据
   */
  data: {
    typeText:''
  },

  /**
   * 组件的方法列表
   */
  methods: {
    onTap:function(event){
      this.triggerEvent('tapping',{
        cid:this.properties.classic.id,
        type:this.properties.classic.type
      },{})
    }
  }
})
```

components\preview\index.wxml

```html
<view catch:tap="onTap" class="container">
  <view class="head">
    <v-tag text="{{typeText}}" tag-class="tag" />
    <v-like class="like" read-only="{{true}}" like="{{true}}" count="{{classic.fav_nums}}" />
  </view>
  <image class="{{classic.type==200?'music-img':'other-img'}}" src="{{classic.image}}"></image>
  <view class="text">{{classic.content}}</view>
</view>
```

components\preview\index.wxss

```css
.container{
  display: flex;
  flex-direction: column;
  align-items: center;
  width:330rpx;
  background-color: #ffffff;
}

.head{
  display: flex;
  width:100%;
  flex-direction: row;
  align-items: center; 
  justify-content: space-between;
  height:80rpx;
}

.tag{
  margin-left:20rpx;
  margin-top:-2rpx;
  height:40rpx;  
  width:72rpx ;
  font-size:24rpx;
  background-color:#f7f7f7 !important;
}

.like{
  margin-top:4rpx;
  margin-right:4rpx;
}

.other-img{
  width:100%;
  height:240rpx;
}

.music-img{
  border-radius: 50%;
  width:240rpx;
  height:240rpx;
}

.text{
  padding:30rpx;
  font-size:28rpx;
  height:130rpx;
  color:#666666;
  overflow: hidden;
}
```

### 跳转到对应的流行页面

<img src="https://cdn.nlark.com/yuque/0/2022/gif/1614731/1653470485485-f1b796bf-3f81-4a5c-a867-f0616320130b.gif" alt="img" style="zoom:80%;" />

pages\classic-detail\classic-detail.json

```json
{
  "component": true,
  "usingComponents": {
    "v-classic":"/pages/classic/classic"
  }
}
```

pages/classic-detail/index.js

```js
// pages/classic-detail/index.js
Component({
  /**
   * 组件的属性列表
   */
  properties: {
    cid: Number,
    type: Number
  },

  /**
   * 组件的初始数据
   */
  data: {

  },


  /**
   * 组件的方法列表
   */
  methods: {
    onLoad(options) {
      
    }
  }
})
```

pages\classic-detail\classic-detail.wxml

```html
<v-classic cid="{{cid}}" type="{{type}}" />
```

pages\classic-detail\classic-detail.wxss

```css
/* pages/classic-detail/index.wxss */
```

## 流行页面添加分享按钮

<img src="https://cdn.nlark.com/yuque/0/2022/png/1614731/1653470479742-58cbfca9-9fee-4354-bc1c-2329b2604f86.png" alt="img" style="zoom:80%;" />

<img src="https://cdn.nlark.com/yuque/0/2022/png/1614731/1653470479703-07d59ece-bc75-473c-abc0-a17d1e1132f6.png" alt="img" style="zoom:80%;" />

项目需要取英文名，才可以正常显示分享框

pages\classic\classic.json

```json
{
  "usingComponents": {
    "v-like": "/components/like/index",
    "v-movie": "/components/classic/movie/index",
    "v-music": "/components/classic/music/index",
    "v-essay": "/components/classic/essay/index",
    "v-episode": "/components/episode/index",
    "v-navi": "/components/navi/index",
    "v-button": "/components/image-button/index"
  }
}
```

pages\classic\classic.wxml

```html
<view class="container">
  <view class="header">
    <!-- episode 组件 -->
    <!-- index 期刊号 -->
    <v-episode class="episode" index="{{classic.index}}" />
    <view class="like-container">
      <v-like class="like" bind:like="onLike" like="{{likeStatus}}"
        count="{{likeCount}}" />
      <v-button class="share-btn" open-type="share">
        <image class="share" slot="img" src="/images/icon/share.png" />
      </v-button>
    </view>
  </view>
  <!-- 三种不同的期刊 电影 音乐 句子 -->
  <!-- 小程序标签自带的 hidden 在自定义组件上不生效, 我们在 v-movie 组件中添加一个自定义properties也就是 hidden 自己实现 -->
  <!-- hidden VS wx:if 显示与隐藏 VS 渲染不渲染 -->
  <!-- hidden 初始加载消耗大, 适合频繁切换的场合 -->
  <!-- wx:if 切换消耗大, 适合运行条件不大可能改变的时候 -->
  <v-movie hidden="{{classic.type!=100}}" img="{{classic.image}}"
    content="{{classic.content}}" />
    <!-- 音乐部分, 我们使用 wx:if 需要使用 detached 生命周期函数, 而 hidden 永远不会触发 detached 函数 -->
  <v-music wx:if="{{classic.type==200}}" img="{{classic.image}}"
    content="{{classic.content}}" title="{{classic.title}}"
    src="{{classic.url}}" />
  <v-essay hidden="{{classic.type!=300}}" img="{{classic.image}}"
    content="{{classic.content}}" />

  <!-- 监听 nav 组件自定义的事件 left 和 right 从而得知, 用户是点击了左箭头, 还是点击了右箭头, 监听系统的 bind:tap 事件是得不到这个信息的, 我们只能知道用户点击了, 但是不知道用户具体点击了 左边还是右边 -->
  <v-navi bind:left="onNext" bind:right="onPrevious" title="{{classic.title}}"
    first="{{first}}" latest="{{latest}}" class="navi" />
</view>
```

pages\classic\classic.wxss

```css
/* classic 共有的样式 */
.container {
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.header {
  width: 100%; /* header 的宽度充满整个屏幕, 不要自适应, 使用 flex 布局的时候, 很多奇怪的现象都是没有 设置 height 和 width 造成的 */
  display: flex;
  flex-direction: row;
  height: 100rpx; /* 整体高度 */
  align-items: center; /* 垂直居中 */
  justify-content: space-between; /* 两端分布 */
  border-top: 1px solid #f5f5f5;
  border-bottom: 1px solid #f5f5f5;
}

.episode {
  margin-left: 20rpx;
  margin-top: 4rpx;
}

.like {
  margin-top: 6rpx;
}

.navi {
  position: absolute; /* 距离底部是一个固定的距离, 使用 position: absolute */
  bottom: 40rpx;
}

.like-container {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: center;
  margin-right: 30rpx;
}

.share-btn {
  margin-top: 28rpx;
  margin-left: 10rpx;
}

.share {
  width: 40rpx;
  height: 40rpx;
}
```







