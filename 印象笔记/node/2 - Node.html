<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/606060 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="1196"/>

<div>
<span><div><div><div><div><div><div><div><span style="font-size: 12pt;">7-75：mogoose数据库</span></div><div><span style="font-size: 12pt;">8-94：验证</span></div><div><span style="font-size: 12pt;">9-103：模型关系</span></div><div><span style="font-size: 12pt;"><br/></span></div><hr/><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">介绍 MongoDB</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">之前我们将数据写在数组里，也就是内存里，一旦应用重启，我们就会丢失所有内存的数据，这就是将数据保存在数据库的原因</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">MongoDB 是 node 和 express 中非常常用的数据库管理系统</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">MongoDB 是一个文档型（非关系型）的数据库，它与传统的关系型数据库（如 SQL Server、MySQL）不同</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">在 </span><span style="font-size: 12pt;">MongoDB 中没有表</span><span style="font-size: 12pt;">、列</span><span style="font-size: 12pt;">、视图、记录等概念，关系型数据库需要你设计数据库，MongoDB 是没有设计或模式的</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">就是简单地在 MongoDB 保存 JSON 对象</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">下载社区版服务器</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><a href="https://jingyan.baidu.com/article/e52e3615ed475000c70c5168.html" style="font-size: 12pt;">https://jingyan.baidu.com/article/e52e3615ed475000c70c5168.html</a></span></div><div><br/></div><div><a href="https://www.cnblogs.com/lynn-z/p/13363188.html" style="font-size: 12pt;">https://www.cnblogs.com/lynn-z/p/13363188.html</a></div><div><span style="font-size: 12pt;"><br/></span></div><div><a href="https://stackoverflow.com/questions/61536341/mongodb-compass-keeps-on-showing-activating-plugin" style="font-size: 12pt;">https://stackoverflow.com/questions/61536341/mongodb-compass-keeps-on-showing-activating-plugin</a></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">启动MongoDB服务</font></div><div><font style="font-size: 12pt;">net start MongoDB</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">关闭MongoDB服务</font></div><div><font style="font-size: 12pt;">net stop MongoDB</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">移除 MongoDB 服务</font></div><div><font style="font-size: 12pt;">D:\MongoDB\bin\mongod.exe --remove</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">下载后，bin 目录下的 mongd ，也就是 mongo demon，是一个跑在后台的服务，也就是 MongoDB 的主服务</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">Mongoose 是一个用于连接 MongoDB 的简单 API，</span><span style="font-size: 12pt;">mongoose 和 </span><span style="font-size: 12pt;">mongodb </span><span style="font-size: 12pt;">就像</span><span style="font-size: 12pt;">用 ts 改善 js 一样，</span><span style="font-size: 12pt;">基于前者进行功能封装的库</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">新建 mongo-demo 文件夹</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">npm init -y</font></div><div><font style="font-size: 12pt;">npm i mongoose@5.0.1</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">index.js</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const mongoose = require('mongoose');</font></div><div><font style="font-size: 12pt;">mongoose.connect('mongodb://localhost/playground</font><span style="font-size: 12pt;">')</span></div><div><font style="font-size: 12pt;">  .then(() =&gt; console.log('已连接到数据库'))</font></div><div><font style="font-size: 12pt;">  .catch((err) =&gt; console.error('无法连接到数据库', err))</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">connect() 字符串参数</span><span style="font-size: 12pt;">表示连接本机安装的 MongoDB，当你在生产环境安装了数据库就需要一个别的字符串，现实中，concect() 中的字符串参数应该来自配置文件</span></div><div><br/></div><div><span style="font-size: 12pt;">字符串参数后面跟上数据库名称，虽然还没有这个数据库，但是不要紧，只要你第一次向这个数据库写入数据时，MongoDB 会自动创建这个数据库</span></div><div><br/></div><div><span style="font-size: 12pt;">connect() 方法返回一个 Promise</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">标准 URI 连接语法：</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">mo<font>ngodb:</font></font><font style="font-size: 12pt;">//[username:password@]host1[:port1][,host2[:port2],...[,hostN[:portN]]][/[database][?options]]</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">●  mongodb:// 这是固定的格式，必须要指定。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">●</span><span style="font-size: 12pt;">  username:password@ 可选项，如果设置，在连接数据库服务器之后，驱动都会尝试登陆这个数据库</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">●</span><span style="font-size: 12pt;">  host1 必须的指定至少一个 host , host1 是这个 URI 唯一要填写的。它指定了要连接服务器的地址。如果要连接复制集，请指定多个主机地址。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">●</span><span style="font-size: 12pt;">  portX 可选的指定端口，如果不填，默认为27017</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">●</span><span style="font-size: 12pt;">  /database 如果指定username:password@，连接并验证登陆指定数据库。若不指定，默认打开 test 数据库。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">●</span><span style="font-size: 12pt;">  ?options 是连接选项。如果不使用/database，则前面需要加上/。所有连接选项都是键值对name=value，键值对之间通过&amp;或;（分号）隔开</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">打开 MongoDB Compass 并点击 connect 连接</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">node index.js</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><hr/><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">MongoDB 基本概念</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(118, 0, 216); font-weight: bold;">MongoDB 的 Collection 集合 就像关系型数据库的表（类）。</span></span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; color: rgb(118, 0, 216); font-weight: bold;">MongoDB 的 Document 文档 就像</span><span style="font-size: 12pt; color: rgb(118, 0, 216); font-weight: bold;">关系型数据库中表的行（对象）</span><span style="font-size: 12pt; color: rgb(118, 0, 216); font-family: unset; font-weight: bold;">。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; color: rgb(118, 0, 216); font-weight: bold;">MongoDB 的 Field 字段 就像</span><span style="font-size: 12pt; color: rgb(118, 0, 216); font-weight: bold;">关系型数据库中表的列（属性名）</span><span style="font-size: 12pt; color: rgb(118, 0, 216); font-family: unset; font-weight: bold;">。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(118, 0, 216); font-weight: bold;">每一格对应那一列的值（属性值）</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0); font-weight: bold;"><img src="2 - Node_files/3.jpg" type="image/jpeg" data-filename="3.jpg"/></span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt;"><br/></span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0); font-weight: bold;"><img src="2 - Node_files/3 [1].jpg" type="image/jpeg" data-filename="3.jpg" width="833"/></span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(255, 0, 0); font-weight: bold;"><img src="2 - Node_files/3 [2].jpg" type="image/jpeg" data-filename="3.jpg"/></span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; color: rgb(255, 0, 0); font-weight: bold;">上面的表包含三行（每一行代表一个人）、五列（Id、姓、名、地址、城市）</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; color: rgb(118, 0, 216); font-weight: bold;">MongoDB 将数据存储为一个文档，数据结构由键值</span><span style="font-size: 12pt; color: rgb(118, 0, 216); font-weight: bold;">对（</span><span style="font-size: 12pt; color: rgb(118, 0, 216); font-weight: bold;">key: value）组成。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(118, 0, 216); font-weight: bold;">MongoDB 文档类似于 JSON 对象。字段值可以包含其他文档，数组及文档数组。</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3.png" type="image/png" data-filename="3.png"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">一个 mongodb 中可以建立多个数据库。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">MongoDB 的默认数据库为&quot;db&quot;，该数据库存储在 data 目录中。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">MongoDB 的单个实例可以容纳多个独立的数据库，每一个都有自己的集合和权限，不同的数据库也放置在不同的文件中。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">有一些数据库名是保留的，可以直接访问这些有特殊作用的数据库：</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">admin：</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"> 从权限的角度来看，这是&quot;root&quot;数据库。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">要是将一个用户添加到这个数据库，这个用户自动继承所有数据库的权限。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">一些特定的服务器端命令也只能从这个数据库运行，比如列出所有的数据库或者关闭服务器。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">local：</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">这个数据库永远不会被复制，可以用来存储限于本地单台服务器的任意集合。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">config：</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">当 Mongo 用于分片设置时，config 数据库在内部使用，用于保存分片的相关信息。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [3].jpg" type="image/jpeg" data-filename="3.jpg"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">通过下图实例，我们也可以更直观的了解 MongoDB 中的一些概念：</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [1].png" type="image/png" data-filename="3.png"/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">ObjectId</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">ObjectId 类似唯一主键，可以很快的去生成和排序，包含 12 bytes，含义是：</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">● 前 4 个字节表示创建 unix 时间戳,格林尼治时间 UTC 时间，比北京时间晚了 8 个小时</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">● </span><span style="font-size: 12pt;">接下来的 3 个字节是机器标识码</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">● </span><span style="font-size: 12pt;">紧接的两个字节由进程 id 组成 PID</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">● </span><span style="font-size: 12pt;">最后三个字节是随机数</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3.jpeg" type="image/jpeg" data-filename="3.jpeg"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><hr/><div><span style="font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><br/></span></div><div><span style="font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(0, 0, 0); font-family: 微软雅黑; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">Schemas 模板（骨</span><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">架</span></span><span style="font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(0, 0, 0); font-family: 微软雅黑; font-variant-caps: normal; font-variant-ligatures: normal; font-weight: bold;">）</span></div><div><span style="font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><br/></span></div><div><span style="font-size: 12pt;">schema 只是 Mongoose 的概念，不是 MongoDB 的。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">我们用 schema 来设计符合 MongoDB </span><span style="font-size: 12pt;">Collection 的 </span><span style="font-size: 12pt;">Document 结构，定义一个</span> <span style="box-sizing: border-box; -webkit-tap-highlight-color: transparent; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 12pt; color: rgb(0, 0, 0); font-family: 微软雅黑; font-variant-caps: normal; font-variant-ligatures: normal;"> </span><span style="box-sizing: border-box; -webkit-tap-highlight-color: transparent; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 12pt; color: rgb(0, 0, 0); font-family: 微软雅黑; font-variant-caps: normal; font-variant-ligatures: normal;">Document</span><span style="box-sizing: border-box; -webkit-tap-highlight-color: transparent; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 12pt; color: rgb(0, 0, 0); font-family: 微软雅黑; font-variant-caps: normal; font-variant-ligatures: normal;"> 应该有什么样的属性</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">mongoose 有 Schema 类（</span><span style="font-size: 12pt;">可以用它创建 schema 对象</span><span style="font-size: 12pt;">），参数需要传入一个对象，这个对象有我们需要传入 Document 的键值对，</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">courseSchema 定义 playground数据库 courses 集合的 Document 结构</span></span></div><div><font style="font-size: 12pt;"><br/></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const courseSchema = new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: String,</font></div><div><font style="font-size: 12pt;">  author: String,</font></div><div><font style="font-size: 12pt;">  tags: [String],</font></div><div><font style="font-size: 12pt;">  date: {type: Date, default: Date.now},</font></div><div><font style="font-size: 12pt;">  isPublished: Boolean</font></div><div><font style="font-size: 12pt;">})</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">[String]  表示数组，不过是字符串数组，数组元素都是字符串类型</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">我们也可以给一个默认值，</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">首先改为一个对象，指定类型，然后指定默认值，Date.now 的返回值将视为 date 属性的默认值</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">schema 可以指定的数据类型有以下几种：</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [4].jpg" type="image/jpeg" data-filename="3.jpg" width="323"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">Buffer 是一种字节格式的数据</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">ObjectID 是用来保存对象唯一标识</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">Schema 可以看作工厂中模具，好比一个茶杯，喝水是茶杯最终的功能，茶杯本身就像是Model，那么茶杯的批量生产是需要靠工厂的模具成型的</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><hr/><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">Model 模型（动物，集合）</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">如何根据 schema 创建 courses 的 </span><span style="font-size: 12pt; font-weight: bold;">Document ？</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">现在我们要将 courseSchema 弄成一个模型（Model） -&gt; 创建</span><span style="font-size: 12pt;">一个类 Course（Model） -&gt; 创建一个对象 nodeCourse（document）</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">第一个参数是模型所使用的集合的单数名称。Mogoose 可以</span><span style="font-size: 12pt;">自动查找集合的复数形式，小写形式。比如，</span><span style="font-size: 12pt;">Tank 名称可用于数据库中的 tanks 集合。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">因为有个集合叫 Courses ，所以要把 s 字母去掉</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">第二个参数是这个集合所需的 schema 。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const Course = mongoose.model('Course', coursesSchema);</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">这样我们就创建了一个 Course 类</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const Course = mongoose.model('course', courseSchema);</font></div><div><font style="font-size: 12pt;">const course = new Course({</font></div><div><font style="font-size: 12pt;">  name: 'Node.js Course',</font></div><div><font style="font-size: 12pt;">  author: 'John',</font></div><div><font style="font-size: 12pt;">  tags: ['node', 'backendnd'],</font></div><div><font style="font-size: 12pt;">  isPublished: true</font></div><div><font style="font-size: 12pt;">});</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">帕斯卡命名类，驼峰命名对象。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">Course 构造函数传入一个对象来初始化这个对象，所以我们来设置 course 的属性，这个对象可以映射为一个 MongoDB 的 Document </span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">MongoDB 或者 非关系型数据库有趣的地方，每个 MongoDB 的 Document 都可以是一个复杂的对象</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">在关系型数据库中这样是不行的（表是二维的，对象是多维的）。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">换句话说，每条数据项的每列只能是单一属性的</span><span style="font-size: 12pt;"> 。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">如果你要将这个结构移到关系型数据库中，你需要 3 张表，</span><span style="font-size: 12pt;">分别是 courses，tags 和一张中间表叫 courseTags </span><span style="font-size: 12pt;">。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">因为这里的 courses 和 tags 表是多对多关系。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">在 MongoDB 或者非关系型数据库中没这个概念，</span><span style="font-size: 12pt;">我们不需要去定义或者描述一张表。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">我们只需创建一个对象，然后保存在数据库中，这就是无 schema（</span><span style="font-size: 12pt;">表结构的定义</span><span style="font-size: 12pt;">），就像上面示例的 tags 属性。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">你可以给某个数据添加任意的属性，甚至任意层次嵌套，比较灵活。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><hr/><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">增加（</span></span><span style="font-size: 12pt; font-weight: bold;">保存</span><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">）一个 Document （鸟，文档，模型的实例）</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">如何将这个 course 对象保存到数据库中？</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">course 对象有一个 save 方法，因为我们要访问文件系统，保存到数据库中需要花点时间，所以我们处理的是异步操作，结果在未来才有，所以这个方法返回一个 Promise。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">这个 result 实际上是数据库保存的 course 对象</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">一旦我们将这个 course 保存到 MongoDB 中，</span><span style="font-size: 12pt;">MongoDB 会给这个对象或者文档一个唯一的标识，</span><span style="font-size: 12pt;">这时我们可以看到 MongoDB 给它的 id了 </span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">index.js</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const mongoose = require(&quot;mongoose&quot;)</font></div><div><font style="font-size: 12pt;">mongoose</font></div><div><font style="font-size: 12pt;">  .connect(&quot;mongodb://localhost/playground&quot;)</font></div><div><font style="font-size: 12pt;">  .then(() =&gt; console.log(&quot;已连接到数据库&quot;))</font></div><div><font style="font-size: 12pt;">  .catch((err) =&gt; console.error(&quot;无法连接到数据库&quot;, err))</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const courseSchema = new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: String,</font></div><div><font style="font-size: 12pt;">  author: String,</font></div><div><font style="font-size: 12pt;">  tags: [String],</font></div><div><font style="font-size: 12pt;">  date: {type: Date, default: Date.now},</font></div><div><font style="font-size: 12pt;">  isPublished: Boolean</font></div><div><font style="font-size: 12pt;">});</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const Course = mongoose.model('course', courseSchema);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">async function createCourse() {</font></div><div><font style="font-size: 12pt;">  const course = new Course({</font></div><div><font style="font-size: 12pt;">    name: &quot;Node.js Course&quot;,</font></div><div><font style="font-size: 12pt;">    author: &quot;John&quot;,</font></div><div><font style="font-size: 12pt;">    tags: [&quot;node&quot;, &quot;backend&quot;],</font></div><div><font style="font-size: 12pt;">    isPublished: true,</font></div><div><font style="font-size: 12pt;">  })</font></div><div><font style="font-size: 12pt;">  const result = await course.save()</font></div><div><font style="font-size: 12pt;">  console.log(result)</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;">createCourse()</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">运行 index.js，终端将会显示：</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [5].jpg" type="image/jpeg" data-filename="3.jpg"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">数据库将增加 playground 数据库、coureses 集合、course 文档</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [6].jpg" type="image/jpeg" data-filename="3.jpg"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">修改代码后，终止进程再重新加载一次 index.js，点击一下 Refresh 按钮就可以看到多添加了一个 Document</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [7].jpg" type="image/jpeg" data-filename="3.jpg"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><hr/><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">查询 MongoDB 的</span></span> <span style="font-size: 12pt; font-weight: bold;">Document</span><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">（</span></span><span style="font-size: 12pt; font-weight: bold;">文档</span><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">）</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">之前创建的 Course 类有很多查询的方法</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">find() 可以返回一个 </span><span style="font-size: 12pt;">文档（Document）的列表数组，</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">参数是一个对象，该对象可以加入一个或多个键值对用来过滤，</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">这个方法返回一个文档查询对象（DocumentQuery），</span><span style="font-size: 12pt;">我们就可以自定义查询，</span><span style="font-size: 12pt;">这</span><span style="font-size: 12pt;">个文档查询对象像 Promise，所以也有 .then 方法</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">findById()</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">findOne() 可以返回一个 </span><span style="font-size: 12pt;">文档（Document）</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">async function getCourses() {</font></div><div><font style="font-size: 12pt;">   const courses = await Course</font></div><div><font style="font-size: 12pt;">     .find({author: 'John', isPublished: true})</font></div><div><font style="font-size: 12pt;">     .limit(10)</font></div><div><font style="font-size: 12pt;">     .sort({name: 1})</font></div><div><font style="font-size: 12pt;">     .select({name: 1, tags: 1});</font></div><div><font style="font-size: 12pt;">   console.log(courses);</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;">getCourses()</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">这里</span><span style="font-size: 12pt;">我们可以设置返回文档的数量，</span><span style="font-size: 12pt;">也可以对文档排序，</span><span style="font-size: 12pt;">我们也可以选择特定属性的文档，</span><span style="font-size: 12pt;">比如我们的course文档有50个属性，</span><span style="font-size: 12pt;">我们只想返回 name</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">sort() 传入一个对象，里面的键值对用</span><span style="font-size: 12pt;">来排序，这里是按照 name 升序，如果想降序排序就用 -1</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">select() 选中我们需要返回的属性，比如我们只想得到课程的 name 属性和 tags 属性</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">选中 name 和 tags </span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">.select({name: 1, tags: 1})</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">也可以写成</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">.select('name tags')</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">按 name 字段（属性）升序， test</span> <span style="font-size: 12pt;">字段（属性）</span><span style="font-size: 12pt;">降序</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">.sort({name: 1, test: -1})</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">也可以写成</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">.sort('name -test')</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><hr/><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">比较查询操作符</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">如何创建更复杂的查询？</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">在 MongoDB 中，有很多操作符用来做值的比较</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">自从 mongoose 根据 MongoDB 的驱动开发出来后，</span><span style="font-size: 12pt;">这些 MongoDB 使用的操作符在 mongoose 中同样有效</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">下面介绍 MongoDB 的操作符</span></div><div><font style="font-size: 12pt;"><br/></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">eq  (equal)                       等于</font></div><div><font style="font-size: 12pt;">ne  (not equal)                   不等于</font></div><div><font style="font-size: 12pt;">gt  (greater than)                大于</font></div><div><font style="font-size: 12pt;">gte (greater than or equal to)    大于等于</font></div><div><font style="font-size: 12pt;">lt  (less than)                   小于</font></div><div><font style="font-size: 12pt;">lte (less than or equal to)       小于等于</font></div><div><font style="font-size: 12pt;">in          </font></div><div><font style="font-size: 12pt;">nin (not in)</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">在 JS 对象中，为了表达大于 10 的意思，需要传入一个对象，用对象来替代数值</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">查询大于 10 刀的课程： </span></div><div><font style="font-size: 12pt;"><br/></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">async function getCourses() {</font></div><div><font style="font-size: 12pt;">   const courses = await Course.find({price: {$gt: 10}})</font></div><div><font style="font-size: 12pt;">}</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">查询大于等于 10 刀，小于等于20 刀的课程：</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">async function getCourses() {</font></div><div><font style="font-size: 12pt;">   const courses = await Course.find({price: {$gte: 10, $lte: 20}})</font></div><div><font style="font-size: 12pt;">}</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">查询一个10刀或15刀或20刀的课程</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">async function getCourses() {</font></div><div><font style="font-size: 12pt;">   const courses = await Course.find({price: {$in: [10, 15, 20]})</font></div><div><font style="font-size: 12pt;">}</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">这就是用比较操作符来查询的方法</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><hr/><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">逻辑查询操作符</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">如果查找的不是 John 已发布的课，我要找的是全部 John 的课或者全部已发布的课呢</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">逻辑操作符：or， and</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">JS 中存储多个值的数据结构是数组，所以我们传入的参数要是一个数组，数组中每个对象都是过滤器</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">async function getCourses() {</font></div><div><font style="font-size: 12pt;">   const courses = await Course.or([{author: 'John'}, {isPublished: true}])</font></div><div><font style="font-size: 12pt;">}</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">async function getCourses() {</font></div><div><font style="font-size: 12pt;">   const courses = await Course.and([{author: 'John'}, {isPublished: true}])</font></div><div><font style="font-size: 12pt;">}</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">相当于</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">async function getCourses() {</font></div><div><font style="font-size: 12pt;">   const courses = await Course.find({author: 'John', isPublished: true})</font></div><div><font style="font-size: 12pt;">}</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><hr/><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">正则表达式</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">/pattern/</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">查找以 John 开头的 author</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">async function getCourses() {</font></div><div><font style="font-size: 12pt;">   const courses = await Course.find({author: <b>/^John/</b>, isPublished: true})</font></div><div><font style="font-size: 12pt;">}</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">查找以 Hamedani 结尾的 author</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">async function getCourses() {</font></div><div><font style="font-size: 12pt;">   const courses = await Course.find({author: <b>/Hamedani$/</b>, isPublished: true})</font></div><div><font style="font-size: 12pt;">}</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">查找</span><span style="font-size: 12pt;">包含 John 的 author，.*表示 0 或多个字符，这里表示 John 前面或后面可以有或没有字符</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">async function getCourses() {</font></div><div><font style="font-size: 12pt;">   const courses = await Course.find({author: <b>/.*John.*/</b>, isPublished: true})</font></div><div><font style="font-size: 12pt;">}</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">如果想让表达式大小写不敏感，就加个 i 字符</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">async function getCourses() {</font></div><div><font style="font-size: 12pt;">   const courses = await Course.find({author: <b>/.*John.*/i</b>, isPublished: true})</font></div><div><font style="font-size: 12pt;">}</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><hr/><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">计数</span></span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;">查找符合条件的文档（Document）数量 </span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt; font-weight: bold;">index.js</span></div><div><font style="font-size: 12pt;"><br/></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const mongoose = require(&quot;mongoose&quot;);</font></div><div><font style="font-size: 12pt;">mongoose</font></div><div><font style="font-size: 12pt;">  .connect(&quot;mongodb://localhost/playground&quot;)</font></div><div><font style="font-size: 12pt;">  .then(() =&gt; console.log(&quot;已连接到数据库&quot;))</font></div><div><font style="font-size: 12pt;">  .catch((err) =&gt; console.error(&quot;无法连接到数据库&quot;, err));</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const courseSchema = new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: String,</font></div><div><font style="font-size: 12pt;">  author: String,</font></div><div><font style="font-size: 12pt;">  tags: [String],</font></div><div><font style="font-size: 12pt;">  date: {type: Date, default: Date.now},</font></div><div><font style="font-size: 12pt;">  isPublished: Boolean</font></div><div><font style="font-size: 12pt;">});</font></div><div><font style="font-size: 12pt;">const Course = mongoose.model('course', courseSchema);</font></div><div><br/></div><div><font style="font-size: 12pt;">async function getCourses() {</font></div><div><font style="font-size: 12pt;">   const courses = await Course</font></div><div><font style="font-size: 12pt;">     .find({ author: &quot;John&quot;, isPublished: true })</font></div><div><font style="font-size: 12pt;">     .limit(10)</font></div><div><font style="font-size: 12pt;">     .sort({ name: 1 })</font></div><div><font style="font-size: 12pt;">     <b>.count()</b></font></div><div><font style="font-size: 12pt;">   console.log(courses);</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;">getCourses()</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><hr/><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">练习</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt;"><br/></span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">exercise-data.json</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">[</font></div><div><font style="font-size: 12pt;">  {&quot;_id&quot;: {&quot;$oid&quot;: &quot;5a68fdc3615eda645bc6bdec&quot;},&quot;tags&quot;:[&quot;express&quot;,&quot;backend&quot;],&quot;date&quot;:&quot;2018-01-24T21:42:27.388Z&quot;,&quot;name&quot;:&quot;Express.js Course&quot;,&quot;author&quot;:&quot;Mosh&quot;,&quot;isPublished&quot;:true,&quot;price&quot;:10,&quot;__v&quot;:0},</font></div><div><font style="font-size: 12pt;">  {&quot;_id&quot;: {&quot;$oid&quot;: &quot;5a68fdd7bee8ea64649c2777&quot;},&quot;tags&quot;:[&quot;node&quot;,&quot;backend&quot;],&quot;date&quot;:&quot;2018-01-24T21:42:47.912Z&quot;,&quot;name&quot;:&quot;Node.js Course&quot;,&quot;author&quot;:&quot;Mosh&quot;,&quot;isPublished&quot;:true,&quot;price&quot;:20,&quot;__v&quot;:0},</font></div><div><font style="font-size: 12pt;">  {&quot;_id&quot;: {&quot;$oid&quot;: &quot;5a68fde3f09ad7646ddec17e&quot;},&quot;tags&quot;:[&quot;aspnet&quot;,&quot;backend&quot;],&quot;date&quot;:&quot;2018-01-24T21:42:59.605Z&quot;,&quot;name&quot;:&quot;ASP.NET MVC Course&quot;,&quot;author&quot;:&quot;Mosh&quot;,&quot;isPublished&quot;:true,&quot;price&quot;:15,&quot;__v&quot;:0},</font></div><div><font style="font-size: 12pt;">  {&quot;_id&quot;: {&quot;$oid&quot;: &quot;5a68fdf95db93f6477053ddd&quot;},&quot;tags&quot;:[&quot;react&quot;,&quot;frontend&quot;],&quot;date&quot;:&quot;2018-01-24T21:43:21.589Z&quot;,&quot;name&quot;:&quot;React Course&quot;,&quot;author&quot;:&quot;Mosh&quot;,&quot;isPublished&quot;:false,&quot;__v&quot;:0},</font></div><div><font style="font-size: 12pt;">  {&quot;_id&quot;: {&quot;$oid&quot;: &quot;5a68fe2142ae6a6482c4c9cb&quot;},&quot;tags&quot;:[&quot;node&quot;,&quot;backend&quot;],&quot;date&quot;:&quot;2018-01-24T21:44:01.075Z&quot;,&quot;name&quot;:&quot;Node.js Course by Jack&quot;,&quot;author&quot;:&quot;Jack&quot;,&quot;isPublished&quot;:true,&quot;price&quot;:12,&quot;__v&quot;:0},</font></div><div><font style="font-size: 12pt;">  {&quot;_id&quot;: {&quot;$oid&quot;: &quot;5a68ff090c553064a218a547&quot;},&quot;tags&quot;:[&quot;node&quot;,&quot;backend&quot;],&quot;date&quot;:&quot;2018-01-24T21:47:53.128Z&quot;,&quot;name&quot;:&quot;Node.js Course by Mary&quot;,&quot;author&quot;:&quot;Mary&quot;,&quot;isPublished&quot;:false,&quot;price&quot;:12,&quot;__v&quot;:0},</font></div><div><font style="font-size: 12pt;">  {&quot;_id&quot;: {&quot;$oid&quot;: &quot;5a6900fff467be65019a9001&quot;},&quot;tags&quot;:[&quot;angular&quot;,&quot;frontend&quot;],&quot;date&quot;:&quot;2018-01-24T21:56:15.353Z&quot;,&quot;name&quot;:&quot;Angular Course&quot;,&quot;author&quot;:&quot;Mosh&quot;,&quot;isPublished&quot;:true,&quot;price&quot;:15,&quot;__v&quot;:0}</font></div><div><font style="font-size: 12pt;">]</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">导入数据到数据库的命令行</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">mongoimport --db mongo-exercises --collection courses --file exercise-data.json --jsonArray</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">db             数据库名</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">collection  集合名</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">file             导入文件名</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; color: unset; font-family: unset;">因为 exercise-data.json 的数据</span><span style="font-size: 12pt; color: unset; font-family: unset;">是一个数组 所以使用 </span><span style="font-size: 12pt; color: unset; font-family: unset;">--jsonArray </span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; color: unset; font-family: unset;">exercise-data.json 的数组里每个对象都是一个 collection</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">练习1：找出所有已发布的后端课程，根据它们的 name 排序，只获取每个课程的 name 和 author，然后显示它们</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">你需要加载 mongoose 模块，连接到 MongoDB 数据库，</span><span style="font-size: 12pt;">定义一个 courses 集合的 schema 然后写出查询</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">index.js</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const mongoose = require(&quot;mongoose&quot;);</font></div><div><font style="font-size: 12pt;">mongoose</font></div><div><font style="font-size: 12pt;">  .connect('mongodb://localhost/mongo-exercises')</font></div><div><font style="font-size: 12pt;">  .then(() =&gt; {console.log('已连接数据库')})</font></div><div><font style="font-size: 12pt;">  .catch((err) =&gt; {console.error('无法连接数据库', err)})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const courseSchema = new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: String,</font></div><div><font style="font-size: 12pt;">  author: String,</font></div><div><font style="font-size: 12pt;">  tags: [String],</font></div><div><font style="font-size: 12pt;">  date: Date,</font></div><div><font style="font-size: 12pt;">  isPublished: Boolean,</font></div><div><font style="font-size: 12pt;">  price: Number</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const Course = mongoose.model('course', courseSchema);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">async function getCourse() {</font></div><div><font style="font-size: 12pt;">  const courses = await Course</font></div><div><font style="font-size: 12pt;">    .find({isPublished: true, tags: 'backend'})</font></div><div><font style="font-size: 12pt;">    .select({name: 1, author: 1})</font></div><div><font style="font-size: 12pt;">    .sort({name: 1})</font></div><div><font style="font-size: 12pt;">  console.log(courses);</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;">getCourse();</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">第二种写法：</span></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt;"><br/></span></span></div><div><span style="font-size: 12pt; font-weight: bold;">index.js</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const mongoose = require('mongoose');</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">mongoose.connect('mongodb://localhost/mongo-exercises');</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const courseSchema = new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: String,</font></div><div><font style="font-size: 12pt;">  author: String,</font></div><div><font style="font-size: 12pt;">  tags: [ String ],</font></div><div><font style="font-size: 12pt;">  date: Date,</font></div><div><font style="font-size: 12pt;">  isPublished: Boolean,</font></div><div><font style="font-size: 12pt;">  price: Number</font></div><div><font style="font-size: 12pt;">});</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const Course = mongoose.model('Course', courseSchema);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><b>async function getCourses() {</b></font></div><div><font style="font-size: 12pt;"><b>  return await Course</b></font></div><div><font style="font-size: 12pt;"><b>  .find({ isPublished: true, tags: 'backend' })</b></font></div><div><font style="font-size: 12pt;"><b>  .sort({ name: 1 })</b></font></div><div><font style="font-size: 12pt;"><b>  .select({ name: 1, author: 1 });</b></font></div><div><font style="font-size: 12pt;"><b>}</b></font></div><div><font style="font-size: 12pt;"><b><br/></b></font></div><div><font style="font-size: 12pt;"><b>async function run() {</b></font></div><div><font style="font-size: 12pt;"><b>  const courses = await getCourses();</b></font></div><div><font style="font-size: 12pt;"><b>  console.log(courses);</b></font></div><div><font style="font-size: 12pt;"><b>}</b></font></div><div><font style="font-size: 12pt;"><b><br/></b></font></div><div><font style="font-size: 12pt;"><b>run();</b></font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">async 修饰的函数返回值一定是 Promise ，是 return await Course... 返回的 Promise 内容是一个包含对象的数组。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">getCourses() 是一个异步任务，所以我们需要 await 它保存在 courses 中，同样地，因为 await ，所以需要 async function 。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">练习2：找出所有已发布的前端和后端课程，根据它们的 price 进行降序排序（从最贵到最便宜），只获取每个课程的 name 和 author，然后显示它们</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">第一种写法： 使用 $in</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">index.js</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const mongoose = require(&quot;mongoose&quot;);</font></div><div><font style="font-size: 12pt;">mongoose</font></div><div><font style="font-size: 12pt;">  .connect('mongodb://localhost/mongo-exercises')</font></div><div><font style="font-size: 12pt;">  .then(() =&gt; {console.log('已连接数据库')})</font></div><div><font style="font-size: 12pt;">  .catch((err) =&gt; {console.error('无法连接数据库', err)})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const courseSchema = new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: String,</font></div><div><font style="font-size: 12pt;">  author: String,</font></div><div><font style="font-size: 12pt;">  tags: [String],</font></div><div><font style="font-size: 12pt;">  date: Date,</font></div><div><font style="font-size: 12pt;">  isPublished: Boolean,</font></div><div><font style="font-size: 12pt;">  price: Number</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const Course = mongoose.model('course', courseSchema);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">async function getCourse() {</font></div><div><font style="font-size: 12pt;">  const courses = await Course</font></div><div><font style="font-size: 12pt;">    .find({</font></div><div><font style="font-size: 12pt;">      isPublished: true,</font></div><div><font style="font-size: 12pt;">      <b>tags: { $in: [&quot;frontend&quot;, &quot;backend&quot;] },</b></font></div><div><font style="font-size: 12pt;">    }, '-_id')</font></div><div><font style="font-size: 12pt;">    .select(&quot;name author price&quot;)</font></div><div><font style="font-size: 12pt;">    .sort(&quot;-price&quot;)</font></div><div><font style="font-size: 12pt;">  console.log(</font></div><div><font style="font-size: 12pt;">    courses.map(function (obj) {</font></div><div><font style="font-size: 12pt;">      return obj._doc</font></div><div><font style="font-size: 12pt;">    })</font></div><div><font style="font-size: 12pt;">  )</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;">getCourse();</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">运行 node index.js ，</span><span style="font-size: 12pt; color: unset; font-family: unset; font-weight: bold;">终端将会显示：</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [8].jpg" type="image/jpeg" data-filename="3.jpg"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">第二种写法：使用 .or() </span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">index.js</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const mongoose = require(&quot;mongoose&quot;);</font></div><div><font style="font-size: 12pt;">mongoose</font></div><div><font style="font-size: 12pt;">  .connect('mongodb://localhost/mongo-exercises')</font></div><div><font style="font-size: 12pt;">  .then(() =&gt; {console.log('已连接数据库')})</font></div><div><font style="font-size: 12pt;">  .catch((err) =&gt; {console.error('无法连接数据库', err)})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const courseSchema = new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: String,</font></div><div><font style="font-size: 12pt;">  author: String,</font></div><div><font style="font-size: 12pt;">  tags: [String],</font></div><div><font style="font-size: 12pt;">  date: Date,</font></div><div><font style="font-size: 12pt;">  isPublished: Boolean,</font></div><div><font style="font-size: 12pt;">  price: Number</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const Course = mongoose.model('course', courseSchema);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">async function getCourse() {</font></div><div><font style="font-size: 12pt;">  const courses = await Course</font></div><div><font style="font-size: 12pt;">    .find({</font></div><div><font style="font-size: 12pt;">      isPublished: true</font></div><div><font style="font-size: 12pt;">    }, '-_id')</font></div><div><font style="font-size: 12pt;">    <b>.or([{tags: 'frontend'}, {tags: 'backend'}])</b></font></div><div><font style="font-size: 12pt;">    .select(&quot;name author price&quot;)</font></div><div><font style="font-size: 12pt;">    .sort(&quot;-price&quot;)</font></div><div><font style="font-size: 12pt;">  console.log(</font></div><div><font style="font-size: 12pt;">    courses.map(function (obj) {</font></div><div><font style="font-size: 12pt;">      return obj._doc</font></div><div><font style="font-size: 12pt;">    })</font></div><div><font style="font-size: 12pt;">  )</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;">getCourse();</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">练习3：找出所有单价 &gt;= 15刀或者 name 中含有 by 关键字的已发布课程，然后显示它们</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">index.js</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const mongoose = require(&quot;mongoose&quot;);</font></div><div><font style="font-size: 12pt;">mongoose</font></div><div><font style="font-size: 12pt;">  .connect('mongodb://localhost/mongo-exercises')</font></div><div><font style="font-size: 12pt;">  .then(() =&gt; {console.log('已连接数据库')})</font></div><div><font style="font-size: 12pt;">  .catch((err) =&gt; {console.error('无法连接数据库', err)})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const courseSchema = new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: String,</font></div><div><font style="font-size: 12pt;">  author: String,</font></div><div><font style="font-size: 12pt;">  tags: [String],</font></div><div><font style="font-size: 12pt;">  date: Date,</font></div><div><font style="font-size: 12pt;">  isPublished: Boolean,</font></div><div><font style="font-size: 12pt;">  price: Number</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const Course = mongoose.model('course', courseSchema);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">async function getCourse() {</font></div><div><font style="font-size: 12pt;">  const courses = await Course</font></div><div><font style="font-size: 12pt;">    .find({</font></div><div><font style="font-size: 12pt;">      isPublished: true</font></div><div><font style="font-size: 12pt;">    }, '-_id')</font></div><div><font style="font-size: 12pt;">    .or([{price: {$gte: 15}}, {name: /.*by.*/}])</font></div><div><font style="font-size: 12pt;">    .select(&quot;name author price&quot;)</font></div><div><font style="font-size: 12pt;">  console.log(</font></div><div><font style="font-size: 12pt;">    courses.map(function (obj) {</font></div><div><font style="font-size: 12pt;">      return obj._doc</font></div><div><font style="font-size: 12pt;">    })</font></div><div><font style="font-size: 12pt;">  )</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;">getCourse();</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">运行 node index.js ，</span><span style="font-size: 12pt; color: unset; font-family: unset; font-weight: bold;">终端将会显示：</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [9].jpg" type="image/jpeg" data-filename="3.jpg"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><hr/><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">更新数据库 Document</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">第一种是先查询的方法</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">先以 id 找到文档，再编辑它的属性，最后保存</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [10].jpg" type="image/jpeg" data-filename="3.jpg" width="441"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">调用 Course 的 findById 方法，传入 id，这里返回的是 Promise，所以 我们 await 它。</span></div><div><br/></div><div><span style="font-size: 12pt;">有可能给定 id 的课程并不存在，我们就需要检测了。</span><span style="font-size: 12pt;">否则我们更新属性。</span></div><div><br/></div><div><span style="font-size: 12pt;">还有另一种方法，不用一个个设置属性，可以调用 set 方法</span></div><div><br/></div><div><span style="font-size: 12pt;">set 需要传入一个对象，对象包含需要更新的键值对</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">index.js</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const mongoose = require(&quot;mongoose&quot;);</font></div><div><font style="font-size: 12pt;">mongoose</font></div><div><font style="font-size: 12pt;">  .connect('mongodb://localhost/mongo-exercises')</font></div><div><font style="font-size: 12pt;">  .then(() =&gt; {console.log('已连接数据库')})</font></div><div><font style="font-size: 12pt;">  .catch((err) =&gt; {console.error('无法连接数据库', err)})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const courseSchema = new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: String,</font></div><div><font style="font-size: 12pt;">  author: String,</font></div><div><font style="font-size: 12pt;">  tags: [String],</font></div><div><font style="font-size: 12pt;">  date: Date,</font></div><div><font style="font-size: 12pt;">  isPublished: Boolean,</font></div><div><font style="font-size: 12pt;">  price: Number</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const Course = mongoose.model('course', courseSchema);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">async function updateCourse(id) {</font></div><div><font style="font-size: 12pt;">  const course = await Course.findById(id, '-_id -tags')</font></div><div><font style="font-size: 12pt;">  if(!course) {</font></div><div><font style="font-size: 12pt;">    return;</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">  course.isPublished = true;</font></div><div><font style="font-size: 12pt;">  course.author = 'Another author';</font></div><div><font style="font-size: 12pt;">  const result = await course.save();</font></div><div><font style="font-size: 12pt;">  console.log(result._doc)</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">updateCourse(&quot;5a68fe2142ae6a6482c4c9cb&quot;)</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">我们之前用save() 方法来保存一个新的课程</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">save() 方法返回的是 Promise，所以 我们 await 它。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">运行 node index.js ，</span><span style="font-size: 12pt; color: unset; font-family: unset; font-weight: bold;">终端将会显示：</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [11].jpg" type="image/jpeg" data-filename="3.jpg"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">这种在当你收到客户端的更新数据又想验证的时候很有用</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">第二种是先更新的方法</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">我们直接接入数据库修改文档</span><span style="font-size: 12pt;">，同时获得已经更新的文档（</span><span style="font-size: 12pt;">可选的</span><span style="font-size: 12pt;">）</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">例如，你有个规则：</span><span style="font-size: 12pt;">如果课程已经发布了，就不允许修改作者</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">为了实现这个规则，就需要先得到这个课程</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">然后写这些逻辑：如果课程的 isPublished 是真，就直接返回，我们不想更新课程信息</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">但是有时候你知道自己在干什么，你无需验证客户端的信息，</span><span style="font-size: 12pt;">你就是想更新一个或者多个数据库中的文档 </span><span style="font-size: 12pt;">Document</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">我们用 update() 方法代替 findById() 方法，</span><span style="font-size: 12pt;">update() </span><span style="font-size: 12pt;">第一个参数是一个查询或者一个过滤器的对象</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; color: unset; font-family: unset;">第二个参数是更新的数据，它是一个对象，这时需要使用一个或多个更新操作符</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; color: unset; font-family: unset; font-weight: bold;">更新操作符</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">$currentDate，可以将给定字段以当前日期填充</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">$inc 也就是增加的简写，非常强大，可以以特定值递增给定</span><span style="font-size: 12pt;">字段</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">比如你创建了一个类似 Facebook 的应用，</span><span style="font-size: 12pt;">当用户对你的内容点赞，你就要增加点赞数，</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">使用这个操作符就可以直接添加给定</span><span style="font-size: 12pt;">字段</span><span style="font-size: 12pt;">的值，</span><span style="font-size: 12pt; color: unset; font-family: unset;">你不用先读取数据库中原本点赞的数值</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">同样也可以通过传入一个负值来实现给定</span><span style="font-size: 12pt;">字段</span><span style="font-size: 12pt;">值的递减</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">$min  可以用比给定</span><span style="font-size: 12pt;">字段</span><span style="font-size: 12pt;">更小的值来覆盖给定</span><span style="font-size: 12pt;">字段</span><span style="font-size: 12pt;">的值</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">$max </span><span style="font-size: 12pt;">可以用比给定</span><span style="font-size: 12pt;">字段</span><span style="font-size: 12pt;">更大的值来覆盖给定</span><span style="font-size: 12pt;">字段</span><span style="font-size: 12pt;">的值</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">$mul 就是 multiply 的缩写，与增加类似，它是起相乘的作用</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">$rename 重命名一个字段</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">$set 设定一个</span><span style="font-size: 12pt;">字段</span><span style="font-size: 12pt;">的值</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">$unset 移除一个字段的值</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">更新所有 _id 为 id 值的课程（Document），使用 $set 操作符更新课程</span></span><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">（Document）</span></span><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">中 author 字段和 isPublished 字段的值</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">async function updateCourse(id) {</font></div><div><font style="font-size: 12pt;">  const result = await Course.update({_id: id}, {</font></div><div><font style="font-size: 12pt;">    $set: {</font></div><div><font style="font-size: 12pt;">      author: 'Mosh',</font></div><div><font style="font-size: 12pt;">      isPublished: false</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;">  });</font></div><div><font style="font-size: 12pt;">  console.log(result)</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><font>updateCourse(</font>&quot;5a68fde3f09ad7646ddec17e&quot;<font>)</font></font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">使用这个方法，我们可以直接修改数据库的文档 Document 而无需先读取它</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">我们这里得到的，是实现更新操作的结果而非符合的文档 </span><span style="font-size: 12pt;">Document</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">可见，result 对象告诉我们更新了 1 处</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">运行 node index.js ，</span><span style="font-size: 12pt; color: unset; font-family: unset; font-weight: bold;">终端将会显示：</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [12].jpg" type="image/jpeg" data-filename="3.jpg"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">打开 </span><span style="font-size: 12pt; font-weight: bold;">MongoDBCompass 即可看到更新：</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [13].jpg" type="image/jpeg" data-filename="3.jpg"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">有时候我们想得到已经被修改好的文档</span><span style="font-size: 12pt;">（Document）</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">如果是这样，我们可以使用 findByIdAndUpdate() 方法</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">第一个参数需要传入 id 而不是查询对象</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">类似地，第二个参数是需要更新的数据对象</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">如果你需要得到更新后的文档，还需要添加一个选项（options） {new: true}</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">index.js</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const mongoose = require(&quot;mongoose&quot;);</font></div><div><font style="font-size: 12pt;">mongoose</font></div><div><font style="font-size: 12pt;">  .connect('mongodb://localhost/mongo-exercises')</font></div><div><font style="font-size: 12pt;">  .then(() =&gt; {console.log('已连接数据库')})</font></div><div><font style="font-size: 12pt;">  .catch((err) =&gt; {console.error('无法连接数据库', err)})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const courseSchema = new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: String,</font></div><div><font style="font-size: 12pt;">  author: String,</font></div><div><font style="font-size: 12pt;">  tags: [String],</font></div><div><font style="font-size: 12pt;">  date: Date,</font></div><div><font style="font-size: 12pt;">  isPublished: Boolean,</font></div><div><font style="font-size: 12pt;">  price: Number</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const Course = mongoose.model('course', courseSchema);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">async function updateCourse(id) {</font></div><div><font style="font-size: 12pt;">  const course= await Course</font></div><div><font style="font-size: 12pt;">    .findByIdAndUpdate(id, {</font></div><div><font style="font-size: 12pt;">      $set: {</font></div><div><font style="font-size: 12pt;">        author: 'Jason',</font></div><div><font style="font-size: 12pt;">        isPublished: true</font></div><div><font style="font-size: 12pt;">      }</font></div><div><font style="font-size: 12pt;">    }, {new: true})</font></div><div><font style="font-size: 12pt;">    .select('-tags -_id');</font></div><div><font style="font-size: 12pt;">  console.log(course._doc)</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">updateCourse(&quot;5a68fde3f09ad7646ddec17e&quot;)</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">运行 node index.js ，</span><span style="font-size: 12pt; color: unset; font-family: unset; font-weight: bold;">终端将会显示：</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [14].jpg" type="image/jpeg" data-filename="3.jpg"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">打开 </span><span style="font-size: 12pt; font-weight: bold;">MongoDBCompass 即可看到更新：</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [15].jpg" type="image/jpeg" data-filename="3.jpg"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">所以使用这个方法我们可以只向数据库发送一次命令。就更新并且返回了更新后的文档（Document）</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><hr/><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">删除数据库 Document</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">Course（模型）对象有一个 deleteOne() 方法，第一个参数是查询对象（找到一个或多个对应的 Document）</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">如果你想一次删除多个文档，可以用 deleteMany() 方法，同样返回 result，显示多少个文档被删除</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">如果你想得到被删的文档，可以使用 findByIdAndRemove() 方法，</span><span style="font-size: 12pt;">给定的 id 文档已经不存在，就会返回null</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt; font-weight: bold;">index.js</span></div><div><font style="font-size: 12pt;"><br/></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">async function removeCourse(id) {</font></div><div><font style="font-size: 12pt;">  // const doc = await Course.deleteOne({_id: id});</font></div><div><font style="font-size: 12pt;">  // const doc = await Course.deleteOne({ _id: id });</font></div><div><font style="font-size: 12pt;">  const doc = await Course.findByIdAndRemove(id);</font></div><div><font style="font-size: 12pt;">  const {tags, _id, ...result} = doc._doc;</font></div><div><font style="font-size: 12pt;">  console.log(result);</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">removeCourse(&quot;5a68fde3f09ad7646ddec17e&quot;)</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">运行 node index.js ，</span><span style="font-size: 12pt; color: unset; font-family: unset; font-weight: bold;">终端将会显示：</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [16].jpg" type="image/jpeg" data-filename="3.jpg"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><hr/><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">验证</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">之前创建的 schema，默认情况下所有这些字段都是可选的</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">所以当我创建一个空的对象并保存到数据库是完全可以通过验证的</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">MongoDB 不关心我们的课程没有名称、没有单价，所以我们要讨论如何进行验证</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">required 验证器（字段必须有值）</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">index.js</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const mongoose = require(&quot;mongoose&quot;);</font></div><div><font style="font-size: 12pt;">mongoose</font></div><div><font style="font-size: 12pt;">  .connect('mongodb://localhost/mongo-exercises')</font></div><div><font style="font-size: 12pt;">  .then(() =&gt; {console.log('已连接数据库')})</font></div><div><font style="font-size: 12pt;">  .catch((err) =&gt; {console.error('无法连接数据库', err)})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const courseSchema = new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: <b>{type: String, required: true}</b>,</font></div><div><font style="font-size: 12pt;">  author: String,</font></div><div><font style="font-size: 12pt;">  tags: [String],</font></div><div><font style="font-size: 12pt;">  date: Date,</font></div><div><font style="font-size: 12pt;">  isPublished: Boolean,</font></div><div><font style="font-size: 12pt;">  price: Number</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const Course = mongoose.model('course', courseSchema);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">async function createCourse() {</font></div><div><font style="font-size: 12pt;">  const course = new Course({</font></div><div><font style="font-size: 12pt;">    author: &quot;John&quot;,</font></div><div><font style="font-size: 12pt;">    tags: [&quot;node&quot;, &quot;backend&quot;],</font></div><div><font style="font-size: 12pt;">    isPublished: true,</font></div><div><font style="font-size: 12pt;">    price: 13</font></div><div><font style="font-size: 12pt;">  })</font></div><div><font style="font-size: 12pt;">  try {</font></div><div><font style="font-size: 12pt;">    const doc = await course.save();</font></div><div><font style="font-size: 12pt;">    const {tags, _id, ...result} = doc._doc;</font></div><div><font style="font-size: 12pt;">    console.log(result);</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">  catch(ex) {</font></div><div><font style="font-size: 12pt;">    console.log(ex.message);</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;">createCourse()</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">如果有验证失败的课程对象，数据库是不允许写入的</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">运行 node index.js ，</span><span style="font-size: 12pt; color: unset; font-family: unset; font-weight: bold;">终端将会显示：</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [17].jpg" type="image/jpeg" data-filename="3.jpg"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">我们可以手动地处理验证：</span><span style="font-size: 12pt;">将 save() 方法改为 validate() 方法</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">course 对象是有一个 validate 方法，返回的是 Promise，</span><span style="font-size: 12pt; color: unset; font-family: unset;">我们就可以 await 它，如果它拒绝，就会转到 catch 块执行</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">index.js</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const mongoose = require(&quot;mongoose&quot;);</font></div><div><font style="font-size: 12pt;">mongoose</font></div><div><font style="font-size: 12pt;">  .connect('mongodb://localhost/mongo-exercises')</font></div><div><font style="font-size: 12pt;">  .then(() =&gt; {console.log('已连接数据库')})</font></div><div><font style="font-size: 12pt;">  .catch((err) =&gt; {console.error('无法连接数据库', err)})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const courseSchema = new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: {type: String, required: true},</font></div><div><font style="font-size: 12pt;">  author: String,</font></div><div><font style="font-size: 12pt;">  tags: [String],</font></div><div><font style="font-size: 12pt;">  date: Date,</font></div><div><font style="font-size: 12pt;">  isPublished: Boolean,</font></div><div><font style="font-size: 12pt;">  price: Number</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const Course = mongoose.model('course', courseSchema);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">async function createCourse() {</font></div><div><font style="font-size: 12pt;">  const course = new Course({</font></div><div><font style="font-size: 12pt;">    name: &quot;React.js Course&quot;,</font></div><div><font style="font-size: 12pt;">    author: &quot;John&quot;,</font></div><div><font style="font-size: 12pt;">    tags: [&quot;node&quot;, &quot;backend&quot;],</font></div><div><font style="font-size: 12pt;">    isPublished: true,</font></div><div><font style="font-size: 12pt;">    price: 13</font></div><div><font style="font-size: 12pt;">  })</font></div><div><font style="font-size: 12pt;">  try {</font></div><div><font style="font-size: 12pt;">    await course.validate()</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">  catch(ex) {</font></div><div><font style="font-size: 12pt;">    console.log(ex.message);</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;">createCourse()</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">这个 validate() 方法返回的是一个 void 的 Promise，也就是说没有任何返回值（这是 Mongoose 的设计失误）</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">理想情况下这个 validate 方法应该返回一个布尔值，</span><span style="font-size: 12pt; font-weight: bold;">这样我就可以保存下来，并通过 if 来判断然后做些逻辑</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">唯一获得布尔值的方法就是回调函数了</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">所以我们要放弃 await，然后进行 callback 方式的写法，</span><span style="font-size: 12pt; font-weight: bold;">验证完成后</span><span style="font-size: 12pt; font-weight: bold;">如果发生错误则传递错误（需要在 catch 块写</span> <span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">handleError </span></span><span style="font-size: 12pt; font-weight: bold;">函数）</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">doc.validate(function (err) {</font></div><div><font style="font-size: 12pt;">  if (err) handleError(err);</font></div><div><font style="font-size: 12pt;">  else // validation passed</font></div><div><font style="font-size: 12pt;">});</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">这里写的验证只在 mongoose 里面才有用，MongoDB 不关心验证这回事</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; color: rgb(118, 0, 216); font-weight: bold;">在 Restful API 中使用 Joi 尽早验证客户端的数据是否合法，</span><span style="font-size: 12pt; color: rgb(118, 0, 216); font-family: unset; font-weight: bold;">用 mongoose 在写入数据库前验证数据是否合法</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">因为可能客户端将合法数据写在请求中，</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">但是当我们在创建 http 服务的 course 对象时，</span><span style="font-size: 12pt;">也许我们会忘记将 name 属性在 req.body.name 上赋值，</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">在</span> <span style="font-size: 12pt;">mongoose 验证</span><span style="font-size: 12pt;">就可以确保在数据库中不会出现不合法的数据文档了。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><hr/><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">内置验证器</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">之前的 required 验证器也是内置验证器</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">required 的值也可以是一个匿名函数，注意在对象字面量中使用 this 不要使用箭头函数</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">index.js</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const mongoose = require(&quot;mongoose&quot;);</font></div><div><font style="font-size: 12pt;">mongoose</font></div><div><font style="font-size: 12pt;">  .connect('mongodb://localhost/mongo-exercises')</font></div><div><font style="font-size: 12pt;">  .then(() =&gt; {console.log('已连接数据库')})</font></div><div><font style="font-size: 12pt;">  .catch((err) =&gt; {console.error('无法连接数据库', err)})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const courseSchema = new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: {type: String, required: true},</font></div><div><font style="font-size: 12pt;">  author: String,</font></div><div><font style="font-size: 12pt;">  tags: [String],</font></div><div><font style="font-size: 12pt;">  date: Date,</font></div><div><font style="font-size: 12pt;">  isPublished: Boolean,</font></div><div><font style="font-size: 12pt;">  price: {</font></div><div><font style="font-size: 12pt;">    type: Number,</font></div><div><font style="font-size: 12pt;">    required: function () { return this.isPublished }</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const Course = mongoose.model('course', courseSchema);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">async function createCourse() {</font></div><div><font style="font-size: 12pt;">  const course = new Course({</font></div><div><font style="font-size: 12pt;">    name: &quot;React.js Course&quot;,</font></div><div><font style="font-size: 12pt;">    author: &quot;John&quot;,</font></div><div><font style="font-size: 12pt;">    tags: [&quot;node&quot;, &quot;backend&quot;],</font></div><div><font style="font-size: 12pt;">    isPublished: true</font></div><div><font style="font-size: 12pt;">  })</font></div><div><font style="font-size: 12pt;">  try {</font></div><div><font style="font-size: 12pt;">    await course.validate()</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">  catch(ex) {</font></div><div><font style="font-size: 12pt;">    console.log(ex.message);</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;">createCourse()</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">如果 isPublished 字段的值为真，则 price 字段的 ruquired 为真，也就是说只有 </span><span style="font-size: 12pt;">isPublished 字段的值为真，price 字段才是必需的</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">运行 node index.js ，</span><span style="font-size: 12pt; color: unset; font-family: unset; font-weight: bold;">终端将会显示：</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [18].jpg" type="image/jpeg" data-filename="3.jpg"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">字符串型验证器还有：maxlength、minlength、match、enum（枚举，该字段的值必须是其中一个）</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;">数值型、Date 型验证器还有：min、max</span></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt; font-weight: bold;">index.js</span></div><div><font style="font-size: 12pt;"><br/></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const courseSchema = new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: { type: String, required: true },</font></div><div><font style="font-size: 12pt;">  author: String,</font></div><div><font style="font-size: 12pt;">  tags: [String],</font></div><div><font style="font-size: 12pt;">  date: Date,</font></div><div><font style="font-size: 12pt;">  isPublished: Boolean,</font></div><div><font style="font-size: 12pt;">  price: {</font></div><div><font style="font-size: 12pt;">    type: Number,</font></div><div><font style="font-size: 12pt;">    required: function () {</font></div><div><font style="font-size: 12pt;">      return this.isPublished</font></div><div><font style="font-size: 12pt;">    },</font></div><div><font style="font-size: 12pt;">    max: 100,</font></div><div><font style="font-size: 12pt;">    min: 5</font></div><div><font style="font-size: 12pt;">  },</font></div><div><font style="font-size: 12pt;">  category: {</font></div><div><font style="font-size: 12pt;">    type: String,</font></div><div><font style="font-size: 12pt;">    maxlength: 30,</font></div><div><font style="font-size: 12pt;">    minlength: 3,</font></div><div><font style="font-size: 12pt;">    eum: ['web', 'mobile', 'network']</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">})</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><hr/><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">自定义验证</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">有时内置验证器无法满足要求，例如 tags 属性是一个字符串数组</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">假设我们要求每个课程至少有一个标签，我们这里不能使用 required 验证器</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">因为如果使用 required，当传入一个空数组，mongoose 也会认为是合法，这时就需要</span><span style="font-size: 12pt;">自定义验证器了</span><span style="font-size: 12pt;">。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">validate 对象有一个属性叫 validator，</span><span style="font-size: 12pt;">validator 是一个函数，需要一个参数 v （也就是 value 的缩写）</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">我们可以这样返回，如果 v 的长度大于 0，那么这个属性就是合法的，</span><span style="font-size: 12pt;">我们可以给它一个验证信息</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">validate 对象有一个可选属性叫 message（提示信息）</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">index.js</span></div><div><font style="font-size: 12pt;"><br/></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const mongoose = require(&quot;mongoose&quot;)</font></div><div><font style="font-size: 12pt;">mongoose</font></div><div><font style="font-size: 12pt;">  .connect(&quot;mongodb://localhost/mongo-exercises&quot;)</font></div><div><font style="font-size: 12pt;">  .then(() =&gt; {</font></div><div><font style="font-size: 12pt;">    console.log(&quot;已连接数据库&quot;)</font></div><div><font style="font-size: 12pt;">  })</font></div><div><font style="font-size: 12pt;">  .catch((err) =&gt; {</font></div><div><font style="font-size: 12pt;">    console.error(&quot;无法连接数据库&quot;, err)</font></div><div><font style="font-size: 12pt;">  })</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const courseSchema = new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: { type: String, required: true },</font></div><div><font style="font-size: 12pt;">  author: String,</font></div><div><font style="font-size: 12pt;"><b>  tags: {</b></font></div><div><font style="font-size: 12pt;"><b>    type: Array,</b></font></div><div><font style="font-size: 12pt;"><b>    validate: {</b></font></div><div><font style="font-size: 12pt;"><b>      validator: function (v) {</b></font></div><div><font style="font-size: 12pt;"><b>        return v &amp;&amp; v.length &gt; 0</b></font></div><div><font style="font-size: 12pt;"><b>      },</b></font></div><div><font style="font-size: 12pt;"><b>      message: &quot;A course should have at least one tag.&quot;,</b></font></div><div><font style="font-size: 12pt;"><b>    }</b></font></div><div><font style="font-size: 12pt;"><b>  }</b>,</font></div><div><font style="font-size: 12pt;">  date: Date,</font></div><div><font style="font-size: 12pt;">  isPublished: Boolean,</font></div><div><font style="font-size: 12pt;">  price: {</font></div><div><font style="font-size: 12pt;">    type: Number,</font></div><div><font style="font-size: 12pt;">    required: function () {</font></div><div><font style="font-size: 12pt;">      return this.isPublished</font></div><div><font style="font-size: 12pt;">    },</font></div><div><font style="font-size: 12pt;">    max: 100,</font></div><div><font style="font-size: 12pt;">    min: 5,</font></div><div><font style="font-size: 12pt;">  },</font></div><div><font style="font-size: 12pt;">  category: {</font></div><div><font style="font-size: 12pt;">    type: String,</font></div><div><font style="font-size: 12pt;">    maxlength: 30,</font></div><div><font style="font-size: 12pt;">    minlength: 3,</font></div><div><font style="font-size: 12pt;">    eum: [&quot;web&quot;, &quot;mobile&quot;, &quot;network&quot;],</font></div><div><font style="font-size: 12pt;">  },</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const Course = mongoose.model(&quot;course&quot;, courseSchema)</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">async function createCourse() {</font></div><div><font style="font-size: 12pt;">  const course = new Course({</font></div><div><font style="font-size: 12pt;">    name: &quot;React.js Course&quot;,</font></div><div><font style="font-size: 12pt;">    author: &quot;John&quot;,</font></div><div><font style="font-size: 12pt;">    category: 'web',</font></div><div><font style="font-size: 12pt;"><b>    tags: [],</b></font></div><div><font style="font-size: 12pt;">    isPublished: true,</font></div><div><font style="font-size: 12pt;">    price: 15</font></div><div><font style="font-size: 12pt;">  })</font></div><div><font style="font-size: 12pt;">  try {</font></div><div><font style="font-size: 12pt;">    await course.validate()</font></div><div><font style="font-size: 12pt;">  } </font></div><div><font style="font-size: 12pt;">  catch (ex) {</font></div><div><font style="font-size: 12pt;">    console.log(ex.message)</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;">createCourse()</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">运行 node index.js ，</span><span style="font-size: 12pt; color: unset; font-family: unset; font-weight: bold;">终端将会显示：</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [19].jpg" type="image/jpeg" data-filename="3.jpg"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">如果 tags: null 则终端会显示：</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">Cannot read property 'length' of null</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">这不是我们想要的，所以</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">tags: {</font></div><div><font style="font-size: 12pt;">  type: Array,</font></div><div><font style="font-size: 12pt;">  validate: {</font></div><div><font style="font-size: 12pt;">    validator: function (v) {</font></div><div><font style="font-size: 12pt;">      <b>return v.length &gt; 0</b></font></div><div><font style="font-size: 12pt;">    },</font></div><div><font style="font-size: 12pt;">    message: &quot;A course should have at least one tag.&quot;,</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">}</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">改为</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">tags: {</font></div><div><font style="font-size: 12pt;">  type: Array,</font></div><div><font style="font-size: 12pt;">  validate: {</font></div><div><font style="font-size: 12pt;">    validator: function (v) {</font></div><div><font style="font-size: 12pt;">     <b> return v &amp;&amp; v.length &gt; 0</b></font></div><div><font style="font-size: 12pt;">    },</font></div><div><font style="font-size: 12pt;">    message: &quot;A course should have at least one tag.&quot;,</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">}</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">这就是如何自定义验证器了</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><hr/><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">异步验证器</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">有时候验证逻辑可能需要读取数据库或者远端的 HTTP 服务，我们不能直接得到响应的，这时我们就需要异步验证器了</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">如何将同步方式的验证器改为异步方式的？</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">首先要添加 isAsync 的值设为 true</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">我们需要修改这里的验证逻辑函数，添加第二个参数 callback</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">在我们学习异步 JS 的时候，处理异步结果的方式就是回调</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">这里我们需要进行一些异步操作，</span><span style="font-size: 12pt;">当结果具备的时候，我们就调用 </span> <span style="font-size: 12pt;">callback </span><span style="font-size: 12pt;">函数</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">为了模拟异步操作，我这里要调用 setTimeout 函数</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">有些情况下我们需要得到结果，</span><span style="font-size: 12pt;">现实中这个结果可能来自于对文件系统，数据库或者远端服务返回值的计算</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">然后我们以 result 来调用 </span> <span style="font-size: 12pt;">callback </span><span style="font-size: 12pt;">函数</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">index.js</span></div><div><font style="font-size: 12pt;"><br/></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const mongoose = require(&quot;mongoose&quot;)</font></div><div><font style="font-size: 12pt;">mongoose</font></div><div><font style="font-size: 12pt;">  .connect(&quot;mongodb://localhost/mongo-exercises&quot;)</font></div><div><font style="font-size: 12pt;">  .then(() =&gt; {</font></div><div><font style="font-size: 12pt;">    console.log(&quot;已连接数据库&quot;)</font></div><div><font style="font-size: 12pt;">  })</font></div><div><font style="font-size: 12pt;">  .catch((err) =&gt; {</font></div><div><font style="font-size: 12pt;">    console.error(&quot;无法连接数据库&quot;, err)</font></div><div><font style="font-size: 12pt;">  })</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const courseSchema = new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: { type: String, required: true },</font></div><div><font style="font-size: 12pt;">  author: String,</font></div><div><font style="font-size: 12pt;">  tags: {</font></div><div><font style="font-size: 12pt;">    type: Array,</font></div><div><font style="font-size: 12pt;"><b>    validate: {</b></font></div><div><font style="font-size: 12pt;"><b>      isAsync: true,</b></font></div><div><font style="font-size: 12pt;"><b>      validator: function (v, callback) {</b></font></div><div><font style="font-size: 12pt;"><b>        setTimeout(function () {</b></font></div><div><font style="font-size: 12pt;"><b>          const result = v &amp;&amp; v.length &gt; 0;</b></font></div><div><font style="font-size: 12pt;"><b>          callback(result)</b></font></div><div><font style="font-size: 12pt;"><b>        }, 3000)      </b></font></div><div><font style="font-size: 12pt;"><b>      },</b></font></div><div><font style="font-size: 12pt;"><b>      message: &quot;A course should have at least one tag.&quot;,</b></font></div><div><font style="font-size: 12pt;"><b>    }</b></font></div><div><font style="font-size: 12pt;">  },</font></div><div><font style="font-size: 12pt;">  date: Date,</font></div><div><font style="font-size: 12pt;">  isPublished: Boolean,</font></div><div><font style="font-size: 12pt;">  price: {</font></div><div><font style="font-size: 12pt;">    type: Number,</font></div><div><font style="font-size: 12pt;">    required: function () {</font></div><div><font style="font-size: 12pt;">      return this.isPublished</font></div><div><font style="font-size: 12pt;">    },</font></div><div><font style="font-size: 12pt;">    max: 100,</font></div><div><font style="font-size: 12pt;">    min: 5,</font></div><div><font style="font-size: 12pt;">  },</font></div><div><font style="font-size: 12pt;">  category: {</font></div><div><font style="font-size: 12pt;">    type: String,</font></div><div><font style="font-size: 12pt;">    maxlength: 30,</font></div><div><font style="font-size: 12pt;">    minlength: 3,</font></div><div><font style="font-size: 12pt;">    eum: [&quot;web&quot;, &quot;mobile&quot;, &quot;network&quot;],</font></div><div><font style="font-size: 12pt;">  },</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const Course = mongoose.model(&quot;course&quot;, courseSchema)</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">async function createCourse() {</font></div><div><font style="font-size: 12pt;">  const course = new Course({</font></div><div><font style="font-size: 12pt;">    name: &quot;React.js Course&quot;,</font></div><div><font style="font-size: 12pt;">    author: &quot;John&quot;,</font></div><div><font style="font-size: 12pt;">    category: 'web',</font></div><div><font style="font-size: 12pt;">    tags: [],</font></div><div><font style="font-size: 12pt;">    isPublished: true,</font></div><div><font style="font-size: 12pt;">    price: 15</font></div><div><font style="font-size: 12pt;">  })</font></div><div><font style="font-size: 12pt;">  try {</font></div><div><font style="font-size: 12pt;">    await course.validate()</font></div><div><font style="font-size: 12pt;">  } </font></div><div><font style="font-size: 12pt;">  catch (ex) {</font></div><div><font style="font-size: 12pt;">    console.log(ex.message)</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;">createCourse()</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">运行 node index.js ，</span><span style="font-size: 12pt; color: unset; font-family: unset; font-weight: bold;">终端将会显示：</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [20].jpg" type="image/jpeg" data-filename="3.jpg"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">连接数据库，3 秒后打印验证错误</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><hr/><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">验证错误</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">我们在 catch 块中捕捉到的异常对象有个 errors 属性</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">这个对象中有很多属性对应了每个课程对象不符合的属性</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">我们首先将 </span><span style="font-size: 12pt;">tags 和 category</span> <span style="font-size: 12pt;">设为非法值，</span><span style="font-size: 12pt;">这样，errors 就有2个属性，分别是 tags 和 category</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">我们可以迭代每个属性，</span><span style="font-size: 12pt;">这个 erors 对象给了我们更多验证的细节</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">index.js</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const mongoose = require(&quot;mongoose&quot;)</font></div><div><font style="font-size: 12pt;">mongoose</font></div><div><font style="font-size: 12pt;">  .connect(&quot;mongodb://localhost/mongo-exercises&quot;)</font></div><div><font style="font-size: 12pt;">  .then(() =&gt; {</font></div><div><font style="font-size: 12pt;">    console.log(&quot;已连接数据库&quot;)</font></div><div><font style="font-size: 12pt;">  })</font></div><div><font style="font-size: 12pt;">  .catch((err) =&gt; {</font></div><div><font style="font-size: 12pt;">    console.error(&quot;无法连接数据库&quot;, err)</font></div><div><font style="font-size: 12pt;">  })</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const courseSchema = new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: { type: String, required: true },</font></div><div><font style="font-size: 12pt;">  author: String,</font></div><div><font style="font-size: 12pt;">  tags: {</font></div><div><font style="font-size: 12pt;">    type: Array,</font></div><div><font style="font-size: 12pt;">    validate: {</font></div><div><font style="font-size: 12pt;">      isAsync: true,</font></div><div><font style="font-size: 12pt;">      validator: function (v, callback) {</font></div><div><font style="font-size: 12pt;">        setTimeout(function () {</font></div><div><font style="font-size: 12pt;">          const result = v &amp;&amp; v.length &gt; 0;</font></div><div><font style="font-size: 12pt;">          callback(result)</font></div><div><font style="font-size: 12pt;">        }, 3000)      </font></div><div><font style="font-size: 12pt;">      },</font></div><div><font style="font-size: 12pt;">      message: &quot;A course should have at least one tag.&quot;,</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;">  },</font></div><div><font style="font-size: 12pt;">  date: Date,</font></div><div><font style="font-size: 12pt;">  isPublished: Boolean,</font></div><div><font style="font-size: 12pt;">  price: {</font></div><div><font style="font-size: 12pt;">    type: Number,</font></div><div><font style="font-size: 12pt;">    required: function () {</font></div><div><font style="font-size: 12pt;">      return this.isPublished</font></div><div><font style="font-size: 12pt;">    },</font></div><div><font style="font-size: 12pt;">    max: 100,</font></div><div><font style="font-size: 12pt;">    min: 5,</font></div><div><font style="font-size: 12pt;">  },</font></div><div><font style="font-size: 12pt;">  category: {</font></div><div><font style="font-size: 12pt;">    type: String,</font></div><div><font style="font-size: 12pt;">    maxlength: 30,</font></div><div><font style="font-size: 12pt;">    minlength: 3,</font></div><div><font style="font-size: 12pt;">    eum: [&quot;web&quot;, &quot;mobile&quot;, &quot;network&quot;],</font></div><div><font style="font-size: 12pt;">  },</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const Course = mongoose.model(&quot;course&quot;, courseSchema)</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">async function createCourse() {</font></div><div><font style="font-size: 12pt;">  const course = new Course({</font></div><div><font style="font-size: 12pt;">    name: &quot;React.js Course&quot;,</font></div><div><font style="font-size: 12pt;">    author: &quot;John&quot;,</font></div><div><font style="font-size: 12pt;">    <b>category: '-',</b></font></div><div><font style="font-size: 12pt;"><b>    tags: [],</b></font></div><div><font style="font-size: 12pt;">    isPublished: true,</font></div><div><font style="font-size: 12pt;">    price: 15</font></div><div><font style="font-size: 12pt;">  })</font></div><div><font style="font-size: 12pt;">  try {</font></div><div><font style="font-size: 12pt;">    await course.validate()</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">  catch (ex) {</font></div><div><font style="font-size: 12pt;"><b>    for (field in ex.errors) {</b></font></div><div><font style="font-size: 12pt;"><b>      console.log(ex.errors[field].message)</b></font></div><div><font style="font-size: 12pt;"><b>    }</b></font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;">createCourse()</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">打印 </span><span style="font-size: 12pt;">ex.errors[field] 将是整个错误对象的信息</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">运行 node index.js ，</span><span style="font-size: 12pt; color: unset; font-family: unset; font-weight: bold;">终端将会显示：</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [21].jpg" type="image/jpeg" data-filename="3.jpg"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><hr/><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">schema 类型选项</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">几个有用的 schema type 对象的属性</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">比如 lowercase 属性可以设置为 true，这样 mongoose 就会自动将字符串转为小写，对应的还有 uppercase 属性（这两个属性只能存在一个）</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">trim 属性：如果字符串前后有空格（无法去除中间的空格），这个属性会删掉它们</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">这三个属性将会在字符串类型的字段起作用</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">我们来到 price 属性（数值类型），比如我们想对 price 的数值四舍五入小数部分，</span><span style="font-size: 12pt;">设置一个自定义的 getter 和 setter，两个属性值都是函数，参数是 v （value 的缩写）</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">index.js</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const mongoose = require(&quot;mongoose&quot;)</font></div><div><font style="font-size: 12pt;">mongoose</font></div><div><font style="font-size: 12pt;">  .connect(&quot;mongodb://localhost/mongo-exercises&quot;)</font></div><div><font style="font-size: 12pt;">  .then(() =&gt; {</font></div><div><font style="font-size: 12pt;">    console.log(&quot;已连接数据库&quot;)</font></div><div><font style="font-size: 12pt;">  })</font></div><div><font style="font-size: 12pt;">  .catch((err) =&gt; {</font></div><div><font style="font-size: 12pt;">    console.error(&quot;无法连接数据库&quot;, err)</font></div><div><font style="font-size: 12pt;">  })</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const courseSchema = new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: { type: String, required: true },</font></div><div><font style="font-size: 12pt;">  author: String,</font></div><div><font style="font-size: 12pt;">  tags: {</font></div><div><font style="font-size: 12pt;">    type: Array,</font></div><div><font style="font-size: 12pt;">    validate: {</font></div><div><font style="font-size: 12pt;">      isAsync: true,</font></div><div><font style="font-size: 12pt;">      validator: function (v, callback) {</font></div><div><font style="font-size: 12pt;">        setTimeout(function () {</font></div><div><font style="font-size: 12pt;">          const result = v &amp;&amp; v.length &gt; 0;</font></div><div><font style="font-size: 12pt;">          callback(result)</font></div><div><font style="font-size: 12pt;">        }, 3000)      </font></div><div><font style="font-size: 12pt;">      },</font></div><div><font style="font-size: 12pt;">      message: &quot;A course should have at least one tag.&quot;,</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;">  },</font></div><div><font style="font-size: 12pt;">  date: Date,</font></div><div><font style="font-size: 12pt;">  isPublished: Boolean,</font></div><div><font style="font-size: 12pt;">  price: {</font></div><div><font style="font-size: 12pt;">    type: Number,</font></div><div><font style="font-size: 12pt;">    required: function () {</font></div><div><font style="font-size: 12pt;">      return this.isPublished</font></div><div><font style="font-size: 12pt;">    },</font></div><div><font style="font-size: 12pt;">    max: 100,</font></div><div><font style="font-size: 12pt;">    min: 5,</font></div><div><font style="font-size: 12pt;">    get: v =&gt; Math.round(v),</font></div><div><font style="font-size: 12pt;">    set: v =&gt; Math.round(v)</font></div><div><font style="font-size: 12pt;">  },</font></div><div><font style="font-size: 12pt;">  category: {</font></div><div><font style="font-size: 12pt;">    type: String,</font></div><div><font style="font-size: 12pt;">    maxlength: 30,</font></div><div><font style="font-size: 12pt;">    minlength: 3,</font></div><div><font style="font-size: 12pt;">    eum: [&quot;web&quot;, &quot;mobile&quot;, &quot;network&quot;],</font></div><div><font style="font-size: 12pt;">    lowercase: true,</font></div><div><font style="font-size: 12pt;">    trim: true</font></div><div><font style="font-size: 12pt;">  },</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const Course = mongoose.model(&quot;course&quot;, courseSchema)</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">async function createCourse() {</font></div><div><font style="font-size: 12pt;">  const course = new Course({</font></div><div><font style="font-size: 12pt;">    name: &quot;React.js Course&quot;,</font></div><div><font style="font-size: 12pt;">    author: &quot;John&quot;,</font></div><div><font style="font-size: 12pt;">    category: &quot; Web &quot;,</font></div><div><font style="font-size: 12pt;">    tags: [&quot;frontend&quot;],</font></div><div><font style="font-size: 12pt;">    isPublished: true,</font></div><div><font style="font-size: 12pt;">    price: 15.8</font></div><div><font style="font-size: 12pt;">  })</font></div><div><font style="font-size: 12pt;">  try {</font></div><div><font style="font-size: 12pt;">    const doc = await course.save();</font></div><div><font style="font-size: 12pt;">    const { tags, _id, ...result } = doc._doc;</font></div><div><font style="font-size: 12pt;">    console.log(result);</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">  catch (ex) {</font></div><div><font style="font-size: 12pt;">    for (field in ex.errors) {</font></div><div><font style="font-size: 12pt;">      console.log(ex.errors[field].message);</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;">createCourse()</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">运行 node index.js ，</span><span style="font-size: 12pt; color: unset; font-family: unset; font-weight: bold;">终端将会显示：</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [22].jpg" type="image/jpeg" data-filename="3.jpg"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">index.js</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const mongoose = require(&quot;mongoose&quot;)</font></div><div><font style="font-size: 12pt;">mongoose</font></div><div><font style="font-size: 12pt;">  .connect(&quot;mongodb://localhost/mongo-exercises&quot;)</font></div><div><font style="font-size: 12pt;">  .then(() =&gt; {</font></div><div><font style="font-size: 12pt;">    console.log(&quot;已连接数据库&quot;)</font></div><div><font style="font-size: 12pt;">  })</font></div><div><font style="font-size: 12pt;">  .catch((err) =&gt; {</font></div><div><font style="font-size: 12pt;">    console.error(&quot;无法连接数据库&quot;, err)</font></div><div><font style="font-size: 12pt;">  })</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const courseSchema = new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: { type: String, required: true },</font></div><div><font style="font-size: 12pt;">  author: String,</font></div><div><font style="font-size: 12pt;">  tags: {</font></div><div><font style="font-size: 12pt;">    type: Array,</font></div><div><font style="font-size: 12pt;">    validate: {</font></div><div><font style="font-size: 12pt;">      isAsync: true,</font></div><div><font style="font-size: 12pt;">      validator: function (v, callback) {</font></div><div><font style="font-size: 12pt;">        setTimeout(function () {</font></div><div><font style="font-size: 12pt;">          const result = v &amp;&amp; v.length &gt; 0;</font></div><div><font style="font-size: 12pt;">          callback(result)</font></div><div><font style="font-size: 12pt;">        }, 3000)      </font></div><div><font style="font-size: 12pt;">      },</font></div><div><font style="font-size: 12pt;">      message: &quot;A course should have at least one tag.&quot;,</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;">  },</font></div><div><font style="font-size: 12pt;">  date: Date,</font></div><div><font style="font-size: 12pt;">  isPublished: Boolean,</font></div><div><font style="font-size: 12pt;">  price: {</font></div><div><font style="font-size: 12pt;">    type: Number,</font></div><div><font style="font-size: 12pt;">    required: function () {</font></div><div><font style="font-size: 12pt;">      return this.isPublished</font></div><div><font style="font-size: 12pt;">    },</font></div><div><font style="font-size: 12pt;">    max: 100,</font></div><div><font style="font-size: 12pt;">    min: 5,</font></div><div><font style="font-size: 12pt;">    get: v =&gt; Math.round(v),</font></div><div><font style="font-size: 12pt;">    set: v =&gt; Math.round(v)</font></div><div><font style="font-size: 12pt;">  },</font></div><div><font style="font-size: 12pt;">  category: {</font></div><div><font style="font-size: 12pt;">    type: String,</font></div><div><font style="font-size: 12pt;">    maxlength: 30,</font></div><div><font style="font-size: 12pt;">    minlength: 3,</font></div><div><font style="font-size: 12pt;">    eum: [&quot;web&quot;, &quot;mobile&quot;, &quot;network&quot;],</font></div><div><font style="font-size: 12pt;">    lowercase: true,</font></div><div><font style="font-size: 12pt;">    trim: true</font></div><div><font style="font-size: 12pt;">  },</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const Course = mongoose.model(&quot;course&quot;, courseSchema)</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">async function createCourse() {</font></div><div><font style="font-size: 12pt;">  const course = new Course({</font></div><div><font style="font-size: 12pt;">    name: &quot;React.js Course&quot;,</font></div><div><font style="font-size: 12pt;">    author: &quot;John&quot;,</font></div><div><font style="font-size: 12pt;">    category: &quot;We b&quot;,</font></div><div><font style="font-size: 12pt;">    tags: [&quot;frontend&quot;],</font></div><div><font style="font-size: 12pt;">    isPublished: true,</font></div><div><font style="font-size: 12pt;">    price: 15.8</font></div><div><font style="font-size: 12pt;">  })</font></div><div><font style="font-size: 12pt;">  try {</font></div><div><font style="font-size: 12pt;">    const doc = await course.save();</font></div><div><font style="font-size: 12pt;">    const { tags, _id, ...result } = doc._doc;</font></div><div><font style="font-size: 12pt;">    console.log(result);</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">  catch (ex) {</font></div><div><font style="font-size: 12pt;">    for (field in ex.errors) {</font></div><div><font style="font-size: 12pt;">      console.log(ex.errors[field].message)</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;">createCourse()</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">// async function getCourse() {</font></div><div><font style="font-size: 12pt;">//   const courses = await Course</font></div><div><font style="font-size: 12pt;">//     .find({</font></div><div><font style="font-size: 12pt;">//       isPublished: true</font></div><div><font style="font-size: 12pt;">//     }, '-_id')</font></div><div><font style="font-size: 12pt;">//     .or([{price: {$gte: 15}}, {name: /.*by.*/}])</font></div><div><font style="font-size: 12pt;">//     .select(&quot;name author price&quot;)</font></div><div><font style="font-size: 12pt;">//   console.log(</font></div><div><font style="font-size: 12pt;">//     courses.map(function (obj) {</font></div><div><font style="font-size: 12pt;">//       return obj._doc</font></div><div><font style="font-size: 12pt;">//     })</font></div><div><font style="font-size: 12pt;">//   )</font></div><div><font style="font-size: 12pt;">// }</font></div><div><font style="font-size: 12pt;">// getCourse();</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">// async function updateCourse(id) {</font></div><div><font style="font-size: 12pt;">//   const course= await Course</font></div><div><font style="font-size: 12pt;">//     .findByIdAndUpdate(id, {</font></div><div><font style="font-size: 12pt;">//       $set: {</font></div><div><font style="font-size: 12pt;">//         author: 'Jason',</font></div><div><font style="font-size: 12pt;">//         isPublished: false</font></div><div><font style="font-size: 12pt;">//       }</font></div><div><font style="font-size: 12pt;">//     }, {new: true})</font></div><div><font style="font-size: 12pt;">//     .select('-tags -_id');</font></div><div><font style="font-size: 12pt;">//   console.log(course._doc)</font></div><div><font style="font-size: 12pt;">// }</font></div><div><font style="font-size: 12pt;">// updateCourse(&quot;5a68fde3f09ad7646ddec17e&quot;)</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">// async function removeCourse(id) {</font></div><div><font style="font-size: 12pt;">//   // const model = await Course.deleteOne({_id: id});</font></div><div><font style="font-size: 12pt;">//   // const model = await Course.deleteOne({ _id: id });</font></div><div><font style="font-size: 12pt;">//   const model = await Course.findByIdAndRemove(id);</font></div><div><font style="font-size: 12pt;">//   const {tags, _id, ...result} = model._doc;</font></div><div><font style="font-size: 12pt;">//   console.log(result);</font></div><div><font style="font-size: 12pt;">// }</font></div><div><font style="font-size: 12pt;">// removeCourse(&quot;5f291dde7097d12bf04e20ea&quot;)</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><hr/><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">练习1 为 Genres API 添加持久性</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">修改之前</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">index.js</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 12pt;">const genres = require('./routes/genres');</span></div><div><font style="font-size: 12pt;">const express = require('express');</font></div><div><font style="font-size: 12pt;">const app = express();</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">app.use(express.json());</font></div><div><font style="font-size: 12pt;">app.use('/api/genres', genres);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const port = process.env.PORT || 3000;</font></div><div><font style="font-size: 12pt;">app.listen(port, () =&gt; console.log(`Listening on port ${port}...`));</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">routes/genres.js</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const express = require('express');</font></div><div><font style="font-size: 12pt;">const router = express.Router();</font></div><div><font style="font-size: 12pt;">const Joi = require('joi');</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const genres = [</font></div><div><font style="font-size: 12pt;">  { id: 1, name: 'Action' },  </font></div><div><font style="font-size: 12pt;">  { id: 2, name: 'Horror' },  </font></div><div><font style="font-size: 12pt;">  { id: 3, name: 'Romance' },  </font></div><div><font style="font-size: 12pt;">];</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.get('/', (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  res.send(genres);</font></div><div><font style="font-size: 12pt;">});</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.post('/', (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  const { error } = validateGenre(req.body);</font></div><div><font style="font-size: 12pt;">  if (error) return res.status(400).send(error.details[0].message);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  const genre = {</font></div><div><font style="font-size: 12pt;">    id: genres.length + 1,</font></div><div><font style="font-size: 12pt;">    name: req.body.name</font></div><div><font style="font-size: 12pt;">  };</font></div><div><font style="font-size: 12pt;">  genres.push(genre);</font></div><div><font style="font-size: 12pt;">  res.send(genre);</font></div><div><font style="font-size: 12pt;">});</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.put('/:id', (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  const genre = genres.find(c =&gt; c.id === parseInt(req.params.id));</font></div><div><font style="font-size: 12pt;">  if (!genre) return res.status(404).send('The genre with the given ID was not found.');</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  const { error } = validateGenre(req.body);</font></div><div><font style="font-size: 12pt;">  if (error) return res.status(400).send(error.details[0].message);</font></div><div><font style="font-size: 12pt;">  </font></div><div><font style="font-size: 12pt;">  genre.name = req.body.name;</font></div><div><font style="font-size: 12pt;">  res.send(genre);</font></div><div><font style="font-size: 12pt;">});</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.delete('/:id', (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  const genre = genres.find(c =&gt; c.id === parseInt(req.params.id));</font></div><div><font style="font-size: 12pt;">  if (!genre) return res.status(404).send('The genre with the given ID was not found.');</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  const index = genres.indexOf(genre);</font></div><div><font style="font-size: 12pt;">  genres.splice(index, 1);</font></div><div><font style="font-size: 12pt;">  res.send(genre);</font></div><div><font style="font-size: 12pt;">});</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.get('/:id', (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  const genre = genres.find(c =&gt; c.id === parseInt(req.params.id));</font></div><div><font style="font-size: 12pt;">  if (!genre) return res.status(404).send('The genre with the given ID was not found.');</font></div><div><font style="font-size: 12pt;">  res.send(genre);</font></div><div><font style="font-size: 12pt;">});</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">function validateGenre(genre) {</font></div><div><font style="font-size: 12pt;">  const schema = {</font></div><div><font style="font-size: 12pt;">    name: Joi.string().min(3).required()</font></div><div><font style="font-size: 12pt;">  };</font></div><div><font style="font-size: 12pt;">  return Joi.validate(genre, schema);</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">module.exports = router;</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">修改之后</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">index.js</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const genres = require('./routes/genres');</font></div><div><font style="font-size: 12pt;">const express = require('express');</font></div><div><font style="font-size: 12pt;">const mongoose = require('mongoose');     </font></div><div><font style="font-size: 12pt;">const app = express();</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">app.use(express.json());</font></div><div><font style="font-size: 12pt;">app.use('/api/genres', genres);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">mongoose</font></div><div><font style="font-size: 12pt;">  .set(&quot;useUnifiedTopology&quot;, true) // 修复废弃警告</font></div><div><font style="font-size: 12pt;">  .connect(&quot;mongodb://localhost/vidly&quot;, { useNewUrlParser: true })</font></div><div><font style="font-size: 12pt;">  .then(console.log(&quot;已连接MongoDB数据库&quot;))</font></div><div><font style="font-size: 12pt;">  .catch((err) =&gt; {</font></div><div><font style="font-size: 12pt;">    console.error(&quot;无法连接MongoDB数据库&quot;), err</font></div><div><font style="font-size: 12pt;">  })  </font></div><div><font style="font-size: 12pt;">  </font></div><div><font style="font-size: 12pt;">const port = process.env.PORT || 3000;</font></div><div><font style="font-size: 12pt;">app.listen(port, () =&gt; console.log(`Listening on port ${port}...`));</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">routes/genres.js</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const express = require('express');</font></div><div><font style="font-size: 12pt;">const router = express.Router();</font></div><div><font style="font-size: 12pt;">const Joi = require(&quot;joi&quot;);</font></div><div><font style="font-size: 12pt;">const mongoose = require(&quot;mongoose&quot;);  </font></div><div><br/></div><div><font style="font-size: 12pt;">// 模板</font></div><div><font style="font-size: 12pt;">const genresSchema = new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: {</font></div><div><font style="font-size: 12pt;">    type: String,</font></div><div><font style="font-size: 12pt;">    required: true,</font></div><div><font style="font-size: 12pt;">    minlength: 3,</font></div><div><font style="font-size: 12pt;">    maxlength: 30</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">})   </font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">// 模型</font></div><div><font style="font-size: 12pt;">const Genres = mongoose.model(&quot;vidly&quot;, genresSchema);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.get(&quot;/&quot;, async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  // 使用模型查找文档，并根据文档的 name 属性排序，返回的是模型（对象）数组</font></div><div><font style="font-size: 12pt;">  const genreModels = await Genres.find().sort(&quot;name&quot;)</font></div><div><font style="font-size: 12pt;">  // 获得数组中每个对象的 _doc 属性值</font></div><div><font style="font-size: 12pt;">  const result = genreModels.map(function (obj) {</font></div><div><font style="font-size: 12pt;">    return obj._doc</font></div><div><font style="font-size: 12pt;">  })</font></div><div><font style="font-size: 12pt;">  // 响应结果</font></div><div><font style="font-size: 12pt;">  res.send(result);</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.post(&quot;/&quot;, async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  const { error } = validateGenre(req.body)</font></div><div><font style="font-size: 12pt;">  if (error) {</font></div><div><font style="font-size: 12pt;">    return res.status(400).send(error.details[0].message);</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">  // new 一个模型创建一个模型实例，该模型实例接受请求体的 name 为模型实例的 _doc 的 name 属性</font></div><div><font style="font-size: 12pt;">  let genre = new Genres({ name: req.body.name });</font></div><div><font style="font-size: 12pt;">  // 将模型实例保存到数据库</font></div><div><font style="font-size: 12pt;">  const genreModel = await genre.save();</font></div><div><font style="font-size: 12pt;">  res.send(genreModel)</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.put('/:id', async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  const { error } = validateGenre(req.body);</font></div><div><font style="font-size: 12pt;">  if (error) {</font></div><div><font style="font-size: 12pt;">    return res.status(400).send(error.details[0].message);</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">  // 使用模型 Genres 查找并修改对应 id 的模型实例</font></div><div><font style="font-size: 12pt;">  const genreModel = await Genres.findByIdAndUpdate(</font></div><div><font style="font-size: 12pt;">    req.params.id,</font></div><div><font style="font-size: 12pt;">    {name: req.body.name},</font></div><div><font style="font-size: 12pt;">    {new: true})</font></div><div><font style="font-size: 12pt;">  if (!genreModel) {</font></div><div><font style="font-size: 12pt;">    return res.status(404).send(&quot;The genre with the given ID was not found.&quot;)</font></div><div><font style="font-size: 12pt;">  }  </font></div><div><font style="font-size: 12pt;">  res.send(genreModel);</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.delete(&quot;/:id&quot;, async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  // 使用模型 Genres 查找并删除对应 id 的模型实例</font></div><div><font style="font-size: 12pt;">  const genreModel = await Genres.findByIdAndRemove(req.params.id);</font></div><div><font style="font-size: 12pt;">  if (!genreModel) {</font></div><div><font style="font-size: 12pt;">    return res.status(404).send(&quot;The genre with the given ID was not found.&quot;)</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">  const { tags, ...result } = genreModel._doc;</font></div><div><font style="font-size: 12pt;">  res.send(`删除${JSON.stringify(result)}成功`)</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.get(&quot;/:id&quot;, async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  // 使用模型根据文档的 id 查找一个文档，返回的是文档</font></div><div><font style="font-size: 12pt;">  const result = await Genres.findById(req.params.id)</font></div><div><font style="font-size: 12pt;">  if (!result) {</font></div><div><font style="font-size: 12pt;">    return res.status(404).send(&quot;The genre with the given ID was not found.&quot;)</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">  // 响应结果</font></div><div><font style="font-size: 12pt;">  res.send(result)</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">function validateGenre(genre) {</font></div><div><font style="font-size: 12pt;">  const schema = {</font></div><div><font style="font-size: 12pt;">    name: Joi.string().min(3).required()</font></div><div><font style="font-size: 12pt;">  };</font></div><div><font style="font-size: 12pt;">  return Joi.validate(genre, schema);</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">module.exports = router;</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><hr/><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">练习2：新增 cutomer 集合并重构</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">index.js</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const genres = require('./routes/genres');</font></div><div><font style="font-size: 12pt;">const customer = require(&quot;./routes/customer&quot;);</font></div><div><font style="font-size: 12pt;">const express = require('express');</font></div><div><font style="font-size: 12pt;">const mongoose = require('mongoose');     </font></div><div><font style="font-size: 12pt;">const app = express();</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">app.use(express.json());</font></div><div><font style="font-size: 12pt;">app.use('/api/genres', genres);</font></div><div><font style="font-size: 12pt;">app.use('/api/customer', customer);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">mongoose</font></div><div><font style="font-size: 12pt;">  .set(&quot;useUnifiedTopology&quot;, true)</font></div><div><font style="font-size: 12pt;">  .connect(&quot;mongodb://localhost/vidly&quot;, { useNewUrlParser: true })</font></div><div><font style="font-size: 12pt;">  .then(console.log(&quot;已连接数据库&quot;))</font></div><div><font style="font-size: 12pt;">  .catch((err) =&gt; {</font></div><div><font style="font-size: 12pt;">    console.error(&quot;无法连接数据库&quot;), err</font></div><div><font style="font-size: 12pt;">  })  </font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const port = process.env.PORT || 3000;</font></div><div><font style="font-size: 12pt;">app.listen(port, () =&gt; console.log(`Listening on port ${port}...`));</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">models/genres.js</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const mongoose = require(&quot;mongoose&quot;)</font></div><div><font style="font-size: 12pt;">const Joi = require(&quot;joi&quot;)</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">// 模板</font></div><div><font style="font-size: 12pt;">const genresSchema = new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: {</font></div><div><font style="font-size: 12pt;">    type: String,</font></div><div><font style="font-size: 12pt;">    required: true,</font></div><div><font style="font-size: 12pt;">    minlength: 3,</font></div><div><font style="font-size: 12pt;">    maxlength: 30,</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">// 模型</font></div><div><font style="font-size: 12pt;">const Genres = mongoose.model(&quot;vidly&quot;, genresSchema);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">function validateGenre(genre) {</font></div><div><font style="font-size: 12pt;">  const schema = {</font></div><div><font style="font-size: 12pt;">    name: Joi.string().min(3).required(),</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">  return Joi.validate(genre, schema)</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">exports.Genres = Genres</font></div><div><font style="font-size: 12pt;">exports.validate= validateGenre</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">m</span><span style="font-size: 12pt; font-weight: bold;">odels/customer.js</span></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const mongoose = require(&quot;mongoose&quot;);</font></div><div><font style="font-size: 12pt;">const Joi = require(&quot;joi&quot;);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">// 模板</font></div><div><font style="font-size: 12pt;">const customerSchema = new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: {</font></div><div><font style="font-size: 12pt;">    type: String,</font></div><div><font style="font-size: 12pt;">    required: true,</font></div><div><font style="font-size: 12pt;">    minlength: 3,</font></div><div><font style="font-size: 12pt;">    maxlength: 30,</font></div><div><font style="font-size: 12pt;">  },</font></div><div><font style="font-size: 12pt;">  isGold: {</font></div><div><font style="font-size: 12pt;">    type: Boolean,</font></div><div><font style="font-size: 12pt;">    default: false</font></div><div><font style="font-size: 12pt;">  },</font></div><div><font style="font-size: 12pt;">  phone: {</font></div><div><font style="font-size: 12pt;">    type: String,</font></div><div><font style="font-size: 12pt;">    required: true,</font></div><div><font style="font-size: 12pt;">    minlength: 3,</font></div><div><font style="font-size: 12pt;">    maxlength: 11,</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">// 模型</font></div><div><font style="font-size: 12pt;">const Customer = mongoose.model(&quot;customer&quot;, customerSchema);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">function validateCustomer(customer) {</font></div><div><font style="font-size: 12pt;">  const schema = {</font></div><div><font style="font-size: 12pt;">    name: Joi.string().min(3).max(30).required(),</font></div><div><font style="font-size: 12pt;">    phone: Joi.string().min(3).max(11).required(),</font></div><div><font style="font-size: 12pt;">    isGold: Joi.boolean(),</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">  return Joi.validate(customer, schema)</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">exports.Customer = Customer;</font></div><div><font style="font-size: 12pt;">exports.validate = validateCustomer;</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">routes/genres.js</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const express = require('express');</font></div><div><font style="font-size: 12pt;">const router = express.Router();</font></div><div><font style="font-size: 12pt;"><b>const {Genres, validate} = require(&quot;../models/genres.js&quot;);</b></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.get(&quot;/&quot;, async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  // 使用模型查找文档，并根据文档的 name 属性排序，返回的是模型（对象）数组</font></div><div><font style="font-size: 12pt;">  const genreModels = await Genres.find().sort(&quot;name&quot;)</font></div><div><font style="font-size: 12pt;">  // 响应结果</font></div><div><font style="font-size: 12pt;">  res.send(genreModels)</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.post(&quot;/&quot;, async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  const { error } = validate(req.body)</font></div><div><font style="font-size: 12pt;">  if (error) {</font></div><div><font style="font-size: 12pt;">    return res.status(400).send(error.details[0].message);</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">  // new 一个模型创建一个模型实例，该模型实例接受请求体的 name 为模型实例的 _doc 的 name 属性</font></div><div><font style="font-size: 12pt;">  let genre = new Genres({ name: req.body.name });</font></div><div><font style="font-size: 12pt;">  // 将模型实例保存到数据库</font></div><div><font style="font-size: 12pt;">  const genreModel = await genre.save();</font></div><div><font style="font-size: 12pt;">  res.send(genreModel)</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.put('/:id', async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  const { error } = validate(req.body);</font></div><div><font style="font-size: 12pt;">  if (error) {</font></div><div><font style="font-size: 12pt;">    return res.status(400).send(error.details[0].message);</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">  // 使用模型 Genres 查找并修改对应 id 的模型实例</font></div><div><font style="font-size: 12pt;">  const genreModel = await Genres.findByIdAndUpdate(</font></div><div><font style="font-size: 12pt;">    req.params.id,</font></div><div><font style="font-size: 12pt;">    { name: req.body.name },</font></div><div><font style="font-size: 12pt;">    {new: true})</font></div><div><font style="font-size: 12pt;">  if (!genreModel) {</font></div><div><font style="font-size: 12pt;">    return res.status(404).send(&quot;The genre with the given ID was not found.&quot;)</font></div><div><font style="font-size: 12pt;">  }  </font></div><div><font style="font-size: 12pt;">  res.send(genreModel);</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.delete(&quot;/:id&quot;, async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  // 使用模型 Genres 查找并删除对应 id 的模型实例</font></div><div><font style="font-size: 12pt;">  const genreModel = await Genres.findByIdAndRemove(req.params.id);</font></div><div><font style="font-size: 12pt;">  if (!genreModel) {</font></div><div><font style="font-size: 12pt;">    return res.status(404).send(&quot;The genre with the given ID was not found.&quot;)</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">  res.send(`删除${JSON.stringify(genreModel)}成功`)</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.get(&quot;/:id&quot;, async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  // 使用模型根据文档的 id 查找一个文档，返回的是文档</font></div><div><font style="font-size: 12pt;">  const genreModel = await Genres.findById(req.params.id)</font></div><div><font style="font-size: 12pt;">  if (!result) {</font></div><div><font style="font-size: 12pt;">    return res.status(404).send(&quot;The genre with the given ID was not found.&quot;)</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">  // 响应结果</font></div><div><font style="font-size: 12pt;">  res.send(genreModel)</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">module.exports = router;</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">routes/customer.js</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const express = require(&quot;express&quot;)</font></div><div><font style="font-size: 12pt;">const router = express.Router()</font></div><div><font style="font-size: 12pt;"><b>const {Customer, validate} = require(&quot;../models/customer&quot;);</b></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.get(&quot;/&quot;, async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  // 使用模型查找文档，并根据文档的 name 属性排序，返回的是模型（对象）数组</font></div><div><font style="font-size: 12pt;">  const customerModels = await Customer.find().sort(&quot;name&quot;)</font></div><div><font style="font-size: 12pt;">  // 响应结果</font></div><div><font style="font-size: 12pt;">  res.send(customerModels)</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.post(&quot;/&quot;, async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  const { error } = validate(req.body)</font></div><div><font style="font-size: 12pt;">  if (error) {</font></div><div><font style="font-size: 12pt;">    return res.status(400).send(error.details[0].message)</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">  // new 一个模型创建一个模型实例，该模型实例接受请求体的 name 为模型实例的 _doc 的 name 属性</font></div><div><font style="font-size: 12pt;">  let customer = new Customer({</font></div><div><font style="font-size: 12pt;">    name: req.body.name,</font></div><div><font style="font-size: 12pt;">    phone: req.body.phone,</font></div><div><font style="font-size: 12pt;">    isGold: req.body.isGold</font></div><div><font style="font-size: 12pt;">  });</font></div><div><font style="font-size: 12pt;">  // 将模型实例保存到数据库</font></div><div><font style="font-size: 12pt;">  const customerModel = await customer.save()</font></div><div><font style="font-size: 12pt;">  res.send(customerModel)</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.put(&quot;/:id&quot;, async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  const { error } = validate(req.body)</font></div><div><font style="font-size: 12pt;">  if (error) {</font></div><div><font style="font-size: 12pt;">    return res.status(400).send(error.details[0].message)</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">  // 使用模型 Genres 查找并修改对应 id 的模型实例</font></div><div><font style="font-size: 12pt;">  const customerModel = await Customer.findByIdAndUpdate(</font></div><div><font style="font-size: 12pt;">    req.params.id,</font></div><div><font style="font-size: 12pt;">    { name: req.body.name, phone: req.body.phone, isGold: req.body.isGold },</font></div><div><font style="font-size: 12pt;">    { new: true }</font></div><div><font style="font-size: 12pt;">  )</font></div><div><font style="font-size: 12pt;">  if (!customerModel) {</font></div><div><font style="font-size: 12pt;">    return res.status(404).send(&quot;The customer with the given ID was not found.&quot;)</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">  res.send(customerModel)</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.delete(&quot;/:id&quot;, async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  // 使用模型 Genres 查找并删除对应 id 的模型实例</font></div><div><font style="font-size: 12pt;">  const customerModel = await Customer.findByIdAndRemove(req.params.id)</font></div><div><font style="font-size: 12pt;">  if (!customerModel) {</font></div><div><font style="font-size: 12pt;">    return res.status(404).send(&quot;The customer with the given ID was not found.&quot;)</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">  res.send(`删除${JSON.stringify(customerModel)}成功`)</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.get(&quot;/:id&quot;, async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  // 使用模型根据文档的 id 查找一个文档，返回的是文档</font></div><div><font style="font-size: 12pt;">  const customerModel = await Customer.findById(req.params.id)</font></div><div><font style="font-size: 12pt;">  if (!customerModel) {</font></div><div><font style="font-size: 12pt;">    return res.status(404).send(&quot;The customer with the given ID was not found.&quot;)</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">  // 响应结果</font></div><div><font style="font-size: 12pt;">  res.send(customerModel)</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">module.exports = router</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">问题 1：Postman 根据 id（已删） Get 请求显示错误后，再次 Get 请求仍然显示错误</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">问题 2：以上代码无法处理异常，比如 get id 不正确时无法响应</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">问题 2 </span></span><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">解决方案如下：</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">routes/genres.js</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const express = require('express');</font></div><div><font style="font-size: 12pt;">const router = express.Router();</font></div><div><font style="font-size: 12pt;"><b>const {Genres, validate} = require(&quot;../models/genres.js&quot;);</b></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.get(&quot;/&quot;, async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  // 使用模型查找文档，并根据文档的 name 属性排序，返回的是模型（对象）数组</font></div><div><font style="font-size: 12pt;">  const genreModels = await Genres.find().sort(&quot;name&quot;);</font></div><div><font style="font-size: 12pt;">  // 响应结果</font></div><div><font style="font-size: 12pt;">  res.send(genreModels);</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.post(&quot;/&quot;, async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  const { error } = validate(req.body)</font></div><div><font style="font-size: 12pt;">  if (error) {</font></div><div><font style="font-size: 12pt;">    return res.status(400).send(error.details[0].message);</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">  // new 一个模型创建一个模型实例，该模型实例接受请求体的 name 为模型实例的 _doc 的 name 属性</font></div><div><font style="font-size: 12pt;">  let genre = new Genres({ name: req.body.name });</font></div><div><font style="font-size: 12pt;">  // 将模型实例保存到数据库</font></div><div><font style="font-size: 12pt;">  const genreModel = await genre.save();</font></div><div><font style="font-size: 12pt;">  res.send(genreModel);</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.put('/:id', async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  const { error } = validate(req.body);</font></div><div><font style="font-size: 12pt;">  if (error) {</font></div><div><font style="font-size: 12pt;">    return res.status(400).send(error.details[0].message);</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">  await Genres.findByIdAndUpdate(</font></div><div><font style="font-size: 12pt;">    req.params.id,</font></div><div><font style="font-size: 12pt;">    { name: req.body.name },</font></div><div><font style="font-size: 12pt;">    { new: true }</font></div><div><font style="font-size: 12pt;">  ).exec(function (err, genreModel) {</font></div><div><font style="font-size: 12pt;">    if (err || !genreModel) {</font></div><div><font style="font-size: 12pt;">      res.status(404).send(&quot;The genre with the given ID was not found.&quot;);</font></div><div><font style="font-size: 12pt;">      return;</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;">    // 响应结果</font></div><div><font style="font-size: 12pt;">    res.send(genreModel);</font></div><div><font style="font-size: 12pt;">  })</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.delete(&quot;/:id&quot;, async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  await Genres.findByIdAndRemove(req.params.id).exec(</font></div><div><font style="font-size: 12pt;">    function (err, genreModel) {</font></div><div><font style="font-size: 12pt;">      if (err || !genreModel) {</font></div><div><font style="font-size: 12pt;">        res.status(404).send(&quot;The genre with the given ID was not found.&quot;);</font></div><div><font style="font-size: 12pt;">        return;</font></div><div><font style="font-size: 12pt;">      }</font></div><div><font style="font-size: 12pt;">      // 响应结果</font></div><div><font style="font-size: 12pt;">      res.send(`删除${JSON.stringify(genreModel)}成功`);</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;">  )</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.get(&quot;/:id&quot;, async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  // 使用模型根据文档的 id 查找一个文档，返回的是文档</font></div><div><font style="font-size: 12pt;">  await Genres.findById(req.params.id).exec(function (</font></div><div><font style="font-size: 12pt;">    err,</font></div><div><font style="font-size: 12pt;">    genreModel</font></div><div><font style="font-size: 12pt;">  ) {</font></div><div><font style="font-size: 12pt;">    if (err || !genreModel) {</font></div><div><font style="font-size: 12pt;">      res.status(404).send(&quot;The genre with the given ID was not found.&quot;);</font></div><div><font style="font-size: 12pt;">      return;</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;">    // 响应结果</font></div><div><font style="font-size: 12pt;">    res.send(genreModel);</font></div><div><font style="font-size: 12pt;">  })</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">module.exports = router;</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">routes/customer.js</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const express = require(&quot;express&quot;);</font></div><div><font style="font-size: 12pt;">const router = express.Router();</font></div><div><font style="font-size: 12pt;"><b>const {Customer, validate} = require(&quot;../models/customer&quot;);</b></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.get(&quot;/&quot;, async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  // 使用模型查找文档，并根据文档的 name 属性排序，返回的是模型（对象）数组</font></div><div><font style="font-size: 12pt;">  const customerModels = await Customer.find().sort(&quot;name&quot;);</font></div><div><font style="font-size: 12pt;">  // 响应结果</font></div><div><font style="font-size: 12pt;">  res.send(customerModels);</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.post(&quot;/&quot;, async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  const { error } = validate(req.body);</font></div><div><font style="font-size: 12pt;">  if (error) {</font></div><div><font style="font-size: 12pt;">    return res.status(400).send(error.details[0].message);</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">  // new 一个模型创建一个模型实例，该模型实例接受请求体的 name 为模型实例的 _doc 的 name 属性</font></div><div><font style="font-size: 12pt;">  let customer = new Customer({</font></div><div><font style="font-size: 12pt;">    name: req.body.name,</font></div><div><font style="font-size: 12pt;">    phone: req.body.phone,</font></div><div><font style="font-size: 12pt;">    isGold: req.body.isGold</font></div><div><font style="font-size: 12pt;">  });</font></div><div><font style="font-size: 12pt;">  // 将模型实例保存到数据库</font></div><div><font style="font-size: 12pt;">  const customerModel = await customer.save();</font></div><div><font style="font-size: 12pt;">  res.send(customerModel);</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.put(&quot;/:id&quot;, async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  const { error } = validate(req.body);</font></div><div><font style="font-size: 12pt;">  if (error) {</font></div><div><font style="font-size: 12pt;">    return res.status(400).send(error.details[0].message);</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">  await Customer.findByIdAndUpdate(</font></div><div><font style="font-size: 12pt;">    req.params.id,</font></div><div><font style="font-size: 12pt;">    { name: req.body.name, phone: req.body.phone, isGold: req.body.isGold },</font></div><div><font style="font-size: 12pt;">    { new: true }</font></div><div><font style="font-size: 12pt;">  ).exec(function (err, customerModel) {</font></div><div><font style="font-size: 12pt;">    if (err || !customerModel) {</font></div><div><font style="font-size: 12pt;">      res.status(404).send(&quot;The customer with the given ID was not found.&quot;);</font></div><div><font style="font-size: 12pt;">      return;</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;">    // 响应结果</font></div><div><font style="font-size: 12pt;">    res.send(customerModel);</font></div><div><font style="font-size: 12pt;">  })</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.delete(&quot;/:id&quot;, async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  // 使用模型 Genres 查找并删除对应 id 的模型实例</font></div><div><font style="font-size: 12pt;">  await Customer.findByIdAndRemove(req.params.id).exec(</font></div><div><font style="font-size: 12pt;">    function (err, customerModel) {</font></div><div><font style="font-size: 12pt;">      if (err || !customerModel) {</font></div><div><font style="font-size: 12pt;">        res.status(404).send(&quot;The customer with the given ID was not found.&quot;);</font></div><div><font style="font-size: 12pt;">        return;</font></div><div><font style="font-size: 12pt;">      }</font></div><div><font style="font-size: 12pt;">      // 响应结果</font></div><div><font style="font-size: 12pt;">      res.send(`删除${JSON.stringify(customerModel)}成功`);</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;">  )</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.get(&quot;/:id&quot;, async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  await Customer.findById(req.params.id).exec(function (err, customerModel) {</font></div><div><font style="font-size: 12pt;">    if (err || !customerModel) {</font></div><div><font style="font-size: 12pt;">      res.status(404).send(&quot;The customer with the given ID was not found.&quot;);</font></div><div><font style="font-size: 12pt;">      return;</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;">    // 响应结果</font></div><div><font style="font-size: 12pt;">    res.send(customerModel);</font></div><div><font style="font-size: 12pt;">  })</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">module.exports = router;</font></div></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;"><br/></span></div><hr/><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">模型关系</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">在真实的开发中，集合的文档之间是有关系的。</span></div><div><br/></div><div><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">比如 </span><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">courses 集合 其中的一个</span> <span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">course </span><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">文档</span><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">中有个 author 字段，</span><span style="font-size: unset;"><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">但作者不只一个，</span></span></div><div><span style="font-size: unset;"><font style="font-size: 12pt;"><br/></font></span></div><div><span style="font-size: unset;"><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">所以 author 字段会有</span></span> <span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">authors 集合 其中的</span><span style="font-size: unset;"><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">一个 author 文档，</span></span><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">author </span><span style="font-size: unset;"><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">文档</span></span><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">里有对应的</span><span style="font-size: 12pt; color: rgb(51, 51, 51); font-family: Monaco;">一个作者的 name、website、image 等字段。</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">// 1、使用引用 —— 范式化  --&gt; 保证一致性、稳定性</font></div><div><font style="font-size: 12pt;">// 关系型数据库 关系是建立两个文档的关系，将数据整合的基本概念。</font></div><div><font style="font-size: 12pt;">// 在非关系型数据库中是没有关系约束的，如果是非法 id ，MongoDB 也不会理的，所以可以用该方法</font></div><div><font style="font-size: 12pt;"><font>// </font>如果某一天我希望将Mosh的名字修改了，只需要修改一处，所有引用的这个数据的文档都能马上看到修改</font></div><div><font style="font-size: 12pt;"><font>// </font>但是，每次我们新建一个课程都需要额外再进行一次作者的查询</font></div><div><font style="font-size: 12pt;">let author = {</font></div><div><font style="font-size: 12pt;">  name: 'Mosh'</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">let course = {</font></div><div><font style="font-size: 12pt;">  author: 'id',</font></div><div><font style="font-size: 12pt;">  // authors: ['id1', 'id2']</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">/</font><font style="font-size: 12pt;">/ 2、使用嵌入式文档 —— 反范式化 --&gt; 保证查询性能</font></div><div><font style="font-size: 12pt;"><font>// 将一个文档嵌入到另一个文档中</font></font></div><div><font style="font-size: 12pt;"><font><font>// </font></font><font>如果某一天我希望将 Mosh 的名字修改了，就要修改多个文档的数据</font></font></div><div><font style="font-size: 12pt;"><font>// </font>如果更新的操作没有成功完成，就有可能某些请求会得到旧数据</font></div><div><font style="font-size: 12pt;">let course = {</font></div><div><font style="font-size: 12pt;">  author: {</font></div><div><font style="font-size: 12pt;">    name: 'Mosh'</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">// 3、混合方案 --&gt; 只取一部分数据</font></div><div><font style="font-size: 12pt;"><font>// </font>例如每个作者有 50 个其他字段，我们不想在每个课程文档中重复这些数据</font></div><div><font style="font-size: 12pt;"><span style="color: rgb(51, 51, 51); font-family: Monaco;">//   </span>这样可以在查询课程的时候很快得到 name 属性，但是没有保存 author 整个文档的 数据</font></div><div><font style="font-size: 12pt;">// 这</font><span style="font-size: 12pt;">种做法特别在建立某个时间点的数据快照时非常有用</span></div><div><font style="font-size: 12pt;"><font>// 比如电商应用</font>有些订单，产品，购物车等等集合，<font>在每个订单中都应有商品的快照，因为要记录给定时间点商品的价格</font></font></div><div><font style="font-size: 12pt;">let author = {</font></div><div><font style="font-size: 12pt;">  name: 'Mosh',</font></div><div><font style="font-size: 12pt;">  // 50 个其他字段</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">let course = {</font></div><div><font style="font-size: 12pt;">  id: 'ref',</font></div><div><font style="font-size: 12pt;">  name: 'Mosh'</font></div><div><font style="font-size: 12pt;">}</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><hr/><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">链接文档</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">删除之前的 playground 数据库</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">population.js</span></span></div><div><font style="font-size: 12pt;"><br/></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const mongoose = require('mongoose');</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">mongoose.connect('mongodb://localhost/playground')</font></div><div><font style="font-size: 12pt;">  .then(() =&gt; console.log('Connected to MongoDB...'))</font></div><div><font style="font-size: 12pt;">  .catch(err =&gt; console.error('Could not connect to MongoDB...', err));</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const Author = mongoose.model('Author', new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: String,</font></div><div><font style="font-size: 12pt;">  bio: String,</font></div><div><font style="font-size: 12pt;">  website: String</font></div><div><font style="font-size: 12pt;">}));</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const Course = mongoose.model('Course', new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: String,</font></div><div><font style="font-size: 12pt;"><b>  author: {</b></font></div><div><font style="font-size: 12pt;"><b>    type: mongoose.Schema.Types.ObjectId,</b></font></div><div><font style="font-size: 12pt;"><b>    ref: 'Author'</b></font></div><div><font style="font-size: 12pt;"><b>  }</b></font></div><div><font style="font-size: 12pt;">}));</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">async function createAuthor(name, bio, website) {</font></div><div><font style="font-size: 12pt;">  const author = new Author({</font></div><div><font style="font-size: 12pt;">    name,</font></div><div><font style="font-size: 12pt;">    bio,</font></div><div><font style="font-size: 12pt;">    website</font></div><div><font style="font-size: 12pt;">  });</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  const result = await author.save();</font></div><div><font style="font-size: 12pt;">  console.log(result);</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">async function createCourse(name, author) {</font></div><div><font style="font-size: 12pt;">  const course = new Course({</font></div><div><font style="font-size: 12pt;">    name,</font></div><div><font style="font-size: 12pt;">    author</font></div><div><font style="font-size: 12pt;">  });</font></div><div><font style="font-size: 12pt;">  </font></div><div><font style="font-size: 12pt;">  const result = await course.save();</font></div><div><font style="font-size: 12pt;">  console.log(result);</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">async function listCourses() {</font></div><div><font style="font-size: 12pt;">  const courses = await Course</font></div><div><font style="font-size: 12pt;">    .find()</font></div><div><font style="font-size: 12pt;">    .select('name');</font></div><div><font style="font-size: 12pt;">  console.log(courses);</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">// createAuthor('Mosh', 'My bio', 'My Website');</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">createCourse('Node Course', '5f2e6d312e78d12bac780c1d')</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">// listCourses();</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><br/></div><div><span style="font-size: 12pt;">执行 createAuthor('Mosh', 'My bio', 'My Website'); </span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">node population.js</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">保存 author</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [23].jpg" type="image/jpeg" data-filename="3.jpg"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">执行 createCourse('Node Course', '5f2e6d312e78d12bac780c1d')</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">node population.js</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">保存 course</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [24].jpg" type="image/jpeg" data-filename="3.jpg"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [25].jpg" type="image/jpeg" data-filename="3.jpg"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">我们创建 Course 模型时没有创建 author 属性，所以上图没有 author 属性</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">添加 </span><span style="font-size: 12pt;">author 属性并</span><span style="font-size: 12pt;">设置一个指向 Author 集合的链接</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [26].jpg" type="image/jpeg" data-filename="3.jpg"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">node population.js</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">再保存一个 course</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [27].jpg" type="image/jpeg" data-filename="3.jpg"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><hr/><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">填入链接文档的属性（展示课程时填入）</span></span></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">async function listCourses() {</font></div><div><font style="font-size: 12pt;">  const courses = await Course</font></div><div><font style="font-size: 12pt;">    .find()</font></div><div><font style="font-size: 12pt;">    .select('name author');</font></div><div><font style="font-size: 12pt;">  console.log(courses);</font></div><div><font style="font-size: 12pt;">}</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">来到代码最下方的 </span><span style="font-size: 12pt;">listCourses() </span><span style="font-size: 12pt;">获取全部课程</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">node population.js</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [28].jpg" type="image/jpeg" data-filename="3.jpg"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">只能获取 author 的引用地址，即 id</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">要想获取 author 的 name，需要用到 populate() 方法</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">async function listCourses() {</font></div><div><font style="font-size: 12pt;">  const courses = await Course</font></div><div><font style="font-size: 12pt;">    .find()</font></div><div><font style="font-size: 12pt;">    <b>.populate('author', 'name -_id')</b></font></div><div><font style="font-size: 12pt;">    .select('name author');</font></div><div><font style="font-size: 12pt;">  console.log(courses);</font></div><div><font style="font-size: 12pt;">}</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">populate() 方法</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">第一个参数是给定属性的路径</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">当我们加载一个课程对象，并“填入“一个作者属性时，</span><span style="font-size: 12pt;">mongoose 要查询 MongoDB 中的 Author 集合，所以第一个参数是 author</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">第二个参数设置想包含或想排除的属性</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">node population.js</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [29].jpg" type="image/jpeg" data-filename="3.jpg"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">如果修改 author 的 id ，将无法链接，author 值会为 null</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">populate 填入多个属性也是可以的，</span><span style="font-size: 12pt;">假设每个课程都有一个 category 属性，category 是链接到 category 文档的</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">async function listCourses() {</font></div><div><font style="font-size: 12pt;">  const courses = await Course</font></div><div><font style="font-size: 12pt;">    .find()</font></div><div><font style="font-size: 12pt;">    .populate('author', 'name -_id')</font></div><div><font style="font-size: 12pt;">    <b>.populate('category', 'name')</b></font></div><div><font style="font-size: 12pt;">    .select('name author');</font></div><div><font style="font-size: 12pt;">  console.log(courses);</font></div><div><font style="font-size: 12pt;">}</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">完整代码如下：</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">population.js</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const mongoose = require('mongoose');</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">mongoose.connect('mongodb://localhost/playground')</font></div><div><font style="font-size: 12pt;">  .then(() =&gt; console.log('Connected to MongoDB...'))</font></div><div><font style="font-size: 12pt;">  .catch(err =&gt; console.error('Could not connect to MongoDB...', err));</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const Author = mongoose.model('Author', new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: String,</font></div><div><font style="font-size: 12pt;">  bio: String,</font></div><div><font style="font-size: 12pt;">  website: String</font></div><div><font style="font-size: 12pt;">}));</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const Course = mongoose.model('Course', new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: String,</font></div><div><font style="font-size: 12pt;">  author: {</font></div><div><font style="font-size: 12pt;">    type: mongoose.Schema.Types.ObjectId,</font></div><div><font style="font-size: 12pt;">    ref: 'Author'</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">}));</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">async function createAuthor(name, bio, website) {</font></div><div><font style="font-size: 12pt;">  const author = new Author({</font></div><div><font style="font-size: 12pt;">    name,</font></div><div><font style="font-size: 12pt;">    bio,</font></div><div><font style="font-size: 12pt;">    website</font></div><div><font style="font-size: 12pt;">  });</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  const result = await author.save();</font></div><div><font style="font-size: 12pt;">  console.log(result);</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">async function createCourse(name, author) {</font></div><div><font style="font-size: 12pt;">  const course = new Course({</font></div><div><font style="font-size: 12pt;">    name,</font></div><div><font style="font-size: 12pt;">    author</font></div><div><font style="font-size: 12pt;">  });</font></div><div><font style="font-size: 12pt;">  </font></div><div><font style="font-size: 12pt;">  const result = await course.save();</font></div><div><font style="font-size: 12pt;">  console.log(result);</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">async function listCourses() {</font></div><div><font style="font-size: 12pt;">  const courses = await Course</font></div><div><font style="font-size: 12pt;">    .find()</font></div><div><font style="font-size: 12pt;">    .populate('author', 'name -_id')</font></div><div><font style="font-size: 12pt;">    .populate('category', 'name')</font></div><div><font style="font-size: 12pt;">    .select('name author');</font></div><div><font style="font-size: 12pt;">  console.log(courses);</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">// createAuthor('Mosh', 'My bio', 'My Website');</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">// createCourse('Node Course', '5f2e6d312e78d12bac780c1d')</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">listCourses();</font></div></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;"><br/></span></div><hr/><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">嵌入文档</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">删除之前的 playground 数据库</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">将 author 文档嵌入 course 文档，</span><span style="font-size: 12pt;">author 文档是嵌入文档也就是子文档</span></div><div><br/></div><div><span style="font-size: 12pt;">子文档是不能自己保存的，只能让父文档保存才行</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">embedding.js</span></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 12pt;">const mongoose = require('mongoose');</span></div><div><br/></div><div><span style="font-size: 12pt;">mongoose.connect('mongodb://localhost/playground')</span></div><div><span style="font-size: 12pt;">  .then(() =&gt; console.log('Connected to MongoDB...'))</span></div><div><span style="font-size: 12pt;">  .catch(err =&gt; console.error('Could not connect to MongoDB...', err));</span></div><div><br/></div><div><span style="font-size: 12pt;">const authorSchema = new mongoose.Schema({</span></div><div><span style="font-size: 12pt;">  name: String,</span></div><div><span style="font-size: 12pt;">  bio: String,</span></div><div><span style="font-size: 12pt;">  website: String</span></div><div><span style="font-size: 12pt;">});</span></div><div><br/></div><div><span style="font-size: 12pt;">const Author = mongoose.model('Author', authorSchema);</span></div><div><br/></div><div><span style="font-size: 12pt;">const Course = mongoose.model('Course', new mongoose.Schema({</span></div><div><span style="font-size: 12pt;">  name: String,</span></div><div><span style="font-size: 12pt;">  <b>author: authorSchema</b></span></div><div><span style="font-size: 12pt;">}));</span></div><div><br/></div><div><span style="font-size: 12pt;">async function createCourse(name, author) {</span></div><div><span style="font-size: 12pt;">  const course = new Course({</span></div><div><span style="font-size: 12pt;">    name,</span></div><div><span style="font-size: 12pt;">    author</span></div><div><span style="font-size: 12pt;">  });</span></div><div><span style="font-size: 12pt;">  </span></div><div><span style="font-size: 12pt;">  const result = await course.save();</span></div><div><span style="font-size: 12pt;">  console.log(result);</span></div><div><span style="font-size: 12pt;">}</span></div><div><br/></div><div><span style="font-size: 12pt;">async function listCourses() {</span></div><div><span style="font-size: 12pt;">  const courses = await Course.find();</span></div><div><span style="font-size: 12pt;">  console.log(courses);</span></div><div><span style="font-size: 12pt;">}</span></div><div><br/></div><div><span style="font-size: 12pt;">// createCourse('Node Course', new Author({ name: 'Mosh' }));</span></div><div><br/></div><div><span style="font-size: 12pt;"><b>async function updateAuthor(courseId) {</b></span></div><div><font style="font-size: 12pt;"><b>  const course = await Course.findById(courseId);</b></font></div><div><span style="font-size: 12pt;"><b>  course.author.name = 'Mosh Hamedani';</b></span></div><div><span style="font-size: 12pt;"><b>  course.save();</b></span></div><div><span style="font-size: 12pt;"><b>  // course.author.save() 是不可以保存的，这个方法不存在</b></span></div><div><span style="font-size: 12pt;"><b>}</b></span></div><div><b><br/></b></div><div><span style="font-size: 12pt;"><b>updateAuthor('5f2eb502e60cc20794b34c59') // 注意，这个 id 是 course 文档的 id</b></span></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">所以，我们不用先找到 author 文档 就可以更新它</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">先执行 </span><span style="font-size: 12pt;">createCourse('Node Course', new Author({ name: 'Mosh' }))</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">node embedding.js</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">保存 course</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [30].jpg" type="image/jpeg" data-filename="3.jpg"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">再执行 </span><span style="font-size: 12pt;">updateAuthor('</span><span style="font-size: 12pt;">5f2eb8ca053be42378437f27</span><span style="font-size: 12pt;">')，可以发现 name 已修改</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [31].jpg" type="image/jpeg" data-filename="3.jpg"/></span></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">第二种更新的方法：</span></font></div><div><font style="font-size: 12pt;"><br/></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">async function updateAuthor(courseId) {</font></div><div><font style="font-size: 12pt;">  const course = await Course.update({_id: courseId}, {</font></div><div><font style="font-size: 12pt;">    $set: {</font></div><div><font style="font-size: 12pt;">      'author.name': 'John Simth'</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;">  })</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">updateAuthor(&quot;5f2eb8ca053be42378437f27&quot;)</font></div></div><div><font style="font-size: 12pt;"><br/></font></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [32].jpg" type="image/jpeg" data-filename="3.jpg"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">如果想删除子文档或者子文档的属性，可以使用 unset 操作符</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">async function updateAuthor(courseId) {</font></div><div><font style="font-size: 12pt;">  const course = await Course.update({_id: courseId}, {</font></div><div><font style="font-size: 12pt;">    $unset: {</font></div><div><font style="font-size: 12pt;">      'author': ''</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;">  })</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">updateAuthor(&quot;5f2eb8ca053be42378437f27&quot;)</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [33].jpg" type="image/jpeg" data-filename="3.jpg"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">子文档与普通文档一样是可以验证的，子文档的属性也一样：</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const authorSchema = new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: {</font></div><div><font style="font-size: 12pt;">    type: String,</font></div><div><font style="font-size: 12pt;">    required: true</font></div><div><font style="font-size: 12pt;">  },</font></div><div><font style="font-size: 12pt;">  bio: String,</font></div><div><font style="font-size: 12pt;">  website: String</font></div><div><font style="font-size: 12pt;">});</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const Author = mongoose.model('Author', authorSchema);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const Course = mongoose.model('Course', new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: String,</font></div><div><font style="font-size: 12pt;">  author: {</font></div><div><font style="font-size: 12pt;">    type: authorSchema,</font></div><div><font style="font-size: 12pt;">    required: true</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">}));</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">完整代码如下：</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">embedding.js</span></div><div><font style="font-size: 12pt;"><br/></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const mongoose = require('mongoose');</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">mongoose.connect('mongodb://localhost/playground')</font></div><div><font style="font-size: 12pt;">  .then(() =&gt; console.log('Connected to MongoDB...'))</font></div><div><font style="font-size: 12pt;">  .catch(err =&gt; console.error('Could not connect to MongoDB...', err));</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const authorSchema = new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: {</font></div><div><font style="font-size: 12pt;">    type: String,</font></div><div><font style="font-size: 12pt;">    required: true</font></div><div><font style="font-size: 12pt;">  },</font></div><div><font style="font-size: 12pt;">  bio: String,</font></div><div><font style="font-size: 12pt;">  website: String</font></div><div><font style="font-size: 12pt;">});</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const Author = mongoose.model('Author', authorSchema);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const Course = mongoose.model('Course', new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: String,</font></div><div><font style="font-size: 12pt;">  author: {</font></div><div><font style="font-size: 12pt;">    type: authorSchema,</font></div><div><font style="font-size: 12pt;">    required: true</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">}));</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">async function createCourse(name, author) {</font></div><div><font style="font-size: 12pt;">  const course = new Course({</font></div><div><font style="font-size: 12pt;">    name,</font></div><div><font style="font-size: 12pt;">    author</font></div><div><font style="font-size: 12pt;">  });</font></div><div><font style="font-size: 12pt;">  </font></div><div><font style="font-size: 12pt;">  const result = await course.save();</font></div><div><font style="font-size: 12pt;">  console.log(result);</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">async function listCourses() {</font></div><div><font style="font-size: 12pt;">  const courses = await Course.find();</font></div><div><font style="font-size: 12pt;">  console.log(courses);</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">// createCourse('Node Course', new Author({ name: 'Mosh' }));</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">async function updateAuthor(courseId) {</font></div><div><font style="font-size: 12pt;">  const course = await Course.update({_id: courseId}, {</font></div><div><font style="font-size: 12pt;">    $unset: {</font></div><div><font style="font-size: 12pt;">      'author': ''</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;">  })</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">updateAuthor(&quot;5f2eb8ca053be42378437f27&quot;)</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><hr/><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">子文档数组</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">删除之前的 playground 数据库</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">embedding.js</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const mongoose = require('mongoose');</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">mongoose.connect('mongodb://localhost/playground')</font></div><div><font style="font-size: 12pt;">  .then(() =&gt; console.log('Connected to MongoDB...'))</font></div><div><font style="font-size: 12pt;">  .catch(err =&gt; console.error('Could not connect to MongoDB...', err));</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const authorSchema = new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: String,</font></div><div><font style="font-size: 12pt;">  bio: String,</font></div><div><font style="font-size: 12pt;">  website: String</font></div><div><font style="font-size: 12pt;">});</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const Author = mongoose.model('Author', authorSchema);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const Course = mongoose.model('Course', new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: String,</font></div><div><font style="font-size: 12pt;">  <b>authors: [authorSchema]</b></font></div><div><font style="font-size: 12pt;">}));</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">async function createCourse(name, <b>authors</b>) {</font></div><div><font style="font-size: 12pt;">  const course = new Course({</font></div><div><font style="font-size: 12pt;">    name,</font></div><div><font style="font-size: 12pt;">    <b>authors</b></font></div><div><font style="font-size: 12pt;">  });</font></div><div><font style="font-size: 12pt;">  </font></div><div><font style="font-size: 12pt;">  const result = await course.save();</font></div><div><font style="font-size: 12pt;">  console.log(result);</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">async function listCourses() {</font></div><div><font style="font-size: 12pt;">  const courses = await Course.find();</font></div><div><font style="font-size: 12pt;">  console.log(courses);</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">createCourse(&quot;Node Course&quot;, <b>[</b></font></div><div><font style="font-size: 12pt;"><b>  new Author({name: 'Mosh'}),</b></font></div><div><font style="font-size: 12pt;"><b>  new Author({name: 'John'})</b></font></div><div><font style="font-size: 12pt;"><b>]</b>)</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">node embedding.js</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">course 文档中新的 authors 属性是一个数组，它</span><span style="font-size: 12pt;">有 2 个对象，代表 2 个作者</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [34].jpg" type="image/jpeg" data-filename="3.jpg"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">我们可以向数组再添加一个作者</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">async function addAuthor(courseId, author) {</font></div><div><font style="font-size: 12pt;">  const course = await Course.findById(courseId);</font></div><div><font style="font-size: 12pt;">  course.authors.push(author);</font></div><div><font style="font-size: 12pt;">  course.save();</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">addAuthor(&quot;5f2ec293d6b2e52744167d45&quot;, {name: 'Amy'});</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">node embedding.js</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [35].jpg" type="image/jpeg" data-filename="3.jpg"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;">我们也可以删除一个作者，但是需要 课程 id 和 作者 id，course 对象的 authors 属性有一个 id 方法，借助 id 可以查询到子对象，它会返回对应的 author 子对象</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">async function removeAuthor(courseId, authorId) {</font></div><div><font style="font-size: 12pt;">  const course = await Course.findById(courseId)</font></div><div><font style="font-size: 12pt;">  const author = course.authors.id(authorId)</font></div><div><font style="font-size: 12pt;">  author.remove();</font></div><div><font style="font-size: 12pt;">  course.save();</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">removeAuthor(&quot;5f2ec293d6b2e52744167d45&quot;, &quot;5f2ec7aea8973b14041271df&quot;)</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">node embedding.js</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [36].jpg" type="image/jpeg" data-filename="3.jpg"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><font style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">完整代码如下：</span></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">embedding.js</span></font></div><div><font style="font-size: 12pt;"><br/></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const mongoose = require(&quot;mongoose&quot;)</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">mongoose</font></div><div><font style="font-size: 12pt;">  .connect(&quot;mongodb://localhost/playground&quot;)</font></div><div><font style="font-size: 12pt;">  .then(() =&gt; console.log(&quot;Connected to MongoDB...&quot;))</font></div><div><font style="font-size: 12pt;">  .catch((err) =&gt; console.error(&quot;Could not connect to MongoDB...&quot;, err))</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const authorSchema = new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: String,</font></div><div><font style="font-size: 12pt;">  bio: String,</font></div><div><font style="font-size: 12pt;">  website: String,</font></div><div><font style="font-size: 12pt;">})</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const Author = mongoose.model(&quot;Author&quot;, authorSchema)</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const Course = mongoose.model(</font></div><div><font style="font-size: 12pt;">  &quot;Course&quot;,</font></div><div><font style="font-size: 12pt;">  new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">    name: String,</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">    authors: [authorSchema],</font></div><div><font style="font-size: 12pt;">  })</font></div><div><font style="font-size: 12pt;">)</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">async function createCourse(name, authors) {</font></div><div><font style="font-size: 12pt;">  const course = new Course({</font></div><div><font style="font-size: 12pt;">    name,</font></div><div><font style="font-size: 12pt;">    authors,</font></div><div><font style="font-size: 12pt;">  });</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  const result = await course.save();</font></div><div><font style="font-size: 12pt;">  console.log(result);</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">async function listCourses() {</font></div><div><font style="font-size: 12pt;">  const courses = await Course.find();</font></div><div><font style="font-size: 12pt;">  console.log(courses);</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">async function addAuthor(courseId, author) {</font></div><div><font style="font-size: 12pt;">  const course = await Course.findById(courseId);</font></div><div><font style="font-size: 12pt;">  course.authors.push(author);</font></div><div><font style="font-size: 12pt;">  course.save();</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">// addAuthor(&quot;5f2ec293d6b2e52744167d45&quot;, {name: 'Amy'});</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">async function removeAuthor(courseId, authorId) {</font></div><div><font style="font-size: 12pt;">  const course = await Course.findById(courseId);</font></div><div><font style="font-size: 12pt;">  const author = course.authors.id(authorId);</font></div><div><font style="font-size: 12pt;">  author.remove();</font></div><div><font style="font-size: 12pt;">  course.save();</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">removeAuthor(&quot;5f2ec293d6b2e52744167d45&quot;, &quot;5f2ec7aea8973b14041271df&quot;);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">// createCourse(&quot;Node Course&quot;, [</font></div><div><font style="font-size: 12pt;">//   new Author({ name: &quot;Mosh&quot; }),</font></div><div><font style="font-size: 12pt;">//   new Author({ name: &quot;John&quot; }),</font></div><div><font style="font-size: 12pt;">// ])</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><hr/><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><img src="2 - Node_files/3 [37].jpg" type="image/jpeg" data-filename="3.jpg"/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">index.js</span></span></div><div><font style="font-size: 12pt;"><br/></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const mongoose = require('mongoose');</font></div><div><font style="font-size: 12pt;">const genres = require('./routes/genres');</font></div><div><font style="font-size: 12pt;">const customers = require('./routes/customers');</font></div><div><font style="font-size: 12pt;">const movies = require('./routes/movies');</font></div><div><font style="font-size: 12pt;">const rentals = require('./routes/rentals');</font></div><div><font style="font-size: 12pt;">const express = require('express');</font></div><div><font style="font-size: 12pt;">const app = express();</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">mongoose.connect('mongodb://localhost/vidly')</font></div><div><font style="font-size: 12pt;">  .then(() =&gt; console.log('Connected to MongoDB...'))</font></div><div><font style="font-size: 12pt;">  .catch(err =&gt; console.error('Could not connect to MongoDB...'));</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">app.use(express.json());</font></div><div><font style="font-size: 12pt;">app.use('/api/genres', genres);</font></div><div><font style="font-size: 12pt;">app.use('/api/customers', customers);</font></div><div><font style="font-size: 12pt;">app.use('/api/movies', movies);</font></div><div><font style="font-size: 12pt;">app.use('/api/rentals', rentals);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const port = process.env.PORT || 3000;</font></div><div><font style="font-size: 12pt;">app.listen(port, () =&gt; console.log(`Listening on port ${port}...`));</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">models/customer.js</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const Joi = require('joi');</font></div><div><font style="font-size: 12pt;">const mongoose = require('mongoose');</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const Customer = mongoose.model('Customer', new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: {</font></div><div><font style="font-size: 12pt;">    type: String,</font></div><div><font style="font-size: 12pt;">    required: true,</font></div><div><font style="font-size: 12pt;">    minlength: 5,</font></div><div><font style="font-size: 12pt;">    maxlength: 50</font></div><div><font style="font-size: 12pt;">  },</font></div><div><font style="font-size: 12pt;">  isGold: {</font></div><div><font style="font-size: 12pt;">    type: Boolean,</font></div><div><font style="font-size: 12pt;">    default: false</font></div><div><font style="font-size: 12pt;">  },</font></div><div><font style="font-size: 12pt;">  phone: {</font></div><div><font style="font-size: 12pt;">    type: String,</font></div><div><font style="font-size: 12pt;">    required: true,</font></div><div><font style="font-size: 12pt;">    minlength: 5,</font></div><div><font style="font-size: 12pt;">    maxlength: 50</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">}));</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">function validateCustomer(customer) {</font></div><div><font style="font-size: 12pt;">  const schema = {</font></div><div><font style="font-size: 12pt;">    name: Joi.string().min(5).max(50).required(),</font></div><div><font style="font-size: 12pt;">    phone: Joi.string().min(5).max(50).required(),</font></div><div><font style="font-size: 12pt;">    isGold: Joi.boolean()</font></div><div><font style="font-size: 12pt;">  };</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  return Joi.validate(customer, schema);</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">exports.Customer = Customer;</font></div><div><font style="font-size: 12pt;">exports.validate = validateCustomer;</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">models/genre.js</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const Joi = require('joi');</font></div><div><font style="font-size: 12pt;">const mongoose = require('mongoose');</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const genreSchema = new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  name: {</font></div><div><font style="font-size: 12pt;">    type: String,</font></div><div><font style="font-size: 12pt;">    required: true,</font></div><div><font style="font-size: 12pt;">    minlength: 5,</font></div><div><font style="font-size: 12pt;">    maxlength: 50</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">});</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const Genre = mongoose.model('Genre', genreSchema);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">function validateGenre(genre) {</font></div><div><font style="font-size: 12pt;">  const schema = {</font></div><div><font style="font-size: 12pt;">    name: Joi.string().min(3).required()</font></div><div><font style="font-size: 12pt;">  };</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  return Joi.validate(genre, schema);</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">exports.genreSchema = genreSchema;</font></div><div><font style="font-size: 12pt;">exports.Genre = Genre;</font></div><div><font style="font-size: 12pt;">exports.validate = validateGenre;</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">models/movie.js</span></span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const Joi = require('joi');</font></div><div><font style="font-size: 12pt;">const mongoose = require('mongoose');</font></div><div><font style="font-size: 12pt;">const {genreSchema} = require('./genre');</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const Movie = mongoose.model('Movies', new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  title: {</font></div><div><font style="font-size: 12pt;">    type: String,</font></div><div><font style="font-size: 12pt;">    required: true,</font></div><div><font style="font-size: 12pt;">    trim: true,</font></div><div><font style="font-size: 12pt;">    minlength: 5,</font></div><div><font style="font-size: 12pt;">    maxlength: 255</font></div><div><font style="font-size: 12pt;">  },</font></div><div><font style="font-size: 12pt;">  genre: {</font></div><div><font style="font-size: 12pt;">    type: genreSchema,  </font></div><div><font style="font-size: 12pt;">    required: true</font></div><div><font style="font-size: 12pt;">  },</font></div><div><font style="font-size: 12pt;">  numberInStock: {</font></div><div><font style="font-size: 12pt;">    type: Number,</font></div><div><font style="font-size: 12pt;">    required: true,</font></div><div><font style="font-size: 12pt;">    min: 0,</font></div><div><font style="font-size: 12pt;">    max: 255</font></div><div><font style="font-size: 12pt;">  },</font></div><div><font style="font-size: 12pt;">  dailyRentalRate: {</font></div><div><font style="font-size: 12pt;">    type: Number,</font></div><div><font style="font-size: 12pt;">    required: true,</font></div><div><font style="font-size: 12pt;">    min: 0,</font></div><div><font style="font-size: 12pt;">    max: 255</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">}));</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">function validateMovie(movie) {</font></div><div><font style="font-size: 12pt;">  const schema = {</font></div><div><font style="font-size: 12pt;">    title: Joi.string().min(5).max(50).required(),</font></div><div><font style="font-size: 12pt;">    genreId: Joi.string().required(),</font></div><div><font style="font-size: 12pt;">    numberInStock: Joi.number().min(0).required(),</font></div><div><font style="font-size: 12pt;">    dailyRentalRate: Joi.number().min(0).required()</font></div><div><font style="font-size: 12pt;">  };</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  return Joi.validate(movie, schema);</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">exports.Movie = Movie;</font></div><div><font style="font-size: 12pt;">exports.validate = validateMovie;</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">models/rental.js</span></div><div><span style="font-size: 12pt;"><br/></span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const Joi = require('joi');</font></div><div><font style="font-size: 12pt;">const mongoose = require('mongoose');</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">const Rental = mongoose.model('Rental', new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">  customer: {</font></div><div><font style="font-size: 12pt;">    type: new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">      name: {</font></div><div><font style="font-size: 12pt;">        type: String,</font></div><div><font style="font-size: 12pt;">        required: true,</font></div><div><font style="font-size: 12pt;">        minlength: 5,</font></div><div><font style="font-size: 12pt;">        maxlength: 50</font></div><div><font style="font-size: 12pt;">      },</font></div><div><font style="font-size: 12pt;">      isGold: {</font></div><div><font style="font-size: 12pt;">        type: Boolean,</font></div><div><font style="font-size: 12pt;">        default: false</font></div><div><font style="font-size: 12pt;">      },</font></div><div><font style="font-size: 12pt;">      phone: {</font></div><div><font style="font-size: 12pt;">        type: String,</font></div><div><font style="font-size: 12pt;">        required: true,</font></div><div><font style="font-size: 12pt;">        minlength: 5,</font></div><div><font style="font-size: 12pt;">        maxlength: 50</font></div><div><font style="font-size: 12pt;">      }      </font></div><div><font style="font-size: 12pt;">    }),  </font></div><div><font style="font-size: 12pt;">    required: true</font></div><div><font style="font-size: 12pt;">  },</font></div><div><font style="font-size: 12pt;">  movie: {</font></div><div><font style="font-size: 12pt;">    type: new mongoose.Schema({</font></div><div><font style="font-size: 12pt;">      title: {</font></div><div><font style="font-size: 12pt;">        type: String,</font></div><div><font style="font-size: 12pt;">        required: true,</font></div><div><font style="font-size: 12pt;">        trim: true,</font></div><div><font style="font-size: 12pt;">        minlength: 5,</font></div><div><font style="font-size: 12pt;">        maxlength: 255</font></div><div><font style="font-size: 12pt;">      },</font></div><div><font style="font-size: 12pt;">      dailyRentalRate: {</font></div><div><font style="font-size: 12pt;">        type: Number,</font></div><div><font style="font-size: 12pt;">        required: true,</font></div><div><font style="font-size: 12pt;">        min: 0,</font></div><div><font style="font-size: 12pt;">        max: 255</font></div><div><font style="font-size: 12pt;">      }   </font></div><div><font style="font-size: 12pt;">    }),</font></div><div><font style="font-size: 12pt;">    required: true</font></div><div><font style="font-size: 12pt;">  },</font></div><div><font style="font-size: 12pt;">  dateOut: {</font></div><div><font style="font-size: 12pt;">    type: Date,</font></div><div><font style="font-size: 12pt;">    required: true,</font></div><div><font style="font-size: 12pt;">    default: Date.now</font></div><div><font style="font-size: 12pt;">  },</font></div><div><font style="font-size: 12pt;">  dateReturned: {</font></div><div><font style="font-size: 12pt;">    type: Date</font></div><div><font style="font-size: 12pt;">  },</font></div><div><font style="font-size: 12pt;">  rentalFee: {</font></div><div><font style="font-size: 12pt;">    type: Number,</font></div><div><font style="font-size: 12pt;">    min: 0</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">}));</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">function validateRental(rental) {</font></div><div><font style="font-size: 12pt;">  const schema = {</font></div><div><font style="font-size: 12pt;">    customerId: Joi.string().required(),</font></div><div><font style="font-size: 12pt;">    movieId: Joi.string().required()</font></div><div><font style="font-size: 12pt;">  };</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  return Joi.validate(rental, schema);</font></div><div><font style="font-size: 12pt;">}</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">exports.Rental = Rental;</font></div><div><font style="font-size: 12pt;">exports.validate = validateRental;</font></div></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">routes/customer.js</span></font></div><div><font style="font-size: 12pt;"><br/></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const {Customer, validate} = require('../models/customer');</font></div><div><font style="font-size: 12pt;">const mongoose = require('mongoose');</font></div><div><font style="font-size: 12pt;">const express = require('express');</font></div><div><font style="font-size: 12pt;">const router = express.Router();</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.get('/', async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  const customers = await Customer.find().sort('name');</font></div><div><font style="font-size: 12pt;">  res.send(customers);</font></div><div><font style="font-size: 12pt;">});</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.post('/', async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  const { error } = validate(req.body);</font></div><div><font style="font-size: 12pt;">  if (error) return res.status(400).send(error.details[0].message);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  let customer = new Customer({</font></div><div><font style="font-size: 12pt;">    name: req.body.name,</font></div><div><font style="font-size: 12pt;">    isGold: req.body.isGold,</font></div><div><font style="font-size: 12pt;">    phone: req.body.phone</font></div><div><font style="font-size: 12pt;">  });</font></div><div><font style="font-size: 12pt;">  customer = await customer.save();</font></div><div><font style="font-size: 12pt;">  </font></div><div><font style="font-size: 12pt;">  res.send(customer);</font></div><div><font style="font-size: 12pt;">});</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.put('/:id', async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  const { error } = validate(req.body);</font></div><div><font style="font-size: 12pt;">  if (error) return res.status(400).send(error.details[0].message);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  const customer = await Customer.findByIdAndUpdate(req.params.id,</font></div><div><font style="font-size: 12pt;">    {</font></div><div><font style="font-size: 12pt;">      name: req.body.name,</font></div><div><font style="font-size: 12pt;">      isGold: req.body.isGold,</font></div><div><font style="font-size: 12pt;">      phone: req.body.phone</font></div><div><font style="font-size: 12pt;">    }, { new: true });</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  if (!customer) return res.status(404).send('The customer with the given ID was not found.');</font></div><div><font style="font-size: 12pt;">  </font></div><div><font style="font-size: 12pt;">  res.send(customer);</font></div><div><font style="font-size: 12pt;">});</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.delete('/:id', async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  const customer = await Customer.findByIdAndRemove(req.params.id);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  if (!customer) return res.status(404).send('The customer with the given ID was not found.');</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  res.send(customer);</font></div><div><font style="font-size: 12pt;">});</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.get('/:id', async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  const customer = await Customer.findById(req.params.id);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  if (!customer) return res.status(404).send('The customer with the given ID was not found.');</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  res.send(customer);</font></div><div><font style="font-size: 12pt;">});</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">module.exports = router;</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">routes/genres.js</span></div><div><font style="font-size: 12pt;"><br/></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const {Genre, validate} = require('../models/genre');</font></div><div><font style="font-size: 12pt;">const mongoose = require('mongoose');</font></div><div><font style="font-size: 12pt;">const express = require('express');</font></div><div><font style="font-size: 12pt;">const router = express.Router();</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.get('/', async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  const genres = await Genre.find().sort('name');</font></div><div><font style="font-size: 12pt;">  res.send(genres);</font></div><div><font style="font-size: 12pt;">});</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.post('/', async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  const { error } = validate(req.body);</font></div><div><font style="font-size: 12pt;">  if (error) return res.status(400).send(error.details[0].message);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  let genre = new Genre({ name: req.body.name });</font></div><div><font style="font-size: 12pt;">  genre = await genre.save();</font></div><div><font style="font-size: 12pt;">  </font></div><div><font style="font-size: 12pt;">  res.send(genre);</font></div><div><font style="font-size: 12pt;">});</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.put('/:id', async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  const { error } = validate(req.body);</font></div><div><font style="font-size: 12pt;">  if (error) return res.status(400).send(error.details[0].message);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  const genre = await Genre.findByIdAndUpdate(req.params.id, { name: req.body.name }, {</font></div><div><font style="font-size: 12pt;">    new: true</font></div><div><font style="font-size: 12pt;">  });</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  if (!genre) return res.status(404).send('The genre with the given ID was not found.');</font></div><div><font style="font-size: 12pt;">  </font></div><div><font style="font-size: 12pt;">  res.send(genre);</font></div><div><font style="font-size: 12pt;">});</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.delete('/:id', async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  const genre = await Genre.findByIdAndRemove(req.params.id);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  if (!genre) return res.status(404).send('The genre with the given ID was not found.');</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  res.send(genre);</font></div><div><font style="font-size: 12pt;">});</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.get('/:id', async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  const genre = await Genre.findById(req.params.id);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  if (!genre) return res.status(404).send('The genre with the given ID was not found.');</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  res.send(genre);</font></div><div><font style="font-size: 12pt;">});</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">module.exports = router;</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt; font-weight: bold;">routes/movies.js （混合方案）</span></div><div><font style="font-size: 12pt;"><br/></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const {Movie, validate} = require('../models/movie');</font></div><div><font style="font-size: 12pt;">const {Genre} = require('../models/genre');</font></div><div><font style="font-size: 12pt;">const mongoose = require('mongoose');</font></div><div><font style="font-size: 12pt;">const express = require('express');</font></div><div><font style="font-size: 12pt;">const router = express.Router();</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.get('/', async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  const movies = await Movie.find().sort('name');</font></div><div><font style="font-size: 12pt;">  res.send(movies);</font></div><div><font style="font-size: 12pt;">});</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.post('/', async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  const { error } = validate(req.body);</font></div><div><font style="font-size: 12pt;">  if (error) return res.status(400).send(error.details[0].message);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  const genre = await Genre.findById(req.body.genreId);</font></div><div><font style="font-size: 12pt;">  if (!genre) return res.status(400).send('Invalid genre.');</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  let movie = new Movie({</font></div><div><font style="font-size: 12pt;">    title: req.body.title,</font></div><div><font style="font-size: 12pt;">   <b> genre: {</b></font></div><div><font style="font-size: 12pt;"><b>      _id: genre._id,</b></font></div><div><font style="font-size: 12pt;"><b>      name: genre.name</b></font></div><div><font style="font-size: 12pt;"><b>    }</b>,</font></div><div><font style="font-size: 12pt;">    numberInStock: req.body.numberInStock,</font></div><div><font style="font-size: 12pt;">    dailyRentalRate: req.body.dailyRentalRate</font></div><div><font style="font-size: 12pt;">  });</font></div><div><font style="font-size: 12pt;">  movie = await movie.save();</font></div><div><font style="font-size: 12pt;">  </font></div><div><font style="font-size: 12pt;">  res.send(movie);</font></div><div><font style="font-size: 12pt;">});</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.put('/:id', async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  const { error } = validate(req.body);</font></div><div><font style="font-size: 12pt;">  if (error) return res.status(400).send(error.details[0].message);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  const genre = await Genre.findById(req.body.genreId);</font></div><div><font style="font-size: 12pt;">  if (!genre) return res.status(400).send('Invalid genre.');</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  const movie = await Movie.findByIdAndUpdate(req.params.id,</font></div><div><font style="font-size: 12pt;">    {</font></div><div><font style="font-size: 12pt;">      title: req.body.title,</font></div><div><font style="font-size: 12pt;">      genre: {</font></div><div><font style="font-size: 12pt;">        _id: genre._id,</font></div><div><font style="font-size: 12pt;">        name: genre.name</font></div><div><font style="font-size: 12pt;">      },</font></div><div><font style="font-size: 12pt;">      numberInStock: req.body.numberInStock,</font></div><div><font style="font-size: 12pt;">      dailyRentalRate: req.body.dailyRentalRate</font></div><div><font style="font-size: 12pt;">    }, { new: true });</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  if (!movie) return res.status(404).send('The movie with the given ID was not found.');</font></div><div><font style="font-size: 12pt;">  </font></div><div><font style="font-size: 12pt;">  res.send(movie);</font></div><div><font style="font-size: 12pt;">});</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.delete('/:id', async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  const movie = await Movie.findByIdAndRemove(req.params.id);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  if (!movie) return res.status(404).send('The movie with the given ID was not found.');</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  res.send(movie);</font></div><div><font style="font-size: 12pt;">});</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.get('/:id', async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  const movie = await Movie.findById(req.params.id);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  if (!movie) return res.status(404).send('The movie with the given ID was not found.');</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  res.send(movie);</font></div><div><font style="font-size: 12pt;">});</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">module.exports = router;</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><span style="font-size: 12pt; font-weight: bold;">routes/rentals.js</span></span></div><div><font style="font-size: 12pt;"><br/></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">const {Rental, validate} = require('../models/rental');</font></div><div><font style="font-size: 12pt;">const {Movie} = require('../models/movie');</font></div><div><font style="font-size: 12pt;">const {Customer} = require('../models/customer');</font></div><div><font style="font-size: 12pt;">const mongoose = require('mongoose');</font></div><div><font style="font-size: 12pt;">const express = require('express');</font></div><div><font style="font-size: 12pt;">const router = express.Router();</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.get('/', async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  const rentals = await Rental.find().sort('-dateOut');</font></div><div><font style="font-size: 12pt;">  res.send(rentals);</font></div><div><font style="font-size: 12pt;">});</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.post('/', async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  const { error } = validate(req.body);</font></div><div><font style="font-size: 12pt;">  if (error) return res.status(400).send(error.details[0].message);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  const customer = await Customer.findById(req.body.customerId);</font></div><div><font style="font-size: 12pt;">  if (!customer) return res.status(400).send('Invalid customer.');</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  const movie = await Movie.findById(req.body.movieId);</font></div><div><font style="font-size: 12pt;">  if (!movie) return res.status(400).send('Invalid movie.');</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  if (movie.numberInStock === 0) return res.status(400).send('Movie not in stock.');</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  let rental = new Rental({</font></div><div><font style="font-size: 12pt;">    customer: {</font></div><div><font style="font-size: 12pt;">      _id: customer._id,</font></div><div><font style="font-size: 12pt;">      name: customer.name,</font></div><div><font style="font-size: 12pt;">      phone: customer.phone</font></div><div><font style="font-size: 12pt;">    },</font></div><div><font style="font-size: 12pt;">    movie: {</font></div><div><font style="font-size: 12pt;">      _id: movie._id,</font></div><div><font style="font-size: 12pt;">      title: movie.title,</font></div><div><font style="font-size: 12pt;">      dailyRentalRate: movie.dailyRentalRate</font></div><div><font style="font-size: 12pt;">    }</font></div><div><font style="font-size: 12pt;">  });</font></div><div><font style="font-size: 12pt;">  rental = await rental.save();</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  movie.numberInStock--;</font></div><div><font style="font-size: 12pt;">  movie.save();</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  res.send(rental);</font></div><div><font style="font-size: 12pt;">});</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">router.get('/:id', async (req, res) =&gt; {</font></div><div><font style="font-size: 12pt;">  const rental = await Rental.findById(req.params.id);</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  if (!rental) return res.status(404).send('The rental with the given ID was not found.');</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">  res.send(rental);</font></div><div><font style="font-size: 12pt;">});</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">module.exports = router;</font></div></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 12pt;"><br/></span></div><div><br/></div></div><hr/><div><br/></div><div><br/></div><div><br/></div></div><hr/><div><br/></div></div><hr/><div><br/></div></div><hr/><div><br/></div></div><hr/><div><br/></div></div><div><br/></div></span>
</div></body></html> 