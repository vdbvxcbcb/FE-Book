<html>
<head>
  <title>欲善其事，必利其器 - 论如何善用ServiceWorker || 陈YFの博客(￣▽￣)"</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/606060 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="6469"/>
<h1>欲善其事，必利其器 - 论如何善用ServiceWorker || 陈YFの博客(￣▽￣)"</h1>

<div><span>
  <div style="--en-clipped-content:article; --en-clipped-source-url:https://blog.cyfan.top/p/c0af86bb.html; --en-clipped-source-title:欲善其事，必利其器 - 论如何善用ServiceWorker || 陈YFの博客(￣▽￣)&quot;;">
<div><br/></div><div style="min-height: 25255px; font-size: 16px; display: block; min-width: 100%; position: relative;"> <div style="box-sizing:border-box;line-height:1.15;text-size-adjust:100%;-webkit-tap-highlight-color:transparent;font-size:16px;font-family:&quot;SF Pro SC&quot;, &quot;SF Pro Text&quot;, &quot;SF Pro Icons&quot;, &quot;PingFang SC&quot;, &quot;Lantinghei SC&quot;, &quot;Microsoft Yahei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Sans Serif&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;overflow-wrap:break-word;"><div style="box-sizing:border-box;font-weight:400;line-height:1.5;text-align:left;font-family:&quot;SF Pro SC&quot;, &quot;SF Pro Text&quot;, &quot;SF Pro Icons&quot;, &quot;PingFang SC&quot;, &quot;Lantinghei SC&quot;, &quot;Microsoft Yahei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Sans Serif&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;font-size:16px;overflow-wrap:break-word;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;color:rgb(60, 72, 88);background-color:rgb(248, 248, 248);"><span style="box-sizing:border-box;"><div style="box-sizing:border-box;"><div style="box-sizing:border-box;"><div style="box-sizing:border-box;"><div style="box-sizing:border-box;"><div style="box-sizing:border-box;background-color:rgb(255, 255, 255);transition:background-color 0.2s ease-in-out 0s;border-radius:8px;box-shadow:rgba(0, 0, 0, 0.24) 0px 12px 15px 0px, rgba(0, 0, 0, 0.19) 0px 17px 50px 0px;"><div style="box-sizing:border-box;"><div style="box-sizing:border-box;text-size-adjust:100%;line-height:1.5;overflow-wrap:break-word;color:rgb(44, 62, 80);font-family:&quot;SF Pro SC&quot;, &quot;SF Pro Text&quot;, &quot;SF Pro Icons&quot;, &quot;PingFang SC&quot;, &quot;Lantinghei SC&quot;, &quot;Microsoft Yahei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Sans Serif&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;font-size:16px;"><p style="box-sizing:border-box;margin-bottom:16px;margin-top:0px;">ServiceWorker作为前端革命领袖，毫不夸张地被誉为前端黑科技，此文将阐述如何巧妙的使用它来实现一些看起来匪夷所思的事情。</p><a style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:inherit;"></a><blockquote style="box-sizing:border-box;margin:0px;margin-top:0px;margin-bottom:16px;padding:0px 1em;border-left:0.25em solid rgb(223, 226, 229);color:rgb(113, 128, 150);"><p style="box-sizing:border-box;margin-top:0px;margin-bottom:0px;"><strong style="box-sizing:border-box;font-weight:700;">Warning</strong><br style="box-sizing:border-box;"/>此文为最基本的SW使用基础,如果你只是想来白嫖代码的建议退出选择下一篇实操文章.</p></blockquote><h1 style="margin:0.67em 0px;box-sizing:border-box;line-height:1.25;font-size:2em;padding-bottom:0.3em;border-bottom:1px solid rgb(234, 236, 239);color:rgb(26, 32, 44);font-weight:700;margin-top:2em;margin-bottom:0.75em;"><a href="https://blog.cyfan.top/p/c0af86bb.html#%E8%B5%B7%E5%9B%A0-%E5%B7%A8%E5%8E%A6%E5%9D%8D%E5%A1%8C" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="起因 - 巨厦坍塌"></a>起因 - 巨厦坍塌</h1><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">2021/12/20日，赶在旧年的末尾，一则<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">JSdelivrSSL证书错误</code>缓缓上了v2ex论坛热点。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">此前JSD由于各种原因,曾经不正常了一段时间,所以大家并未对此感冒.正当人们以为这只是JSdelivr每年一度的<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">年经</code>阵痛,发个issue,过一段时间就好了的时候.官方直接爆出大料:<strong style="box-sizing:border-box;font-weight:700;">JSDelivr had lost their ICP license</strong></p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">由此可见,过去的几年里,当人们发现JSD对个人面向国内加速拥有者无与伦比的效果时,各种滥用方式层出不穷:图床曾一阵流行,国内搜索引擎JSdelivr十有八九都是作为图床的,连PicGo插件都出了Github+JSdelivr图床;猛一点的,直接做视频床,甚至为了突破单文件20M限制开发了一套ts切片m3u8一条龙服务;作妖的,托管了不少突破网络审查的脚本和规则集;寻死的,添加了大量的政治宗教敏感,有些甚至不配称为宗教,直接上来就是骗钱的.</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">jsd并不是没有发布许可条款，但这并不能阻止白嫖大军的进程。在羊毛大军中，只要是你是免费的、公益的，你就要做好被薅爆的结果。但是薅羊毛的前提是羊还活着，倘若羊被薅死了，哪来的羊毛给诸君所薅？</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">总之，不管怎样，JSDelivr在决定将节点设置为<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">NearChina</code>，可以肯定的是，在最近很长一段时间内，我们都无法享受国内外双料同时加速的快感，换句话说，jsd在中国就被永久地打入了冷宫。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">视线转向国内，jsd的替代品并不少。早在我写<a href="https://blog.cyfan.top/p/eb490c73.html" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);">图床的千层套路</a>我就试着假想jsd不可用时，我们该用什么。最终我给出的一份较为完美的答案-npm图床，优点无非就是镜像多速度快，许可条款较为宽松，缺点也很明显，需要安装node，用专门的客户端上传。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">那事情就逐渐变得扑朔迷离起来了，我们应当如何选择合理的CDN加速器呢。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">这时候，我想起了前端黑科技Serviceworker。是的，这种情况下使用SW最为巧妙不过，它可以在后台自动优选最佳的CDN，甚至可以用黑中黑<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">Promise.any</code>打出一套漂亮的并行拳。经过两天的完善，我终于写出了一套具有离线可达、绕备、优选CDN、跟踪统计合一的SW脚本。<a href="https://blog.cyfan.top/sw.js" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);">此博客使用的SW</a></p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">接下来我将从头开始讲述ServiceWorker的妙用。</p><h1 style="margin:0.67em 0px;box-sizing:border-box;line-height:1.25;font-size:2em;padding-bottom:0.3em;border-bottom:1px solid rgb(234, 236, 239);color:rgb(26, 32, 44);font-weight:700;margin-top:2em;margin-bottom:0.75em;"><a href="https://blog.cyfan.top/p/c0af86bb.html#Before-Start" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="Before Start"></a>Before Start</h1><h2 style="box-sizing:border-box;line-height:1.25;padding-bottom:0.3em;border-bottom:1px solid rgb(234, 236, 239);font-size:1.5em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/c0af86bb.html#What-Is-The-ServiceWorker" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="What Is The ServiceWorker"></a>What Is The ServiceWorker</h2><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">网上对于SW的解释比较模糊，在这里，我将其定义为<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">用户浏览器里的服务器</code>，功能强大到令人发指。是的，接下来的两张图你应该能显著的看到这一差距：</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;"><a href="https://npm.elemecdn.com/chenyfan-os@0.0.0-r5/1.jpg" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);"><a href="欲善其事，必利其器 - 论如何善用ServiceWorker  陈YFの博客(￣▽￣)_files/1.jpg"><img src="欲善其事，必利其器 - 论如何善用ServiceWorker  陈YFの博客(￣▽￣)_files/755e936c59d30e74cc18cea349834ac2.png" alt="1.jpg"></a></a></p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;"><a href="https://npm.elemecdn.com/chenyfan-os@0.0.0-r5/2.jpg" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);"><a href="欲善其事，必利其器 - 论如何善用ServiceWorker  陈YFの博客(￣▽￣)_files/2.jpg"><img src="欲善其事，必利其器 - 论如何善用ServiceWorker  陈YFの博客(￣▽￣)_files/bb69481d6625451b86f80bebb374e20a.png" alt="2.jpg"></a></a></p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">在第一张图中，用户和服务器的关系直的就像电线杆，用户想要什么，服务器就还给他什么。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">第二张图中，用户在被ServiceWorker控制的页面中，无论向哪个服务器发起请求，其过程都会被SW捕获，SW可以仿佛不存在一般单纯地请求服务器，返回原本应该返回的内容【透明代理】；也可以对当前服务器返回的内容进行随意的捏造、修改【请求修改结果】；甚至可以将请求指向完全另一台服务器，返回不是此服务器应该返回的内容【移花接木】；当然，SW也可以直接返回已经存储在本地的文件，甚至离线的时候也能返回【离线访问可达性】。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">由于SW对于用户页面的操纵实在过于强大，因此，它被设计成<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">不可跨域请求</code>、<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">SW脚本必须在同一域名下</code>、<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">必须在HTTPS条件下运行</code>、<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">不可操纵DOM和BOM</code>，同样的，为了避免阻塞和延迟，SW也被特意设计成<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">完全异步的</code>。这些点将会在后面一一讲述。</p><blockquote style="box-sizing:border-box;margin:0px;margin-top:0px;margin-bottom:16px;padding:0px 1em;border-left:0.25em solid rgb(223, 226, 229);color:rgb(113, 128, 150);"><p style="box-sizing:border-box;margin-top:0px;margin-bottom:0px;">当然，开发者至上，为了方便本地调试，本机地址<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">localhost</code>和<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">127.0.0.1</code>被浏览器所信任，允许以<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">非HTTPS</code>方式运行serviceworker。</p></blockquote><h2 style="box-sizing:border-box;line-height:1.25;padding-bottom:0.3em;border-bottom:1px solid rgb(234, 236, 239);font-size:1.5em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/c0af86bb.html#What-Relationship-Between-ServiceWorker-and-PWA" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="What Relationship Between ServiceWorker and PWA"></a>What Relationship Between ServiceWorker and PWA</h2><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">很多人看到sw，第一反应是PWA，即渐进式Web应用。实际上，SW确实是PWA的核心与灵魂，但SW在PWA中起的主要作用是缓存文件，提供给离线访问。并没有完整地发挥出SW的巧妙用法。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">SW可以完全脱离PWA存在，当然，PWA可离不开SW ：）</p><h2 style="box-sizing:border-box;line-height:1.25;padding-bottom:0.3em;border-bottom:1px solid rgb(234, 236, 239);font-size:1.5em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/c0af86bb.html#And-WorkBox" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="And WorkBox ?"></a>And WorkBox ?</h2><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">WorkBox是谷歌开发的一款基于SW的缓存控制器，其主要目的是方便维护PWA。核心依旧是SW，但还是没有SW原本的自定义程度高（</p><h2 style="box-sizing:border-box;line-height:1.25;padding-bottom:0.3em;border-bottom:1px solid rgb(234, 236, 239);font-size:1.5em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/c0af86bb.html#Why-Not-WorkBox" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="Why Not WorkBox ?"></a>Why Not WorkBox ?</h2><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">首先，博客呢，是没有必要用PWA，有SW做中间件足矣。同时，WorkBox只能简单的缓存数据，并不能做到拦截篡改请求的功能，尤其不能精准把握每一个资源的缓存情况，自定义程度并不高。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;"><del style="box-sizing:border-box;">自己编写SW，格局就打开了</del></p><h1 style="margin:0.67em 0px;box-sizing:border-box;line-height:1.25;font-size:2em;padding-bottom:0.3em;border-bottom:1px solid rgb(234, 236, 239);color:rgb(26, 32, 44);font-weight:700;margin-top:2em;margin-bottom:0.75em;"><a href="https://blog.cyfan.top/p/c0af86bb.html#Start-From-Zero" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="Start From Zero"></a>Start From Zero</h1><h2 style="box-sizing:border-box;line-height:1.25;padding-bottom:0.3em;border-bottom:1px solid rgb(234, 236, 239);font-size:1.5em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/c0af86bb.html#%E5%AE%89%E8%A3%85-Install" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="安装 / Install"></a>安装 / Install</h2><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">首先，SW的本质是JS脚本，要安装它必须要经过一个html。毕竟，只有拿到了html，JS才能运行于DOM上下文。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">剥离层层加成，安装的代码只有一行</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;">navigator.serviceWorker.register(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'/sw.js'</span>)</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">其中，<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">/sw.js</code>即为ServiceWorker脚本所在，由于安全性，你不能加载跨域的SW。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">例如，当前网页为<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">https://blog.cyfan.top</code>，以下加载位置是允许的</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;">/sw.js
https://blog.cyfan.top/sw.js</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">以下加载是不允许的:</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;">http://blog.cyfan.top/sw.js#非HTTPS
https://cyfan.top/sw.js#非同一域名，视为跨域
https://119.91.80.151:59996/sw.js#虽然为同一文件,但非同一域名，视为跨域
./sw.js#容易造成SW脚本获取路径不一致</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">在加载前，我们最好判断一下dom是否加载完了，不然安装sw可能会卡dom</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">加载完成后，register函数将返回一个<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">Promise</code>，由于前端大多不适用于<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">异步</code>，我们通常以<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">同步</code>的方式<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">.then()</code>和<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">.catch()</code>来获取是否加载成功。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">为了方便判断脚本是否能够加载，我们还要判断navigator里有无sw这一属性<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">'serviceWorker' in navigator</code>。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">由于SW安装后，页面需要刷新后才能交给SW所宰割，同时为了避免浏览器缓存的影响，我通常采用修改<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">search</code>的方式强刷新，而不是通过<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">reload</code>函数。同样的，为了避免刚安装完就刷新的尴尬感，建议用<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">setTimeout</code>延迟一秒刷新。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">简易的完整安装代码如下:</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(155, 155, 155);">&lt;<span style="box-sizing:border-box;color:rgb(86, 156, 214);">script</span>&gt;</span><span style="box-sizing:border-box;">
<span style="box-sizing:border-box;color:rgb(78, 201, 176);">window</span>.addEventListener(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'load'</span>, <span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span> () =&gt; {
    navigator.serviceWorker.register(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">`/sw.js?time=<span style="box-sizing:border-box;color:rgb(220, 220, 220);">${<span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> <span style="box-sizing:border-box;color:rgb(78, 201, 176);">Date</span>().getTime()}</span>`</span>)
        .then(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span> reg =&gt; {
            <span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//安装成功，建议此处强刷新以立刻执行SW</span>
            <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (<span style="box-sizing:border-box;color:rgb(78, 201, 176);">window</span>.localStorage.getItem(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'install'</span>) != <span style="box-sizing:border-box;color:rgb(214, 157, 133);">'true'</span>) {
                <span style="box-sizing:border-box;color:rgb(78, 201, 176);">window</span>.localStorage.setItem(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'install'</span>, <span style="box-sizing:border-box;color:rgb(214, 157, 133);">'true'</span>);
                setTimeout(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">()</span> =&gt;</span> {
                    <span style="box-sizing:border-box;color:rgb(78, 201, 176);">window</span>.location.search = <span style="box-sizing:border-box;color:rgb(214, 157, 133);">`?time=<span style="box-sizing:border-box;color:rgb(220, 220, 220);">${<span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> <span style="box-sizing:border-box;color:rgb(78, 201, 176);">Date</span>().getTime()}</span>`</span>
                }, <span style="box-sizing:border-box;color:rgb(184, 215, 163);">1000</span>)
            }
        }).catch(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">err</span> =&gt;</span> {
            <span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//安装失败，错误信息会由err传参</span>
        })
});
</span><span style="box-sizing:border-box;color:rgb(155, 155, 155);">&lt;/<span style="box-sizing:border-box;color:rgb(86, 156, 214);">script</span>&gt;</span></code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">一刷新，世界就变成了ServiceWorker的瓮中之鳖，接下来，该是SW脚本正式登场的时候了。</p><h2 style="box-sizing:border-box;line-height:1.25;padding-bottom:0.3em;border-bottom:1px solid rgb(234, 236, 239);font-size:1.5em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/c0af86bb.html#SW%E5%AE%89%E8%A3%85%E5%88%9D%E5%A7%8B%E5%8C%96-Installations" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="SW安装初始化 / Installations"></a>SW安装初始化 / Installations</h2><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">首先，先尴尬的开一个空缓存列表：</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> CACHE_NAME = <span style="box-sizing:border-box;color:rgb(214, 157, 133);">'ICDNCache'</span>;<span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//可以为Cache版本号，但这样可能会导致缓存冗余累积</span>
<span style="box-sizing:border-box;color:rgb(86, 156, 214);">let</span> cachelist = [];</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;"><code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">cachelist</code>里面填写的是预缓存网址，例如在离线时返回的错误页面。此处不宜添加过多网址，此处点名@一下Akilar。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">此处我建议只缓存离线页面展示的内容:</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">let</span> cachelist = [
    <span style="box-sizing:border-box;color:rgb(214, 157, 133);">'/offline.html'</span>,
    <span style="box-sizing:border-box;color:rgb(214, 157, 133);">'https://npm.elemecdn.com/chenyfan-os@0.0.0-r6'</span>
];</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">同时监听sw安装时开启此缓存空间：</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;">self.addEventListener(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'install'</span>, <span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span> <span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">function</span> (<span style="box-sizing:border-box;color:rgb(220, 220, 220);">installEvent</span>) </span>{
    self.skipWaiting();
    installEvent.waitUntil(
        caches.open(CACHE_NAME)
            .then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">function</span> (<span style="box-sizing:border-box;color:rgb(220, 220, 220);">cache</span>) </span>{
                <span style="box-sizing:border-box;color:rgb(78, 201, 176);">console</span>.log(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'Opened cache'</span>);
                <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> cache.addAll(cachelist);
            })
    );
});</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">由于SW完全没有办法访问DOM，因此对于全局变量，不应当用<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">window</code>，而是<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">self</code>指代自己。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;"><code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">addEventListener</code>这一监听器将监听<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">install</code>,也就是这一段代码只会在脚本首次安装和更新时运行.</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;"><code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">skipWaiting</code>的作用是促进新版本sw跳过waiting这一阶段，直接active。</p><blockquote style="box-sizing:border-box;margin:0px;margin-top:0px;margin-bottom:16px;padding:0px 1em;border-left:0.25em solid rgb(223, 226, 229);color:rgb(113, 128, 150);"><p style="box-sizing:border-box;margin-top:0px;margin-bottom:0px;">关于SW的状态（waiting，installing，activing）将在文后详细解释。</p></blockquote><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;"><code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">installEvent.waitUntil</code>的作用是直接结束安装过程的等待，待会在后台完成开启缓存空间这一操作。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;"><code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">cache.addAll</code>将会直接获取<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">cachelist</code>里面所有的网址并直接缓存到CacheStorage。如果此处网址过多，将在页面加载时疯狂请求所有的url<del style="box-sizing:border-box;">(例如1k个)</del></p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">现在，SW初始化已经完成了。接下来，我将讲述SW如何捕获页面的请求。</p><h2 style="box-sizing:border-box;line-height:1.25;padding-bottom:0.3em;border-bottom:1px solid rgb(234, 236, 239);font-size:1.5em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/c0af86bb.html#%E6%8D%95%E8%8E%B7%E8%AF%B7%E6%B1%82-Fetch-Event" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="捕获请求 / Fetch Event"></a>捕获请求 / Fetch Event</h2><h3 style="box-sizing:border-box;line-height:1.25;font-size:1.25em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/c0af86bb.html#%E6%B7%BB%E5%8A%A0%E7%9B%91%E5%90%AC%E5%99%A8-AddEventListener" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="添加监听器 / AddEventListener"></a>添加监听器 / AddEventListener</h3><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;">self.addEventListener(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'fetch'</span>, <span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span> event =&gt; {
    event.respondWith(handle(event.request))
});

<span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> handle = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span>(req)=&gt;{
    <span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//do something</span>
}</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">第一行很简单，绑定一个监听器，监听<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">fetch</code>事件，即网页向服务器获取请求，也就是相当于前端的<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">XMLHTTPRequest</code></p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;"><code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">event.respondWith</code>即设定返回内容，交给<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">handle</code>主函数处理，传参<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">event.request</code>。这是一个<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">Request</code>对象，里面包含了请求的详细信息。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">接下来，我们开始实战吧。</p><blockquote style="box-sizing:border-box;margin:0px;margin-top:0px;margin-bottom:16px;padding:0px 1em;border-left:0.25em solid rgb(223, 226, 229);color:rgb(113, 128, 150);"><p style="box-sizing:border-box;margin-top:0px;margin-bottom:0px;">以下所有内容均针对handle修改</p></blockquote><h3 style="box-sizing:border-box;line-height:1.25;font-size:1.25em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/c0af86bb.html#%E9%80%8F%E6%98%8E%E4%BB%A3%E7%90%86-Transparent-Proxy" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="透明代理 / Transparent Proxy"></a>透明代理 / Transparent Proxy</h3><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">顾名思义，此实战脚本的作用是SW代理目前的所有流量但不进行修改，仿佛SW不存在一般。</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> handle = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span>(req)=&gt;{
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> fetch(req)
}</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;"><code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">fetch</code>这个函数相当于前端的<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">ajax</code>或者<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">XMLHTTPRequest</code>，作用是发起一个请求，获得一个返回值。由于sw不可访问<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">window</code>，在sw中是无法使用<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">ajax</code>或<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">XMLHTTPRequest</code>。同时，<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">fetch</code>是一个异步函数，直接调用它会返回一个<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">Promise</code>。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;"><code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">fetch</code>只能传递<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">Requset</code>对象,而<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">Requset</code>对象有两个参数<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">(url,[option])</code>,第一个参数是网址,第二个参数为<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">Request</code>的内容,例如<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">body</code>或<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">header</code>。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">此脚本适用于卸载<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">ServiceWorker</code>的替换脚本。因为sw在无法拉取新版本时不会主动卸载，依旧保持运行，填入一个透明代理sw即可。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">由于SW冷启动【即页面关闭后SW】处于暂停状态是从硬盘读取的，这会导致第一次请求有少许性能延迟[~10ms]。</p><h3 style="box-sizing:border-box;line-height:1.25;font-size:1.25em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/c0af86bb.html#%E7%AF%A1%E6%94%B9%E8%AF%B7%E6%B1%82-Edit-Requset" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="篡改请求 / Edit Requset"></a>篡改请求 / Edit Requset</h3><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">对于一张图片，有时候服务端会变态到让你必须用<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">POST</code>协议才能获得，此时用SW篡改最为方便。</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> handle = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span> (req) =&gt; {
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> ((req.url.split(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'/'</span>))[<span style="box-sizing:border-box;color:rgb(184, 215, 163);">2</span>].match(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'xxx.com'</span>)) {
        <span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//xxx.com为图片所在域名</span>
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> fetch(req.url, {
            <span style="box-sizing:border-box;color:rgb(156, 220, 254);">method</span>: <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;POST&quot;</span>
        })
    }
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> fetch(req)
}</code></pre></div><blockquote style="box-sizing:border-box;margin:0px;margin-top:0px;margin-bottom:16px;padding:0px 1em;border-left:0.25em solid rgb(223, 226, 229);color:rgb(113, 128, 150);"><p style="box-sizing:border-box;margin-top:0px;margin-bottom:0px;">注意，在ServiceWorker里面，header头是不能修改refferer和origin的，因此此方法无法绕开新浪图床反盗链</p></blockquote><h3 style="box-sizing:border-box;line-height:1.25;font-size:1.25em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/c0af86bb.html#%E7%AF%A1%E6%94%B9%E5%93%8D%E5%BA%94-Edit-Response" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="篡改响应 / Edit Response"></a>篡改响应 / Edit Response</h3><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">这个例子会检测返回内容，若为html，将把所有的”TEST”都替换成”SHIT”</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> handle = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span> (req) =&gt; {
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> res = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">await</span> fetch(req)
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> resp = res.clone()
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (!!resp.headers.get(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'content-type'</span>)) {
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (resp.headers.get(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'content-type'</span>).includes(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'text/html'</span>)) {
            <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> Response((<span style="box-sizing:border-box;color:rgb(86, 156, 214);">await</span> resp.text()).replace(<span style="box-sizing:border-box;color:rgb(154, 83, 52);">/TEST/g</span>, <span style="box-sizing:border-box;color:rgb(214, 157, 133);">'SHIT'</span>), {
                <span style="box-sizing:border-box;color:rgb(156, 220, 254);">headers</span>: resp.headers,
                <span style="box-sizing:border-box;color:rgb(156, 220, 254);">status</span>: resp.status
            })
        }
    }
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> resp
}</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;"><code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">const resp = res.clone()</code>由于<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">Response</code>的<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">body</code>一旦被读取，这个<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">body</code>就会被锁死，再也无法读取。<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">clone()</code>能够创造出响应的副本用于处理。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;"><code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">resp.headers.get('content-type')</code>通过读取响应的头，判断是否包含<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">text/html</code>，如果是，将响应以<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">text()</code>异步流的方式读取，然后正则替换掉响应内容，并还原头和响应Code。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">返回的内容必须是<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">Response</code>对象，所以<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">new Response</code>构建一个新对象，并直接返回。不匹配html头将直接原封不动地透明代理。</p><h3 style="box-sizing:border-box;line-height:1.25;font-size:1.25em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/c0af86bb.html#%E7%A7%BB%E8%8A%B1%E6%8E%A5%E6%9C%A8-Graft-Request-To-Another-Server" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="移花接木 / Graft Request To Another Server"></a>移花接木 / Graft Request To Another Server</h3><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;"><code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">unpkg.zhimg.com</code>是<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">unpkg.com</code>的镜像网站。此脚本将会把所有的<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">unpkg.com</code>流量直接拦截到<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">unpkg.zhimg.com</code>，用于中国大陆内CDN加速。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">由于npm镜像固定为GET请求方式并且没有其他鉴权需求，所以我们没有必要还原<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">Request</code>其他数据。</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> handle = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span> (req) =&gt; {
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> domain = req.url.split(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'/'</span>)[<span style="box-sizing:border-box;color:rgb(184, 215, 163);">2</span>];
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (domain.match(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;unpkg.com&quot;</span>)) {
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> fetch(req.url.replace(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;https://unpkg.com&quot;</span>, <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;https://zhimg.unpkg.com&quot;</span>));
    }
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">else</span> {
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> fetch(req)
    }
}</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;"><code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">domain.match</code>捕获请求中是否有待替换域名，检查出来后直接<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">replace</code>掉域名，如果没有匹配到，直接透明代理走掉。</p><h3 style="box-sizing:border-box;line-height:1.25;font-size:1.25em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/c0af86bb.html#%E5%B9%B6%E8%A1%8C%E8%AF%B7%E6%B1%82-Request-Parallelly" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="并行请求 / Request Parallelly"></a>并行请求 / Request Parallelly</h3><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">SW中又一大黑科技隆重登场=&gt;<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">Promise.any</code>，这个函数拥有另外两个衍生兄弟<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">Promise.all</code>&amp;<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">Promise.race</code>。下面我将简单介绍这三种方式</p><h4 style="box-sizing:border-box;line-height:1.25;font-size:1em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/c0af86bb.html#Promose-all" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="Promose.all"></a>Promose.all</h4><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">当列表中所有的<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">Promise</code>都<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">resolve</code>[即成功]后，这个函数才会返回<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">resolve</code>，只要有一个返回<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">reject</code>，整个函数都会<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">reject</code>。</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(78, 201, 176);">Promise</span>.all([
    fetch(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'https://unpkg.com/jquery'</span>),
    fetch(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'https://cdn.jsdelivr.net/npm/jquery'</span>),
    fetch(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'https://unpkg.zhimg.com/jquery'</span>)
])</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">这个函数将会请求三个网址，当每一个网址都链接联通后，整个函数将会返回一个列表：</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;">[Response1,Response2,Response3]</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">当任何一个<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">fetch</code>失败[即<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">reject</code>]后，整个<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">Promise.all</code>函数都会直接<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">reject</code>并报错。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">此函数可以检测网络连通性，由于采取并行处理，相比以前的循环效率要高不少。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">这是一段检测国内国外网络连通性的测试。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">没有采用<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">Promise.all</code>的代码和效果：</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> test = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span> () =&gt; {
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> url = [
        
        <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;https://cdn.jsdelivr.net/npm/jquery@3.6.0/package.json&quot;</span>,
        <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;https://unpkg.com/jquery@3.6.0/package.json&quot;</span>,
        <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;https://unpkg.zhimg.com/jquery@3.6.0/package.json&quot;</span>
    ]
    flag = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">true</span>
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">for</span> (<span style="box-sizing:border-box;color:rgb(86, 156, 214);">var</span> i <span style="box-sizing:border-box;color:rgb(86, 156, 214);">in</span> url) {
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">try</span> {
            <span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> res = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">await</span> fetch(url[i])
            <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (res.status !== <span style="box-sizing:border-box;color:rgb(184, 215, 163);">200</span>) {
                flag = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">false</span>
            }
        }<span style="box-sizing:border-box;color:rgb(86, 156, 214);">catch</span>(n){
            <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> <span style="box-sizing:border-box;color:rgb(86, 156, 214);">false</span>
        }
    }
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> flag
}</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;"><a href="https://npm.elemecdn.com/chenyfan-os@0.0.0-r7/1.png" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);"><img src="欲善其事，必利其器 - 论如何善用ServiceWorker  陈YFの博客(￣▽￣)_files/1.png" type="image/png" data-filename="1.png" height="176" style="vertical-align:middle;margin:0px auto;border-style:none;background-color:rgb(255, 255, 255);box-sizing:initial;object-fit:cover;max-width:90%;box-shadow:rgba(0, 0, 0, 0.18) 0px 5px 11px 0px, rgba(0, 0, 0, 0.15) 0px 4px 15px 0px;border-radius:3px;" width="696"/></a></p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">采用循环，<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">await</code>会堵塞循环，直到这次请求完成后才能执行下一个。如果有任何一个url长时间无法联通，将会导致极长的检测时间浪费。</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;">
<span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> test = <span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">()</span> =&gt;</span> {
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> url = [
        <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;https://cdn.jsdelivr.net/npm/jquery@3.6.0/package.json&quot;</span>,
        <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;https://unpkg.com/jquery@3.6.0/package.json&quot;</span>,
        <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;https://unpkg.zhimg.com/jquery@3.6.0/package.json&quot;</span>
    ]
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> <span style="box-sizing:border-box;color:rgb(78, 201, 176);">Promise</span>.all(url.map(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">url</span> =&gt;</span> {
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> <span style="box-sizing:border-box;color:rgb(78, 201, 176);">Promise</span>(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">resolve, reject</span>) =&gt;</span> {
            fetch(url)
                .then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">res</span> =&gt;</span> {
                    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (res.status == <span style="box-sizing:border-box;color:rgb(184, 215, 163);">200</span>) {
                        resolve(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">true</span>)
                    } <span style="box-sizing:border-box;color:rgb(86, 156, 214);">else</span> {

                        reject(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">false</span>)
                    }
                })
                .catch(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">err</span> =&gt;</span> {
                    reject(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">false</span>)
                })
        })

    }
    )).then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">res</span> =&gt;</span> {
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> <span style="box-sizing:border-box;color:rgb(86, 156, 214);">true</span>
    }).catch(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">err</span> =&gt;</span> {
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> <span style="box-sizing:border-box;color:rgb(86, 156, 214);">false</span>
    })
}</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;"><a href="https://npm.elemecdn.com/chenyfan-os@0.0.0-r7/2.png" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);"><img src="欲善其事，必利其器 - 论如何善用ServiceWorker  陈YFの博客(￣▽￣)_files/loading.gif" type="image/gif" data-filename="loading.gif" height="420" style="vertical-align:middle;margin:0px auto;border-style:none;background-color:rgb(255, 255, 255);box-sizing:initial;object-fit:cover;max-width:90%;box-shadow:rgba(0, 0, 0, 0.18) 0px 5px 11px 0px, rgba(0, 0, 0, 0.15) 0px 4px 15px 0px;border-radius:3px;" width="560"/></a></p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;"><code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">Promise.all</code>几乎在一瞬间请求所有的url，其请求时并行，每一个请求并不会堵塞其他请求，函数总耗时为最长请求耗时。</p><h4 style="box-sizing:border-box;line-height:1.25;font-size:1em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/c0af86bb.html#Promise-race" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="Promise.race"></a>Promise.race</h4><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">此函数也是并行执行，不过与all不同的是，只要有任何一个函数完成，就立刻返回，无论其是否<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">reject</code>或者<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">resolve</code>。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">这个函数比较适合用于同时请求一些不关心结果，只要访问达到了即可，例如统计、签到等应用场景。</p><h4 style="box-sizing:border-box;line-height:1.25;font-size:1em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/c0af86bb.html#Promise-any" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="Promise.any"></a>Promise.any</h4><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">这个函数非常的有用，其作用和<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">race</code>接近，不过与之不同的是，<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">any</code>会同时检测结果是否<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">resolve</code>。其并行处理后，只要有任何一个返回正确，就直接返回哪个最快的请求结果，返回错误的直接忽视，除非所有的请求都失败了，才会返回<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">reject</code></p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">这是一段同时请求<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">jquery</code>的<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">package.json</code>代码，它将从四个镜像同时请求：</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> get_json = <span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">()</span> =&gt;</span> {
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> <span style="box-sizing:border-box;color:rgb(78, 201, 176);">Promise</span>(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">resolve, reject</span>) =&gt;</span> {
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> urllist = [
            <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;https://cdn.jsdelivr.net/npm/jquery@3.6.0/package.json&quot;</span>,
            <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;https://unpkg.com/jquery@3.6.0/package.json&quot;</span>,
            <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;https://unpkg.zhimg.com/jquery@3.6.0/package.json&quot;</span>,
            <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;https://npm.elemecdn.com/jquery@3.6.0/package.json&quot;</span>
        ]
        <span style="box-sizing:border-box;color:rgb(78, 201, 176);">Promise</span>.any(urllist.map(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">url</span> =&gt;</span> {
            fetch(url)
                .then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">res</span> =&gt;</span> {
                    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (res.status == <span style="box-sizing:border-box;color:rgb(184, 215, 163);">200</span>) {
                        resolve(res)
                    } <span style="box-sizing:border-box;color:rgb(86, 156, 214);">else</span> {
                        reject()
                    }
                }).catch(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">err</span> =&gt;</span> {
                    reject()
                })
        }))
    })
}

<span style="box-sizing:border-box;color:rgb(78, 201, 176);">console</span>.log(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">await</span>(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">await</span> get_json()).text())</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;"><a href="https://npm.elemecdn.com/chenyfan-os@0.0.0-r7/3.png" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);"><img src="欲善其事，必利其器 - 论如何善用ServiceWorker  陈YFの博客(￣▽￣)_files/loading [1].gif" type="image/gif" data-filename="loading.gif" height="420" style="vertical-align:middle;margin:0px auto;border-style:none;background-color:rgb(255, 255, 255);box-sizing:initial;object-fit:cover;max-width:90%;box-shadow:rgba(0, 0, 0, 0.18) 0px 5px 11px 0px, rgba(0, 0, 0, 0.15) 0px 4px 15px 0px;border-radius:3px;" width="560"/></a></p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">函数将会在<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">21ms</code>上下返回json中的数据。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">此函数的好处在于可以在用户客户端判断哪一个镜像发挥速度最快，并保证用户每一次获取都能达到最大速度。同时，任何一个镜像站崩溃了都不会造成太大的影响，脚本将自动从其他源拉取信息。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">除非所有源都炸了，否则此请求不会失败。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">但是，我们会额外地发现，当知乎镜像返回最新版本后，其余的请求依旧在继续，只是没有被利用到而已。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">这会堵塞浏览器并发线程数，并且会造成额外的流量浪费。所以我们应该在其中任何一个请求完成后就打断其余请求。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;"><code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">fetch</code>有一个<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">abort</code>对象，只要刚开始<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">new AbortController()</code>指定控制器，在<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">init</code>的里面指定控制器的<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">signal</code>即可将其标记为待打断函数，最后<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">controller.abort()</code>即可打断。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">那么，很多同学就会开始这么写了:</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> get_json = <span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">()</span> =&gt;</span> {
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> <span style="box-sizing:border-box;color:rgb(78, 201, 176);">Promise</span>(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">resolve, reject</span>) =&gt;</span> {
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> controller = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> AbortController();
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> urllist = [
            <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;https://cdn.jsdelivr.net/npm/jquery@3.6.0/package.json&quot;</span>,
            <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;https://unpkg.com/jquery@3.6.0/package.json&quot;</span>,
            <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;https://unpkg.zhimg.com/jquery@3.6.0/package.json&quot;</span>,
            <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;https://npm.elemecdn.com/jquery@3.6.0/package.json&quot;</span>
        ]
        <span style="box-sizing:border-box;color:rgb(78, 201, 176);">Promise</span>.any(urllist.map(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">url</span> =&gt;</span> {
            fetch(url,{
                <span style="box-sizing:border-box;color:rgb(156, 220, 254);">signal</span>: controller.signal
            })
                .then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">res</span> =&gt;</span> {
                    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (res.status == <span style="box-sizing:border-box;color:rgb(184, 215, 163);">200</span>) {
                        controller.abort();
                        resolve(res)
                    } <span style="box-sizing:border-box;color:rgb(86, 156, 214);">else</span> {
                        reject()
                    }
                }).catch(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">err</span> =&gt;</span> {
                    reject()
                })
        }))
    })
}

<span style="box-sizing:border-box;color:rgb(78, 201, 176);">console</span>.log(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">await</span>(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">await</span> get_json()).text())</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">但很快，你就会发现它报错了：<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">Uncaught DOMException: The user aborted a request.</code>，并且没有任何数据输出。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">让我们看一下Network选项卡：</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;"><a href="https://npm.elemecdn.com/chenyfan-os@0.0.0-r7/4.png" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);"><img src="欲善其事，必利其器 - 论如何善用ServiceWorker  陈YFの博客(￣▽￣)_files/loading [2].gif" type="image/gif" data-filename="loading.gif" height="420" style="vertical-align:middle;margin:0px auto;border-style:none;background-color:rgb(255, 255, 255);box-sizing:initial;object-fit:cover;max-width:90%;box-shadow:rgba(0, 0, 0, 0.18) 0px 5px 11px 0px, rgba(0, 0, 0, 0.15) 0px 4px 15px 0px;border-radius:3px;" width="560"/></a></p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">其中，知乎返回的最快，但他并没有完整的返回文件[源文件1.8KB，但他只返回了1.4KB]。这也直接导致了整个函数的<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">fail</code>。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">原因出在<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">fetch</code>上，这个函数在获得响应之后就立刻<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">resolve</code>了<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">Response</code>，但这个时候<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">body</code>并没有下载完成，即<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">fetch</code>的返回基于状态的而非基于响应内容，当其中<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">fetch</code>已经拿到了完整的状态代码，它就立刻把<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">Response</code>丢给了下一个管道函数，而此时<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">status</code>正确，<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">abort</code>打断了包括这一个<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">fetch</code>的所有请求，<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">fetch</code>就直接工作不正常。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">我个人采取的方式是读取<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">arrayBuffer</code>，阻塞<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">fetch</code>函数直到把整个文件下载下来。函数名为<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">PauseProgress</code></p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> get_json = <span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">()</span> =&gt;</span> {
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> <span style="box-sizing:border-box;color:rgb(78, 201, 176);">Promise</span>(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">resolve, reject</span>) =&gt;</span> {
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> controller = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> AbortController();
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> PauseProgress = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span> (res) =&gt; {
            <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> Response(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">await</span> (res).arrayBuffer(), { <span style="box-sizing:border-box;color:rgb(156, 220, 254);">status</span>: res.status, <span style="box-sizing:border-box;color:rgb(156, 220, 254);">headers</span>: res.headers });
        };
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> urllist = [
            <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;https://cdn.jsdelivr.net/npm/jquery@3.6.0/package.json&quot;</span>,
            <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;https://unpkg.com/jquery@3.6.0/package.json&quot;</span>,
            <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;https://unpkg.zhimg.com/jquery@3.6.0/package.json&quot;</span>,
            <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;https://npm.elemecdn.com/jquery@3.6.0/package.json&quot;</span>
        ]
        <span style="box-sizing:border-box;color:rgb(78, 201, 176);">Promise</span>.any(urllist.map(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">url</span> =&gt;</span> {
            fetch(url, {
                <span style="box-sizing:border-box;color:rgb(156, 220, 254);">signal</span>: controller.signal
            })
                .then(PauseProgress)
                .then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">res</span> =&gt;</span> {
                    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (res.status == <span style="box-sizing:border-box;color:rgb(184, 215, 163);">200</span>) {
                        controller.abort();
                        resolve(res)
                    } <span style="box-sizing:border-box;color:rgb(86, 156, 214);">else</span> {
                        reject()
                    }
                }).catch(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">err</span> =&gt;</span> {
                    reject()
                })
        }))
    })
}

<span style="box-sizing:border-box;color:rgb(78, 201, 176);">console</span>.log(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">await</span>(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">await</span> get_json()).text())</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;"><a href="https://npm.elemecdn.com/chenyfan-os@0.0.0-r7/5.png" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);"><img src="欲善其事，必利其器 - 论如何善用ServiceWorker  陈YFの博客(￣▽￣)_files/loading [3].gif" type="image/gif" data-filename="loading.gif" height="420" style="vertical-align:middle;margin:0px auto;border-style:none;background-color:rgb(255, 255, 255);box-sizing:initial;object-fit:cover;max-width:90%;box-shadow:rgba(0, 0, 0, 0.18) 0px 5px 11px 0px, rgba(0, 0, 0, 0.15) 0px 4px 15px 0px;border-radius:3px;" width="560"/></a></p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">在这其中通过<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">arrayBuffer()</code>方法异步读取<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">res</code>的<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">body</code>，将其读取为二进制文件，并新建一个新的<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">Response</code>，还原状态和头，然后丢给管道函数同步处理。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">在这里，我们就实现了暴力并发，以流量换速度的方式。同时也获得了一个高可用的SW负载均衡器。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">这一段函数可以这样写在SW中：</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//...</span>
<span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> lfetch = <span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">urllist</span>) =&gt;</span> {
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> <span style="box-sizing:border-box;color:rgb(78, 201, 176);">Promise</span>(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">resolve, reject</span>) =&gt;</span> {
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> controller = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> AbortController();
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> PauseProgress = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span> (res) =&gt; {
            <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> Response(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">await</span> (res).arrayBuffer(), { <span style="box-sizing:border-box;color:rgb(156, 220, 254);">status</span>: res.status, <span style="box-sizing:border-box;color:rgb(156, 220, 254);">headers</span>: res.headers });
        };
        <span style="box-sizing:border-box;color:rgb(78, 201, 176);">Promise</span>.any(urllist.map(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">url</span> =&gt;</span> {
            fetch(url, {
                <span style="box-sizing:border-box;color:rgb(156, 220, 254);">signal</span>: controller.signal
            })
                .then(PauseProgress)
                .then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">res</span> =&gt;</span> {
                    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (res.status == <span style="box-sizing:border-box;color:rgb(184, 215, 163);">200</span>) {
                        controller.abort();
                        resolve(res)
                    } <span style="box-sizing:border-box;color:rgb(86, 156, 214);">else</span> {
                        reject()
                    }
                }).catch(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">err</span> =&gt;</span> {
                    reject()
                })
        }))
    })
}
<span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> handle = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span> (req) =&gt; {
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> npm_mirror = [
        <span style="box-sizing:border-box;color:rgb(214, 157, 133);">'https://cdn.jsdelivr.net/npm/'</span>,
        <span style="box-sizing:border-box;color:rgb(214, 157, 133);">'https://unpkg.com/'</span>,
        <span style="box-sizing:border-box;color:rgb(214, 157, 133);">'https://npm.elemecdn.com/'</span>,
        <span style="box-sizing:border-box;color:rgb(214, 157, 133);">'https://unpkg.zhimg.com/'</span>
    ]
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">for</span> (<span style="box-sizing:border-box;color:rgb(86, 156, 214);">var</span> k <span style="box-sizing:border-box;color:rgb(86, 156, 214);">in</span> npm_mirror) {
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (req.url.match(npm_mirror[k]) &amp;&amp; req.url.replace(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'https://'</span>, <span style="box-sizing:border-box;color:rgb(214, 157, 133);">''</span>).split(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'/'</span>)[<span style="box-sizing:border-box;color:rgb(184, 215, 163);">0</span>] == npm_mirror[k].replace(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'https://'</span>, <span style="box-sizing:border-box;color:rgb(214, 157, 133);">''</span>).split(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'/'</span>)[<span style="box-sizing:border-box;color:rgb(184, 215, 163);">0</span>]) {
            <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> lfetch(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">(</span>) =&gt;</span> {
                <span style="box-sizing:border-box;color:rgb(86, 156, 214);">let</span> l = []
                <span style="box-sizing:border-box;color:rgb(86, 156, 214);">for</span> (<span style="box-sizing:border-box;color:rgb(86, 156, 214);">let</span> i = <span style="box-sizing:border-box;color:rgb(184, 215, 163);">0</span>; i &lt; npm_mirror.length; i++) {
                    l.push(npm_mirror[i] + req.url.split(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'/'</span>)[<span style="box-sizing:border-box;color:rgb(184, 215, 163);">3</span>])
                }
                <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> l
            })())
        }
    }
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> fetch(req)
}</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">另外,<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">Promise.any</code>,兼容性比较差:</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;"><a href="https://npm.elemecdn.com/chenyfan-os@0.0.0-r9/1.png" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);"><img src="欲善其事，必利其器 - 论如何善用ServiceWorker  陈YFの博客(￣▽￣)_files/loading [4].gif" type="image/gif" data-filename="loading.gif" height="420" style="vertical-align:middle;margin:0px auto;border-style:none;background-color:rgb(255, 255, 255);box-sizing:initial;object-fit:cover;max-width:90%;box-shadow:rgba(0, 0, 0, 0.18) 0px 5px 11px 0px, rgba(0, 0, 0, 0.15) 0px 4px 15px 0px;border-radius:3px;" width="560"/></a></p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">因此,我的解决办法是判断浏览器如果不支持,就提前polyfill一下:</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (!<span style="box-sizing:border-box;color:rgb(78, 201, 176);">Promise</span>.any) {
        <span style="box-sizing:border-box;color:rgb(78, 201, 176);">Promise</span>.any = <span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">function</span> (<span style="box-sizing:border-box;color:rgb(220, 220, 220);">promises</span>) </span>{
            <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> <span style="box-sizing:border-box;color:rgb(78, 201, 176);">Promise</span>(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">resolve, reject</span>) =&gt;</span> {
                promises = <span style="box-sizing:border-box;color:rgb(78, 201, 176);">Array</span>.isArray(promises) ? promises : []
                <span style="box-sizing:border-box;color:rgb(86, 156, 214);">let</span> len = promises.length
                <span style="box-sizing:border-box;color:rgb(86, 156, 214);">let</span> errs = []
                <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (len === <span style="box-sizing:border-box;color:rgb(184, 215, 163);">0</span>) <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> reject(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> AggregateError(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'All promises were rejected'</span>))
                promises.forEach(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">promise</span>) =&gt;</span> {
                    promise.then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">value</span> =&gt;</span> {
                        resolve(value)
                    }, err =&gt; {
                        len--
                        errs.push(err)
                        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (len === <span style="box-sizing:border-box;color:rgb(184, 215, 163);">0</span>) {
                            reject(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> AggregateError(errs))
                        }
                    })
                })
            })
        }
    }</code></pre></div><h2 style="box-sizing:border-box;line-height:1.25;padding-bottom:0.3em;border-bottom:1px solid rgb(234, 236, 239);font-size:1.5em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/c0af86bb.html#%E7%BC%93%E5%AD%98%E6%8E%A7%E5%88%B6-Cache" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="缓存控制 / Cache"></a>缓存控制 / Cache</h2><h3 style="box-sizing:border-box;line-height:1.25;font-size:1.25em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/c0af86bb.html#%E6%8C%81%E4%B9%85%E5%8C%96%E7%BC%93%E5%AD%98-Cache-Persistently" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="持久化缓存 / Cache Persistently"></a>持久化缓存 / Cache Persistently</h3><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">对于来自CDN的流量，大部分是持久不变的，因此，如果我们将文件获得后直接填入缓存，之后访问也直接从本地缓存中读取，那将大大提升访问速度。</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> handle = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span> (req) =&gt; {
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> cache_url_list = [
        <span style="box-sizing:border-box;color:rgb(154, 83, 52);">/(http://|https://)cdn.jsdelivr.net/g</span>,
        /(http://|https://)cdn.bootcss.com/g,
        /(http://|https://)zhimg.unpkg.com/g,
        /(http://|https://)unpkg.com/g
    ]
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">for</span> (<span style="box-sizing:border-box;color:rgb(86, 156, 214);">var</span> i <span style="box-sizing:border-box;color:rgb(86, 156, 214);">in</span> cache_url_list) {
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (req.url.match(cache_url_list[i])) {
            <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> caches.match(req).then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">function</span> (<span style="box-sizing:border-box;color:rgb(220, 220, 220);">resp</span>) </span>{
                <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> resp || fetch(req).then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">function</span> (<span style="box-sizing:border-box;color:rgb(220, 220, 220);">res</span>) </span>{
                    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> caches.open(CACHE_NAME).then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">function</span> (<span style="box-sizing:border-box;color:rgb(220, 220, 220);">cache</span>) </span>{
                        cache.put(req, res.clone());
                        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> res;
                    });
                });
            })
        }
    }
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> fetch(req)
}</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;"><code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">cache_url_list</code>列出所有待匹配的域名(包括http/https头是为了避免误杀其他url)，然后<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">for</code>开始遍历待列表，如果url中匹配到了，开始执行返回缓存操作。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">cache是一个近似于Key/Value(键名/键值)，只要有对应的<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">Request</code>(<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">KEY</code>)，就能匹配到响应的<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">Response</code>(<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">VALUE</code>)。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;"><code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">caches.match(req)</code>将会试图在CacheStorage中匹配请求的url获取值，然后丢给管道同步函数<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">then</code>，传参<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">resp</code>为Cache匹配到的值。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">此时管道内将尝试返回resp，如果resp为<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">null</code>或<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">undefined</code>[即获取不到对应的缓存]，将执行fetch操作，fetch成功后将<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">open</code>打开CacheStorage，并<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">put</code>放入缓存。此时如果<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">fetch</code>失败将直接报错，不写入缓存。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">在下一次获取同一个URL的时候，缓存匹配到的将不再是空白值，此时<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">fetch</code>不执行，直接返回缓存，大大提升了速度。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">由于npm的cdn对于latest缓存并不是持久有效的，所以我们最好还是判断一下url版本中是否以@latest为结尾。</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> is_latest = <span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">url</span>) =&gt;</span> {
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> url.replace(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'https://'</span>, <span style="box-sizing:border-box;color:rgb(214, 157, 133);">''</span>).split(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'/'</span>)[<span style="box-sizing:border-box;color:rgb(184, 215, 163);">1</span>].split(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'@'</span>)[<span style="box-sizing:border-box;color:rgb(184, 215, 163);">1</span>] === <span style="box-sizing:border-box;color:rgb(214, 157, 133);">'latest'</span>
}
<span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//...</span>
<span style="box-sizing:border-box;color:rgb(86, 156, 214);">for</span> (<span style="box-sizing:border-box;color:rgb(86, 156, 214);">var</span> i <span style="box-sizing:border-box;color:rgb(86, 156, 214);">in</span> cache_url_list) {
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (is_latest(req.url)) { <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> fetch(req) }
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (req.url.match(cache_url_list[i])) {
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> caches.match(req).then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">function</span> (<span style="box-sizing:border-box;color:rgb(220, 220, 220);">resp</span>) </span>{
            <span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//...</span>
        })
    }
}</code></pre></div><h3 style="box-sizing:border-box;line-height:1.25;font-size:1.25em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/c0af86bb.html#%E7%A6%BB%E7%BA%BF%E5%8C%96%E7%BC%93%E5%AD%98-Cache-For-Offline" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="离线化缓存 / Cache For Offline"></a>离线化缓存 / Cache For Offline</h3><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">对于博客来说，并不是所有内容都是一成不变的。传统PWA采用SW更新同时刷新缓存，这样不够灵活，同时刷新缓存的版本号管理也存在着很大的漏洞，长时间访问极易造成庞大的缓存冗余。因此，对于博客的缓存，我们要保证用户每次获取都是最新的版本，但也要保证用户在离线时能看到最后一个版本的内容。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">因此，针对博客来说，策略应该是先获取最新内容，然后更新本地缓存，最后返回最新内容；离线的时候，尝试访问最新内容会回退到缓存，如果缓存也没有，就回退到错误页面。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">即：</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;">Online:
发起Request =&gt; 发起fetch =&gt; 更新Cache =&gt; 返回Response
Offline:
发起Request =&gt; 获取Cache =&gt; 返回Response</code></pre></div><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> handle = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span> (req) =&gt; {
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> fetch(req.url).then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">function</span> (<span style="box-sizing:border-box;color:rgb(220, 220, 220);">res</span>) </span>{
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (!res) { <span style="box-sizing:border-box;color:rgb(86, 156, 214);">throw</span> <span style="box-sizing:border-box;color:rgb(214, 157, 133);">'error'</span> } <span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//1</span>
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> caches.open(CACHE_NAME).then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">function</span> (<span style="box-sizing:border-box;color:rgb(220, 220, 220);">cache</span>) </span>{
            cache.delete(req);
            cache.put(req, res.clone());
            <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> res;
        });
    }).catch(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">function</span> (<span style="box-sizing:border-box;color:rgb(220, 220, 220);">err</span>) </span>{
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> caches.match(req).then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">function</span> (<span style="box-sizing:border-box;color:rgb(220, 220, 220);">resp</span>) </span>{
            <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> resp || caches.match(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> Request(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'/offline.html'</span>)) <span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//2</span>
        })
    })
}</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;"><code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">if (!res) { throw 'error' }</code> 如果没有返回值，直接抛出错误，会被下面的Catch捕获，返回缓存或错误页面</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;"><code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">return resp || caches.match(new Request('/offline.html'))</code> 返回缓存获得的内容。如果没有，就返回从缓存中拿到的错误网页。此处offline.html应该在最开始的时候就缓存好</p><h2 style="box-sizing:border-box;line-height:1.25;padding-bottom:0.3em;border-bottom:1px solid rgb(234, 236, 239);font-size:1.5em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/c0af86bb.html#%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8-Storage-Persistently" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="持久化存储 / Storage Persistently"></a>持久化存储 / Storage Persistently</h2><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">由于sw中无<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">window</code>，我们不能使用<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">localStorage</code>和<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">sessionStorage</code>。SW脚本会在所有页面都关闭或重载的时候丢失原先的数据。因此，如果想要使用持久化存储，我们只能使用<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">CacheAPI</code>和<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">IndexdDB</code>。</p><h3 style="box-sizing:border-box;line-height:1.25;font-size:1.25em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/c0af86bb.html#IndexdDB" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="IndexdDB"></a>IndexdDB</h3><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">这货结构表类型类似于<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">SQL</code>，能够存储JSON对象和数据内容，但版本更新及其操作非常麻烦，因此本文不对此做过多解释。</p><h3 style="box-sizing:border-box;line-height:1.25;font-size:1.25em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/c0af86bb.html#CacheAPI" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="CacheAPI"></a>CacheAPI</h3><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">这东西原本是用来缓存响应，但其本身的特性我们可以将其改造成一个简易的Key/Value数据表，可以存储文本/二进制，可扩展性远远比IndexdDB要好。</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;">self.CACHE_NAME = <span style="box-sizing:border-box;color:rgb(214, 157, 133);">'SWHelperCache'</span>;
self.db = {
    <span style="box-sizing:border-box;color:rgb(156, 220, 254);">read</span>: <span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">key</span>) =&gt;</span> {
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> <span style="box-sizing:border-box;color:rgb(78, 201, 176);">Promise</span>(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">resolve, reject</span>) =&gt;</span> {
            caches.match(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> Request(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">`https://LOCALCACHE/<span style="box-sizing:border-box;color:rgb(220, 220, 220);">${<span style="box-sizing:border-box;color:rgb(78, 201, 176);">encodeURIComponent</span>(key)}</span>`</span>)).then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">function</span> (<span style="box-sizing:border-box;color:rgb(220, 220, 220);">res</span>) </span>{
                res.text().then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">text</span> =&gt;</span> resolve(text))
            }).catch(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">()</span> =&gt;</span> {
                resolve(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">null</span>)
            })
        })
    },
    <span style="box-sizing:border-box;color:rgb(156, 220, 254);">read_arrayBuffer</span>: <span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">key</span>) =&gt;</span> {
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> <span style="box-sizing:border-box;color:rgb(78, 201, 176);">Promise</span>(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">resolve, reject</span>) =&gt;</span> {
            caches.match(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> Request(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">`https://LOCALCACHE/<span style="box-sizing:border-box;color:rgb(220, 220, 220);">${<span style="box-sizing:border-box;color:rgb(78, 201, 176);">encodeURIComponent</span>(key)}</span>`</span>)).then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">function</span> (<span style="box-sizing:border-box;color:rgb(220, 220, 220);">res</span>) </span>{
                res.arrayBuffer().then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">aB</span> =&gt;</span> resolve(aB))
            }).catch(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">()</span> =&gt;</span> {
                resolve(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">null</span>)
            })
        })
    },
    <span style="box-sizing:border-box;color:rgb(156, 220, 254);">write</span>: <span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">key, value</span>) =&gt;</span> {
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> <span style="box-sizing:border-box;color:rgb(78, 201, 176);">Promise</span>(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">resolve, reject</span>) =&gt;</span> {
            caches.open(CACHE_NAME).then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">function</span> (<span style="box-sizing:border-box;color:rgb(220, 220, 220);">cache</span>) </span>{
                cache.put(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> Request(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">`https://LOCALCACHE/<span style="box-sizing:border-box;color:rgb(220, 220, 220);">${<span style="box-sizing:border-box;color:rgb(78, 201, 176);">encodeURIComponent</span>(key)}</span>`</span>), <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> Response(value));
                resolve()
            }).catch(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">()</span> =&gt;</span> {
                reject()
            })
        })
    }
}</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">使用操作：</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">写入key，value:</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">await</span> db.wtite(key,value)</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">以文本方式读取key：</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">await</span> db.read(key)</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">以二进制方式读取key：</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">await</span> db.read_arrayBuffer(key)</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">其余的blob读取、delete操作此处不过多阐述。</p><h2 style="box-sizing:border-box;line-height:1.25;padding-bottom:0.3em;border-bottom:1px solid rgb(234, 236, 239);font-size:1.5em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/c0af86bb.html#%E9%A1%B5%E9%9D%A2%E4%B8%8ESW%E9%80%9A%E4%BF%A1-Build-Communication-with-Page-and-ServiceWorker" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="页面与SW通信 / Build Communication with Page and ServiceWorker"></a>页面与SW通信 / Build Communication with Page and ServiceWorker</h2><h3 style="box-sizing:border-box;line-height:1.25;font-size:1.25em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/c0af86bb.html#%E5%8D%95%E5%90%91%E8%BF%9E%E6%8E%A5-Unidirectional-Connect" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="单向连接 / Unidirectional Connect"></a>单向连接 / Unidirectional Connect</h3><h3 style="box-sizing:border-box;line-height:1.25;font-size:1.25em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/c0af86bb.html#Clients-To-SW" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="Clients To SW"></a>Clients To SW</h3><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">浏览器 =&gt; SW</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">ServiceWorker中有一个非常简单的API<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">postMessage</code>,全路径为<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">navigator.serviceWorker.controller.postMessage</code>.</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">因此,如果你只是作为页面单方面传递给SW,此api是个不错的选择.</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">前端写法</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> data = <span style="box-sizing:border-box;color:rgb(184, 215, 163);">123</span>
navigator.serviceWorker.controller.postMessage(data)
<span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//发送123</span></code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">SW接收</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;">self.addEventListener(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'message'</span>, (event) =&gt; {
  <span style="box-sizing:border-box;color:rgb(78, 201, 176);">console</span>.log(event.data)
  <span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//输出123</span>
});</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">此方法可用于单方面向SW提交数据,但无需返回值.比如提示SW可以SkipWaiting,或者提交前端统计数据等等.</p><h4 style="box-sizing:border-box;line-height:1.25;font-size:1em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/c0af86bb.html#SW-To-Clients" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="SW To Clients"></a>SW To Clients</h4><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">首先,Clients必须要从SW中的一个event事件中获取,比如<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">fetch</code>.无法从<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">message</code>事件中获取client.</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;">addEventListener(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'fetch'</span>, event =&gt; {
    event.waitUntil(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span> <span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">function</span> (<span style="box-sizing:border-box;color:rgb(220, 220, 220);"></span>) </span>{
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (!event.clientId) <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span>;
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> client = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">await</span> clients.get(event.clientId);
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (!client) <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span>;
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> data = <span style="box-sizing:border-box;color:rgb(184, 215, 163);">123</span>;
        client.postMessage(data);
    }());
});</code></pre></div><h3 style="box-sizing:border-box;line-height:1.25;font-size:1.25em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/c0af86bb.html#%E5%8F%8C%E5%90%91%E9%80%9A%E8%AE%AF-Connect-Each" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="双向通讯 / Connect Each"></a>双向通讯 / Connect Each</h3><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">浏览器 &lt;=&gt; SW</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">我们拥有两种方式双向通讯:</p><ol style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;padding-left:2em;"><li style="box-sizing:border-box;"><a href="https://developer.mozilla.org/en-US/docs/Web/API/Broadcast_Channel_API" rel="noopener" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" target="_blank">Broadcast Channel API</a> 多对多,广播形式.</li><li style="box-sizing:border-box;margin-top:0.25em;"><a href="https://developer.mozilla.org/en-US/docs/Web/API/MessageChannel" rel="noopener" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" target="_blank">Message Channel</a> 一对一</li></ol><h4 style="box-sizing:border-box;line-height:1.25;font-size:1em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/c0af86bb.html#MessageChannel" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="MessageChannel"></a>MessageChannel</h4><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">顾名思义，MessageChannel API 设置了一个可以发送消息的通道。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">该实现可以归结为3个步骤。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">1.在两侧设置事件侦听器以接收<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">message</code> 事件<br style="box-sizing:border-box;"/>2.通过发送<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">port</code>并将其存储在SW中，建立与SW的连接。<br style="box-sizing:border-box;"/>3.使用存储的<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">port</code>回复客户端</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">前端写法</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> messageChannel = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> MessageChannel();
navigator.serviceWorker.controller.postMessage({
  <span style="box-sizing:border-box;color:rgb(156, 220, 254);">type</span>: <span style="box-sizing:border-box;color:rgb(214, 157, 133);">'INIT'</span>,<span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//发送init信息,表示以port2为接收端[即SW的发送端]</span>
}, [messageChannel.port2]);
messageChannel.port1.onmessage = <span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">event</span>) =&gt;</span> {
  <span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//监听port1</span>
  navigator.serviceWorker.controller.postMessage({
    <span style="box-sizing:border-box;color:rgb(156, 220, 254);">type</span>: <span style="box-sizing:border-box;color:rgb(214, 157, 133);">'PING'</span><span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//发送PING</span>
  });
};</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">SW端写法</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;">self.addEventListener(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;message&quot;</span>, event =&gt; {
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> data = event.data;
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (!!data) {
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">switch</span> (data.type) {
            <span style="box-sizing:border-box;color:rgb(86, 156, 214);">case</span> <span style="box-sizing:border-box;color:rgb(214, 157, 133);">'INIT'</span>:
                self.ClientPort = event.ports[<span style="box-sizing:border-box;color:rgb(184, 215, 163);">0</span>];
            <span style="box-sizing:border-box;color:rgb(86, 156, 214);">default</span>:
                self.ClientPort.postMessage({
                    <span style="box-sizing:border-box;color:rgb(156, 220, 254);">type</span>: <span style="box-sizing:border-box;color:rgb(214, 157, 133);">'DATA'</span>,
                    <span style="box-sizing:border-box;color:rgb(156, 220, 254);">data</span>: <span style="box-sizing:border-box;color:rgb(214, 157, 133);">'pong'</span>
                });
        }
    }
})</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">然后查看控制台,你就会看到里面一直在乒乒乓乓,说明成功了.</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">我们简单的改写一下,变成异步形式传输数据:</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> mCh = {
        <span style="box-sizing:border-box;color:rgb(156, 220, 254);">init</span>: <span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">()</span> =&gt;</span> {
            <span style="box-sizing:border-box;color:rgb(78, 201, 176);">window</span>.messageChannel = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> MessageChannel();
            navigator.serviceWorker.controller.postMessage({
                <span style="box-sizing:border-box;color:rgb(156, 220, 254);">type</span>: <span style="box-sizing:border-box;color:rgb(214, 157, 133);">'INIT'</span>,
            }, [messageChannel.port2]);
        },
        <span style="box-sizing:border-box;color:rgb(156, 220, 254);">send</span>: <span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">data</span>) =&gt;</span> {

            <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> <span style="box-sizing:border-box;color:rgb(78, 201, 176);">Promise</span>(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">resolve, reject</span>) =&gt;</span> {
                <span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> uuid = <span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">(</span>) =&gt;</span> {
                    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> <span style="box-sizing:border-box;color:rgb(214, 157, 133);">'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'</span>.replace(<span style="box-sizing:border-box;color:rgb(154, 83, 52);">/[xy]/g</span>, <span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">function</span> (<span style="box-sizing:border-box;color:rgb(220, 220, 220);">c</span>) </span>{
                        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">var</span> r = <span style="box-sizing:border-box;color:rgb(78, 201, 176);">Math</span>.random() * <span style="box-sizing:border-box;color:rgb(184, 215, 163);">16</span> | <span style="box-sizing:border-box;color:rgb(184, 215, 163);">0</span>, v = c == <span style="box-sizing:border-box;color:rgb(214, 157, 133);">'x'</span> ? r : (r &amp; <span style="box-sizing:border-box;color:rgb(184, 215, 163);">0x3</span> | <span style="box-sizing:border-box;color:rgb(184, 215, 163);">0x8</span>);
                        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> v.toString(<span style="box-sizing:border-box;color:rgb(184, 215, 163);">16</span>);
                    });
                })()
                navigator.serviceWorker.controller.postMessage({
                    <span style="box-sizing:border-box;color:rgb(156, 220, 254);">type</span>: <span style="box-sizing:border-box;color:rgb(214, 157, 133);">'DATA'</span>,
                    <span style="box-sizing:border-box;color:rgb(156, 220, 254);">data</span>: data,
                    <span style="box-sizing:border-box;color:rgb(156, 220, 254);">id</span>: uuid
                });
                setTimeout(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">()</span> =&gt;</span> {
                    reject({
                        <span style="box-sizing:border-box;color:rgb(156, 220, 254);">message</span>: <span style="box-sizing:border-box;color:rgb(214, 157, 133);">'timeout'</span>,
                        <span style="box-sizing:border-box;color:rgb(156, 220, 254);">ok</span>: <span style="box-sizing:border-box;color:rgb(86, 156, 214);">false</span>
                    })
                }, <span style="box-sizing:border-box;color:rgb(184, 215, 163);">2000</span>);
                messageChannel.port1.onmessage = <span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">event</span>) =&gt;</span> {
                    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (event.data.id === uuid) {
                        resolve({
                            <span style="box-sizing:border-box;color:rgb(156, 220, 254);">message</span>: event.data.data,
                            <span style="box-sizing:border-box;color:rgb(156, 220, 254);">ok</span>: <span style="box-sizing:border-box;color:rgb(86, 156, 214);">true</span>
                        })
                    };
                }
            })
        }
    }</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">由于MessageChannel特性,一个port只要不是连续传输数据就会被断开.所以每次传输时我们要先初始化,后发送数据.</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">由于传输时无状态的,我们将每一个包都打上特定的uuid,返回包里也写上对应的uuid即可判断那个包是哪个对应的返回值.</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">SW端也要做一点点相应的改动</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;">self.ClientPort.postMessage({
<span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//...</span>
<span style="box-sizing:border-box;color:rgb(156, 220, 254);">id</span>: data.id
});</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">这样,一个兼容性较好的SW双向传输就解决了.</p><h4 style="box-sizing:border-box;line-height:1.25;font-size:1em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/c0af86bb.html#Broadcast-Channel" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="Broadcast Channel"></a>Broadcast Channel</h4><blockquote style="box-sizing:border-box;margin:0px;margin-top:0px;margin-bottom:16px;padding:0px 1em;border-left:0.25em solid rgb(223, 226, 229);color:rgb(113, 128, 150);"><p style="box-sizing:border-box;margin-top:0px;margin-bottom:0px;">请注意,BroadCast虽然写法建议,但是对浏览器兼容性要求非常高[Chrome 54,IOS Safari全线不支持].用此api请三思.</p></blockquote><blockquote style="box-sizing:border-box;margin:0px;margin-top:0px;margin-bottom:16px;padding:0px 1em;border-left:0.25em solid rgb(223, 226, 229);color:rgb(113, 128, 150);"><p style="box-sizing:border-box;margin-top:0px;margin-bottom:0px;">另外,由于是广播形式,一个页面如果有多个SW,他们会同时收到消息.</p></blockquote><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">前端</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> broadcast = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> BroadcastChannel(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'Channel Name'</span>);
<span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> send_ping = <span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">()</span> =&gt;</span> {
    broadcast.postMessage({
        <span style="box-sizing:border-box;color:rgb(156, 220, 254);">type</span>: <span style="box-sizing:border-box;color:rgb(214, 157, 133);">'PING'</span>
    });
}
broadcast.onmessage = <span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">event</span>) =&gt;</span> {
    <span style="box-sizing:border-box;color:rgb(78, 201, 176);">console</span>.log(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'PONG'</span>)
    setTimeout(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">()</span> =&gt;</span> {
        send_ping()
    }, <span style="box-sizing:border-box;color:rgb(184, 215, 163);">500</span>);
};
send_ping()</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">SW端</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> broadcast = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> BroadcastChannel(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'Channel Name'</span>);
broadcast.onmessage = <span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">event</span>) =&gt;</span> {
    broadcast.postMessage({ <span style="box-sizing:border-box;color:rgb(156, 220, 254);">type</span>: <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;PONG&quot;</span> })
};</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">只要ChannelName对应,即可在里面顺利传输消息.</p><h2 style="box-sizing:border-box;line-height:1.25;padding-bottom:0.3em;border-bottom:1px solid rgb(234, 236, 239);font-size:1.5em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/c0af86bb.html#%E7%BB%86%E8%8A%82%E4%B8%8E%E6%B3%A8%E6%84%8F-Something-Small-But-Need-to-Be-Mentioned" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="细节与注意 / Something Small But Need to Be Mentioned"></a>细节与注意 / Something Small But Need to Be Mentioned</h2><h3 style="box-sizing:border-box;line-height:1.25;font-size:1.25em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/c0af86bb.html#%E6%97%A0%E6%B3%95%E4%BF%AE%E6%94%B9%E7%9A%84-Header" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="无法修改的 Header"></a>无法修改的 Header</h3><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">由于ServiceWorker本质上仍然属于浏览器,因此,你无法控制例如header中的<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">Host</code><code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">Refferer</code><code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">Access-Control-Allow-Origin</code>用于绕过防盗链CORS指定host选择ip</p><h3 style="box-sizing:border-box;line-height:1.25;font-size:1.25em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/c0af86bb.html#%E9%9A%BE%E4%BB%A5%E5%8D%B8%E8%BD%BD%E7%9A%84-SW" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="难以卸载的 SW"></a>难以卸载的 SW</h3><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">SW一大特性,一旦被安装,就不能通过传统方式卸载掉.</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">如果你直接删除<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">sw.js</code>文件并删除安装代码,那么,新用户是不会被安装的,但是原先已经安装过的用户sw会继续劫持这他们的网页,导致老用户网页不更新或者出现异常.</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">正确的删除方法是将安装代码改成卸载代码:</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;">navigator.serviceWorker.getRegistrations().<span style="box-sizing:border-box;color:rgb(86, 156, 214);">then</span>(function(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">registrations</span>) {
 <span style="box-sizing:border-box;color:rgb(86, 156, 214);">for</span>(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">let</span> <span style="box-sizing:border-box;color:rgb(86, 156, 214);">registration</span> <span style="box-sizing:border-box;color:rgb(86, 156, 214);">of</span> <span style="box-sizing:border-box;color:rgb(86, 156, 214);">registrations</span>) {
  <span style="box-sizing:border-box;color:rgb(86, 156, 214);">registration</span>.unregister()
} })</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">并将sw内容改成透明代理,方便没有卸载的用户正常使用.</p><h3 style="box-sizing:border-box;line-height:1.25;font-size:1.25em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/c0af86bb.html#%E5%A0%B5%E5%A1%9E%E6%95%B4%E4%B8%AA%E6%B5%8F%E8%A7%88%E5%99%A8%E7%9A%84%E4%BB%A3%E7%A0%81" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="堵塞整个浏览器的代码"></a>堵塞整个浏览器的代码</h3><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">由于SW运行在DOM上下文,如果在sw中执行一些消耗资源的代码会直接耗尽浏览器资源,与dom不同的是,dom耗资源代码只会堵塞一个线程,另一个线程依旧可以正常工作,而sw一旦堵塞会将整个浏览器堵死.因此sw固然可以更快的计算,但万不可将一些极易死机的代码交给sw处理.</p><h1 style="margin:0.67em 0px;box-sizing:border-box;line-height:1.25;font-size:2em;padding-bottom:0.3em;border-bottom:1px solid rgb(234, 236, 239);color:rgb(26, 32, 44);font-weight:700;margin-top:2em;margin-bottom:0.75em;"><a href="https://blog.cyfan.top/p/c0af86bb.html#End" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="End"></a>End</h1><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">这篇文章结尾的很仓促,毕竟已经快拖了一个月了,也有很多东西没有讲清楚,未来可能会小修小改.</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">篇幅所限,一些sw其他功能并没有详细讲述,比如后台更新或者推送通知.这些功能在实际开发中并不是特别有用,或者在国内大环境下并不适合.可能这些功能会在下一篇文章,sw的实操中讲述.</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">停下笔的时候,hexo统计这篇文章已经将近1万字,阅读时间近100分钟.不过我认为这值得,毕竟sw就是这么一个凭借着奇思妙想就能绽放出Spark的事物.唯有独特的创造力才能激发无限可能.</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">当然,这篇文章讲述的都是些非常基础的东西,那在下一篇文章,我会贴出一个个demo,希望你们能对这些充满着智慧的样例激发你们的灵感.</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:0px;">另外,在祝贺你们,虎年大吉,新年快乐!</p></div></div></div></div></div></div></div></span></div></div></div>
</div>
</span>
</div></body></html> 