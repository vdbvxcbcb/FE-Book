<html>
<head>
  <title>SpeedUp!使用黑科技为你的网站提速 || 陈YFの博客(￣▽￣)"</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/606060 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="6465"/>
<h1>SpeedUp!使用黑科技为你的网站提速 || 陈YFの博客(￣▽￣)"</h1>

<div><span>
  <div style="--en-clipped-content:article; --en-clipped-source-url:https://blog.cyfan.top/p/d3c51290.html; --en-clipped-source-title:SpeedUp!使用黑科技为你的网站提速 || 陈YFの博客(￣▽￣)&quot;;">
<div><br/></div><div style="min-height: 12514px; font-size: 16px; display: block; min-width: 100%; position: relative;"> <div style="box-sizing:border-box;line-height:1.15;text-size-adjust:100%;-webkit-tap-highlight-color:transparent;font-size:16px;font-family:&quot;SF Pro SC&quot;, &quot;SF Pro Text&quot;, &quot;SF Pro Icons&quot;, &quot;PingFang SC&quot;, &quot;Lantinghei SC&quot;, &quot;Microsoft Yahei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Sans Serif&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;overflow-wrap:break-word;"><div style="box-sizing:border-box;font-weight:400;line-height:1.5;text-align:left;font-family:&quot;SF Pro SC&quot;, &quot;SF Pro Text&quot;, &quot;SF Pro Icons&quot;, &quot;PingFang SC&quot;, &quot;Lantinghei SC&quot;, &quot;Microsoft Yahei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Sans Serif&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;font-size:16px;overflow-wrap:break-word;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;color:rgb(60, 72, 88);background-color:rgb(248, 248, 248);"><span style="box-sizing:border-box;"><div style="box-sizing:border-box;"><div style="box-sizing:border-box;"><div style="box-sizing:border-box;"><div style="box-sizing:border-box;"><div style="box-sizing:border-box;background-color:rgb(255, 255, 255);transition:background-color 0.2s ease-in-out 0s;border-radius:8px;box-shadow:rgba(0, 0, 0, 0.24) 0px 12px 15px 0px, rgba(0, 0, 0, 0.19) 0px 17px 50px 0px;"><div style="box-sizing:border-box;"><div style="box-sizing:border-box;text-size-adjust:100%;line-height:1.5;overflow-wrap:break-word;color:rgb(44, 62, 80);font-family:&quot;SF Pro SC&quot;, &quot;SF Pro Text&quot;, &quot;SF Pro Icons&quot;, &quot;PingFang SC&quot;, &quot;Lantinghei SC&quot;, &quot;Microsoft Yahei&quot;, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Sans Serif&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;font-size:16px;"><p style="box-sizing:border-box;margin-bottom:16px;margin-top:0px;">实战，利用黑科技ServiceWorker提速你的网站。</p><a style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:inherit;"></a><blockquote style="box-sizing:border-box;margin:0px;margin-top:0px;margin-bottom:16px;padding:0px 1em;border-left:0.25em solid rgb(223, 226, 229);color:rgb(113, 128, 150);"><p style="box-sizing:border-box;margin-top:0px;margin-bottom:0px;">本文所标记的内容，大多是直接复制粘贴即可实现的。但依然会存在这和您的服务存在冲突这一情况。请阅读上一篇基础文章<a href="https://blog.cyfan.top/p/c0af86bb.html" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);">欲善其事，必利其器 - 论如何善用ServiceWorker</a>进行合理的修改。</p></blockquote><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">我们简单的列一下表，这是我们加速清单：</p><ul style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;padding-left:2em;"><li style="box-sizing:border-box;"><a href="https://blog.cyfan.top/p/d3c51290.html#%E5%89%8D%E7%AB%AF%E7%AB%9E%E9%80%9FCDN" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);">分离资源，静态加速</a></li><li style="box-sizing:border-box;margin-top:0.25em;"><a href="https://blog.cyfan.top/p/d3c51290.html#%E5%85%A8%E7%AB%99NPM%E9%9D%99%E6%80%81%E5%8C%96" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);">加速主网页</a></li><li style="box-sizing:border-box;margin-top:0.25em;"><a href="https://blog.cyfan.top/p/d3c51290.html#%E8%B0%83%E5%89%82%E5%93%8D%E5%BA%94" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);">调剂响应</a></li><li style="box-sizing:border-box;margin-top:0.25em;"><a href="https://blog.cyfan.top/p/d3c51290.html#%E4%BC%98%E5%8C%96%E9%A6%96%E5%B1%8F" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);">首屏加速</a></li></ul><h1 style="margin:0.67em 0px;box-sizing:border-box;line-height:1.25;font-size:2em;padding-bottom:0.3em;border-bottom:1px solid rgb(234, 236, 239);color:rgb(26, 32, 44);font-weight:700;margin-top:2em;margin-bottom:0.75em;"><a href="https://blog.cyfan.top/p/d3c51290.html#%E5%89%8D%E7%AB%AF%E7%AB%9E%E9%80%9FCDN" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="前端竞速CDN"></a>前端竞速CDN</h1><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">最传统的网页加载，其静态资源一旦独立是直接放在同域服务器下的。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">不过后来，为了减少主服务器开销，我们通常将静态资分离至其他面向用户加载比较快的节点，以减少主服务器开销，提升网页加载速度。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">现在，各种公益cdn服务蓬勃生长，其节点通常是全球部署，并且对各个国家/地区做了优化，使用公益cdn，他的质量和可用性是远远大于自己部署的。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">在一个网页加载中，主网页只提供一个html（你所看的网页其大小约<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">15kb</code>），而流量开销巨头是静态资源（只论js，本页大约<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">800kb</code>）。我们对一个网站的加速，第一步就应当从静态加速做起。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">对于加速存储的选择，通常市面上有三种主流加速<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">cdnjs</code>/<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">npm</code>/<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">gh</code>。而在这其中，对于个人而言，我还是推崇<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">npm</code>，这在接下来对于竞速节点的选择就多了起来。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">对于加速节点的选择，从mainland角度来讲，首先你要遵循一个普世结论：<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">不要用跨国节点</code>。本身China国度就有个奇葩规定，没有ICP备案许可就不得在mainland开展网站服务。这使得大部分本应该分散在边缘末端的流量全压到了国际出口的汇聚层。你再引导他们去海外拉资源，凑过去挤热闹，其稳定性和速率完全无法保证，这在生产环境使用无异于自杀。这里提一嘴jsdelivr，备案掉了，节点迁出中国了，那你面向国内的网站早就可以切了。使用fastly，联通和电信晚上ntt几乎堵到妈都不认识，能连上就是奇迹。除非你真的不在意加速，也不在意资源能不能正常加载，在面向mainland的生产环境里还坚持jsd就是愚不可及的行为。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">当然，在这里我还是推崇黑科技<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">ServiceWorker</code>，它可以利用<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">Promise.any</code>，并发数个请求至不同的cdn节点，提升前端资源加载。而借助于强大的js引擎，其在本地处理的效率奇高，性能折损几乎不计。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">在这之前，我们定义一个<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">lfetch</code>，它的作用是对<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">urls</code>这个数组里的所有网址发起并发请求，并且在任意一个节点返回正常值时<strong style="box-sizing:border-box;font-weight:700;">打断</strong>其余请求，避免流量浪费。</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> lfetch = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span> (urls, url) =&gt; {
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">let</span> controller = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> AbortController(); <span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//针对此次请求新建一个AbortController,用于打断并发的其余请求</span>
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> PauseProgress = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span> (res) =&gt; {
        <span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//这个函数的作用时阻塞响应,直到主体被完整下载,避免被提前打断</span>
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> Response(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">await</span> (res).arrayBuffer(), { <span style="box-sizing:border-box;color:rgb(156, 220, 254);">status</span>: res.status, <span style="box-sizing:border-box;color:rgb(156, 220, 254);">headers</span>: res.headers });
    };
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (!<span style="box-sizing:border-box;color:rgb(78, 201, 176);">Promise</span>.any) { <span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//Polyfill,避免Promise.any不存在,无需关注</span>
        <span style="box-sizing:border-box;color:rgb(78, 201, 176);">Promise</span>.any = <span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">function</span> (<span style="box-sizing:border-box;color:rgb(220, 220, 220);">promises</span>) </span>{
            <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> <span style="box-sizing:border-box;color:rgb(78, 201, 176);">Promise</span>(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">resolve, reject</span>) =&gt;</span> {
                promises = <span style="box-sizing:border-box;color:rgb(78, 201, 176);">Array</span>.isArray(promises) ? promises : []
                <span style="box-sizing:border-box;color:rgb(86, 156, 214);">let</span> len = promises.length
                <span style="box-sizing:border-box;color:rgb(86, 156, 214);">let</span> errs = []
                <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (len === <span style="box-sizing:border-box;color:rgb(184, 215, 163);">0</span>) <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> reject(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> AggregateError(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'All promises were rejected'</span>))
                promises.forEach(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">promise</span>) =&gt;</span> {
                    promise.then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">value</span> =&gt;</span> {
                        resolve(value)
                    }, err =&gt; {
                        len--
                        errs.push(err)
                        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (len === <span style="box-sizing:border-box;color:rgb(184, 215, 163);">0</span>) {
                            reject(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> AggregateError(errs))
                        }
                    })
                })
            })
        }
    }
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> <span style="box-sizing:border-box;color:rgb(78, 201, 176);">Promise</span>.any(urls.map(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">urls</span> =&gt;</span> {<span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//并发请求</span>
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> <span style="box-sizing:border-box;color:rgb(78, 201, 176);">Promise</span>(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">resolve, reject</span>) =&gt;</span> {
            fetch(urls, {
                <span style="box-sizing:border-box;color:rgb(156, 220, 254);">signal</span>: controller.signal<span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//设置打断点</span>
            })
                .then(PauseProgress)<span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//阻塞当前响应直到下载完成</span>
                .then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">res</span> =&gt;</span> {
                    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (res.status == <span style="box-sizing:border-box;color:rgb(184, 215, 163);">200</span>) {
                        controller.abort()<span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//打断其余响应(同时也打断了自己的,但本身自己已下载完成,打断无效)</span>
                        resolve(res)<span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//返回</span>
                    } <span style="box-sizing:border-box;color:rgb(86, 156, 214);">else</span> {
                        reject(res)
                    }
                })
        })
    }))
}</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">在这其中，有一个难点：<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">fetch</code>返回的时状态而非内容。<br style="box-sizing:border-box;"/>即当<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">fetch</code>的<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">Promise resolve</code>时，它是已经获得了响应，但此时内容还没下载，提前打断会导致无法返回。这是<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">PauseProgress</code>作用。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">之后我们考虑静态资源加速。这时候用npm的好处就体现出来了，不仅镜像多，其格式也还算固定。</p><blockquote style="box-sizing:border-box;margin:0px;margin-top:0px;margin-bottom:16px;padding:0px 1em;border-left:0.25em solid rgb(223, 226, 229);color:rgb(113, 128, 150);"><p style="box-sizing:border-box;margin-top:0px;margin-bottom:0px;">注意，此方法是以流量换速度的方式进行的，虽然在任何一个节点返回正确内容后会打断其余请求，但依然会造成不可避免的流量消耗(+~20%)。如果你面向的是手机流量用户，请三思而后行！</p></blockquote><blockquote style="box-sizing:border-box;margin:0px;margin-top:0px;margin-bottom:16px;padding:0px 1em;border-left:0.25em solid rgb(223, 226, 229);color:rgb(113, 128, 150);"><p style="box-sizing:border-box;margin-top:0px;margin-bottom:0px;">此代码与<a href="https://github.com/EtherDream/freecdn-js" rel="noopener" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" target="_blank">freecdn-js</a>核心功能相似，但实现方法并不同，并且完全支持动态网页。</p></blockquote><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">例如jquery，你可以这样加速：</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;">原始地址:
<span style="box-sizing:border-box;color:rgb(86, 156, 214);">https:</span>//cdn.jsdelivr.net/npm/jquery<span style="box-sizing:border-box;color:rgb(220, 220, 220);">@3</span><span style="box-sizing:border-box;color:rgb(184, 215, 163);">.6</span><span style="box-sizing:border-box;color:rgb(184, 215, 163);">.0</span>
各类镜像：
<span style="box-sizing:border-box;color:rgb(86, 156, 214);">https:</span>//fastly.jsdelivr.net/npm/jquery<span style="box-sizing:border-box;color:rgb(220, 220, 220);">@3</span><span style="box-sizing:border-box;color:rgb(184, 215, 163);">.6</span><span style="box-sizing:border-box;color:rgb(184, 215, 163);">.0</span>
<span style="box-sizing:border-box;color:rgb(86, 156, 214);">https:</span>//gcore.jsdelivr.net/npm/jquery<span style="box-sizing:border-box;color:rgb(220, 220, 220);">@3</span><span style="box-sizing:border-box;color:rgb(184, 215, 163);">.6</span><span style="box-sizing:border-box;color:rgb(184, 215, 163);">.0</span>
<span style="box-sizing:border-box;color:rgb(86, 156, 214);">https:</span>//unpkg.com/jquery<span style="box-sizing:border-box;color:rgb(220, 220, 220);">@3</span><span style="box-sizing:border-box;color:rgb(184, 215, 163);">.6</span><span style="box-sizing:border-box;color:rgb(184, 215, 163);">.0</span>
<span style="box-sizing:border-box;color:rgb(86, 156, 214);">https:</span>//unpkg.zhimg.com/jquery<span style="box-sizing:border-box;color:rgb(220, 220, 220);">@3</span><span style="box-sizing:border-box;color:rgb(184, 215, 163);">.6</span><span style="box-sizing:border-box;color:rgb(184, 215, 163);">.0</span> <span style="box-sizing:border-box;color:rgb(155, 155, 155);">#回源有问题</span>
<span style="box-sizing:border-box;color:rgb(86, 156, 214);">https:</span>//unpkg.com/jquery<span style="box-sizing:border-box;color:rgb(220, 220, 220);">@3</span><span style="box-sizing:border-box;color:rgb(184, 215, 163);">.6</span><span style="box-sizing:border-box;color:rgb(184, 215, 163);">.0</span>
<span style="box-sizing:border-box;color:rgb(86, 156, 214);">https:</span>//npm.elemecdn.com/jquery<span style="box-sizing:border-box;color:rgb(220, 220, 220);">@3</span><span style="box-sizing:border-box;color:rgb(184, 215, 163);">.6</span><span style="box-sizing:border-box;color:rgb(184, 215, 163);">.0</span>
<span style="box-sizing:border-box;color:rgb(86, 156, 214);">https:</span>//npm.sourcegcdn.com/jquery<span style="box-sizing:border-box;color:rgb(220, 220, 220);">@3</span><span style="box-sizing:border-box;color:rgb(184, 215, 163);">.6</span><span style="box-sizing:border-box;color:rgb(184, 215, 163);">.0</span> <span style="box-sizing:border-box;color:rgb(155, 155, 155);">#滥用封仓库</span>
<span style="box-sizing:border-box;color:rgb(86, 156, 214);">https:</span>//cdn1.tianli0.top/jquery<span style="box-sizing:border-box;color:rgb(220, 220, 220);">@3</span><span style="box-sizing:border-box;color:rgb(184, 215, 163);">.6</span><span style="box-sizing:border-box;color:rgb(184, 215, 163);">.0</span> <span style="box-sizing:border-box;color:rgb(155, 155, 155);">#滥用封仓库</span></code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">我们可以简单搓一个sw小脚本完成前端加速：</p><div style="display:block;box-sizing:border-box;margin-top:0px;margin-bottom:16px;cursor:pointer;"><div style="box-sizing:border-box;display:list-item;cursor:pointer;outline:0px;">ServiceWorker完整代码：</div><div style="display:block;box-sizing:border-box;margin-top:0px;margin-bottom:16px;cursor:pointer;"><div style="box-sizing:border-box;display:list-item;cursor:pointer;outline:0px;">我已经很详细的看了上面的阐述，并且我不会直接照搬</div><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> CACHE_NAME = <span style="box-sizing:border-box;color:rgb(214, 157, 133);">'ICDNCache'</span>;
<span style="box-sizing:border-box;color:rgb(86, 156, 214);">let</span> cachelist = [];
self.addEventListener(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'install'</span>, <span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span> <span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">function</span> (<span style="box-sizing:border-box;color:rgb(220, 220, 220);">installEvent</span>) </span>{
    self.skipWaiting();
    installEvent.waitUntil(
        caches.open(CACHE_NAME)
            .then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">function</span> (<span style="box-sizing:border-box;color:rgb(220, 220, 220);">cache</span>) </span>{
                <span style="box-sizing:border-box;color:rgb(78, 201, 176);">console</span>.log(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'Opened cache'</span>);
                <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> cache.addAll(cachelist);
            })
    );
});
self.addEventListener(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'fetch'</span>, <span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span> event =&gt; {
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">try</span> {
        event.respondWith(handle(event.request))
    } <span style="box-sizing:border-box;color:rgb(86, 156, 214);">catch</span> (msg) {
        event.respondWith(handleerr(event.request, msg))
    }
});
<span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> handleerr = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span> (req, msg) =&gt; {
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> Response(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">`&lt;h1&gt;CDN分流器遇到了致命错误&lt;/h1&gt;
    &lt;b&gt;<span style="box-sizing:border-box;color:rgb(220, 220, 220);">${msg}</span>&lt;/b&gt;`</span>, { <span style="box-sizing:border-box;color:rgb(156, 220, 254);">headers</span>: { <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;content-type&quot;</span>: <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;text/html; charset=utf-8&quot;</span> } })
}
<span style="box-sizing:border-box;color:rgb(86, 156, 214);">let</span> cdn = {<span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//镜像列表</span>
    <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;gh&quot;</span>: {
        <span style="box-sizing:border-box;color:rgb(156, 220, 254);">jsdelivr</span>: {
            <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;url&quot;</span>: <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;https://cdn.jsdelivr.net/gh&quot;</span>
        },
        <span style="box-sizing:border-box;color:rgb(156, 220, 254);">jsdelivr_fastly</span>: {
            <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;url&quot;</span>: <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;https://fastly.jsdelivr.net/gh&quot;</span>
        },
        <span style="box-sizing:border-box;color:rgb(156, 220, 254);">jsdelivr_gcore</span>: {
            <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;url&quot;</span>: <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;https://gcore.jsdelivr.net/gh&quot;</span>
        }
    },
    <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;combine&quot;</span>: {
        <span style="box-sizing:border-box;color:rgb(156, 220, 254);">jsdelivr</span>: {
            <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;url&quot;</span>: <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;https://cdn.jsdelivr.net/combine&quot;</span>
        },
        <span style="box-sizing:border-box;color:rgb(156, 220, 254);">jsdelivr_fastly</span>: {
            <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;url&quot;</span>: <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;https://fastly.jsdelivr.net/combine&quot;</span>
        },
        <span style="box-sizing:border-box;color:rgb(156, 220, 254);">jsdelivr_gcore</span>: {
            <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;url&quot;</span>: <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;https://gcore.jsdelivr.net/combine&quot;</span>
        }
    },
    <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;npm&quot;</span>: {
        <span style="box-sizing:border-box;color:rgb(156, 220, 254);">eleme</span>: {
            <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;url&quot;</span>: <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;https://npm.elemecdn.com&quot;</span>
        },
        <span style="box-sizing:border-box;color:rgb(156, 220, 254);">jsdelivr</span>: {
            <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;url&quot;</span>: <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;https://cdn.jsdelivr.net/npm&quot;</span>
        },
        <span style="box-sizing:border-box;color:rgb(156, 220, 254);">zhimg</span>: {
            <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;url&quot;</span>: <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;https://unpkg.zhimg.com&quot;</span>
        },
        <span style="box-sizing:border-box;color:rgb(156, 220, 254);">unpkg</span>: {
            <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;url&quot;</span>: <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;https://unpkg.com&quot;</span>
        },
        <span style="box-sizing:border-box;color:rgb(156, 220, 254);">bdstatic</span>: {
            <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;url&quot;</span>: <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;https://code.bdstatic.com/npm&quot;</span>
        },
        <span style="box-sizing:border-box;color:rgb(156, 220, 254);">tianli</span>: {
            <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;url&quot;</span>: <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;https://cdn1.tianli0.top/npm&quot;</span>
        },
        <span style="box-sizing:border-box;color:rgb(156, 220, 254);">sourcegcdn</span>: {
            <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;url&quot;</span>: <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;https://npm.sourcegcdn.com/npm&quot;</span>
        }

    }
}
<span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//主控函数</span>
<span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> handle = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span> <span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">function</span> (<span style="box-sizing:border-box;color:rgb(220, 220, 220);">req</span>) </span>{
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> urlStr = req.url
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> domain = (urlStr.split(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'/'</span>))[<span style="box-sizing:border-box;color:rgb(184, 215, 163);">2</span>]
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">let</span> urls = []
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">for</span> (<span style="box-sizing:border-box;color:rgb(86, 156, 214);">let</span> i <span style="box-sizing:border-box;color:rgb(86, 156, 214);">in</span> cdn) {
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">for</span> (<span style="box-sizing:border-box;color:rgb(86, 156, 214);">let</span> j <span style="box-sizing:border-box;color:rgb(86, 156, 214);">in</span> cdn[i]) {
            <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (domain == cdn[i][j].url.split(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'https://'</span>)[<span style="box-sizing:border-box;color:rgb(184, 215, 163);">1</span>].split(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'/'</span>)[<span style="box-sizing:border-box;color:rgb(184, 215, 163);">0</span>] &amp;&amp; urlStr.match(cdn[i][j].url)) {
                urls = []
                <span style="box-sizing:border-box;color:rgb(86, 156, 214);">for</span> (<span style="box-sizing:border-box;color:rgb(86, 156, 214);">let</span> k <span style="box-sizing:border-box;color:rgb(86, 156, 214);">in</span> cdn[i]) {
                    urls.push(urlStr.replace(cdn[i][j].url, cdn[i][k].url))
                }
                <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (urlStr.indexOf(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'@latest/'</span>) &gt; <span style="box-sizing:border-box;color:rgb(184, 215, 163);">-1</span>) {
                    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> lfetch(urls, urlStr)
                } <span style="box-sizing:border-box;color:rgb(86, 156, 214);">else</span> {
                    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> caches.match(req).then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">function</span> (<span style="box-sizing:border-box;color:rgb(220, 220, 220);">resp</span>) </span>{
                        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> resp || lfetch(urls, urlStr).then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">function</span> (<span style="box-sizing:border-box;color:rgb(220, 220, 220);">res</span>) </span>{
                            <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> caches.open(CACHE_NAME).then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">function</span> (<span style="box-sizing:border-box;color:rgb(220, 220, 220);">cache</span>) </span>{
                                cache.put(req, res.clone());
                                <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> res;
                            });
                        });
                    })
                }
            }
        }
    }
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> fetch(req)
}
<span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> lfetch = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span> (urls, url) =&gt; {
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">let</span> controller = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> AbortController();
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> PauseProgress = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span> (res) =&gt; {
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> Response(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">await</span> (res).arrayBuffer(), { <span style="box-sizing:border-box;color:rgb(156, 220, 254);">status</span>: res.status, <span style="box-sizing:border-box;color:rgb(156, 220, 254);">headers</span>: res.headers });
    };
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (!<span style="box-sizing:border-box;color:rgb(78, 201, 176);">Promise</span>.any) {
        <span style="box-sizing:border-box;color:rgb(78, 201, 176);">Promise</span>.any = <span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">function</span> (<span style="box-sizing:border-box;color:rgb(220, 220, 220);">promises</span>) </span>{
            <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> <span style="box-sizing:border-box;color:rgb(78, 201, 176);">Promise</span>(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">resolve, reject</span>) =&gt;</span> {
                promises = <span style="box-sizing:border-box;color:rgb(78, 201, 176);">Array</span>.isArray(promises) ? promises : []
                <span style="box-sizing:border-box;color:rgb(86, 156, 214);">let</span> len = promises.length
                <span style="box-sizing:border-box;color:rgb(86, 156, 214);">let</span> errs = []
                <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (len === <span style="box-sizing:border-box;color:rgb(184, 215, 163);">0</span>) <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> reject(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> AggregateError(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'All promises were rejected'</span>))
                promises.forEach(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">promise</span>) =&gt;</span> {
                    promise.then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">value</span> =&gt;</span> {
                        resolve(value)
                    }, err =&gt; {
                        len--
                        errs.push(err)
                        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (len === <span style="box-sizing:border-box;color:rgb(184, 215, 163);">0</span>) {
                            reject(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> AggregateError(errs))
                        }
                    })
                })
            })
        }
    }
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> <span style="box-sizing:border-box;color:rgb(78, 201, 176);">Promise</span>.any(urls.map(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">urls</span> =&gt;</span> {
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> <span style="box-sizing:border-box;color:rgb(78, 201, 176);">Promise</span>(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">resolve, reject</span>) =&gt;</span> {
            fetch(urls, {
                <span style="box-sizing:border-box;color:rgb(156, 220, 254);">signal</span>: controller.signal
            })
                .then(PauseProgress)
                .then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">res</span> =&gt;</span> {
                    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (res.status == <span style="box-sizing:border-box;color:rgb(184, 215, 163);">200</span>) {
                        controller.abort();
                        resolve(res)
                    } <span style="box-sizing:border-box;color:rgb(86, 156, 214);">else</span> {
                        reject(res)
                    }
                })
        })
    }))
}</code></pre></div></div></div><h1 style="margin:0.67em 0px;box-sizing:border-box;line-height:1.25;font-size:2em;padding-bottom:0.3em;border-bottom:1px solid rgb(234, 236, 239);color:rgb(26, 32, 44);font-weight:700;margin-top:2em;margin-bottom:0.75em;"><a href="https://blog.cyfan.top/p/d3c51290.html#%E5%85%A8%E7%AB%99NPM%E9%9D%99%E6%80%81%E5%8C%96" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="全站NPM静态化"></a>全站NPM静态化</h1><blockquote style="box-sizing:border-box;margin:0px;margin-top:0px;margin-bottom:16px;padding:0px 1em;border-left:0.25em solid rgb(223, 226, 229);color:rgb(113, 128, 150);"><p style="box-sizing:border-box;margin-top:0px;margin-bottom:0px;">此法chen独创，是一种比较野路子的手法，但加速效果显著。<br style="box-sizing:border-box;"/>通常建议用于Hexo等静态博客，WordPress等需要做好伪静态，并且要配置好动态接口。</p></blockquote><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">hexo作为静态博客有什么好处，那当然是纯静态啦。生成的静态文件随便搬到一个web服务器都能用。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">自然就有了接下的骚操作，用npm托管博客，然后在请求的时候用sw劫持并引流到npm镜像，效果就如同本博客所示，加载速度（抛开首屏不谈）接近于闪开。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">首先我博客的CI是用GithubAction的，在部署的过程中顺便把html上传到npm是最简单不过的事情，只要在生成代码块后面再加一块：</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(215, 186, 125);">-</span> <span style="box-sizing:border-box;color:rgb(156, 220, 254);">uses:</span> <span style="box-sizing:border-box;color:rgb(214, 157, 133);">JS-DevTools/npm-publish@v1</span>
  <span style="box-sizing:border-box;color:rgb(156, 220, 254);">with:</span>
    <span style="box-sizing:border-box;color:rgb(156, 220, 254);">token:</span> <span style="box-sizing:border-box;color:rgb(214, 157, 133);">${{</span> <span style="box-sizing:border-box;color:rgb(214, 157, 133);">secrets.NPM</span> <span style="box-sizing:border-box;color:rgb(214, 157, 133);">}}</span></code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">配置<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">NPM</code>环境变量，之后需要更新的时候叠一个新版本就行。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">然后接下来我们就要解决ServiceWorker获取问题。我们先设立一个监听器：</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;">self.addEventListener(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'fetch'</span>, <span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span> event =&gt; {
    event.respondWith(handle(event.request))
});
<span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> handle = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span>(req)=&gt;{
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> urlStr = req.url
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> urlObj = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> URL(urlStr);
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> urlPath = urlObj.pathname;
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> domain = urlObj.hostname;
    <span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//从这里开始</span>
}</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">首先我们要判断一下这个域名是不是博客主域名,不然瞎拦截到其他地方可不好:</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span>(domain === <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;blog.cyfan.top&quot;</span>){<span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//这里写你需要拦截的域名</span>
    <span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//从这里开始处理</span>
}</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">我们还要记得给url进行提前处理，剥离出路径，去除参数。在这其中尤其要注意的是默认路由的处理。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">通常情况下我们访问一个网址，web服务器会在后面添加<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">.html</code>后缀。对于一个默认路径则是<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">index.html</code>。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">还要注意的是剥离<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">#</code>，不然又会获取失败。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">定义一个<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">fullpath</code>函数，用于预处理和剥离路径：</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> fullpath = <span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">path</span>) =&gt;</span> {
    path = path.split(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'?'</span>)[<span style="box-sizing:border-box;color:rgb(184, 215, 163);">0</span>].split(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'#'</span>)[<span style="box-sizing:border-box;color:rgb(184, 215, 163);">0</span>]
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (path.match(<span style="box-sizing:border-box;color:rgb(154, 83, 52);">//$/</span>)) {
        path += <span style="box-sizing:border-box;color:rgb(214, 157, 133);">'index'</span>
    }
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (!path.match(<span style="box-sizing:border-box;color:rgb(154, 83, 52);">/.[a-zA-Z]+$/</span>)) {
        path += <span style="box-sizing:border-box;color:rgb(214, 157, 133);">'.html'</span>
    }
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> path
}</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">结果类似于：</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;">&gt; fullpath('/')
'/index.html'
&gt; fullpath('/p/1')
'/p/1.html'
&gt; fullpath('/p/1?q=<span style="box-sizing:border-box;color:rgb(184, 215, 163);">1234</span>')
'/p/1.html'
&gt; fullpath('/p/1.html#QWERT')
'/p/1.html'</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">然后再定义一个镜像并发函数，用于生成待获取的网址：</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> generate_blog_urls = <span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">packagename, blogversion, path</span>) =&gt;</span> {
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> npmmirror = [
        <span style="box-sizing:border-box;color:rgb(214, 157, 133);">`https://unpkg.com/<span style="box-sizing:border-box;color:rgb(220, 220, 220);">${packagename}</span>@<span style="box-sizing:border-box;color:rgb(220, 220, 220);">${blogversion}</span>/public`</span>,
        <span style="box-sizing:border-box;color:rgb(214, 157, 133);">`https://npm.elemecdn.com/<span style="box-sizing:border-box;color:rgb(220, 220, 220);">${packagename}</span>@<span style="box-sizing:border-box;color:rgb(220, 220, 220);">${blogversion}</span>/public`</span>,
        <span style="box-sizing:border-box;color:rgb(214, 157, 133);">`https://cdn.jsdelivr.net/npm/<span style="box-sizing:border-box;color:rgb(220, 220, 220);">${packagename}</span>@<span style="box-sizing:border-box;color:rgb(220, 220, 220);">${blogversion}</span>/public`</span>,
        <span style="box-sizing:border-box;color:rgb(214, 157, 133);">`https://npm.sourcegcdn.com/npm/<span style="box-sizing:border-box;color:rgb(220, 220, 220);">${packagename}</span>@<span style="box-sizing:border-box;color:rgb(220, 220, 220);">${blogversion}</span>/public`</span>,
        <span style="box-sizing:border-box;color:rgb(214, 157, 133);">`https://cdn1.tianli0.top/npm/<span style="box-sizing:border-box;color:rgb(220, 220, 220);">${packagename}</span>@<span style="box-sizing:border-box;color:rgb(220, 220, 220);">${blogversion}</span>/public`</span>
    ]
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">for</span> (<span style="box-sizing:border-box;color:rgb(86, 156, 214);">var</span> i <span style="box-sizing:border-box;color:rgb(86, 156, 214);">in</span> npmmirror) {
        npmmirror[i] += path
    }
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> npmmirror
}</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">接下来我们将其填入主路由中:</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span>(domain === <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;blog.cyfan.top&quot;</span>){<span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//这里写你需要拦截的域名</span>
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> lfetch(generate_blog_urls(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'chenyfan-blog'</span>,<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'1.1.4'</span>,fullpath(urlPath)))
}</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">然而谨记,npm返回的文件格式通常是text而非html，所以我们还要进一步处理header。处理也简单，连环then下去就行：</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span>(domain === <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;blog.cyfan.top&quot;</span>){
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> lfetch(generate_blog_urls(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'chenyfan-blog'</span>,<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'1.1.4'</span>,fullpath(urlPath)))
    .then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">res</span>=&gt;</span>res.arrayBuffer())<span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//arrayBuffer最科学也是最快的返回</span>
    .then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">buffer</span>=&gt;</span><span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> Response(buffer,{<span style="box-sizing:border-box;color:rgb(156, 220, 254);">headers</span>:{<span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;Content-Type&quot;</span>:<span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;text/html;charset=utf-8&quot;</span>}}))<span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//重新定义header</span>
}</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">那么接下来，除了首屏以外，你的网站相当于托管在全球(包括中国)各个主流cdn服务器中，提速效果无与伦比.如果你将原网站托管在cf，那么你将获得一个打不死，国内加载速度超快(首屏除外)的网站。</p><h2 style="box-sizing:border-box;line-height:1.25;padding-bottom:0.3em;border-bottom:1px solid rgb(234, 236, 239);font-size:1.5em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/d3c51290.html#%E8%A7%A3%E6%94%BE%E5%8F%8C%E6%89%8B-npm%E7%89%88%E6%9C%AC%E8%87%AA%E5%AE%9A%E4%B9%89%E6%9B%B4%E6%96%B0" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="解放双手 - npm版本自定义更新"></a>解放双手 - npm版本自定义更新</h2><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">有人会问了，我为什么不能直接用latest来获取最新版本，还要手动指定？</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">简单地说，在生产环境中用@latest指定最新版本是一个很不合理、且非常愚蠢的操作。你永远都不知道对面的缓存什么时候清除，获取到的可能是一年前的版本。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">为了节约成本，避免回源，cdn服务商通常会缓存资源，尤其是那些静态资源。以jsd为例，其latest缓存为7天，不过可以手动刷新。unpkg cf边缘2星期，eleme已经将近6个月没更新了。至于那些自建的。你根本搞不懂他什么时候更新，使用latest会导致随机获取到版本，接近无法正常使用。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">而指定版本的，cdn通常会永久缓存。毕竟版本定死了东西是不会变的，而请求指定版本的cdn也可以或多或少提升访问速度，因为文件时永久缓存的，HIT的热度比较高。</p><h3 style="box-sizing:border-box;line-height:1.25;font-size:1.25em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/d3c51290.html#sw%E7%AB%AF" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="sw端"></a>sw端</h3><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">利用npm registry获取最新版本，其官方endpoint如下：</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;">https://registry.npmjs.org/chenyfan-blog/latest</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">其version字段即最新版本。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">npm registry的镜像也不少，以腾讯/阿里为例：</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;">https://registry.npmmirror.com/chenyfan/latest #阿里，可手动同步
https://mirrors.cloud.tencent.com/npm/chenyfan/latest #腾讯，每日凌晨同步</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">获取最新版本也不难:</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> mirror = [
        <span style="box-sizing:border-box;color:rgb(214, 157, 133);">`https://registry.npmmirror.com/chenyfan-blog/latest`</span>,
        <span style="box-sizing:border-box;color:rgb(214, 157, 133);">`https://registry.npmjs.org/chenyfan-blog/latest`</span>,
        <span style="box-sizing:border-box;color:rgb(214, 157, 133);">`https://mirrors.cloud.tencent.com/npm/chenyfan-blog/latest`</span>
]
<span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> get_newest_version = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span> (mirror) =&gt; {
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> lfetch(mirror, mirror[<span style="box-sizing:border-box;color:rgb(184, 215, 163);">0</span>])
        .then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">res</span> =&gt;</span> res.json())
        .then(res.version)
}</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">在这里还有一个坑点：ServiceWorker的全局变量会在所有页面关闭后销毁。下次启动时会优先响应handle，其定义变量要在handle响应后才会执行。因此，对于最新版本的存储，不能直接定义变量，需要持久化，这里另辟蹊径，采用CacheStorage存储：</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;">self.db = { <span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//全局定义db,只要read和write,看不懂可以略过</span>
    <span style="box-sizing:border-box;color:rgb(156, 220, 254);">read</span>: <span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">key, config</span>) =&gt;</span> {
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (!config) { config = { <span style="box-sizing:border-box;color:rgb(156, 220, 254);">type</span>: <span style="box-sizing:border-box;color:rgb(214, 157, 133);">&quot;text&quot;</span> } }
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> <span style="box-sizing:border-box;color:rgb(78, 201, 176);">Promise</span>(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">resolve, reject</span>) =&gt;</span> {
            caches.open(CACHE_NAME).then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">cache</span> =&gt;</span> {
                cache.match(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> Request(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">`https://LOCALCACHE/<span style="box-sizing:border-box;color:rgb(220, 220, 220);">${<span style="box-sizing:border-box;color:rgb(78, 201, 176);">encodeURIComponent</span>(key)}</span>`</span>)).then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">function</span> (<span style="box-sizing:border-box;color:rgb(220, 220, 220);">res</span>) </span>{
                    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (!res) resolve(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">null</span>)
                    res.text().then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">text</span> =&gt;</span> resolve(text))
                }).catch(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">()</span> =&gt;</span> {
                    resolve(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">null</span>)
                })
            })
        })
    },
    <span style="box-sizing:border-box;color:rgb(156, 220, 254);">write</span>: <span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">key, value</span>) =&gt;</span> {
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> <span style="box-sizing:border-box;color:rgb(78, 201, 176);">Promise</span>(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">(<span style="box-sizing:border-box;color:rgb(220, 220, 220);">resolve, reject</span>) =&gt;</span> {
            caches.open(CACHE_NAME).then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">function</span> (<span style="box-sizing:border-box;color:rgb(220, 220, 220);">cache</span>) </span>{
                cache.put(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> Request(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">`https://LOCALCACHE/<span style="box-sizing:border-box;color:rgb(220, 220, 220);">${<span style="box-sizing:border-box;color:rgb(78, 201, 176);">encodeURIComponent</span>(key)}</span>`</span>), <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> Response(value));
                resolve()
            }).catch(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">()</span> =&gt;</span> {
                reject()
            })
        })
    }
}

<span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> set_newest_version = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span> (mirror) =&gt; { <span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//改为最新版本写入数据库</span>
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> lfetch(mirror, mirror[<span style="box-sizing:border-box;color:rgb(184, 215, 163);">0</span>])
        .then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">res</span> =&gt;</span> res.json()) <span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//JSON Parse</span>
        .then(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span> res =&gt; {
            <span style="box-sizing:border-box;color:rgb(86, 156, 214);">await</span> db.write(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'blog_version'</span>, res.version) <span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//写入</span>
            <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span>;
        })
}

setInterval(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span>() =&gt; {
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">await</span> set_newest_version(mirror) <span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//定时更新,一分钟一次</span>
}, <span style="box-sizing:border-box;color:rgb(184, 215, 163);">60</span>*<span style="box-sizing:border-box;color:rgb(184, 215, 163);">1000</span>);

setTimeout(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span>() =&gt; { 
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">await</span> set_newest_version(mirror)<span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//打开五秒后更新,避免堵塞</span>
},<span style="box-sizing:border-box;color:rgb(184, 215, 163);">5000</span>)</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">再将上面的生成urls从:</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;">generate_blog_urls(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'chenyfan-blog'</span>,<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'1.1.4'</span>,fullpath(urlPath))</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">改为</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//若第一次没有,则使用初始版本1.1.4,或者你也可以改成latest(不推荐)</span>
generate_blog_urls(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'chenyfan-blog'</span>,<span style="box-sizing:border-box;color:rgb(86, 156, 214);">await</span> db.read(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'blog_version'</span>) || <span style="box-sizing:border-box;color:rgb(214, 157, 133);">'1.1.4'</span>,fullpath(urlPath))</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">此后用户加载时，会尽可能的获取最新版本，无需手动更新。</p><h3 style="box-sizing:border-box;line-height:1.25;font-size:1.25em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/d3c51290.html#ci%E7%AB%AF" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="ci端"></a>ci端</h3><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">有了前端自动更新，我们在上传包的时候还要手动更新<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">package.json</code>中的version字段。其实这里也可以直接交给ci处理。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">然而需要注意，<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">npm version patch</code> 虽然能更新z位数版本，但其更新不会上传到仓库。换句话说，这只能上传一次。因此这个地方我干脆建议用随机数，反正通过api获得的latest都是最新的上传。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">案例代码这里不展示，实际上这一步做起来也不难。</p><h1 style="margin:0.67em 0px;box-sizing:border-box;line-height:1.25;font-size:2em;padding-bottom:0.3em;border-bottom:1px solid rgb(234, 236, 239);color:rgb(26, 32, 44);font-weight:700;margin-top:2em;margin-bottom:0.75em;"><a href="https://blog.cyfan.top/p/d3c51290.html#%E8%B0%83%E5%89%82%E5%93%8D%E5%BA%94" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="调剂响应"></a>调剂响应</h1><h2 style="box-sizing:border-box;line-height:1.25;padding-bottom:0.3em;border-bottom:1px solid rgb(234, 236, 239);font-size:1.5em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/d3c51290.html#%E7%BC%93%E5%AD%98-%E4%BA%92%E8%81%94%E7%BD%91%E4%B8%8A%E4%B8%80%E4%BC%9F%E5%A4%A7%E5%8F%91%E6%98%8E" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="缓存 - 互联网上一伟大发明"></a>缓存 - 互联网上一伟大发明</h2><blockquote style="box-sizing:border-box;margin:0px;margin-top:0px;margin-bottom:16px;padding:0px 1em;border-left:0.25em solid rgb(223, 226, 229);color:rgb(113, 128, 150);"><p style="box-sizing:border-box;margin-top:0px;margin-bottom:0px;">虽然我也不清楚有一小部分人对那么丁点CacheStorage缓存占用那么敏感，但至少，缓存对网站加载速度的提升有极大的帮助。</p></blockquote><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">通常，有大量的资源是访问一个网站重复需要的，对于这些东西，浏览器会自带MemoryCache或DiskCache，但这一类缓存不是持久的，在下一次打开网站的时候缓存不一定生效。而CacheStorage是浏览器自带的缓存桶（Key/Value），这种桶是持久存储，长期有效，而sw是能控制这桶。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">而不同的网域资源所应当采取的缓存策略也是不一样的。对于确定版本的静态资源，直接终生缓存；对于有时限的静态资源，应当不缓存或只缓存一小段时间。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">CacheStorage不是sw专属的，你可以在前端和sw中同时控制它，这是几分样例代码：</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> CACHE_NAME = <span style="box-sizing:border-box;color:rgb(214, 157, 133);">'cache-v1'</span>; <span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//定义缓存桶名称</span>
caches.open(CACHE_NAME).then(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span> <span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">function</span> (<span style="box-sizing:border-box;color:rgb(220, 220, 220);">cache</span>) </span>{
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> KEYNAME = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> Request(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'https://example.com/1.xxx'</span>) <span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//定义KEY，[Object Request]</span>
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">await</span> cache.put(KEYNAME, <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> Response(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'Hello World'</span>)); <span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//自定义填入</span>
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">await</span> cache.match(KEYNAME).then(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span> <span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">function</span> (<span style="box-sizing:border-box;color:rgb(220, 220, 220);">response</span>) </span>{
        <span style="box-sizing:border-box;color:rgb(78, 201, 176);">console</span>.log(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">await</span> response.text()); <span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//匹配并输出</span>
    })
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">await</span> cache.put(KEYNAME, <span style="box-sizing:border-box;color:rgb(86, 156, 214);">await</span> fetch(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'https://example.com/2.xxx'</span>).then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">res</span>=&gt;</span>res.arrayBuffer())); <span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//使用fetch填入缓存</span>
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">await</span> cache.matchAll().then(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">function</span> (<span style="box-sizing:border-box;color:rgb(220, 220, 220);">responses</span>) </span>{ <span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//列出所有（也可以根据内容列出指定的项</span>
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">for</span> (<span style="box-sizing:border-box;color:rgb(86, 156, 214);">let</span> response <span style="box-sizing:border-box;color:rgb(86, 156, 214);">of</span> responses) {
            <span style="box-sizing:border-box;color:rgb(78, 201, 176);">console</span>.log(response.url);
        }
    })
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">await</span> cache.delete(KEYNAME) <span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//删除指定项</span>
});</code></pre></div><h2 style="box-sizing:border-box;line-height:1.25;padding-bottom:0.3em;border-bottom:1px solid rgb(234, 236, 239);font-size:1.5em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/d3c51290.html#SetTimeout-%E6%AF%AB%E7%A7%92%E7%BA%A7%E8%B0%83%E6%8E%A7%E5%93%8D%E5%BA%94" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="SetTimeout - 毫秒级调控响应"></a>SetTimeout - 毫秒级调控响应</h2><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">对于同一个网页，你需要合理的对他执行决策树，这是目前我的博客[网页]采取的决策树:</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;"><a href="https://npm.elemecdn.com/chenyfan-os@0.0.0-r18/1.png" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);"><img src="SpeedUp!使用黑科技为你的网站提速  陈YFの博客(￣▽￣)_files/1.png" type="image/png" data-filename="1.png" height="422" style="vertical-align:middle;margin:0px auto;border-style:none;background-color:rgb(255, 255, 255);box-sizing:initial;object-fit:cover;max-width:90%;box-shadow:rgba(0, 0, 0, 0.18) 0px 5px 11px 0px, rgba(0, 0, 0, 0.15) 0px 4px 15px 0px;border-radius:3px;" width="696"/></a></p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">js里有两个对时间控制的古老函数：<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">SetTimeout</code>和<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">SetInterval</code>.在这里我采用<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">SetTimeout</code>,同时并行执行任务.</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">这里采用代码片段比较容易解释:</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (请求的网址是博客) {
    <span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//这里一定要用Promise,这样在之后settimeout就不需要回调,直接Resolve</span>
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">return</span> <span style="box-sizing:border-box;color:rgb(86, 156, 214);">new</span> <span style="box-sizing:border-box;color:rgb(78, 201, 176);">Promise</span>(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(86, 156, 214);">function</span> (<span style="box-sizing:border-box;color:rgb(220, 220, 220);">resolve, reject</span>) </span>{
        setTimeout(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span> () =&gt; {
            <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (存在缓存) {
                setTimeout(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">()</span> =&gt;</span> {
                    resolve(获取当前页面缓存(请求))
                }, <span style="box-sizing:border-box;color:rgb(184, 215, 163);">200</span>);<span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//200ms表示下面的拉取失败后直接返回缓存,但下面的拉取不会被踢出,更新会在后台执行,会填入缓存,但也不会返回</span>
                setTimeout(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">()</span> =&gt;</span> {
                    resolve(
                        拉取最新版本的网页(请求)
                            .then(填入缓存并返回内容)<span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//返回缓存</span>
                    )
                }, <span style="box-sizing:border-box;color:rgb(184, 215, 163);">0</span>);<span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//表示立刻执行,优先级最高</span>
            } <span style="box-sizing:border-box;color:rgb(86, 156, 214);">else</span> {
                setTimeout(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">()</span> =&gt;</span> {
                    resolve(
                        拉取最新版本的网页(请求)
                            .then(填入缓存并返回内容)<span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//返回缓存</span>
                    )
                }, <span style="box-sizing:border-box;color:rgb(184, 215, 163);">0</span>);<span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//表示立刻执行,优先级最高</span>

                setTimeout(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">()</span> =&gt;</span> {
                    resolve(返回错误提示())
                }, <span style="box-sizing:border-box;color:rgb(184, 215, 163);">5000</span>)<span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//5000ms后如果没有返回最新内容就直接返回错误提示,如果成功了此次返回是无效的</span>
            }
        }, <span style="box-sizing:border-box;color:rgb(184, 215, 163);">0</span>)<span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//这里需要一个大settimeout包裹以便于踢出主线程,否则无法并行处理</span>

    })
}</code></pre></div><h1 style="margin:0.67em 0px;box-sizing:border-box;line-height:1.25;font-size:2em;padding-bottom:0.3em;border-bottom:1px solid rgb(234, 236, 239);color:rgb(26, 32, 44);font-weight:700;margin-top:2em;margin-bottom:0.75em;"><a href="https://blog.cyfan.top/p/d3c51290.html#%E4%BC%98%E5%8C%96%E9%A6%96%E5%B1%8F" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="优化首屏"></a>优化首屏</h1><h2 style="box-sizing:border-box;line-height:1.25;padding-bottom:0.3em;border-bottom:1px solid rgb(234, 236, 239);font-size:1.5em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/d3c51290.html#window-stop-%E4%B8%8E%E6%AD%BB%E7%A5%9E%E6%93%A6%E8%82%A9%E8%80%8C%E8%BF%87" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="window.stop - 与死神擦肩而过"></a>window.stop - 与死神擦肩而过</h2><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">事实上，ServiceWorker最显著的缺点是要在第一次加载网页安装后，刷新一次才能激活。即访客第一次访问是不受sw控制的。换句话说，访客首屏不受加速，其加载速度与你的服务器有直接联系 <del style="box-sizing:border-box;">[虽然安装完成后就起飞了,但安装前就是屑]</del>。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">而本人未成年，浙江的规定又是未成年不得备案，在加上之后备案主题切换异常的麻烦。我的决定是至少高考前都不会备案。那这后果就很直接，我并不能使用国内的cdn节点。再加上我又没这个经济实力用香港CN2或拉iplc专线，对首屏服务器这一块优化其实能做的很少。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">更加令人抓狂的是，在首屏加载时，静态资源会被直接获取，并且不缓存，而sw激活后又会强制第二次获取，拉跨速度。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">不过我们可以尽可能弱化这一劣势。我们可以用js打断所有的请求，以确保首屏只加载一个html和一个sw.js，其余资源都不会加载，降低首屏加载延迟。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">我们尽可能将打断代码提到<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">&lt;head&gt;</code> 以确保不被其他资源堵塞，对于hexo来说打开主题的<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">head.ejs</code>，在<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">&lt;head&gt;</code>标签靠前的位置中加入：</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;">(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span> () =&gt; {<span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//使用匿名函数确保body已载入</span>
    <span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">/*
    ChenBlogHelper_Set 存储在LocalStorage中,用于指示sw安装状态
    0 或不存在 未安装
    1 已打断
    2 已安装
    3 已激活,并且已缓存必要的文件(此处未写出,无需理会)
    */</span>
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">const</span> $ = <span style="box-sizing:border-box;color:rgb(78, 201, 176);">document</span>.querySelector.bind(<span style="box-sizing:border-box;color:rgb(78, 201, 176);">document</span>);<span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//语法糖</span>
    <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'serviceWorker'</span> <span style="box-sizing:border-box;color:rgb(86, 156, 214);">in</span> navigator) { <span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//如果支持sw</span>
        <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (<span style="box-sizing:border-box;color:rgb(78, 201, 176);">Number</span>(<span style="box-sizing:border-box;color:rgb(78, 201, 176);">window</span>.localStorage.getItem(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'ChenBlogHelper_Set'</span>)) &lt; <span style="box-sizing:border-box;color:rgb(184, 215, 163);">1</span>) {
            <span style="box-sizing:border-box;color:rgb(78, 201, 176);">window</span>.localStorage.setItem(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'ChenBlogHelper_Set'</span>, <span style="box-sizing:border-box;color:rgb(184, 215, 163);">1</span>)
            <span style="box-sizing:border-box;color:rgb(78, 201, 176);">window</span>.stop()
            <span style="box-sizing:border-box;color:rgb(78, 201, 176);">document</span>.write(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'Wait'</span>)
        }
        navigator.serviceWorker.register(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">`/sw.js?time=<span style="box-sizing:border-box;color:rgb(220, 220, 220);">${ranN(<span style="box-sizing:border-box;color:rgb(184, 215, 163);">1</span>, <span style="box-sizing:border-box;color:rgb(184, 215, 163);">88888888888888888888</span>)}</span>`</span>)<span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//随机数,强制更新</span>
            .then(<span style="box-sizing:border-box;color:rgb(86, 156, 214);">async</span> () =&gt; {
                <span style="box-sizing:border-box;color:rgb(86, 156, 214);">if</span> (<span style="box-sizing:border-box;color:rgb(78, 201, 176);">Number</span>(<span style="box-sizing:border-box;color:rgb(78, 201, 176);">window</span>.localStorage.getItem(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'ChenBlogHelper_Set'</span>)) &lt; <span style="box-sizing:border-box;color:rgb(184, 215, 163);">2</span>) {
                    setTimeout(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">()</span> =&gt;</span> {
                        <span style="box-sizing:border-box;color:rgb(78, 201, 176);">window</span>.localStorage.setItem(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'ChenBlogHelper_Set'</span>, <span style="box-sizing:border-box;color:rgb(184, 215, 163);">2</span>)
                        <span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//window.location.search = `?time=${ranN(1, 88888888888888888888)}` //已弃用,在等待500ms安装成功后直接刷新没有问题</span>
                        <span style="box-sizing:border-box;color:rgb(78, 201, 176);">window</span>.location.reload()<span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//刷新,以载入sw</span>
                    }, <span style="box-sizing:border-box;color:rgb(184, 215, 163);">500</span>)<span style="box-sizing:border-box;color:rgb(87, 166, 74);font-style:italic;">//安装后等待500ms使其激活</span>
                }
            })
            .catch(<span style="box-sizing:border-box;color:rgb(220, 220, 220);"><span style="box-sizing:border-box;color:rgb(220, 220, 220);">err</span> =&gt;</span> <span style="box-sizing:border-box;color:rgb(78, 201, 176);">console</span>.error(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">`ChenBlogHelperError:<span style="box-sizing:border-box;color:rgb(220, 220, 220);">${err}</span>`</span>))
    }
})()</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">当然了，这回导致白屏500ms，如果你觉得不好看，也可以和我一样载入一个等待界面，将<code style="color:rgb(232, 62, 140);overflow-wrap:break-word;box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;padding:0.2em 0.4em;margin:0px;background-color:rgba(27, 31, 35, 0.05);border-radius:3px;font-size:85%;">document.write()</code>改为:</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;"><span style="box-sizing:border-box;color:rgb(78, 201, 176);">document</span>.body.innerHTML = <span style="box-sizing:border-box;color:rgb(86, 156, 214);">await</span> (<span style="box-sizing:border-box;color:rgb(86, 156, 214);">await</span> fetch(<span style="box-sizing:border-box;color:rgb(214, 157, 133);">'https://npm.elemecdn.com/chenyfan-blog@1.0.13/public/notice.html'</span>)).text()</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">即可</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;"><a href="https://npm.elemecdn.com/chenyfan-os@0.0.0-r18/2.png" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);"><img src="SpeedUp!使用黑科技为你的网站提速  陈YFの博客(￣▽￣)_files/2.png" type="image/png" data-filename="2.png" height="331" style="vertical-align:middle;margin:0px auto;border-style:none;background-color:rgb(255, 255, 255);box-sizing:initial;object-fit:cover;max-width:90%;box-shadow:rgba(0, 0, 0, 0.18) 0px 5px 11px 0px, rgba(0, 0, 0, 0.15) 0px 4px 15px 0px;border-radius:3px;" width="696"/></a></p><h2 style="box-sizing:border-box;line-height:1.25;padding-bottom:0.3em;border-bottom:1px solid rgb(234, 236, 239);font-size:1.5em;color:rgb(26, 32, 44);margin-top:2em;margin-bottom:0.75em;font-weight:700;"><a href="https://blog.cyfan.top/p/d3c51290.html#%E4%B8%BB%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BC%98%E5%8C%96-%E7%BB%9D%E6%9C%9B%E4%B8%AD%E7%9A%84%E6%9C%80%E5%90%8E%E4%B8%80%E6%A0%B9%E7%A8%BB%E8%8D%89" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="主服务器优化 - 绝望中的最后一根稻草"></a>主服务器优化 - 绝望中的最后一根稻草</h2><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">实际上我一直以为，主服务器的优化在整个网站中是最必要的，也是最不重要的。必要的原因是它关系到最初的加载速度，也是访客中最主要的一环；不重要的是相对于静态资源的记载、页面的渲染和脚本的编译，首屏的加载对整体效果太小了。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">尤其是在sw托管后，之后的所有访问，除了sw的更新（以及所有镜像源全炸后），基本与主服务器脱离了关系，正常访问与其没有关系。加速源站实则没有必要。</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">当然，你说有用吗，那肯定还有点用处，至少首次加载不至于卡人心态。我的要求很简单，能在600ms内完成首次html下载的基本就没问题了。<br style="box-sizing:border-box;"/>最优的无非是香港CN2，不过我们没这个能力。退而求其次，普通的香港服务器我们也能接受。不过依旧是白嫖至上的念头，我才用了Vercel。Vercel也是可以自选节点（主要是亚马逊和谷歌）的，我稍加测试【主要注重可连接性，其次是延迟。丢包和速度作为建站（尤其只有一个10kb的网页）最次】，决定使用一下策略：</p><div style="box-sizing:border-box;display:block;background:rgb(30, 30, 30);color:rgb(220, 220, 220);border-radius:3px;overflow-x:initial;padding:0px;"><pre style="display:block;color:rgb(33, 37, 41);box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;margin-top:0px;margin-bottom:16px;overflow-wrap:normal;padding:16px;line-height:1.45;border-radius:3px;font-size:85%;position:relative;overflow:visible;background-color:initial;"><code style="box-sizing:border-box;font-family:SFMono-Regular, Consolas, &quot;Liberation Mono&quot;, Menlo, monospace;white-space:pre;color:rgb(220, 220, 220);word-break:normal;background:rgb(30, 30, 30);overflow:visible;overflow-wrap:normal;margin:0px;border:0px;background-color:initial;tab-size:4;font-size:85%;padding:0.5rem 0px;border-radius:3px;display:block;line-height:1.5;overflow-x:auto;">电信 <span style="box-sizing:border-box;color:rgb(184, 215, 163);">104.199</span><span style="box-sizing:border-box;color:rgb(184, 215, 163);">.217</span><span style="box-sizing:border-box;color:rgb(184, 215, 163);">.228</span> 【台北 谷歌Cloud】 <span style="box-sizing:border-box;color:rgb(184, 215, 163);">70</span>ms （绕新加坡 但是是质量最好的）
联通 <span style="box-sizing:border-box;color:rgb(184, 215, 163);">18.178</span><span style="box-sizing:border-box;color:rgb(184, 215, 163);">.194</span><span style="box-sizing:border-box;color:rgb(184, 215, 163);">.147</span> 【日本 亚马逊】 <span style="box-sizing:border-box;color:rgb(184, 215, 163);">45</span>ms （<span style="box-sizing:border-box;color:rgb(184, 215, 163);">4837</span>和aws在tyo互联）
移动 <span style="box-sizing:border-box;color:rgb(184, 215, 163);">18.162</span><span style="box-sizing:border-box;color:rgb(184, 215, 163);">.37</span><span style="box-sizing:border-box;color:rgb(184, 215, 163);">.140</span> 【香港 谷歌Cloud】 <span style="box-sizing:border-box;color:rgb(184, 215, 163);">60</span>ms （移动去香港总是最好的选择）</code></pre></div><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">在这里，不推荐其他地区的理由是：</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">电信：基本上除了台北，去GoogleCloud的都是走日本ntt × ； 亚马逊这一块有大部分绕美，去日本延迟异常的大。<br style="box-sizing:border-box;"/>联通：去香港的绕美了，去日本这一条存在这直接的互联点，负载比较小，延迟也不错。<br style="box-sizing:border-box;"/>移动：没什么好说的，移动互联除了去亚太的都是垃圾。</p><h1 style="margin:0.67em 0px;box-sizing:border-box;line-height:1.25;font-size:2em;padding-bottom:0.3em;border-bottom:1px solid rgb(234, 236, 239);color:rgb(26, 32, 44);font-weight:700;margin-top:2em;margin-bottom:0.75em;"><a href="https://blog.cyfan.top/p/d3c51290.html#%E5%90%8E%E8%AE%B0" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);" title="后记"></a>后记</h1><p style="box-sizing:border-box;margin-top:0px;margin-bottom:16px;">一张思维导图总结全文，你学废了吗？</p><p style="box-sizing:border-box;margin-top:0px;margin-bottom:0px;"><a href="https://npm.elemecdn.com/chenyfan-os@0.0.0-r18/3.png" style="cursor:pointer;transition:color 0.2s ease-in-out 0s, background-color 0.2s ease-in-out 0s;box-sizing:border-box;background-color:initial;text-decoration:none;color:rgb(3, 102, 214);"><img src="SpeedUp!使用黑科技为你的网站提速  陈YFの博客(￣▽￣)_files/3.png" type="image/png" data-filename="3.png" height="692" style="vertical-align:middle;margin:0px auto;border-style:none;background-color:rgb(255, 255, 255);box-sizing:initial;object-fit:cover;max-width:90%;box-shadow:rgba(0, 0, 0, 0.18) 0px 5px 11px 0px, rgba(0, 0, 0, 0.15) 0px 4px 15px 0px;border-radius:3px;" width="696"/></a></p></div></div></div></div></div></div></div></span></div></div></div>
</div>
</span>
</div></body></html> 