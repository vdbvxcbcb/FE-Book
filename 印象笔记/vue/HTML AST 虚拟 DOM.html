<html>
<head>
  <title>HTML AST 虚拟 DOM</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/606060 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="554"/>
<h1>HTML AST 虚拟 DOM</h1>

<div>
<span><div><font style="font-size: 12pt;">HTML AST 虚拟 DOM</font></div><div><font style="font-size: 12pt;"><br/></font></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="font-size: 12pt;">&lt;!DOCTYPE html&gt;</font></div><div><font style="font-size: 12pt;">&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</font></div><div><font style="font-size: 12pt;">&lt;head&gt;</font></div><div><font style="font-size: 12pt;">    &lt;title&gt;Hello&lt;/title&gt;</font></div><div><font style="font-size: 12pt;">&lt;/head&gt;</font></div><div><font style="font-size: 12pt;">&lt;body&gt;</font></div><div><font style="font-size: 12pt;">  &lt;div id=&quot;container&quot;&gt;</font></div><div><font style="font-size: 12pt;">    &lt;div class=&quot;header&quot;&gt;&lt;/div&gt;</font></div><div><font style="font-size: 12pt;">    &lt;div class=&quot;content&quot;&gt;&lt;/div&gt;</font></div><div><font style="font-size: 12pt;">    &lt;div class=&quot;footer&quot;&gt;&lt;/div&gt;</font></div><div><font style="font-size: 12pt;">  &lt;/div&gt;</font></div><div><font style="font-size: 12pt;">  &lt;script&gt;</font></div><div><font style="font-size: 12pt;">    const html = `&lt;head&gt;&lt;title&gt;Hello&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;div id=&quot;container&quot;&gt;&lt;div class=&quot;header&quot;&gt;&lt;/div&gt;&lt;div class=&quot;content&quot;&gt;&lt;/div&gt;&lt;div class=&quot;footer&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/body&gt;`</font></div><div><font style="font-size: 12pt;">    function html2AST(html) {</font></div><div><font style="font-size: 12pt;">      const startTag = /&lt;([a-zA-Z_][\w\-\.]*)((?:\s+([a-zA-Z_:][-a-zA-Z0-9_:.]*)\s*=\s*(?:&quot;([^&quot;]*)&quot;|'([^']*)'|([^\s&quot;'=&lt;&gt;`]+)))*)\s*(\/?)&gt;/;</font></div><div><font style="font-size: 12pt;">      const endTag = /&lt;\/([a-zA-Z_][\w\-\.]*)&gt;/;</font></div><div><font style="font-size: 12pt;">      const attr = /([a-zA-Z_:][-a-zA-Z0-9_:.]*)\s*=\s*(?:&quot;([^&quot;]*)&quot;|'([^']*)'|([^\s&quot;'=&lt;&gt;`]+))/g;</font></div><div><font style="font-size: 12pt;">      const bufArray = [];</font></div><div><font style="font-size: 12pt;">      const results = {</font></div><div><font style="font-size: 12pt;">        node: &quot;root&quot;,</font></div><div><font style="font-size: 12pt;">        child: []</font></div><div><font style="font-size: 12pt;">      };</font></div><div><font style="font-size: 12pt;">      let chars;</font></div><div><font style="font-size: 12pt;">      let match;</font></div><div><font style="font-size: 12pt;">      let last;</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">      while (html &amp;&amp; last != html) {</font></div><div><font style="font-size: 12pt;">        last = html;</font></div><div><font style="font-size: 12pt;">        chars = true; // 是不是文本内容</font></div><div><font style="font-size: 12pt;">        if (html.indexOf(&quot;&lt;/&quot;) == 0) {</font></div><div><font style="font-size: 12pt;">          match = html.match(endTag);</font></div><div><font style="font-size: 12pt;">          if (match) {</font></div><div><font style="font-size: 12pt;">            chars = false;</font></div><div><font style="font-size: 12pt;">            html = html.substring(match[0].length);</font></div><div><font style="font-size: 12pt;">            match[0].replace(endTag, parseEndTag);</font></div><div><font style="font-size: 12pt;">          }</font></div><div><font style="font-size: 12pt;">        } else if (html.indexOf(&quot;&lt;&quot;) == 0) {</font></div><div><font style="font-size: 12pt;">          match = html.match(startTag);</font></div><div><font style="font-size: 12pt;">          if (match) {</font></div><div><font style="font-size: 12pt;">            chars = false;</font></div><div><font style="font-size: 12pt;">            html = html.substring(match[0].length);</font></div><div><font style="font-size: 12pt;">            match[0].replace(startTag, parseStartTag);</font></div><div><font style="font-size: 12pt;">          }</font></div><div><font style="font-size: 12pt;">        }</font></div><div><font style="font-size: 12pt;">        if (chars) {</font></div><div><font style="font-size: 12pt;">          let index = html.indexOf(&quot;&lt;&quot;);</font></div><div><font style="font-size: 12pt;">          let text;</font></div><div><font style="font-size: 12pt;">          if (index &lt; 0) {</font></div><div><font style="font-size: 12pt;">            text = html;</font></div><div><font style="font-size: 12pt;">            html = &quot;&quot;;</font></div><div><font style="font-size: 12pt;">          } else {</font></div><div><font style="font-size: 12pt;">            text = html.substring(0, index);</font></div><div><font style="font-size: 12pt;">            html = html.substring(index);</font></div><div><font style="font-size: 12pt;">          }</font></div><div><font style="font-size: 12pt;">          const node = {</font></div><div><font style="font-size: 12pt;">            node: &quot;text&quot;,</font></div><div><font style="font-size: 12pt;">            text</font></div><div><font style="font-size: 12pt;">          };</font></div><div><font style="font-size: 12pt;">          pushChild(node);</font></div><div><font style="font-size: 12pt;">        }</font></div><div><font style="font-size: 12pt;">      }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">      function pushChild(node) {</font></div><div><font style="font-size: 12pt;">        if (bufArray.length === 0) {</font></div><div><font style="font-size: 12pt;">          results.child.push(node);</font></div><div><font style="font-size: 12pt;">        } else {</font></div><div><font style="font-size: 12pt;">          const parent = bufArray[bufArray.length - 1];</font></div><div><font style="font-size: 12pt;">          if (typeof parent.child == &quot;undefined&quot;) {</font></div><div><font style="font-size: 12pt;">            parent.child = [];</font></div><div><font style="font-size: 12pt;">          }</font></div><div><font style="font-size: 12pt;">          parent.child.push(node);</font></div><div><font style="font-size: 12pt;">        }</font></div><div><font style="font-size: 12pt;">      }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">      function parseStartTag(tag, tagName, rest) {</font></div><div><font style="font-size: 12pt;">        tagName = tagName.toLowerCase();</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">        const ds = {};</font></div><div><font style="font-size: 12pt;">        const attrs = [];</font></div><div><font style="font-size: 12pt;">        let unary = !!arguments[7];</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">        const node = {</font></div><div><font style="font-size: 12pt;">          node: &quot;element&quot;,</font></div><div><font style="font-size: 12pt;">          tag: tagName</font></div><div><font style="font-size: 12pt;">        };</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">        rest.replace(attr, function(match, name) {</font></div><div><font style="font-size: 12pt;">          const value = arguments[2]</font></div><div><font style="font-size: 12pt;">            ? arguments[2]</font></div><div><font style="font-size: 12pt;">            : arguments[3]</font></div><div><font style="font-size: 12pt;">            ? arguments[3]</font></div><div><font style="font-size: 12pt;">            : arguments[4]</font></div><div><font style="font-size: 12pt;">            ? arguments[4]</font></div><div><font style="font-size: 12pt;">            : &quot;&quot;;</font></div><div><font style="font-size: 12pt;">          if (name &amp;&amp; name.indexOf(&quot;data-&quot;) == 0) {</font></div><div><font style="font-size: 12pt;">            ds[name.replace(&quot;data-&quot;, &quot;&quot;)] = value;</font></div><div><font style="font-size: 12pt;">          } else {</font></div><div><font style="font-size: 12pt;">            if (name == &quot;class&quot;) {</font></div><div><font style="font-size: 12pt;">              node.class = value;</font></div><div><font style="font-size: 12pt;">            } else {</font></div><div><font style="font-size: 12pt;">              attrs.push({</font></div><div><font style="font-size: 12pt;">                name,</font></div><div><font style="font-size: 12pt;">                value</font></div><div><font style="font-size: 12pt;">              });</font></div><div><font style="font-size: 12pt;">            }</font></div><div><font style="font-size: 12pt;">          }</font></div><div><font style="font-size: 12pt;">        });</font></div><div><font style="font-size: 12pt;">        node.dataset = ds;</font></div><div><font style="font-size: 12pt;">        node.attrs = attrs;</font></div><div><font style="font-size: 12pt;">        if (!unary) {</font></div><div><font style="font-size: 12pt;">          bufArray.push(node);</font></div><div><font style="font-size: 12pt;">        } else {</font></div><div><font style="font-size: 12pt;">          pushChild(node);</font></div><div><font style="font-size: 12pt;">        }</font></div><div><font style="font-size: 12pt;">      }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">      function parseEndTag(tag, tagName) {</font></div><div><font style="font-size: 12pt;">        let pos = 0;</font></div><div><font style="font-size: 12pt;">        for (pos = bufArray.length - 1; pos &gt;= 0; pos--) {</font></div><div><font style="font-size: 12pt;">          if (bufArray[pos].tag == tagName) {</font></div><div><font style="font-size: 12pt;">            break;</font></div><div><font style="font-size: 12pt;">          }</font></div><div><font style="font-size: 12pt;">        }</font></div><div><font style="font-size: 12pt;">        if (pos &gt;= 0) {</font></div><div><font style="font-size: 12pt;">          pushChild(bufArray.pop());</font></div><div><font style="font-size: 12pt;">        }</font></div><div><font style="font-size: 12pt;">      }</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">      return results;</font></div><div><font style="font-size: 12pt;">  }</font></div><div><font style="font-size: 12pt;">    console.log(html2AST(html));</font></div><div><font style="font-size: 12pt;">  &lt;/script&gt;</font></div><div><font style="font-size: 12pt;">&lt;/body&gt;</font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;"><br/></font></div><div><font style="font-size: 12pt;">&lt;/html&gt;</font></div><div><font style="font-size: 12pt;">&lt;script&gt;</font></div><div><font style="font-size: 12pt;">&lt;/script&gt;</font></div></div><div><br/></div></span>
</div></body></html> 